<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="">

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"> <!--320-->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no">

    <link rel="icon" href="../../mapt/images/favicon.ico">

    <link rel="stylesheet" href="../../mapt/css/font-awesome.css">
    <link rel="stylesheet" href="../../mapt/css/google-fonts.css">
    <link rel="stylesheet" href="../../mapt/css/devicon.css">

    <link rel="stylesheet" href="../../mapt/css/bootstrap.css">
    <link rel="stylesheet" href="../../mapt/css/bootstrap-xl.css">
    <link rel="stylesheet" href="../../mapt/css/magnific-popup.css">
    <link rel="stylesheet" href="../../mapt/css/prism.css">
    <link rel="stylesheet" href="../../mapt/css/hljs-github.css">

    <link rel="stylesheet" href="../../mapt/css/mapt.css">
    <link rel="stylesheet" href="../../mapt/css/custom.css">

    <script src="../../mapt/js/jquery.js"></script>
    <script src="../../mapt/js/bootstrap.js"></script>
    <script src="../../mapt/js/jquery.magnific-popup.js"></script>
    <script src="../../mapt/js/highlight.min.js"></script>

    <script src="../../mapt/js/custom.js"></script>
    
    <title>CentOS 7 Server Deployment Cookbook</title>
</head>

<body class="home-body">
    <div id="wrapper">
        <div id="sidebar-wrapper">    
            <ul class="sidebar-nav">
                <div class="list-group" id="sidebar-nav" role="tablist">
                    <li>
                        <a href="../../index.html" class="sidenav-menu-holder back-btn" id="back-link">
                            <span class="sidenav-menu">Book List</span>
                            <span class="pull-left mr5"><i class="fa fa-chevron-left"></i></span>
                        </a>
                    </li>
                    
                    <li class="book-info copyright">
                        <span class="info text-nowrap"><span class="copyleft">&copy;</span><span><strong>RuTracker</strong>.org</span></span>
                    </li>          
                    <li class="book-info copyright">
                        <span class="info text-nowrap">Pub date: <strong>6 Oct 2016</strong></span>
                    </li>         
                    <li class="book-info">
                        <span class="info text-nowrap">Price: â‚¬<strong>34.99</strong></span>
                        <span class="info text-nowrap">ISBN: <strong>9781783288885</strong></span>
                    </li>     
            
                    <li>
                        <a href="graphics/cover.jpg" class="sidenav-menu-holder cover-img">
                            <img src="graphics/cover.jpg" class="cover-image">
                        </a>
                    </li>        
            
                    <div class="book_navigation">
                        <li>
                            <a data-toggle="collapse" data-parent="#sidebar-nav" class="sidenav-menu-holder collapsed" href="#collapse1">
                                <div class="section-name">1: Getting Started with CentOS</div>
                            </a>
                        </li>
                        <div id="collapse1" class="panel-collapse collapse" role="tabpanel">
                            <li data-chapter="1" class="sub-nav">
                                <a href="#ch01">
                                    <div class="section-name">Chapter 1: Getting Started with CentOS</div>
                                </a>
                            </li>
                            <li data-chapter="1" data-section-id="ch01lvl1sec8" class="sub-nav">
                                <a href="#ch01lvl1sec8">                    
                                    <div class="section-name">Introduction</div>
                                </a>
                            </li>
                            <li data-chapter="1" data-section-id="ch01lvl1sec9" class="sub-nav">
                                <a href="#ch01lvl1sec9">                    
                                    <div class="section-name">Installing CentOS using Anaconda in graphics mode</div>
                                </a>
                            </li>
                            <li data-chapter="1" data-section-id="ch01lvl1sec10" class="sub-nav">
                                <a href="#ch01lvl1sec10">                    
                                    <div class="section-name">Installing CentOS using Anaconda in text mode</div>
                                </a>
                            </li>
                            <li data-chapter="1" data-section-id="ch01lvl1sec11" class="sub-nav">
                                <a href="#ch01lvl1sec11">                    
                                    <div class="section-name">Coordinating multiple installations using Kickstart</div>
                                </a>
                            </li>
                            <li data-chapter="1" data-section-id="ch01lvl1sec12" class="sub-nav">
                                <a href="#ch01lvl1sec12">                    
                                    <div class="section-name">Running a cloud image with Amazon Web Services&#x27; EC2</div>
                                </a>
                            </li>
                            <li data-chapter="1" data-section-id="ch01lvl1sec13" class="sub-nav">
                                <a href="#ch01lvl1sec13">                    
                                    <div class="section-name">Installing a container image from the Docker Registry</div>
                                </a>
                            </li>
                            <li data-chapter="1" data-section-id="ch01lvl1sec14" class="sub-nav">
                                <a href="#ch01lvl1sec14">                    
                                    <div class="section-name">Installing the GNOME desktop</div>
                                </a>
                            </li>
                            <li data-chapter="1" data-section-id="ch01lvl1sec15" class="sub-nav">
                                <a href="#ch01lvl1sec15">                    
                                    <div class="section-name">Installing the KDE Plasma desktop</div>
                                </a>
                            </li>
                        </div>
                        <li>
                            <a data-toggle="collapse" data-parent="#sidebar-nav" class="sidenav-menu-holder collapsed" href="#collapse2">
                                <div class="section-name">2: Networking</div>
                            </a>
                        </li>
                        <div id="collapse2" class="panel-collapse collapse" role="tabpanel">
                            <li data-chapter="2" class="sub-nav">
                                <a href="#ch02">
                                    <div class="section-name">Chapter 2: Networking</div>
                                </a>
                            </li>
                            <li data-chapter="2" data-section-id="ch02lvl1sec16" class="sub-nav">
                                <a href="#ch02lvl1sec16">                    
                                    <div class="section-name">Introduction</div>
                                </a>
                            </li>
                            <li data-chapter="2" data-section-id="ch02lvl1sec17" class="sub-nav">
                                <a href="#ch02lvl1sec17">                    
                                    <div class="section-name">Setting a static IP address</div>
                                </a>
                            </li>
                            <li data-chapter="2" data-section-id="ch02lvl1sec18" class="sub-nav">
                                <a href="#ch02lvl1sec18">                    
                                    <div class="section-name">Binding multiple addresses to a single Ethernet device</div>
                                </a>
                            </li>
                            <li data-chapter="2" data-section-id="ch02lvl1sec19" class="sub-nav">
                                <a href="#ch02lvl1sec19">                    
                                    <div class="section-name">Bonding two Ethernet devices</div>
                                </a>
                            </li>
                            <li data-chapter="2" data-section-id="ch02lvl1sec20" class="sub-nav">
                                <a href="#ch02lvl1sec20">                    
                                    <div class="section-name">Configuring the network firewall with FirewallD</div>
                                </a>
                            </li>
                            <li data-chapter="2" data-section-id="ch02lvl1sec21" class="sub-nav">
                                <a href="#ch02lvl1sec21">                    
                                    <div class="section-name">Configuring the network firewall using iptables</div>
                                </a>
                            </li>
                            <li data-chapter="2" data-section-id="ch02lvl1sec22" class="sub-nav">
                                <a href="#ch02lvl1sec22">                    
                                    <div class="section-name">Installing a DHCP server</div>
                                </a>
                            </li>
                            <li data-chapter="2" data-section-id="ch02lvl1sec23" class="sub-nav">
                                <a href="#ch02lvl1sec23">                    
                                    <div class="section-name">Configuring an NFS server to share a filesystem</div>
                                </a>
                            </li>
                            <li data-chapter="2" data-section-id="ch02lvl1sec24" class="sub-nav">
                                <a href="#ch02lvl1sec24">                    
                                    <div class="section-name">Configuring an NFS client to use a shared filesystem</div>
                                </a>
                            </li>
                            <li data-chapter="2" data-section-id="ch02lvl1sec25" class="sub-nav">
                                <a href="#ch02lvl1sec25">                    
                                    <div class="section-name">Serving Windows shares with Samba</div>
                                </a>
                            </li>
                        </div>
                        <li>
                            <a data-toggle="collapse" data-parent="#sidebar-nav" class="sidenav-menu-holder collapsed" href="#collapse3">
                                <div class="section-name">3: User and Permission Management</div>
                            </a>
                        </li>
                        <div id="collapse3" class="panel-collapse collapse" role="tabpanel">
                            <li data-chapter="3" class="sub-nav">
                                <a href="#ch03">
                                    <div class="section-name">Chapter 3: User and Permission Management</div>
                                </a>
                            </li>
                            <li data-chapter="3" data-section-id="ch03lvl1sec26" class="sub-nav">
                                <a href="#ch03lvl1sec26">                    
                                    <div class="section-name">Introduction</div>
                                </a>
                            </li>
                            <li data-chapter="3" data-section-id="ch03lvl1sec27" class="sub-nav">
                                <a href="#ch03lvl1sec27">                    
                                    <div class="section-name">Escalating privileges with sudo</div>
                                </a>
                            </li>
                            <li data-chapter="3" data-section-id="ch03lvl1sec28" class="sub-nav">
                                <a href="#ch03lvl1sec28">                    
                                    <div class="section-name">Enforcing password restrictions</div>
                                </a>
                            </li>
                            <li data-chapter="3" data-section-id="ch03lvl1sec29" class="sub-nav">
                                <a href="#ch03lvl1sec29">                    
                                    <div class="section-name">Setting default permissions for new files and directories</div>
                                </a>
                            </li>
                            <li data-chapter="3" data-section-id="ch03lvl1sec30" class="sub-nav">
                                <a href="#ch03lvl1sec30">                    
                                    <div class="section-name">Running binaries as a different user</div>
                                </a>
                            </li>
                            <li data-chapter="3" data-section-id="ch03lvl1sec31" class="sub-nav">
                                <a href="#ch03lvl1sec31">                    
                                    <div class="section-name">Working with SELinux for greater security</div>
                                </a>
                            </li>
                        </div>
                        <li>
                            <a data-toggle="collapse" data-parent="#sidebar-nav" class="sidenav-menu-holder collapsed" href="#collapse4">
                                <div class="section-name">4: Software Installation Management</div>
                            </a>
                        </li>
                        <div id="collapse4" class="panel-collapse collapse" role="tabpanel">
                            <li data-chapter="4" class="sub-nav">
                                <a href="#ch04">
                                    <div class="section-name">Chapter 4: Software Installation Management</div>
                                </a>
                            </li>
                            <li data-chapter="4" data-section-id="ch04lvl1sec32" class="sub-nav">
                                <a href="#ch04lvl1sec32">                    
                                    <div class="section-name">Introduction</div>
                                </a>
                            </li>
                            <li data-chapter="4" data-section-id="ch04lvl1sec33" class="sub-nav">
                                <a href="#ch04lvl1sec33">                    
                                    <div class="section-name">Registering the EPEL and Remi repositories</div>
                                </a>
                            </li>
                            <li data-chapter="4" data-section-id="ch04lvl1sec34" class="sub-nav">
                                <a href="#ch04lvl1sec34">                    
                                    <div class="section-name">Prioritizing repositories using the Priorities plugin</div>
                                </a>
                            </li>
                            <li data-chapter="4" data-section-id="ch04lvl1sec35" class="sub-nav">
                                <a href="#ch04lvl1sec35">                    
                                    <div class="section-name">Automating software updates with yum-cron</div>
                                </a>
                            </li>
                            <li data-chapter="4" data-section-id="ch04lvl1sec36" class="sub-nav">
                                <a href="#ch04lvl1sec36">                    
                                    <div class="section-name">Verifying installed RPM packages</div>
                                </a>
                            </li>
                            <li data-chapter="4" data-section-id="ch04lvl1sec37" class="sub-nav">
                                <a href="#ch04lvl1sec37">                    
                                    <div class="section-name">Compiling a program from source</div>
                                </a>
                            </li>
                        </div>
                        <li>
                            <a data-toggle="collapse" data-parent="#sidebar-nav" class="sidenav-menu-holder collapsed" href="#collapse5">
                                <div class="section-name">5: Managing Filesystems and Storage</div>
                            </a>
                        </li>
                        <div id="collapse5" class="panel-collapse collapse" role="tabpanel">
                            <li data-chapter="5" class="sub-nav">
                                <a href="#ch05">
                                    <div class="section-name">Chapter 5: Managing Filesystems and Storage</div>
                                </a>
                            </li>
                            <li data-chapter="5" data-section-id="ch05lvl1sec38" class="sub-nav">
                                <a href="#ch05lvl1sec38">                    
                                    <div class="section-name">Introduction</div>
                                </a>
                            </li>
                            <li data-chapter="5" data-section-id="ch05lvl1sec39" class="sub-nav">
                                <a href="#ch05lvl1sec39">                    
                                    <div class="section-name">Viewing the size of files and available storage</div>
                                </a>
                            </li>
                            <li data-chapter="5" data-section-id="ch05lvl1sec40" class="sub-nav">
                                <a href="#ch05lvl1sec40">                    
                                    <div class="section-name">Setting storage limits for users and groups</div>
                                </a>
                            </li>
                            <li data-chapter="5" data-section-id="ch05lvl1sec41" class="sub-nav">
                                <a href="#ch05lvl1sec41">                    
                                    <div class="section-name">Creating a RAM disk</div>
                                </a>
                            </li>
                            <li data-chapter="5" data-section-id="ch05lvl1sec42" class="sub-nav">
                                <a href="#ch05lvl1sec42">                    
                                    <div class="section-name">Creating a RAID</div>
                                </a>
                            </li>
                            <li data-chapter="5" data-section-id="ch05lvl1sec43" class="sub-nav">
                                <a href="#ch05lvl1sec43">                    
                                    <div class="section-name">Replacing a device in a RAID</div>
                                </a>
                            </li>
                            <li data-chapter="5" data-section-id="ch05lvl1sec44" class="sub-nav">
                                <a href="#ch05lvl1sec44">                    
                                    <div class="section-name">Creating a new LVM volume</div>
                                </a>
                            </li>
                            <li data-chapter="5" data-section-id="ch05lvl1sec45" class="sub-nav">
                                <a href="#ch05lvl1sec45">                    
                                    <div class="section-name">Removing an existing LVM volume</div>
                                </a>
                            </li>
                            <li data-chapter="5" data-section-id="ch05lvl1sec46" class="sub-nav">
                                <a href="#ch05lvl1sec46">                    
                                    <div class="section-name">Adding storage and growing an LVM volume</div>
                                </a>
                            </li>
                            <li data-chapter="5" data-section-id="ch05lvl1sec47" class="sub-nav">
                                <a href="#ch05lvl1sec47">                    
                                    <div class="section-name">Working with LVM snapshots</div>
                                </a>
                            </li>
                        </div>
                        <li>
                            <a data-toggle="collapse" data-parent="#sidebar-nav" class="sidenav-menu-holder collapsed" href="#collapse6">
                                <div class="section-name">6: Allowing Remote Access</div>
                            </a>
                        </li>
                        <div id="collapse6" class="panel-collapse collapse" role="tabpanel">
                            <li data-chapter="6" class="sub-nav">
                                <a href="#ch06">
                                    <div class="section-name">Chapter 6: Allowing Remote Access</div>
                                </a>
                            </li>
                            <li data-chapter="6" data-section-id="ch06lvl1sec48" class="sub-nav">
                                <a href="#ch06lvl1sec48">                    
                                    <div class="section-name">Introduction</div>
                                </a>
                            </li>
                            <li data-chapter="6" data-section-id="ch06lvl1sec49" class="sub-nav">
                                <a href="#ch06lvl1sec49">                    
                                    <div class="section-name">Running commands remotely through SSH</div>
                                </a>
                            </li>
                            <li data-chapter="6" data-section-id="ch06lvl1sec50" class="sub-nav">
                                <a href="#ch06lvl1sec50">                    
                                    <div class="section-name">Configuring a more secure SSH login</div>
                                </a>
                            </li>
                            <li data-chapter="6" data-section-id="ch06lvl1sec51" class="sub-nav">
                                <a href="#ch06lvl1sec51">                    
                                    <div class="section-name">Securely connecting to SSH without a password</div>
                                </a>
                            </li>
                            <li data-chapter="6" data-section-id="ch06lvl1sec52" class="sub-nav">
                                <a href="#ch06lvl1sec52">                    
                                    <div class="section-name">Restricting SSH access by user or group</div>
                                </a>
                            </li>
                            <li data-chapter="6" data-section-id="ch06lvl1sec53" class="sub-nav">
                                <a href="#ch06lvl1sec53">                    
                                    <div class="section-name">Protecting SSH with Fail2ban</div>
                                </a>
                            </li>
                            <li data-chapter="6" data-section-id="ch06lvl1sec54" class="sub-nav">
                                <a href="#ch06lvl1sec54">                    
                                    <div class="section-name">Confining sessions to a chroot jail</div>
                                </a>
                            </li>
                            <li data-chapter="6" data-section-id="ch06lvl1sec55" class="sub-nav">
                                <a href="#ch06lvl1sec55">                    
                                    <div class="section-name">Configuring TigerVNC</div>
                                </a>
                            </li>
                            <li data-chapter="6" data-section-id="ch06lvl1sec56" class="sub-nav">
                                <a href="#ch06lvl1sec56">                    
                                    <div class="section-name">Tunneling VNC connections through SSH</div>
                                </a>
                            </li>
                        </div>
                        <li>
                            <a data-toggle="collapse" data-parent="#sidebar-nav" class="sidenav-menu-holder collapsed" href="#collapse7">
                                <div class="section-name">7: Working with Databases</div>
                            </a>
                        </li>
                        <div id="collapse7" class="panel-collapse collapse" role="tabpanel">
                            <li data-chapter="7" class="sub-nav">
                                <a href="#ch07">
                                    <div class="section-name">Chapter 7: Working with Databases</div>
                                </a>
                            </li>
                            <li data-chapter="7" data-section-id="ch07lvl1sec57" class="sub-nav">
                                <a href="#ch07lvl1sec57">                    
                                    <div class="section-name">Introduction</div>
                                </a>
                            </li>
                            <li data-chapter="7" data-section-id="ch07lvl1sec58" class="sub-nav">
                                <a href="#ch07lvl1sec58">                    
                                    <div class="section-name">Setting up a MySQL database</div>
                                </a>
                            </li>
                            <li data-chapter="7" data-section-id="ch07lvl1sec59" class="sub-nav">
                                <a href="#ch07lvl1sec59">                    
                                    <div class="section-name">Backing up and restoring a MySQL database</div>
                                </a>
                            </li>
                            <li data-chapter="7" data-section-id="ch07lvl1sec60" class="sub-nav">
                                <a href="#ch07lvl1sec60">                    
                                    <div class="section-name">Configuring MySQL replication</div>
                                </a>
                            </li>
                            <li data-chapter="7" data-section-id="ch07lvl1sec61" class="sub-nav">
                                <a href="#ch07lvl1sec61">                    
                                    <div class="section-name">Standing up a MySQL cluster</div>
                                </a>
                            </li>
                            <li data-chapter="7" data-section-id="ch07lvl1sec62" class="sub-nav">
                                <a href="#ch07lvl1sec62">                    
                                    <div class="section-name">Setting up a MongoDB database</div>
                                </a>
                            </li>
                            <li data-chapter="7" data-section-id="ch07lvl1sec63" class="sub-nav">
                                <a href="#ch07lvl1sec63">                    
                                    <div class="section-name">Backing up and restoring a MongoDB database</div>
                                </a>
                            </li>
                            <li data-chapter="7" data-section-id="ch07lvl1sec64" class="sub-nav">
                                <a href="#ch07lvl1sec64">                    
                                    <div class="section-name">Configuring a MongoDB replica set</div>
                                </a>
                            </li>
                            <li data-chapter="7" data-section-id="ch07lvl1sec65" class="sub-nav">
                                <a href="#ch07lvl1sec65">                    
                                    <div class="section-name">Setting up an OpenLDAP directory</div>
                                </a>
                            </li>
                            <li data-chapter="7" data-section-id="ch07lvl1sec66" class="sub-nav">
                                <a href="#ch07lvl1sec66">                    
                                    <div class="section-name">Backing up and restoring an OpenLDAP database</div>
                                </a>
                            </li>
                        </div>
                        <li>
                            <a data-toggle="collapse" data-parent="#sidebar-nav" class="sidenav-menu-holder collapsed" href="#collapse8">
                                <div class="section-name">8: Managing Domains and DNS</div>
                            </a>
                        </li>
                        <div id="collapse8" class="panel-collapse collapse" role="tabpanel">
                            <li data-chapter="8" class="sub-nav">
                                <a href="#ch08">
                                    <div class="section-name">Chapter 8: Managing Domains and DNS</div>
                                </a>
                            </li>
                            <li data-chapter="8" data-section-id="ch08lvl1sec67" class="sub-nav">
                                <a href="#ch08lvl1sec67">                    
                                    <div class="section-name">Introduction</div>
                                </a>
                            </li>
                            <li data-chapter="8" data-section-id="ch08lvl1sec68" class="sub-nav">
                                <a href="#ch08lvl1sec68">                    
                                    <div class="section-name">Setting up BIND as a resolving DNS server</div>
                                </a>
                            </li>
                            <li data-chapter="8" data-section-id="ch08lvl1sec69" class="sub-nav">
                                <a href="#ch08lvl1sec69">                    
                                    <div class="section-name">Configuring BIND as an authoritative DNS server</div>
                                </a>
                            </li>
                            <li data-chapter="8" data-section-id="ch08lvl1sec70" class="sub-nav">
                                <a href="#ch08lvl1sec70">                    
                                    <div class="section-name">Writing a reverse lookup zone file</div>
                                </a>
                            </li>
                            <li data-chapter="8" data-section-id="ch08lvl1sec71" class="sub-nav">
                                <a href="#ch08lvl1sec71">                    
                                    <div class="section-name">Setting up a slave DNS server</div>
                                </a>
                            </li>
                            <li data-chapter="8" data-section-id="ch08lvl1sec72" class="sub-nav">
                                <a href="#ch08lvl1sec72">                    
                                    <div class="section-name">Configuring rndc to control BIND</div>
                                </a>
                            </li>
                        </div>
                        <li>
                            <a data-toggle="collapse" data-parent="#sidebar-nav" class="sidenav-menu-holder collapsed" href="#collapse9">
                                <div class="section-name">9: Managing E-mails</div>
                            </a>
                        </li>
                        <div id="collapse9" class="panel-collapse collapse" role="tabpanel">
                            <li data-chapter="9" class="sub-nav">
                                <a href="#ch09">
                                    <div class="section-name">Chapter 9: Managing E-mails</div>
                                </a>
                            </li>
                            <li data-chapter="9" data-section-id="ch09lvl1sec73" class="sub-nav">
                                <a href="#ch09lvl1sec73">                    
                                    <div class="section-name">Introduction</div>
                                </a>
                            </li>
                            <li data-chapter="9" data-section-id="ch09lvl1sec74" class="sub-nav">
                                <a href="#ch09lvl1sec74">                    
                                    <div class="section-name">Configuring Postfix to provide SMTP services</div>
                                </a>
                            </li>
                            <li data-chapter="9" data-section-id="ch09lvl1sec75" class="sub-nav">
                                <a href="#ch09lvl1sec75">                    
                                    <div class="section-name">Adding SASL to Postfix with Dovecot</div>
                                </a>
                            </li>
                            <li data-chapter="9" data-section-id="ch09lvl1sec76" class="sub-nav">
                                <a href="#ch09lvl1sec76">                    
                                    <div class="section-name">Configuring Postfix to use TLS</div>
                                </a>
                            </li>
                            <li data-chapter="9" data-section-id="ch09lvl1sec77" class="sub-nav">
                                <a href="#ch09lvl1sec77">                    
                                    <div class="section-name">Configuring Dovecot for secure POP3 and IMAP access</div>
                                </a>
                            </li>
                            <li data-chapter="9" data-section-id="ch09lvl1sec78" class="sub-nav">
                                <a href="#ch09lvl1sec78">                    
                                    <div class="section-name">Targeting spam with SpamAssassin</div>
                                </a>
                            </li>
                            <li data-chapter="9" data-section-id="ch09lvl1sec79" class="sub-nav">
                                <a href="#ch09lvl1sec79">                    
                                    <div class="section-name">Routing messages with Procmail</div>
                                </a>
                            </li>
                        </div>
                        <li>
                            <a data-toggle="collapse" data-parent="#sidebar-nav" class="sidenav-menu-holder collapsed" href="#collapse10">
                                <div class="section-name">10: Managing Web Servers</div>
                            </a>
                        </li>
                        <div id="collapse10" class="panel-collapse collapse" role="tabpanel">
                            <li data-chapter="10" class="sub-nav">
                                <a href="#ch10">
                                    <div class="section-name">Chapter 10: Managing Web Servers</div>
                                </a>
                            </li>
                            <li data-chapter="10" data-section-id="ch10lvl1sec80" class="sub-nav">
                                <a href="#ch10lvl1sec80">                    
                                    <div class="section-name">Introduction</div>
                                </a>
                            </li>
                            <li data-chapter="10" data-section-id="ch10lvl1sec81" class="sub-nav">
                                <a href="#ch10lvl1sec81">                    
                                    <div class="section-name">Installing Apache HTTP Server and PHP</div>
                                </a>
                            </li>
                            <li data-chapter="10" data-section-id="ch10lvl1sec82" class="sub-nav">
                                <a href="#ch10lvl1sec82">                    
                                    <div class="section-name">Configuring name-based virtual hosting</div>
                                </a>
                            </li>
                            <li data-chapter="10" data-section-id="ch10lvl1sec83" class="sub-nav">
                                <a href="#ch10lvl1sec83">                    
                                    <div class="section-name">Configuring Apache to serve pages over HTTPS</div>
                                </a>
                            </li>
                            <li data-chapter="10" data-section-id="ch10lvl1sec84" class="sub-nav">
                                <a href="#ch10lvl1sec84">                    
                                    <div class="section-name">Enabling overrides and performing URL rewriting</div>
                                </a>
                            </li>
                            <li data-chapter="10" data-section-id="ch10lvl1sec85" class="sub-nav">
                                <a href="#ch10lvl1sec85">                    
                                    <div class="section-name">Installing NGINX as a load balancer</div>
                                </a>
                            </li>
                        </div>
                        <li>
                            <a data-toggle="collapse" data-parent="#sidebar-nav" class="sidenav-menu-holder collapsed" href="#collapse11">
                                <div class="section-name">11: Safeguarding Against Threats</div>
                            </a>
                        </li>
                        <div id="collapse11" class="panel-collapse collapse" role="tabpanel">
                            <li data-chapter="11" class="sub-nav">
                                <a href="#ch11">
                                    <div class="section-name">Chapter 11: Safeguarding Against Threats</div>
                                </a>
                            </li>
                            <li data-chapter="11" data-section-id="ch11lvl1sec86" class="sub-nav">
                                <a href="#ch11lvl1sec86">                    
                                    <div class="section-name">Introduction</div>
                                </a>
                            </li>
                            <li data-chapter="11" data-section-id="ch11lvl1sec87" class="sub-nav">
                                <a href="#ch11lvl1sec87">                    
                                    <div class="section-name">Sending messages to Syslog</div>
                                </a>
                            </li>
                            <li data-chapter="11" data-section-id="ch11lvl1sec88" class="sub-nav">
                                <a href="#ch11lvl1sec88">                    
                                    <div class="section-name">Rotating log files with logrotate</div>
                                </a>
                            </li>
                            <li data-chapter="11" data-section-id="ch11lvl1sec89" class="sub-nav">
                                <a href="#ch11lvl1sec89">                    
                                    <div class="section-name">Using Tripwire to detect modified files</div>
                                </a>
                            </li>
                            <li data-chapter="11" data-section-id="ch11lvl1sec90" class="sub-nav">
                                <a href="#ch11lvl1sec90">                    
                                    <div class="section-name">Using ClamAV to fight viruses</div>
                                </a>
                            </li>
                            <li data-chapter="11" data-section-id="ch11lvl1sec91" class="sub-nav">
                                <a href="#ch11lvl1sec91">                    
                                    <div class="section-name">Checking for rootkits with chkrootkit</div>
                                </a>
                            </li>
                            <li data-chapter="11" data-section-id="ch11lvl1sec92" class="sub-nav">
                                <a href="#ch11lvl1sec92">                    
                                    <div class="section-name">Using Bacula for network backups</div>
                                </a>
                            </li>
                        </div>
                        <li>
                            <a data-toggle="collapse" data-parent="#sidebar-nav" class="sidenav-menu-holder collapsed" href="#collapse12">
                                <div class="section-name">12: Virtualization</div>
                            </a>
                        </li>
                        <div id="collapse12" class="panel-collapse collapse" role="tabpanel">
                            <li data-chapter="12" class="sub-nav">
                                <a href="#ch12">
                                    <div class="section-name">Chapter 12: Virtualization</div>
                                </a>
                            </li>
                            <li data-chapter="12" data-section-id="ch12lvl1sec93" class="sub-nav">
                                <a href="#ch12lvl1sec93">                    
                                    <div class="section-name">Introduction</div>
                                </a>
                            </li>
                            <li data-chapter="12" data-section-id="ch12lvl1sec94" class="sub-nav">
                                <a href="#ch12lvl1sec94">                    
                                    <div class="section-name">Creating a new virtual machine</div>
                                </a>
                            </li>
                            <li data-chapter="12" data-section-id="ch12lvl1sec95" class="sub-nav">
                                <a href="#ch12lvl1sec95">                    
                                    <div class="section-name">Cloning a virtual machine</div>
                                </a>
                            </li>
                            <li data-chapter="12" data-section-id="ch12lvl1sec96" class="sub-nav">
                                <a href="#ch12lvl1sec96">                    
                                    <div class="section-name">Adding storage to a virtual machine</div>
                                </a>
                            </li>
                            <li data-chapter="12" data-section-id="ch12lvl1sec97" class="sub-nav">
                                <a href="#ch12lvl1sec97">                    
                                    <div class="section-name">Connecting USB peripherals to a guest system</div>
                                </a>
                            </li>
                            <li data-chapter="12" data-section-id="ch12lvl1sec98" class="sub-nav">
                                <a href="#ch12lvl1sec98">                    
                                    <div class="section-name">Configuring a guest&#x27;s network interface</div>
                                </a>
                            </li>
                        </div>
                    </div>
                </div>
            </ul>
        </div>
        
        <div id="page-content-wrapper" class="book-page">
            <a href="#" id="menu-toggle" class="toggle-nav"><i class="fa fa-bars fa-2x mr5"></i></a>
            
            <a href="#" id="back_to_top" class="back-to-top"><img src="../../mapt/images/kopimi.svg"></a>
            
            <div class="col-sm-12 col-xl-offset-2 col-xl-8 col-lg-offset-1 col-lg-10">
                <div class="btn-group pull-right mt15 mb30" role="group">
                    <a href="#home" class="btn btn-default">
                        <i class="fa fa-share fa-lg no-text-padding"></i>
                        <span class="hidden-xs ml5">Book Home</span>
                    </a>
                    <button class="btn btn-default disabled" id="code-download">
                        <i class="fa fa-file fa-lg"></i>
                        <span class="hidden-xs ml5">Download Code Files</span>
                    </button>
                </div>
            </div>
            <div class="clearfix"></div>
            
            <div id="book-wrapper" class="container-fluid">
                <div class="col-sm-12 col-xl-offset-2 col-xl-8 col-lg-offset-1 col-lg-10" id="home">
                    <h2 class="product-title">CentOS 7 Server Deployment Cookbook</h2>
                    <hr>
                    <div class="row">
                        <div class="col-sm-12">
                            <h5 class="mt10">By Timothy Boronczyk</h5>
                            <div>
                                <p class="mb20"><b>Deploy and manage today&#x27;s essential services on an enterprise-class, open operating system</b></p>
                                <a href="#ch01" class="btn btn-info btn-lg pull-right hidden-xs">
                                    Start Reading <i class="fa fa-chevron-right ml5"></i>
                                </a>
                                <a href="#ch01" class="btn btn-info btn-lg btn-block mt20 mb20 visible-xs">
                                    Start Reading <i class="fa fa-chevron-right ml5"></i>
                                </a>
                                <div class="clearfix"></div>
                                <div class="col-sm-12">
                                    <ul id="myTabs" class="nav nav-tabs nav-justified hidden-xs mt20" role="tablist">
                                        <li class="active">
                                            <a href="#info" role="tab" id="info-tab" data-toggle="tab">
                                                <h5>Info</h5>
                                            </a>
                                        </li>
                                        <li>
                                            <a href="#content" role="tab" id="content-tab" data-toggle="tab">
                                                <h5>Contents</h5>
                                            </a>
                                        </li>
                                        <li>
                                            <a href="#author" role="tab" id="author-tab" data-toggle="tab">
                                                <h5>Author</h5>
                                            </a>
                                        </li>
                                    </ul>
                
                                    <ul id="myTabsMobile" class="nav nav-pills text-center nav-stacked visible-xs mb60" role="tablist">
                                        <li class="active">
                                            <a href="#info" role="tab" id="info-tab-responsive" data-toggle="tab">
                                                Info
                                            </a>
                                        </li>
                                        <li>
                                            <a href="#content" role="tab" id="content-tab-responsive" data-toggle="tab">
                                                Contents
                                            </a>
                                        </li>
                                        <li>
                                            <a href="#author" role="tab" id="author-tab-responsive" data-toggle="tab">
                                                Author
                                            </a>
                                        </li>
                                    </ul>
                
                                    <div id="myTabContent" class="tab-content pt30">
                                    
                                        <div role="tabpanel" class="tab-pane active fade in" id="info">
                                            <div class="visible-xs">
                                                <h5 class="mobile-title">Features</h5>
                                            </div>
                                            <div class="hidden-xs">
                                                <h5>Features</h5>
                                            </div>
                                            <hr>
                                            <div>
                                                <ul>
                <li>Configure and manage Linux servers in varying scenarios and for a range of business requirements</li>
                <li>Explore the up-to-date features of CentOS using real-world scenarios</li>
                <li>See practical and extensive recipes to deploy and manage CentOS</li>
                </ul>
                                            </div>
                                            <br>
                                            <div class="visible-xs">
                                                <h5 class="mobile-title">Learning</h5>
                                            </div>
                                            <div class="hidden-xs">
                                                <h5>Learning</h5>
                                            </div>
                                            <hr>
                                            <div>
                                                <ul>
                <li>See how to deploy CentOS easily and painlessly, even in multi-server environments</li>
                <li>Configure various methods of remote access to the server so you donâ€™t always have to be in the data center</li>
                <li>Make changes to the default configuration of many services to harden them and increase the security of the system</li>
                <li>Learn to manage DNS, emails and web servers</li>
                <li>Protect yourself from threats by monitoring and logging network intrusion and system intrusion attempts, rootkits, and viruses</li>
                <li>Take advantage of todayâ€™s powerful hardware by running multiple systems using virtualization</li>
                </ul>
                                            </div>
                                            <br>
                                            <div class="visible-xs">
                                                <h5 class="mobile-title">About</h5>
                                            </div>
                                            <div class="hidden-xs">
                                                <h5>About</h5>
                                            </div>
                                            <hr>
                                            <div>
                                                <p>CentOS is derived from Red Hat Enterprise Linux (RHEL) sources and is widely used as a Linux server. This book will help you to better configure and manage Linux servers in varying scenarios and business requirements.</p>
                <p>Starting with installing CentOS, this book will walk you through the networking aspects of CentOS. You will then learn how to manage users and their permissions, software installs, disks, filesystems, and so on. Youâ€™ll then see how to secure connection to remotely access a desktop and work with databases. Toward the end, you will find out how to manage DNS, e-mails, web servers, and more. You will also learn to detect threats by monitoring network intrusion. Finally, the book will cover virtualization techniques that will help you make the most of CentOS.</p>
                                            </div>
                                        </div>
                                        
                                        <div role="tabpanel" class="tab-pane fade in" id="content">
                                            <div class="visible-xs">
                                                <h5 class="mobile-title">Contents</h5>
                                                <hr>
                                            </div>
                                            <ul>
                                                <div>
                                                    <li data-chapter="1">
                                                        <div class="section-name">1: Getting Started with CentOS</div>
                                                        <div class="panel-collapse" role="tabpanel">
                                                            <ul>
                                                                <li data-chapter="1" class="chapter-section">
                                                                    <a href="#ch01">        
                                                                        <div class="section-name">Chapter 1: Getting Started with CentOS</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="1" data-section-id="ch01lvl1sec8" class="chapter-section">
                                                                    <a href="#ch01lvl1sec8">                    
                                                                        <div class="section-name">Introduction</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="1" data-section-id="ch01lvl1sec9" class="chapter-section">
                                                                    <a href="#ch01lvl1sec9">                    
                                                                        <div class="section-name">Installing CentOS using Anaconda in graphics mode</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="1" data-section-id="ch01lvl1sec10" class="chapter-section">
                                                                    <a href="#ch01lvl1sec10">                    
                                                                        <div class="section-name">Installing CentOS using Anaconda in text mode</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="1" data-section-id="ch01lvl1sec11" class="chapter-section">
                                                                    <a href="#ch01lvl1sec11">                    
                                                                        <div class="section-name">Coordinating multiple installations using Kickstart</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="1" data-section-id="ch01lvl1sec12" class="chapter-section">
                                                                    <a href="#ch01lvl1sec12">                    
                                                                        <div class="section-name">Running a cloud image with Amazon Web Services&#x27; EC2</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="1" data-section-id="ch01lvl1sec13" class="chapter-section">
                                                                    <a href="#ch01lvl1sec13">                    
                                                                        <div class="section-name">Installing a container image from the Docker Registry</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="1" data-section-id="ch01lvl1sec14" class="chapter-section">
                                                                    <a href="#ch01lvl1sec14">                    
                                                                        <div class="section-name">Installing the GNOME desktop</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="1" data-section-id="ch01lvl1sec15" class="chapter-section">
                                                                    <a href="#ch01lvl1sec15">                    
                                                                        <div class="section-name">Installing the KDE Plasma desktop</div>
                                                                    </a>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                    </li>
                                                </div>
                                                <div>
                                                    <li data-chapter="2">
                                                        <div class="section-name">2: Networking</div>
                                                        <div class="panel-collapse" role="tabpanel">
                                                            <ul>
                                                                <li data-chapter="2" class="chapter-section">
                                                                    <a href="#ch02">        
                                                                        <div class="section-name">Chapter 2: Networking</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="2" data-section-id="ch02lvl1sec16" class="chapter-section">
                                                                    <a href="#ch02lvl1sec16">                    
                                                                        <div class="section-name">Introduction</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="2" data-section-id="ch02lvl1sec17" class="chapter-section">
                                                                    <a href="#ch02lvl1sec17">                    
                                                                        <div class="section-name">Setting a static IP address</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="2" data-section-id="ch02lvl1sec18" class="chapter-section">
                                                                    <a href="#ch02lvl1sec18">                    
                                                                        <div class="section-name">Binding multiple addresses to a single Ethernet device</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="2" data-section-id="ch02lvl1sec19" class="chapter-section">
                                                                    <a href="#ch02lvl1sec19">                    
                                                                        <div class="section-name">Bonding two Ethernet devices</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="2" data-section-id="ch02lvl1sec20" class="chapter-section">
                                                                    <a href="#ch02lvl1sec20">                    
                                                                        <div class="section-name">Configuring the network firewall with FirewallD</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="2" data-section-id="ch02lvl1sec21" class="chapter-section">
                                                                    <a href="#ch02lvl1sec21">                    
                                                                        <div class="section-name">Configuring the network firewall using iptables</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="2" data-section-id="ch02lvl1sec22" class="chapter-section">
                                                                    <a href="#ch02lvl1sec22">                    
                                                                        <div class="section-name">Installing a DHCP server</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="2" data-section-id="ch02lvl1sec23" class="chapter-section">
                                                                    <a href="#ch02lvl1sec23">                    
                                                                        <div class="section-name">Configuring an NFS server to share a filesystem</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="2" data-section-id="ch02lvl1sec24" class="chapter-section">
                                                                    <a href="#ch02lvl1sec24">                    
                                                                        <div class="section-name">Configuring an NFS client to use a shared filesystem</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="2" data-section-id="ch02lvl1sec25" class="chapter-section">
                                                                    <a href="#ch02lvl1sec25">                    
                                                                        <div class="section-name">Serving Windows shares with Samba</div>
                                                                    </a>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                    </li>
                                                </div>
                                                <div>
                                                    <li data-chapter="3">
                                                        <div class="section-name">3: User and Permission Management</div>
                                                        <div class="panel-collapse" role="tabpanel">
                                                            <ul>
                                                                <li data-chapter="3" class="chapter-section">
                                                                    <a href="#ch03">        
                                                                        <div class="section-name">Chapter 3: User and Permission Management</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="3" data-section-id="ch03lvl1sec26" class="chapter-section">
                                                                    <a href="#ch03lvl1sec26">                    
                                                                        <div class="section-name">Introduction</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="3" data-section-id="ch03lvl1sec27" class="chapter-section">
                                                                    <a href="#ch03lvl1sec27">                    
                                                                        <div class="section-name">Escalating privileges with sudo</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="3" data-section-id="ch03lvl1sec28" class="chapter-section">
                                                                    <a href="#ch03lvl1sec28">                    
                                                                        <div class="section-name">Enforcing password restrictions</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="3" data-section-id="ch03lvl1sec29" class="chapter-section">
                                                                    <a href="#ch03lvl1sec29">                    
                                                                        <div class="section-name">Setting default permissions for new files and directories</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="3" data-section-id="ch03lvl1sec30" class="chapter-section">
                                                                    <a href="#ch03lvl1sec30">                    
                                                                        <div class="section-name">Running binaries as a different user</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="3" data-section-id="ch03lvl1sec31" class="chapter-section">
                                                                    <a href="#ch03lvl1sec31">                    
                                                                        <div class="section-name">Working with SELinux for greater security</div>
                                                                    </a>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                    </li>
                                                </div>
                                                <div>
                                                    <li data-chapter="4">
                                                        <div class="section-name">4: Software Installation Management</div>
                                                        <div class="panel-collapse" role="tabpanel">
                                                            <ul>
                                                                <li data-chapter="4" class="chapter-section">
                                                                    <a href="#ch04">        
                                                                        <div class="section-name">Chapter 4: Software Installation Management</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="4" data-section-id="ch04lvl1sec32" class="chapter-section">
                                                                    <a href="#ch04lvl1sec32">                    
                                                                        <div class="section-name">Introduction</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="4" data-section-id="ch04lvl1sec33" class="chapter-section">
                                                                    <a href="#ch04lvl1sec33">                    
                                                                        <div class="section-name">Registering the EPEL and Remi repositories</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="4" data-section-id="ch04lvl1sec34" class="chapter-section">
                                                                    <a href="#ch04lvl1sec34">                    
                                                                        <div class="section-name">Prioritizing repositories using the Priorities plugin</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="4" data-section-id="ch04lvl1sec35" class="chapter-section">
                                                                    <a href="#ch04lvl1sec35">                    
                                                                        <div class="section-name">Automating software updates with yum-cron</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="4" data-section-id="ch04lvl1sec36" class="chapter-section">
                                                                    <a href="#ch04lvl1sec36">                    
                                                                        <div class="section-name">Verifying installed RPM packages</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="4" data-section-id="ch04lvl1sec37" class="chapter-section">
                                                                    <a href="#ch04lvl1sec37">                    
                                                                        <div class="section-name">Compiling a program from source</div>
                                                                    </a>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                    </li>
                                                </div>
                                                <div>
                                                    <li data-chapter="5">
                                                        <div class="section-name">5: Managing Filesystems and Storage</div>
                                                        <div class="panel-collapse" role="tabpanel">
                                                            <ul>
                                                                <li data-chapter="5" class="chapter-section">
                                                                    <a href="#ch05">        
                                                                        <div class="section-name">Chapter 5: Managing Filesystems and Storage</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="5" data-section-id="ch05lvl1sec38" class="chapter-section">
                                                                    <a href="#ch05lvl1sec38">                    
                                                                        <div class="section-name">Introduction</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="5" data-section-id="ch05lvl1sec39" class="chapter-section">
                                                                    <a href="#ch05lvl1sec39">                    
                                                                        <div class="section-name">Viewing the size of files and available storage</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="5" data-section-id="ch05lvl1sec40" class="chapter-section">
                                                                    <a href="#ch05lvl1sec40">                    
                                                                        <div class="section-name">Setting storage limits for users and groups</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="5" data-section-id="ch05lvl1sec41" class="chapter-section">
                                                                    <a href="#ch05lvl1sec41">                    
                                                                        <div class="section-name">Creating a RAM disk</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="5" data-section-id="ch05lvl1sec42" class="chapter-section">
                                                                    <a href="#ch05lvl1sec42">                    
                                                                        <div class="section-name">Creating a RAID</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="5" data-section-id="ch05lvl1sec43" class="chapter-section">
                                                                    <a href="#ch05lvl1sec43">                    
                                                                        <div class="section-name">Replacing a device in a RAID</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="5" data-section-id="ch05lvl1sec44" class="chapter-section">
                                                                    <a href="#ch05lvl1sec44">                    
                                                                        <div class="section-name">Creating a new LVM volume</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="5" data-section-id="ch05lvl1sec45" class="chapter-section">
                                                                    <a href="#ch05lvl1sec45">                    
                                                                        <div class="section-name">Removing an existing LVM volume</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="5" data-section-id="ch05lvl1sec46" class="chapter-section">
                                                                    <a href="#ch05lvl1sec46">                    
                                                                        <div class="section-name">Adding storage and growing an LVM volume</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="5" data-section-id="ch05lvl1sec47" class="chapter-section">
                                                                    <a href="#ch05lvl1sec47">                    
                                                                        <div class="section-name">Working with LVM snapshots</div>
                                                                    </a>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                    </li>
                                                </div>
                                                <div>
                                                    <li data-chapter="6">
                                                        <div class="section-name">6: Allowing Remote Access</div>
                                                        <div class="panel-collapse" role="tabpanel">
                                                            <ul>
                                                                <li data-chapter="6" class="chapter-section">
                                                                    <a href="#ch06">        
                                                                        <div class="section-name">Chapter 6: Allowing Remote Access</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="6" data-section-id="ch06lvl1sec48" class="chapter-section">
                                                                    <a href="#ch06lvl1sec48">                    
                                                                        <div class="section-name">Introduction</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="6" data-section-id="ch06lvl1sec49" class="chapter-section">
                                                                    <a href="#ch06lvl1sec49">                    
                                                                        <div class="section-name">Running commands remotely through SSH</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="6" data-section-id="ch06lvl1sec50" class="chapter-section">
                                                                    <a href="#ch06lvl1sec50">                    
                                                                        <div class="section-name">Configuring a more secure SSH login</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="6" data-section-id="ch06lvl1sec51" class="chapter-section">
                                                                    <a href="#ch06lvl1sec51">                    
                                                                        <div class="section-name">Securely connecting to SSH without a password</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="6" data-section-id="ch06lvl1sec52" class="chapter-section">
                                                                    <a href="#ch06lvl1sec52">                    
                                                                        <div class="section-name">Restricting SSH access by user or group</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="6" data-section-id="ch06lvl1sec53" class="chapter-section">
                                                                    <a href="#ch06lvl1sec53">                    
                                                                        <div class="section-name">Protecting SSH with Fail2ban</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="6" data-section-id="ch06lvl1sec54" class="chapter-section">
                                                                    <a href="#ch06lvl1sec54">                    
                                                                        <div class="section-name">Confining sessions to a chroot jail</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="6" data-section-id="ch06lvl1sec55" class="chapter-section">
                                                                    <a href="#ch06lvl1sec55">                    
                                                                        <div class="section-name">Configuring TigerVNC</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="6" data-section-id="ch06lvl1sec56" class="chapter-section">
                                                                    <a href="#ch06lvl1sec56">                    
                                                                        <div class="section-name">Tunneling VNC connections through SSH</div>
                                                                    </a>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                    </li>
                                                </div>
                                                <div>
                                                    <li data-chapter="7">
                                                        <div class="section-name">7: Working with Databases</div>
                                                        <div class="panel-collapse" role="tabpanel">
                                                            <ul>
                                                                <li data-chapter="7" class="chapter-section">
                                                                    <a href="#ch07">        
                                                                        <div class="section-name">Chapter 7: Working with Databases</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="7" data-section-id="ch07lvl1sec57" class="chapter-section">
                                                                    <a href="#ch07lvl1sec57">                    
                                                                        <div class="section-name">Introduction</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="7" data-section-id="ch07lvl1sec58" class="chapter-section">
                                                                    <a href="#ch07lvl1sec58">                    
                                                                        <div class="section-name">Setting up a MySQL database</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="7" data-section-id="ch07lvl1sec59" class="chapter-section">
                                                                    <a href="#ch07lvl1sec59">                    
                                                                        <div class="section-name">Backing up and restoring a MySQL database</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="7" data-section-id="ch07lvl1sec60" class="chapter-section">
                                                                    <a href="#ch07lvl1sec60">                    
                                                                        <div class="section-name">Configuring MySQL replication</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="7" data-section-id="ch07lvl1sec61" class="chapter-section">
                                                                    <a href="#ch07lvl1sec61">                    
                                                                        <div class="section-name">Standing up a MySQL cluster</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="7" data-section-id="ch07lvl1sec62" class="chapter-section">
                                                                    <a href="#ch07lvl1sec62">                    
                                                                        <div class="section-name">Setting up a MongoDB database</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="7" data-section-id="ch07lvl1sec63" class="chapter-section">
                                                                    <a href="#ch07lvl1sec63">                    
                                                                        <div class="section-name">Backing up and restoring a MongoDB database</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="7" data-section-id="ch07lvl1sec64" class="chapter-section">
                                                                    <a href="#ch07lvl1sec64">                    
                                                                        <div class="section-name">Configuring a MongoDB replica set</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="7" data-section-id="ch07lvl1sec65" class="chapter-section">
                                                                    <a href="#ch07lvl1sec65">                    
                                                                        <div class="section-name">Setting up an OpenLDAP directory</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="7" data-section-id="ch07lvl1sec66" class="chapter-section">
                                                                    <a href="#ch07lvl1sec66">                    
                                                                        <div class="section-name">Backing up and restoring an OpenLDAP database</div>
                                                                    </a>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                    </li>
                                                </div>
                                                <div>
                                                    <li data-chapter="8">
                                                        <div class="section-name">8: Managing Domains and DNS</div>
                                                        <div class="panel-collapse" role="tabpanel">
                                                            <ul>
                                                                <li data-chapter="8" class="chapter-section">
                                                                    <a href="#ch08">        
                                                                        <div class="section-name">Chapter 8: Managing Domains and DNS</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="8" data-section-id="ch08lvl1sec67" class="chapter-section">
                                                                    <a href="#ch08lvl1sec67">                    
                                                                        <div class="section-name">Introduction</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="8" data-section-id="ch08lvl1sec68" class="chapter-section">
                                                                    <a href="#ch08lvl1sec68">                    
                                                                        <div class="section-name">Setting up BIND as a resolving DNS server</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="8" data-section-id="ch08lvl1sec69" class="chapter-section">
                                                                    <a href="#ch08lvl1sec69">                    
                                                                        <div class="section-name">Configuring BIND as an authoritative DNS server</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="8" data-section-id="ch08lvl1sec70" class="chapter-section">
                                                                    <a href="#ch08lvl1sec70">                    
                                                                        <div class="section-name">Writing a reverse lookup zone file</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="8" data-section-id="ch08lvl1sec71" class="chapter-section">
                                                                    <a href="#ch08lvl1sec71">                    
                                                                        <div class="section-name">Setting up a slave DNS server</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="8" data-section-id="ch08lvl1sec72" class="chapter-section">
                                                                    <a href="#ch08lvl1sec72">                    
                                                                        <div class="section-name">Configuring rndc to control BIND</div>
                                                                    </a>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                    </li>
                                                </div>
                                                <div>
                                                    <li data-chapter="9">
                                                        <div class="section-name">9: Managing E-mails</div>
                                                        <div class="panel-collapse" role="tabpanel">
                                                            <ul>
                                                                <li data-chapter="9" class="chapter-section">
                                                                    <a href="#ch09">        
                                                                        <div class="section-name">Chapter 9: Managing E-mails</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="9" data-section-id="ch09lvl1sec73" class="chapter-section">
                                                                    <a href="#ch09lvl1sec73">                    
                                                                        <div class="section-name">Introduction</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="9" data-section-id="ch09lvl1sec74" class="chapter-section">
                                                                    <a href="#ch09lvl1sec74">                    
                                                                        <div class="section-name">Configuring Postfix to provide SMTP services</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="9" data-section-id="ch09lvl1sec75" class="chapter-section">
                                                                    <a href="#ch09lvl1sec75">                    
                                                                        <div class="section-name">Adding SASL to Postfix with Dovecot</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="9" data-section-id="ch09lvl1sec76" class="chapter-section">
                                                                    <a href="#ch09lvl1sec76">                    
                                                                        <div class="section-name">Configuring Postfix to use TLS</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="9" data-section-id="ch09lvl1sec77" class="chapter-section">
                                                                    <a href="#ch09lvl1sec77">                    
                                                                        <div class="section-name">Configuring Dovecot for secure POP3 and IMAP access</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="9" data-section-id="ch09lvl1sec78" class="chapter-section">
                                                                    <a href="#ch09lvl1sec78">                    
                                                                        <div class="section-name">Targeting spam with SpamAssassin</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="9" data-section-id="ch09lvl1sec79" class="chapter-section">
                                                                    <a href="#ch09lvl1sec79">                    
                                                                        <div class="section-name">Routing messages with Procmail</div>
                                                                    </a>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                    </li>
                                                </div>
                                                <div>
                                                    <li data-chapter="10">
                                                        <div class="section-name">10: Managing Web Servers</div>
                                                        <div class="panel-collapse" role="tabpanel">
                                                            <ul>
                                                                <li data-chapter="10" class="chapter-section">
                                                                    <a href="#ch10">        
                                                                        <div class="section-name">Chapter 10: Managing Web Servers</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="10" data-section-id="ch10lvl1sec80" class="chapter-section">
                                                                    <a href="#ch10lvl1sec80">                    
                                                                        <div class="section-name">Introduction</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="10" data-section-id="ch10lvl1sec81" class="chapter-section">
                                                                    <a href="#ch10lvl1sec81">                    
                                                                        <div class="section-name">Installing Apache HTTP Server and PHP</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="10" data-section-id="ch10lvl1sec82" class="chapter-section">
                                                                    <a href="#ch10lvl1sec82">                    
                                                                        <div class="section-name">Configuring name-based virtual hosting</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="10" data-section-id="ch10lvl1sec83" class="chapter-section">
                                                                    <a href="#ch10lvl1sec83">                    
                                                                        <div class="section-name">Configuring Apache to serve pages over HTTPS</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="10" data-section-id="ch10lvl1sec84" class="chapter-section">
                                                                    <a href="#ch10lvl1sec84">                    
                                                                        <div class="section-name">Enabling overrides and performing URL rewriting</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="10" data-section-id="ch10lvl1sec85" class="chapter-section">
                                                                    <a href="#ch10lvl1sec85">                    
                                                                        <div class="section-name">Installing NGINX as a load balancer</div>
                                                                    </a>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                    </li>
                                                </div>
                                                <div>
                                                    <li data-chapter="11">
                                                        <div class="section-name">11: Safeguarding Against Threats</div>
                                                        <div class="panel-collapse" role="tabpanel">
                                                            <ul>
                                                                <li data-chapter="11" class="chapter-section">
                                                                    <a href="#ch11">        
                                                                        <div class="section-name">Chapter 11: Safeguarding Against Threats</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="11" data-section-id="ch11lvl1sec86" class="chapter-section">
                                                                    <a href="#ch11lvl1sec86">                    
                                                                        <div class="section-name">Introduction</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="11" data-section-id="ch11lvl1sec87" class="chapter-section">
                                                                    <a href="#ch11lvl1sec87">                    
                                                                        <div class="section-name">Sending messages to Syslog</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="11" data-section-id="ch11lvl1sec88" class="chapter-section">
                                                                    <a href="#ch11lvl1sec88">                    
                                                                        <div class="section-name">Rotating log files with logrotate</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="11" data-section-id="ch11lvl1sec89" class="chapter-section">
                                                                    <a href="#ch11lvl1sec89">                    
                                                                        <div class="section-name">Using Tripwire to detect modified files</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="11" data-section-id="ch11lvl1sec90" class="chapter-section">
                                                                    <a href="#ch11lvl1sec90">                    
                                                                        <div class="section-name">Using ClamAV to fight viruses</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="11" data-section-id="ch11lvl1sec91" class="chapter-section">
                                                                    <a href="#ch11lvl1sec91">                    
                                                                        <div class="section-name">Checking for rootkits with chkrootkit</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="11" data-section-id="ch11lvl1sec92" class="chapter-section">
                                                                    <a href="#ch11lvl1sec92">                    
                                                                        <div class="section-name">Using Bacula for network backups</div>
                                                                    </a>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                    </li>
                                                </div>
                                                <div>
                                                    <li data-chapter="12">
                                                        <div class="section-name">12: Virtualization</div>
                                                        <div class="panel-collapse" role="tabpanel">
                                                            <ul>
                                                                <li data-chapter="12" class="chapter-section">
                                                                    <a href="#ch12">        
                                                                        <div class="section-name">Chapter 12: Virtualization</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="12" data-section-id="ch12lvl1sec93" class="chapter-section">
                                                                    <a href="#ch12lvl1sec93">                    
                                                                        <div class="section-name">Introduction</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="12" data-section-id="ch12lvl1sec94" class="chapter-section">
                                                                    <a href="#ch12lvl1sec94">                    
                                                                        <div class="section-name">Creating a new virtual machine</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="12" data-section-id="ch12lvl1sec95" class="chapter-section">
                                                                    <a href="#ch12lvl1sec95">                    
                                                                        <div class="section-name">Cloning a virtual machine</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="12" data-section-id="ch12lvl1sec96" class="chapter-section">
                                                                    <a href="#ch12lvl1sec96">                    
                                                                        <div class="section-name">Adding storage to a virtual machine</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="12" data-section-id="ch12lvl1sec97" class="chapter-section">
                                                                    <a href="#ch12lvl1sec97">                    
                                                                        <div class="section-name">Connecting USB peripherals to a guest system</div>
                                                                    </a>
                                                                </li>
                                                                <li data-chapter="12" data-section-id="ch12lvl1sec98" class="chapter-section">
                                                                    <a href="#ch12lvl1sec98">                    
                                                                        <div class="section-name">Configuring a guest&#x27;s network interface</div>
                                                                    </a>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                    </li>
                                                </div>
                                            </ul>
                                        </div>
                                        
                                        <div role="tabpanel" class="tab-pane fade" id="author">
                                            <div class="visible-xs">
                                                <h4 class="mobile-title">About the Author</h4>
                                                <hr>
                                            </div>
                                            <p><strong>Timothy Boronczyk</strong></p>
                                            <div>
                                                <p><span id="author_bio_c" class="sugar_field">Timothy Boronczyk is a native of Syracuse, New York, where he works as a lead developer at Optanix, Inc. (formerly ShoreGroup, Inc.). He's been involved with web technologies since 1998, has a degree in Software Application Programming, and is a Zend Certified Engineer. In what little spare time he has left, Timothy enjoys hanging out with friends, studying Esperanto, and sleeping with his feet off the end of the bed. He's easily distracted by shiny objects.</span></p>
                                            </div>
                                        </div>
                                        
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="next-wrapper">
                        <div class="row ns">
                            <hr />
                            <span class="hidden-xs">
                                <h4 class="pull-left">
                                    <strong>Up Next: </strong><span class="section-title"></span>
                                </h4>
                                <a href="#" class="btn btn-primary pull-right btn-lg">
                                    Next Section
                                </a>
                            </span>
                            <span class="visible-xs">
                                <a href="#" class="btn btn-primary btn-block btn-lg">
                                    Next Section
                                </a>
                            </span>
                        </div>
                        <div class="row ns">
                            <hr>
                        </div>
                    </div>
                </div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="chapter" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="ch01"></a>ChapterÂ 1.Â Getting Started with CentOS</h2></div></div></div><p>This chapter contains the following recipes:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Installing CentOS using Anaconda in graphics mode</p></li><li style="list-style-type: disc"><p>Installing CentOS using Anaconda in text mode</p></li><li style="list-style-type: disc"><p>Coordinating multiple installations using Kickstart</p></li><li style="list-style-type: disc"><p>Running a cloud image with Amazon Web Services' EC2</p></li><li style="list-style-type: disc"><p>Installing a container image from the Docker Registry</p></li><li style="list-style-type: disc"><p>Installing the GNOME desktop</p></li><li style="list-style-type: disc"><p>Installing the KDE Plasma desktop</p></li></ul></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch01lvl1sec8"></a>Introduction</h2></div></div><hr /></div><p>This chapter's recipes focus on getting up and running with CentOS using a variety of installation methods. You'll learn how to perform interactive graphical and text-based installations using Anaconda and perform an unattended installation using Kickstart. You'll also see how to run CentOS in the cloud with Amazon Web Services and in a Docker container image. Most of the recipes in this book take place at the command prompt, but some require a graphical desktop, so we'll finish up with a look at installing the GNOME and KDE Plasma desktops.</p></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch01lvl1sec9"></a>Installing CentOS using Anaconda in graphics mode</h2></div></div><hr /></div><p>In this recipe, you'll learn how to install CentOS using the graphical installer Anaconda. This is the most common way that CentOS is installed, although there are other ways too (some of which are discussed in later recipes). This approach is also the easiest installation method, especially for setting up single-server deployments.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec9"></a>Getting ready</h3></div></div></div><p>This recipe assumes that you have a copy of the CentOS 7 installation medium. If you don't, visit <a class="ulink" href="https://www.centos.org" target="_blank">https://www.centos.org</a> and download a minimal ISO image. You'll also need to make a physical disc from the image. Instructions for burning the ISO image to disc can be found at <a class="ulink" href="https://www.centos.org/docs/5/html/CD_burning_howto.html" target="_blank">https://www.centos.org/docs/5/html/CD_burning_howto.html</a>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip3"></a>Note</h3><p>If your system doesn't have an optical drive and its BIOS supports booting from a USB device, you can also write the ISO image to a USB stick.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec10"></a>How to do it...</h3></div></div></div><p>Follow these steps to install CentOS using the graphical installer Anaconda:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Insert the installation disc into your system's optical drive (or USB stick into a USB port) and reboot. The system should boot to the CentOS 7 installation menu:</p><div class="mediaobject"><img src="graphics/image_01_001.jpg" /><div class="caption"><p>The installer is launched from the installation menu</p></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note4"></a>Note</h3><p>If your system doesn't boot to the installation menu then the drive may not be configured as a boot device. The exact steps to verify and adjust the configuration vary between BIOS vendors, but in general you'll press <span class="emphasis"><em>Esc, F1, F2,</em></span> or <span class="emphasis"><em>Delete</em></span> while the system is booting to gain access to the BIOS settings. Then you'll find the list of boot devices and change the order in which each is searched for a boot record.</p></div></li><li><p>Using the arrow keys, make sure that the <span class="strong"><strong>Install CentOS 7</strong></span> option is highlighted and press <span class="emphasis"><em>Enter.</em></span></p></li><li><p>The <span class="strong"><strong>WELCOME TO CENTOS 7</strong></span> screen confirms which language to use during the installation process. Select your desired language and click on <span class="strong"><strong>Continue</strong></span>:</p><div class="mediaobject"><img src="graphics/image_01_002.jpg" /><div class="caption"><p>You can change the language used during the installation process</p></div></div></li><li><p>The next screen is a menu that organizes the installation options by category. We'll configure networking firstâ€”click on <span class="strong"><strong>NETWORK &amp; HOST NAME</strong></span> under the <span class="strong"><strong>SYSTEM</strong></span> category:</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note5"></a>Note</h3><p>If your system doesn't have a mouse, you can navigate using <span class="emphasis"><em>Tab</em></span> to cycle through the input fields, use the arrow keys to select the entry, and press <span class="emphasis"><em>Enter</em></span> to select or activate an input.</p></div><div class="mediaobject"><img src="graphics/B00509_01_03.jpg" /><div class="caption"><p>The installation summary screen organizes the installation options into categories</p></div></div></li><li><p>Enter the system's hostname in the <span class="strong"><strong>Host name</strong></span> field. Then, select the system's primary network interface and toggle the switch at the right to <span class="strong"><strong>ON</strong></span> to enable it. Click on the <span class="strong"><strong>Done</strong></span> button when you're finished to return to the <span class="strong"><strong>INSTALLATION SUMMARY</strong></span> menu:</p><div class="mediaobject"><img src="graphics/image_01_004.jpg" /><div class="caption"><p>The NETWORK &amp; HOST NAMEÂ screen lets us configure the system's network interfaces</p></div></div></li><li><p>Click on <span class="strong"><strong>DATE &amp; TIME</strong></span> under the <span class="strong"><strong>LOCALIZATION</strong></span> category.</p></li><li><p>Set your time zone by either selecting your region and city or by clicking on your location on the map. Then, click on <span class="strong"><strong>Done</strong></span> to return to the <span class="strong"><strong>INSTALLATION SUMMARY</strong></span> menu:</p><div class="mediaobject"><img src="graphics/image_01_005.jpg" /><div class="caption"><p>The DATE &amp; TIME screen lets us configure the system's time zone</p></div></div></li><li><p>If you know what purpose the system will serve on your network and require something more than a minimal installation, click on <span class="strong"><strong>SOFTWARE SELECTION</strong></span> under the <span class="strong"><strong>SOFTWARE</strong></span> category. Select the environment and any additional add-ons to install the desired packages. When you're finished, click on <span class="strong"><strong>Done:</strong></span></p><div class="mediaobject"><img src="graphics/image_01_006.jpg" /><div class="caption"><p>The SOFTWARE SELECTION screen lets us install purpose-based software</p></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note6"></a>Note</h3><p>Software can easily be installed using <code class="literal">yum</code>, so don't worry if you need to install additional software after you already have CentOS up and running. The <span class="strong"><strong>SOFTWARE SELECTION</strong></span> section is purely for convenience.</p></div></li><li><p>Click on <span class="strong"><strong>INSTALLATION DESTINATION</strong></span> under the <span class="strong"><strong>SYSTEM</strong></span> category.</p></li><li><p>Click on the appropriate drive in the <span class="strong"><strong>Local Standard Disks</strong></span> area to set the installation target. If the drive is not bootable, or if multiple drives are selected, click on the <span class="strong"><strong>Full disk summary and boot loader...</strong></span> link at the bottom of the screen to open the <span class="strong"><strong>Selected Disks</strong></span> window. Then, select the drive you want to be the boot device, click on the <span class="strong"><strong>Set as Boot Device</strong></span> button, and click on <span class="strong"><strong>Close</strong></span>. When you're finished, click on <span class="strong"><strong>Done:</strong></span></p><div class="mediaobject"><img src="graphics/image_01_007.jpg" /><div class="caption"><p>The INSTALLATION DESTINATION screen lets us set the disk where CentOS will be installed</p></div></div></li><li><p>Click on the <span class="strong"><strong>Begin Installation</strong></span> button to start the installation process.</p></li><li><p>Click on <span class="strong"><strong>Root Password</strong></span>. In the input fields, enter and confirm the password you want to use for the system's root account. Click on <span class="strong"><strong>Done</strong></span> when you've finished entering these details:</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note7"></a>Note</h3><p>You'll need to press the Done button twice to return to the configuration screen if you specify a password that's too weak. If you need help to create a strong password, visit <a class="ulink" href="http://www.howtogeek.com/195430/how-to-create-a-strong-password-and-remember-it/" target="_blank">http://www.howtogeek.com/195430/how-to-create-a-strong-password-and-remember-it/</a>.</p></div><div class="mediaobject"><img src="graphics/B00509_01_08.jpg" /><div class="caption"><p>The ROOT PASSWORD screen lets us set the root account's password</p></div></div></li><li><p>Click on <span class="strong"><strong>User Creation</strong></span>. In the input fields, provide your name, username, and desired password. Again, press <span class="strong"><strong>Done</strong></span> when you've finished entering these details:</p><div class="mediaobject"><img src="graphics/image_01_009.jpg" /><div class="caption"><p>The CREATE USERÂ screen lets us create an unprivileged user account</p></div></div></li><li><p>When the installation is complete, click on the <span class="strong"><strong>Finish Configuration</strong></span> button. Anaconda will finalize the system's configuration and the button's label will change to <span class="strong"><strong>Reboot</strong></span>.</p></li><li><p>Remove the CentOS installation media from the drive and reboot your system.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec11"></a>How it works...</h3></div></div></div><p>After installing CentOS using Anaconda in graphical mode, you should now have a basic CentOS 7 system up and running. The process began when we booted the system from the installation disc and selected <span class="strong"><strong>Install CentOS 7</strong></span> from the installation menu. The installer's kernel loaded into memory and Anaconda launched in graphical mode.</p><p>The <span class="strong"><strong>NETWORK &amp; HOST NAME</strong></span> screen shows a list of the available network interfaces and basic information about them, for instance, the card's MAC address and transfer rate. By default, the interfaces are configured to use DHCP to obtain their IP address when they are enabled. (Configuring a static IP address is discussed in a later recipe.)</p><p>The system's time zone is set on the <span class="strong"><strong>LOCALIZATION</strong></span> screen. The date and time fields are disabled when NTP is enabled because the values will be set by the NTP service. The system clock's time can drift for many reasons, especially if the system is running on a virtual machine, so allowing NTP to manage the system's time is a good idea to ensure it stays correct. If the date and time fields aren't set by NTP, make sure the <span class="strong"><strong>Network Time</strong></span> toggle is set <span class="strong"><strong>ON</strong></span>. You can specify an NTP server by clicking on the button with the gears icon.</p><p>The <span class="strong"><strong>INSTALLATION DESTINATION</strong></span> screen lets us set the installation target for CentOS and specify how the system's drives are partitioned. You can choose to configure the partitions if you have special requirements, but in this recipe I let Anaconda partition the drives automatically.</p><p>While Anaconda is busy installing CentOS and any additional software packages you may have requested, it shows us the <span class="strong"><strong>Configuration</strong></span> screen. This screen gives us the opportunity to set a password for the system's administrative account (<code class="literal">root</code>) and create an unprivileged user account. You should only sign in with <code class="literal">root</code> when necessary; for your normal day-to-day work you should use your unprivileged account. Anaconda finalizes the installation by configuring the system's boot record and creating the user account.</p><p>After the system reboots, the Grub boot loader prompt appears and the arrow keys can be used to select a boot configuration. There's also a timer,Â so pressing nothing will eventually boot the system using the default configuration.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec12"></a>See also</h3></div></div></div><p>For more information on installing CentOS 7, refer to the RHEL 7Â Installation Guide (<a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Installation_Guide/" target="_blank">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Installation_Guide</a>).</p></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch01lvl1sec10"></a>Installing CentOS using Anaconda in text mode</h2></div></div><hr /></div><p>Next, you'll learn how to install CentOS using Anaconda in text mode. It's recommended that you install CentOS graphically because graphics mode is easier to use and offers more functionality. However, it may not be available when the system lacks sufficient resources to run the installer in graphical mode, for example, if the display adaptor's capabilities are limited or if there is reduced RAM.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec13"></a>Getting ready</h3></div></div></div><p>This recipe assumes that you have a copy of the CentOS 7 installation medium. If you don't, visit <a class="ulink" href="https://www.centos.org" target="_blank">https://www.centos.org</a> to download an ISO image and then burn the image to a disc.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec14"></a>How to do it...</h3></div></div></div><p>Follow these steps to perform a text-based installation of CentOS:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Insert the installation disc into your system's optical drive (or USB stick into a USB port) and reboot. The system should boot to the CentOS 7 installation menu.</p></li><li><p>Using the arrow keys, make sure the <span class="strong"><strong>Install CentOS 7</strong></span> option is highlighted and press <span class="emphasis"><em>
<span class="strong"><strong>Tab</strong></span>.</em></span> The command to boot the installer kernel appears at the bottom of the screen.</p></li><li><p>Add the word <code class="literal">text</code> to the end of the list of arguments and press <span class="emphasis"><em>
<span class="strong"><strong>Enter</strong></span>.</em></span> Anaconda will launch in text mode:</p><pre class="programlisting">       vmzlinuz initrd=initrd.img inst.stage2=hd:LABEL=CentOS
       \x207\x20x86_64 rd.live.check quiet text
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note8"></a>Note</h3><p>Anaconda will launch in text mode automatically if your system has less than 768 MB of RAM.</p></div></li><li><p>The <span class="strong"><strong>Installation</strong></span> menu presents the installation options by category. Type <span class="strong"><strong>2</strong></span> and press <span class="emphasis"><em>Enter</em></span> to select <span class="strong"><strong>Timezone settings</strong></span>:</p><div class="mediaobject"><img src="graphics/image_01_010.jpg" /><div class="caption"><p>The text-based installation menu categorizes the installation options</p></div></div></li><li><p>The <span class="strong"><strong>Timezone settings</strong></span> menu presents a list of regions. Enter the number for the desired value.</p></li><li><p>You will be given a list of available time zones in the selected region (paginate through the list by pressing <span class="emphasis"><em>Enter</em></span> if the list is long). Enter the number for the desired time zone.</p></li><li><p>If you know what purpose the system will serve and require something more than a minimal installation, enter <span class="strong"><strong>3</strong></span> to select <span class="strong"><strong>Software selection</strong></span>. Here you can select groups of software packages for that purpose. When finished, enter <span class="emphasis"><em>c</em></span> to continue back to the <span class="strong"><strong>Installation</strong></span> menu.</p></li><li><p>Enter <span class="strong"><strong>5</strong></span> to select <span class="strong"><strong>Network settings</strong></span>.</p></li><li><p>Enter <span class="strong"><strong>1</strong></span> to set the system's hostname. Type the desired name and press <span class="emphasis"><em>Enter.</em></span></p></li><li><p>Enter the number to configure the system's primary network interface. Then, enter <span class="strong"><strong>7</strong></span> to mark <span class="strong"><strong>Connect automatically after reboot</strong></span> and <span class="strong"><strong>8</strong></span> to mark <span class="strong"><strong>Apply configuration in installer</strong></span>. Enter <span class="emphasis"><em>c</em></span> to go back to the <span class="strong"><strong>Network settings</strong></span> menu and <span class="emphasis"><em>c</em></span> again to return to the <span class="strong"><strong>Installation</strong></span> menu:</p><div class="mediaobject"><img src="graphics/image_01_011.jpg" /><div class="caption"><p>The Network settings menu lets us configure the system's network interfaces</p></div></div></li><li><p>Enter <span class="strong"><strong>6</strong></span> to select <span class="strong"><strong>Install Destination</strong></span>.</p></li><li><p>If the desired drive is not already marked, enter the number for the drive. Then, enter <span class="emphasis"><em>c</em></span> to continue. The <span class="strong"><strong>Autopartioning Options</strong></span> menu is shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/image_01_012.jpg" /><div class="caption"><p>The Install Destination menu let us set the installation target and the Autopartioning Options menu lets us specify how the disk will be used</p></div></div></li><li><p>Enter the number for the desired partitioning (<span class="strong"><strong>Use All Space</strong></span> is the default) and then <span class="strong"><strong>c</strong></span> to continue.</p></li><li><p>Select the desired partition scheme (<span class="strong"><strong>LVM</strong></span> is the default) and then enter <span class="emphasis"><em>c</em></span> to return to the <span class="strong"><strong>Installation</strong></span> menu.</p></li><li><p>Enter <span class="strong"><strong>8</strong></span> to select <span class="strong"><strong>Create user</strong></span>.</p></li><li><p>Enter <span class="strong"><strong>1</strong></span> to mark the <span class="strong"><strong>Create user</strong></span> option. Provide your name and set a username for the account by entering <span class="strong"><strong>2</strong></span> and <span class="strong"><strong>3</strong></span> respectively. Enter <span class="strong"><strong>4</strong></span> to mark the <span class="strong"><strong>Use password</strong></span> option and then <span class="strong"><strong>5</strong></span> to set your password. Then, enter <span class="emphasis"><em>c</em></span> to return to the <span class="strong"><strong>Installation</strong></span> menu:</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note9"></a>Note</h3><p>You must confirm you really want to use your password if you provide a password that is too weak.</p></div><div class="mediaobject"><img src="graphics/image_01_013.jpg" /><div class="caption"><p>The Create User menu let us create an unprivileged user account</p></div></div></li><li><p>Enter <span class="strong"><strong>9</strong></span> to select <span class="strong"><strong>Set root password</strong></span>. Enter and confirm the password you want to use for the system's root account.</p></li><li><p>After all of the sections that required attention have been resolved, enter <span class="emphasis"><em>b</em></span> to begin the installation process.</p></li><li><p>When the installation is complete, remove the media from the drive and reboot the system.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec15"></a>How it works...</h3></div></div></div><p>This recipe showed you how to install CentOS using Anaconda running in text mode. The process began when we booted the system from the installation disc, selected <span class="strong"><strong>Install CentOS 7</strong></span> from the installation menu, and added the <code class="literal">text</code> option to the boot parameters. The installer's kernel loaded into memory and Anaconda launched in text mode.</p><p>The text-based installation is similar to installing CentOS in graphical mode, answering prompts for time zone, software, and networking information. However, Anaconda presents the prompts in a different order when running in text mode and some functionality is missing. For example, we can't perform custom disk partitioning. Nevertheless, text mode enables us to quickly install a basic CentOS system.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec16"></a>See also</h3></div></div></div><p>For more information on installing CentOS 7, refer to the RHEL 7Â Installation Guide (<a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Installation_Guide" target="_blank">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Installation_Guide</a>).</p></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch01lvl1sec11"></a>Coordinating multiple installations using Kickstart</h2></div></div><hr /></div><p>If you're planning on installing CentOS on multiple servers, it's more convenient to automate as much of the process as possible. In this recipe, you'll learn how to use Anaconda's <code class="literal">kickstart.cfg</code> file to perform an unattended network-based installation.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec17"></a>Getting ready</h3></div></div></div><p>This recipe requires at least two systems on your network: an existing system running an HTTP server to host the installation files and Kickstart configuration (the recipe <span class="emphasis"><em>Installing Apache HTTP Server and PHP</em></span> in <a class="link" href="#" linkend="ch10">Chapter 10</a>, <span class="emphasis"><em>Managing Web Servers</em></span>, shows you how to install Apache) and the target system on which we'll install CentOS. You'll also need the installation media and administrative privileges.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec18"></a>How to do it...</h3></div></div></div><p>Follow these steps to perform unattended network installations using the Kickstart method:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Log in to the system running the HTTP server using the root account.</p></li><li><p>Place the installation disc in the system's optical drive.</p></li><li><p>Mount the disc using the <code class="literal">mount</code> command so that its contents are accessible:</p><pre class="programlisting">
<span class="strong"><strong>mount /dev/cdrom /media</strong></span>
</pre></li><li><p>Create a new directory under Apache's web root to host the installation files:</p><pre class="programlisting">
<span class="strong"><strong>mkdir -p /var/www/html/centos/7/x86_64</strong></span>
</pre></li><li><p>Copy the contents of the installation disc to the new directory:</p><pre class="programlisting">
<span class="strong"><strong>cp -r /media/* /var/www/html/centos/7/x86_64</strong></span>
</pre></li><li><p>Copy the <code class="literal">kickstart.cfg</code> file created by Anaconda when the system was installed to Apache's web root:</p><pre class="programlisting">
<span class="strong"><strong>cp /root/kickstart.cfg /var/www/html/kickstart.cfg</strong></span>
</pre></li><li><p>Unmount and remove the installation disc:</p><pre class="programlisting">
<span class="strong"><strong>umount /media</strong></span>
<span class="strong"><strong>eject /dev/cdrom</strong></span>
</pre></li><li><p>Insert the disc into the target system's drive and reboot it. The system should boot to the CentOS 7 installation menu.</p></li><li><p>Highlight the <span class="strong"><strong>Install CentOS 7</strong></span> option and press <span class="emphasis"><em>Tab.</em></span></p></li><li><p>Update the arguments used to boot the installer kernel to read as follows. Change the IP address as necessary to point to the system hosting the Kickstart file:</p><pre class="programlisting">       vmlinuz initrd=initrd.img ks=http://192.168.56.100/kickstart.cfg
</pre></li><li><p>Press <span class="emphasis"><em>Enter</em></span> to begin the installation process.</p></li><li><p>Once the installation process begins, you can eject the disc and begin the next system's installation. Repeat steps 8-11 for each additional system.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec19"></a>How it works...</h3></div></div></div><p>Anaconda writes the configuration values we provide when performing a graphical or text-based installation to <code class="literal">kickstart.cfg</code>. If you plan on installing CentOS on multiple servers, it's more convenient to use the file to provide the interface's answers. The remaining installations can be performed mostly unattended and the systems' configurations will be more consistent.</p><p>This recipe showed you how to make the <code class="literal">kickstart.cfg</code> file and the CentOS installation files available to other systems over the network, and update the boot command to tell Anaconda where to look for the installation files and prompt responses. Since the software packages are retrieved from the installation server instead of the disc, you can eject the disc as soon as the installation process is underway and use it to begin the next process on your next system.</p><p>Of course, <code class="literal">kickstart.cfg</code> can be used as a starting point, and you can edit the responses using a text editor to further customize the installations. If you like, you can create multiple kickstart files in the web root, each with a different configuration. Just specify the desired file when you set the installer's boot arguments.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip10"></a>Note</h3><p>Although you can edit your kickstart files with a basic text editor, dedicated programs exist for editing them as well. Check out Kickstart Configurator (<a class="ulink" href="http://landoflinux.com/linux_kickstart_configurator.html" target="_blank">http://landoflinux.com/linux_kickstart_configurator.html</a>).</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec20"></a>See also</h3></div></div></div><p>For more information on coordinating multiple installations of CentOS 7, refer to the following resources:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>RHEL 7Â Installation Guide (<a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Installation_Guide" target="_blank">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Installation_Guide</a>)</p></li><li style="list-style-type: disc"><p>Anaconda documentation (<a class="ulink" href="http://rhinstaller.github.io/anaconda/index.html" target="_blank">http://rhinstaller.github.io/anaconda/index.html</a>)</p></li><li style="list-style-type: disc"><p>Install PXE Server on CentOS 7 (<a class="ulink" href="http://www.unixmen.com/install-pxe-server-centos-7" target="_blank">http://www.unixmen.com/install-pxe-server-centos-7</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch01lvl1sec12"></a>Running a cloud image with Amazon Web Services' EC2</h2></div></div><hr /></div><p>Amazon Web Services (AWS) is a suite of services hosted within Amazon's network infrastructure which allows companies and individuals take advantage of their computing/storage capacity and world wide data centers. Elastic Cloud Compute (EC2) is a virtualization platform that lets us set up virtual systems on demand, usually to host websites and web apps. This recipe will walk you through the process of setting up a new virtual server running CentOS on the AWS platform.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec21"></a>Getting ready</h3></div></div></div><p>This recipe assumes that you have an AWS account. You can sign up for one at <a class="ulink" href="http://aws.amazon.com" target="_blank">http://aws.amazon.com</a>. You will need to provide a valid credit card, although you will have access to Amazon's free tier for 12 months.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec22"></a>How to do it...</h3></div></div></div><p>To set up a newÂ Amazon Machine Instance (AMI) on AWS's EC2 platform, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Log in at <a class="ulink" href="https://aws.amazon.com" target="_blank">https://aws.amazon.com</a> and go to the AWS Management console. Under the <span class="strong"><strong>Compute</strong></span> category, click on the EC2 link to access the EC2 management page. Then, click on the <span class="strong"><strong>Launch Instance</strong></span> button:</p><div class="mediaobject"><img src="graphics/image_01_014.jpg" /><div class="caption"><p>The EC2 Management Console presents an overview and quick access to resources</p></div></div></li><li><p>On the <span class="strong"><strong>Choose an Amazon Machine Image (AMI)</strong></span> page, select <span class="strong"><strong>Community AMIs</strong></span> in the side menu and then check the <span class="strong"><strong>CentOS</strong></span> filter. A list of instances created by the community will be shown. Select the one you desire:</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note11"></a>Note</h3><p>Review the list of available images carefully. Many are available, created using different versions of CentOS and with various configurations.</p></div><div class="mediaobject"><img src="graphics/image_01_015.jpg" /><div class="caption"><p>The image selection page presents a filterable list of machine images created by community users</p></div></div></li><li><p>On the <span class="strong"><strong>Review Instance Launch</strong></span> page, review your instance's resources (the number of virtual CPUs, available memory, and so on) and click on the <span class="strong"><strong>Launch</strong></span> button:</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note12"></a>Note</h3><p>Amazon guides you through selecting an AMI and configuring it in a wizard-like fashion, listing the steps at the top of the page. The <span class="strong"><strong>Review</strong></span> and <span class="strong"><strong>Launch</strong></span> buttons jump directly to the last step. You can use the links at the top of the page to go back to an earlier step and adjust the instance's configuration.</p></div><div class="mediaobject"><img src="graphics/image_01_016.jpg" /><div class="caption"><p>Review your instance's resources on the <span class="strong"><strong>Review Instance Launch</strong></span> page</p></div></div></li><li><p>Using the drop-down list, select <span class="strong"><strong>Create a new key pair</strong></span>, enter a suitable filename for the key, and click on the <span class="strong"><strong>Download Key Pair</strong></span> button. After you save the downloaded private encryption key, click on the <span class="strong"><strong>Launch Instances</strong></span> button:</p><div class="mediaobject"><img src="graphics/image_01_017.jpg" /><div class="caption"><p>You're prompted to create a pair of encryption keys the first time you launch the image</p></div></div></li><li><p>On the launch status page, click on the <span class="strong"><strong>View Instances</strong></span> button at the bottom of the page. Then, right-click on the running instance and select <span class="strong"><strong>Connect</strong></span> from the context menu. Select the preferred connection method and follow the instructions that appear on the screen.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec23"></a>How it works...</h3></div></div></div><p>This recipe walked you through the steps necessary to spin up a new CentOS AMI on AWS's EC2 platform. To log in to the system, a password or set of encryption keys is needed, and since the primary user account's password is likely to be unknown, we opted to generate a new pair of keys. The private key is downloaded and then used with your SSH client to authenticate your login.</p><p>Once you have logged in to your running system, it's worth viewing the contents of the <code class="literal">/etc/system-release</code> file to verify the running version of CentOS. Also, you should use the <code class="literal">passwd</code> command to change the root account's password if the account isn't already locked down. This is an important security precaution because you don't know who knows the default password. You'll find recipes for managing user permissions in <a class="link" href="#" linkend="ch03">Chapter 3</a>, <span class="emphasis"><em>User and Permission Management,</em></span> and recipes for managing remote access in <a class="link" href="#" linkend="ch06">Chapter 6</a>, <span class="emphasis"><em>Allowing Remote Access:</em></span></p><div class="mediaobject"><img src="graphics/image_01_018.jpg" /><div class="caption"><p>After you log in, verify the system's version number and update the root password</p></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec24"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on working with AMIs on Amazon's EC2 platform:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>What Is Amazon EC2? (<a class="ulink" href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/concepts.html" target="_blank">http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/concepts.html</a>)</p></li><li style="list-style-type: disc"><p>Connect to Your Linux Instance (<a class="ulink" href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AccessingInstances.html" target="_blank">http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AccessingInstances.html</a>)</p></li><li style="list-style-type: disc"><p>Remove SSH Host Key Pairs (<a class="ulink" href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/building-shared-amis.html#remove-ssh-host-key-pairs" target="_blank">http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/building-shared-amis.html#remove-ssh-host-key-pairs</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch01lvl1sec13"></a>Installing a container image from the Docker Registry</h2></div></div><hr /></div><p>This recipe shows you how to procure a CentOS base for your development needs using Docker, a virtualization strategy based on the concept of containers. Each container wraps the target software in its own filesystem so that it can run regardless of the operating system on which it's installed. Developers like Docker especially because it helps provide consistency between development and deployment environments.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec25"></a>Getting ready</h3></div></div></div><p>The recipe assumes that you have a system with Docker installed. If you don't, you can obtain the Docker installer from <a class="ulink" href="http://www.docker.com" target="_blank">http://www.docker.com</a>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec26"></a>How to do it...</h3></div></div></div><p>Follow these steps to install a CentOS container image from the Docker Registry:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Open the Docker Toolbox terminal program.</p></li><li><p>At the terminal's prompt, invoke the <code class="literal">docker pull</code> command to retrieve a CentOS 7 container:</p><pre class="programlisting">
<span class="strong"><strong>docker pull centos:7</strong></span>
</pre></li><li><p>After the container has been downloaded, you can launch an interactive shell with <code class="literal">docker run</code>:</p><pre class="programlisting">
<span class="strong"><strong>docker run -i -t centos:7 /bin/bash</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec27"></a>How it works...</h3></div></div></div><p>This recipe retrieves the official CentOS container from the Docker Registry using the <code class="literal">docker pull</code> command. By providing the version tag (<code class="literal">:7</code>), we can make sure we retrieved CentOS 7 as opposed to an earlier (or perhaps newer) version.</p><p>Alternatively, Kitematic is the graphical program which lets us search for and retrieve containers from the registry. Simply launch Kitematic and enter CentOS as the search term in the search box. Then, look for the official CentOS repository in the results list.</p><p>The default version retrieved by Kitematic is the latest. To specifically select CentOS 7 or a maintenanceÂ release, click on the entry's ellipsis button. Set the desired tag and then click on the <span class="strong"><strong>Create</strong></span> button:</p><div class="mediaobject"><img src="graphics/image_01_019.jpg" /><div class="caption"><p>Kitematic displays the results of searching for CentOS</p></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec28"></a>See also</h3></div></div></div><p>Refer to the following resources for more information about working with Docker:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Docker home page (<a class="ulink" href="http://www.docker.com" target="_blank">http://www.docker.com</a>)</p></li><li style="list-style-type: disc"><p>Understanding the Docker architecture (<a class="ulink" href="https://docs.docker.com/engine/understanding-docker" target="_blank">https://docs.docker.com/engine/understanding-docker</a>)</p></li><li style="list-style-type: disc"><p>The official CentOS Docker hub (<a class="ulink" href="https://hub.docker.com/_/centos" target="_blank">https://hub.docker.com/_/centos</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch01lvl1sec14"></a>Installing the GNOME desktop</h2></div></div><hr /></div><p>This recipe shows you how to install the GNOME desktop environment, which provides a graphical user interface (GUI) for working with your CentOS system. Usually, such environments aren't installed on server systems, but it can be convenient sometimes to have one available. For example, an administrator might feel more comfortable updating a system's configuration using graphical programs.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note13"></a>Note</h3><p>GNOME isn't the only GUI environment available â€”other popular environments include KDE, XFCE, and Fluxbox. If GNOME isn't your cup of tea, the next recipe shows you how to install KDE.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec29"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection. Administrative privileges are also required by logging in with the <code class="literal">root</code> account.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec30"></a>How to do it...</h3></div></div></div><p>Follow these steps to install the GNOME desktop environment:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Install the <code class="literal">GNOME Desktop</code> package group with <code class="literal">yum groupinstall</code>:</p><pre class="programlisting">
<span class="strong"><strong>yum groupinstall "GNOME Desktop"</strong></span>
</pre></li><li><p>Manually start the desktop environment using <code class="literal">startx</code>:</p><pre class="programlisting">
<span class="strong"><strong>startx</strong></span>
</pre></li><li><p>If more than one environment is installed, you'll need to specify the path to <code class="literal">gnome-session</code>:</p><pre class="programlisting">
<span class="strong"><strong>startx /usr/bin/gnome-session</strong></span>
</pre></li><li><p>When you're done using GNOME and log out of the desktop, you'll be returned to the console.</p></li><li><p>To configure the system to automatically start the graphical environment when it boots, set the default start up target to <code class="literal">graphical.target</code>:</p><pre class="programlisting">
<span class="strong"><strong>systemctl set-default graphical.target</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec31"></a>How it works...</h3></div></div></div><p>This recipe uses <code class="literal">yum</code> to install the GNOME desktop environment. All of the necessary components and dependencies are installed by the <code class="literal">GNOME Desktop</code> package group. Package groups saves us time and hassle because they let us install a collection of packages for a common task at the same time instead of individual packages one at a time.</p><pre class="programlisting">
<span class="strong"><strong>yum groupinstall "GNOME Desktop"</strong></span>
</pre><p>Unlike Windows, where the graphical desktop is part of its operating system, Linux systems delegate basic graphics and input handling to a graphics server. This approach is one reason why there are several desktop environments to choose from â€”it abstracts many of the specifics and provides a common platform on top of which any number of environments can run, both locally and across a network. CentOS's default graphics server is X Window System.</p><p>If GNOME is the only desktop environment installed, it'll be run by default when we launch X with <code class="literal">startx</code>. However, if more than one desktop is installed, we need to tell X which one we want to run. For GNOME, we provide the path to <code class="literal">gnome-session</code>:</p><pre class="programlisting">
<span class="strong"><strong>startx /usr/bin/gnome-session</strong></span>
</pre><div class="mediaobject"><img src="graphics/image_01_020.jpg" /><div class="caption"><p>The GNOME desktop provides a graphical interface for working with the system</p></div></div><p>The systemd service manager is responsible for starting various servers and processes when the system boots. The <code class="literal">systemctl</code> command is our interface to the service manager and can be used to set the default boot target. The default target dictates whether the system boots to a terminal or GUI-based login screen:</p><pre class="programlisting">
<span class="strong"><strong>systemctl set-default graphical.target</strong></span>
</pre><p>When set to graphical, systemd starts X and the GNOME Display Manager when the system boots, which presents us with a graphical login to provide our account details. Once we're authenticated, the desktop session is initiated and we find ourselves at the GNOME desktop.</p><p>If you no longer want to boot to the graphical environment, you can set the default target back to multiuser and the system will boot to the terminal-based login screen again:</p><pre class="programlisting">
<span class="strong"><strong>systemctl set-default multi-user.target</strong></span>
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip14"></a>Note</h3><p>You can choose which desktop environment you want to use if more than one environment is installed by selecting it from the gear button on the login screen:</p><div class="mediaobject"><img src="graphics/image_01_021.jpg" /><div class="caption"><p>You can select your preferred desktop from the login screen</p></div></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec32"></a>See also</h3></div></div></div><p>The following resources will provide you with more information about installing graphical desktop environments and using the GNOME desktop:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>GNOME Library (<a class="ulink" href="https://help.gnome.org" target="_blank">https://help.gnome.org</a>)</p></li><li style="list-style-type: disc"><p>RHEL 7 Desktop Migration and Administration Guide (<a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Desktop_Migration_and_Administration_Guide" target="_blank">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Desktop_Migration_and_Administration_Guide</a>)</p></li><li style="list-style-type: disc"><p><span class="emphasis"><em>Guild to X11/Starting Sessions</em></span> (<a class="ulink" href="https://en.wikibooks.org/wiki/Guide_to_X11/Starting_Sessions" target="_blank">https://en.wikibooks.org/wiki/Guide_to_X11/Starting_Sessions</a>)</p></li><li style="list-style-type: disc"><p>How to install desktop environments on CentOS 7 (<a class="ulink" href="http://unix.stackexchange.com/questions/181503/how-to-install-desktop-environments-on-centos-7/181504#181504" target="_blank">http://unix.stackexchange.com/questions/181503/how-to-install-desktop-environments-on-centos-7/181504#181504</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch01lvl1sec15"></a>Installing the KDE Plasma desktop</h2></div></div><hr /></div><p>Separating the graphical interface from the operating system gives users the power to choose the graphical environment they like best. Don't worry if you're not a GNOME fan because there are still many other desktops you can explore! This recipe shows you how to install another popular desktop environment, KDE Plasma Workspaces.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec33"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection. Administrative privileges are also required by logging in with the root account.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec34"></a>How to do it...</h3></div></div></div><p>Follow these steps to install the KDE Plasma Workspaces desktop environment:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Install the <code class="literal">KDE Plasma Workspaces</code> package group:</p><pre class="programlisting">
<span class="strong"><strong>yum groupinstall "KDE Plasma Workspaces"</strong></span>
</pre></li><li><p>Manually start the desktop environment using <code class="literal">startkde</code>. When you're done using KDE and log out of the desktop, you'll be returned to the console:</p><pre class="programlisting">
<span class="strong"><strong>startkde</strong></span>
</pre></li><li><p>To configure the system to automatically start the graphical environment when it boots, use <code class="literal">systemctl</code> to set the default start up target to <code class="literal">graphical.target</code>:</p><pre class="programlisting">
<span class="strong"><strong>systemctl set-default graphical.target</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec35"></a>How it works...</h3></div></div></div><p>This recipe installs the KDE Plasma Workspaces desktop environment via Yum's package groups. All of the necessary software components and dependencies to run KDE are installed by the <code class="literal">KDE Plasma Workspaces</code> package group:</p><pre class="programlisting">
<span class="strong"><strong>yum groupinstall "KDE Plasma Workspaces"</strong></span>
</pre><p>The <code class="literal">startkde</code> script starts the X server and launches the KDE environment together. Unlike with GNOME, we're not invoking <code class="literal">startx</code> directly, so we don't need to provide additional paths when more than one environment is installed:</p><pre class="programlisting">
<span class="strong"><strong>startkde</strong></span>
</pre><div class="mediaobject"><img src="graphics/image_01_022.jpg" /><div class="caption"><p>KDE Plasma Workspaces is a Â popular graphical desktop environment for Linux-based systems</p></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl2sec36"></a>See also</h3></div></div></div><p>The following resources will provide you with more information about installing and using KDE Plasma Workspaces:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>How to install desktop environments on CentOS 7 (<a class="ulink" href="http://unix.stackexchange.com/questions/181503/how-to-install-desktop-environments-on-centos-7/181504#181504" target="_blank">http://unix.stackexchange.com/questions/181503/how-to-install-desktop-environments-on-centos-7/181504#181504</a>)</p></li><li style="list-style-type: disc"><p>KDE documentation (<a class="ulink" href="https://docs.kde.org" target="_blank">https://docs.kde.org</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="chapter" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="ch02"></a>ChapterÂ 2.Â Networking</h2></div></div></div><p>This chapter contains the following recipes:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Setting a static IP address</p></li><li style="list-style-type: disc"><p>Binding multiple addresses to a single Ethernet device</p></li><li style="list-style-type: disc"><p>Bonding two Ethernet devices</p></li><li style="list-style-type: disc"><p>Configuring the network firewall with FirewallD</p></li><li style="list-style-type: disc"><p>Configuring the network firewall using iptables</p></li><li style="list-style-type: disc"><p>Installing a DHCP server</p></li><li style="list-style-type: disc"><p>Configuring an NFS server to share a filesystem</p></li><li style="list-style-type: disc"><p>Configuring an NFS client to use a shared filesystem</p></li><li style="list-style-type: disc"><p>Serving Windows shares with Samba</p></li></ul></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch02lvl1sec16"></a>Introduction</h2></div></div><hr /></div><p>The recipes in this chapter cover various networking tasks that should prove useful to you as a CentOS administrator. You'll learn how to configure a static IP address, bind multiple addresses to a single Ethernet device, and bond two devices together. You'll also see how to configure the system's firewall using FirewallD and iptables, and how to set up a DHCP server to distribute IP addresses, which allows other computers using dynamic networking configurations to access the network. The remaining recipes will teach you how to set up centralized file storage using NFS and Samba.</p></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch02lvl1sec17"></a>Setting a static IP address</h2></div></div><hr /></div><p>This recipe shows you how to configure a static IP address. Unless you configured a static address during installation, CentOS uses the Dynamic Host Configuration Protocol (DHCP) to obtain an IP address to communicate across the network. Using a dynamically assigned address is fine for most desktop and laptop systems, but those that host e-mail servers, file sharing and print services, and web servers should have an address that doesn't change. The static address provides a stable, known location on the network where users can access a system's services.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec37"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection and administrative privileges provided by logging in with the <code class="literal">root</code> account. It assumes that your primary Ethernet device is named <code class="literal">enp0s3</code> and is currently configured with DHCP. If your device is named differently, substitute its name appropriately in the following commands.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec38"></a>How to do it...</h3></div></div></div><p>Follow these steps to configure a static IP address:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Open the Ethernet device's configuration file, found under <code class="literal">/etc/ sysconfig/network-scripts</code>,with your text editor:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/sysconfig/network-scripts/ifcfg-enp0s3</strong></span>
</pre></li><li><p>Change the value of <code class="literal">BOOTPROTO</code> to none:</p><pre class="programlisting">
<span class="strong"><strong>BOOTPROTO="none"</strong></span>
</pre></li><li><p>At the end of the file, add the <code class="literal">IPADDR</code>, <code class="literal">NETMASK</code>, and <code class="literal">BROADCAST</code> entries to set the desired IP address. Assign them values that properly reflect your network:</p><pre class="programlisting">
<span class="strong"><strong>IPADDR="192.168.56.100"</strong></span>
<span class="strong"><strong>NETMASK="255.255.255.0"</strong></span>
<span class="strong"><strong>BROADCAST="192.168.56.255"</strong></span>
</pre><div class="mediaobject"><img src="graphics/image_02_001.jpg" /><div class="caption"><p>The interface is configured with a static IP address</p></div></div></li><li><p>Save your changes and close the file.</p></li><li><p>Open the <code class="literal">/etc/sysconfig/network</code> file using your editor:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/sysconfig/network</strong></span>
</pre></li><li><p>Add a <code class="literal">GATEWAY</code> entry to identify your network's gateway:</p><pre class="programlisting">
<span class="strong"><strong>GATEWAY="192.168.56.1"</strong></span>
</pre></li><li><p>Save your changes and close the file.</p></li><li><p>Restart the networking service for the configuration changes to take effect:</p><pre class="programlisting">
<span class="strong"><strong>systemctl restart network.service</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec39"></a>How it works...</h3></div></div></div><p>In this recipe, you learned how to assign a static IP address to an Ethernet device. It assumed the name of your primary Ethernet device to be <code class="literal">enp0s3</code>, thus <code class="literal">ifcfg-enp0s3</code> would be the name of the device's configuration file. If your device is named differently (for example, <code class="literal">eth0</code>, <code class="literal">eno1677</code>, and so on) then you need to adjust the recipe's directions accordingly.</p><p>First, we changed the value for <code class="literal">BOOTPROTO</code> from <code class="literal">dhcp</code>, the protocol used to obtain an IP address dynamically, to <code class="literal">none</code> since we are setting the address ourselves. Then we added the <code class="literal">IPADDR</code>, <code class="literal">NETMASK</code>, and <code class="literal">BROADCAST</code> entries to provide the details of the static IP address. Next, we specified the network's default gateway using <code class="literal">GATEWAY</code> in <code class="literal">/etc/ sysconfig/network</code>. This allows us to route traffic beyond the local subnetwork.</p><p>After you restart the networking service, you can confirm the new address using the <code class="literal">ip</code> command. <code class="literal">ip addr show</code> will display information about the current state of your system's network devices:</p><div class="mediaobject"><img src="graphics/image_02_002.jpg" /><div class="caption"><p>ip addr show displays your system's networking information</p></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec40"></a>See also</h3></div></div></div><p>For more information on configuring network settings in CentOS, refer to the <span class="emphasis"><em>Configure IP Networking</em></span> chapter in the RHEL 7 Networking Guide (<a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Networking_Guide/ch-Configure_IP_Networking.html" target="_blank">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Networking_Guide/ch-Configure_IP_Networking.html</a>).</p></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch02lvl1sec18"></a>Binding multiple addresses to a single Ethernet device</h2></div></div><hr /></div><p>This recipe shows you how to bind multiple IP addresses to a single Ethernet device. The ability to assign more than one address to the same device can be useful-the most obvious benefit is that you don't need to procure multiple Ethernet cards. The cost of hardware has dropped substantially, but IT budgets still run tight. Perhaps a less obvious benefit, but one more valuable, is the greater flexibility it gives when configuring network services. Different services, such as e-mail and websites, can run on the same system but be accessed using different addresses.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec41"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection. It assumes that your primary Ethernet device is <code class="literal">enp0s3</code> and is configured with a static IP address. You'll also need administrative privileges provided by logging in with the <code class="literal">root</code> account.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec42"></a>How to do it...</h3></div></div></div><p>Follow these steps to bind multiple addresses to the same Ethernet device:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Make a copy of the device's configuration file:</p><pre class="programlisting">
<span class="strong"><strong>cp /etc/sysconfig/network-scripts/ifcfg-enp0s3
       /etc/sysconfig/network-scripts/ifcfg-enp0s3:1</strong></span>
</pre></li><li><p>Open the new file with your text editor:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/sysconfig/network-scripts/ifcfg-enp0s3:1</strong></span>
</pre></li><li><p>Delete the <code class="literal">UUID</code> entry entirely. If a <code class="literal">HWADDR</code> entry exists, delete that also.</p></li><li><p>Update the <code class="literal">NAME</code> and <code class="literal">DEVICE</code> values:</p><pre class="programlisting">
<span class="strong"><strong>NAME="System enp0s3:1"</strong></span>
<span class="strong"><strong>DEVICE="enp0s3:1"</strong></span>
</pre></li><li><p>Change the value of <code class="literal">IPADDR</code> to the IP address you wish to use:</p><pre class="programlisting">
<span class="strong"><strong>IPADDR="192.168.56.101"</strong></span>
</pre></li><li><p>Save your changes and close the file.</p></li><li><p>Restart the networking service for the configuration changes to take effect:</p><pre class="programlisting">
<span class="strong"><strong>systemctl restart network.service</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec43"></a>How it works...</h3></div></div></div><p>In this recipe, you learned how to assign multiple IP addresses to the same Ethernet device. We made a copy of one of the original network configuration files, taking care to name it appropriately to create a virtual adapter, and edited its configuration details. Since the name of the first device's configuration is <code class="literal">ifcfg-enp0s3</code>, the new file is named <code class="literal">ifcfg-enp0s3:1</code> to create the first virtual adapter associated with that device. If you want to add more adapters (assign more IP addresses), repeat the steps using incrementing numbers, for example, <code class="literal">enp0s3:2</code>, <code class="literal">enp0s3:3</code>, and so on.</p><p>In the configuration file, we removed the <code class="literal">HWADDR</code> and <code class="literal">UUID</code> entries since they are not needed for a virtual adapter. Then we updated the <code class="literal">DEVICE</code> and <code class="literal">NAME</code> entries to give the adapter its own identify, and, of course, we updated the <code class="literal">IPADDR</code> entry to assign its IP address:</p><div class="mediaobject"><img src="graphics/image_02_003.jpg" /><div class="caption"><p>Multiple IP addresses are bound to an Ethernet device via a virtual adapter</p></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec44"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on binding multiple addresses to the same Ethernet device:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Create Multiple IP Addresses to One Single Network Interface (<a class="ulink" href="http://www.tecmint.com/create-multiple-ip-addresses-to-one-single-network-interface" target="_blank">http://www.tecmint.com/create-multiple-ip-addresses-to-one-single-network-interface</a>)</p></li><li style="list-style-type: disc"><p>Assign Multiple IP Addresses To Single Network Interface Card On CentOS 7 (<a class="ulink" href="http://www.unixmen.com/linux-basics-assign-multiple-ip-addresses-single-network-interface-card-centos-7" target="_blank">http://www.unixmen.com/linux-basics-assign-multiple-ip-addresses-single-network-interface-card-centos-7</a>)</p></li><li style="list-style-type: disc"><p>Adding Secondary IP Addresses (<a class="ulink" href="https://dbiers.me/adding-secondary-ip-addresses-centosrhel/" target="_blank">https://dbiers.me/adding-secondary-ip-addresses-centosrhel/</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch02lvl1sec19"></a>Bonding two Ethernet devices</h2></div></div><hr /></div><p>In this recipe, you'll learn how to combine multiple Ethernet devices as a single network device in a configuration known as channel bonding. Channel bonding allows us to bind multiple devices together so that they appear as a single interface to servers running on the CentOS system. Its purpose is to improve your system's overall network performance and provide redundancy if one of the network devices fails.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec45"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with at least two Ethernet devices. It assumes that your primary Ethernet device is <code class="literal">enp0s3</code>. If your device is named differently, substitute the name appropriately in the recipe's commands. You'll also need administrative privileges provided by logging in with the <code class="literal">root</code> account.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec46"></a>How to do it...</h3></div></div></div><p>Follow these steps to bond two Ethernet devices:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Install the <code class="literal">bind-utils</code> and <code class="literal">ethtool</code> packages:</p><pre class="programlisting">
<span class="strong"><strong>yum install bind-utils ethtool</strong></span>
</pre></li><li><p>Create a new configuration file for the bonded interface:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/sysconfig/network-scripts/ifcfg-bond0</strong></span>
</pre></li><li><p>Add the following lines to the file, substituting values for <code class="literal">IPADDR</code>, <code class="literal">NETMASK</code>, and <code class="literal">BROADCAST</code> that are appropriate for your network:</p><pre class="programlisting">
<span class="strong"><strong>BOOTPROTO="none"</strong></span>
<span class="strong"><strong>DEVICE="bond0"</strong></span>
<span class="strong"><strong>USERCTL="no"</strong></span>
<span class="strong"><strong>ONBOOT="yes"</strong></span>
<span class="strong"><strong>IPADDR="192.168.56.100"</strong></span>
<span class="strong"><strong>NETMASK="255.255.255.0"</strong></span>
<span class="strong"><strong>BROADCAST="192.168.56.255"</strong></span>
</pre></li><li><p>Save your changes and close the configuration file.</p></li><li><p>Open the configuration file of the first device you wish to bond:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/sysconfig/network-scripts/ifcfg-enp0s3</strong></span>
</pre></li><li><p>Make sure <code class="literal">BOOTPROTO</code> is set to <code class="literal">none</code> and <code class="literal">ONBOOT</code> is set to <code class="literal">yes</code>. Then remove the <code class="literal">IPADDR</code>, <code class="literal">NETMASK</code>, and <code class="literal">BROADCAST</code> entries if they exist.</p></li><li><p>Add the <code class="literal">SLAVE</code> and <code class="literal">MASTER</code> entries at the end of the file:</p><pre class="programlisting">
<span class="strong"><strong>SLAVE=yes</strong></span>
<span class="strong"><strong>MASTER=bond0</strong></span>
</pre></li><li><p>Save your changes and close the configuration file.</p></li><li><p>Repeat steps 5-8 for each additional device you want to bond.</p></li><li><p>Create the configuration file used by the kernel to control how the bonding interface should behave:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/modprobe.d/bonding.conf</strong></span>
</pre></li><li><p>Add the following lines to the file:</p><pre class="programlisting">
<span class="strong"><strong>alias bond0 bonding</strong></span>
<span class="strong"><strong>options bond0 mode=5 miimon=100</strong></span>
</pre></li><li><p>Save your changes and close the file.</p></li><li><p>Register the bonding module with the system's kernel:</p><pre class="programlisting">
<span class="strong"><strong>modprobe bonding</strong></span>
</pre></li><li><p>Restart networking services for the changes to take effect:</p><pre class="programlisting">
<span class="strong"><strong>systemctl restart network.service</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec47"></a>How it works...</h3></div></div></div><p>We began by creating a configuration file for the bonding interface at <code class="literal">/etc/sysconfig/ network-scripts/ifcfg-bond0</code>. <code class="literal">BOOTPROTO</code> was set to <code class="literal">none</code> because the IP address is set statically, <code class="literal">DEVICE</code> gives a name to the interface, <code class="literal">USERCTL</code> was set to <code class="literal">no</code> to prohibit nonadministrative users from bringing the interface up and down, and <code class="literal">ONBOOT</code> was set to <code class="literal">yes</code> so that the interface will be automatically activated. We also gave the IP address information with <code class="literal">IPADDR</code>, <code class="literal">NETMASK</code>, and <code class="literal">BROADCAST</code>:</p><pre class="programlisting">
<span class="strong"><strong>BOOTPROTO="none"</strong></span>
<span class="strong"><strong>DEVICE="bond0"</strong></span>
<span class="strong"><strong>USERCTL="no"</strong></span>
<span class="strong"><strong>ONBOOT="yes"</strong></span>
<span class="strong"><strong>IPADDR="192.168.56.100"</strong></span>
<span class="strong"><strong>NETMASK="255.255.255.0"</strong></span>
<span class="strong"><strong>BROADCAST="192.168.56.255"</strong></span>
</pre><p>Then we updated the configuration files for each device we want to bond. We made sure <code class="literal">BOOTPROTO</code> was set to <code class="literal">none</code> and there was no address information since the device will no longer need its own IP address. Adding the <code class="literal">SLAVE</code> and <code class="literal">MASTER</code> entries, we identified the device as being bound to the new <code class="literal">bond0</code> device:</p><pre class="programlisting">
<span class="strong"><strong>SLAVE=yes</strong></span>
<span class="strong"><strong>MASTER=bond0</strong></span>
</pre><p>By performing these steps, we have created a new virtual device known as the bonding master that will use our real Ethernet devices as slaves. If one slave device fails, the other slave will still be active, providing redundancy.</p><p>Next, we created a new configuration file with our preferences for the kernel bonding module. The module is the kernel implementation of the bonding device and is responsible for coordinating the physical devices:</p><pre class="programlisting">
<span class="strong"><strong>alias bond0 bonding</strong></span>
<span class="strong"><strong>options bond0 miimon=100 mode=5</strong></span>
</pre><p><code class="literal">miimon=100</code> specifies that MII link monitoring will occur every <code class="literal">100</code> milliseconds to verify that the physical devices are active. <code class="literal">mode=5</code> represents a basic configuration that doesn't require any specific type of network switch support. It allows outgoing traffic to be distributed according to the current load on each slave device. There are five other modes which give you plenty of options in configuring how the devices work together, although you should be aware that some modes may require specific hardware support. Refer to <a class="ulink" href="http://wiki.centos.org/TipsAndTricks/BondingInterfaces" target="_blank">http://wiki.centos.org/TipsAndTricks/BondingInterfaces</a> for more information.</p><p>After making changes to the device's configuration files, we registered the bonding kernel module using <code class="literal">modprobe</code>:</p><pre class="programlisting">
<span class="strong"><strong>modprobe bonding</strong></span>
</pre><div class="mediaobject"><img src="graphics/image_02_004.jpg" /><div class="caption"><p>Two Ethernet devices are bound with the same IP addresses through the bonding adapter</p></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec48"></a>See also</h3></div></div></div><p>For more information on bonding Ethernet devices CentOS, refer to the <span class="emphasis"><em>Configure Network Bonding</em></span> chapter in the RHEL 7 Networking Guide (<a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Networking_Guide/ch-Configure_Network_Bonding.html" target="_blank">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Networking_Guide/ch-Configure_Network_Bonding.html</a>).</p></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch02lvl1sec20"></a>Configuring the network firewall with FirewallD</h2></div></div><hr /></div><p>Now you'll learn how to configure the networking firewall using FirewallD. Starting with CentOS 7, FirewallD replaces iptables as the default firewall configuration utility (although iptables is still used behind the scenes by FirewallD). Based on which zones and services you configure, you can increase the network security of your server by controlling what traffic is allowed or disallowed to and from the system.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec49"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection. You'll also need administrative privileges provided by logging in with the <code class="literal">root</code> account.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec50"></a>How to do it...</h3></div></div></div><p>This collection of commands will show you how to perform several basic configuration tasks using FirewallD's command-line client, <code class="literal">firewall-cmd</code>:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>To identify the currently active zones and which Ethernet devices are assigned to them, use the <code class="literal">--get-active-zones</code> flag:</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --get-active-zones</strong></span>
</pre></li><li><p>To temporarily change which zone a device is assigned to, use the <code class="literal">--zone</code> argument to specify the target zone and <code class="literal">--change-interface</code> to specify the Ethernet device:</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --change-interface=enp0s3</strong></span>
</pre></li><li><p>To permanently assign a device to a zone, add a <code class="literal">ZONE</code> entry to the device's configuration file. This change will not take effect until the service has been restarted:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/sysconfig/network-scripts/ifcfg-enp0s3</strong></span>
<span class="strong"><strong>ZONE="public"</strong></span>
</pre></li><li><p>To identify the current configuration for a zone, use the <code class="literal">--zone</code> argument to specify the target zone and include <code class="literal">--list-all</code>:</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --list-all</strong></span>
</pre></li><li><p>To allow traffic through the firewall, use the <code class="literal">--add-service</code> or <code class="literal">--add-port</code> arguments:</p><p>Traffic for common services and protocols such as HTTP and SMTP can be allowed by name. The following adds the <code class="literal">http</code> service which opens port <code class="literal">80</code> (the port used by Apache and other HTTP servers):</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --add-service=http</strong></span>
</pre><p>Traffic can always be allowed directly given the port and network protocol. The following opens port 8080 to TCP traffic, another port commonly used to serve web content:</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --add-port=8080/tcp</strong></span>
</pre></li><li><p>To disallow traffic that isÂ currently allowed through the firewall, use the <code class="literal">--remove-service</code> or <code class="literal">--remove-port</code> arguments:</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --remove-service=http</strong></span>
<span class="strong"><strong>firewall-cmd --zone=public --permanent --remove- port=8080/tcp</strong></span>
</pre></li><li><p>To reload the firewall after making a change, use <code class="literal">--reload Â </code>:</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --reload</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec51"></a>How it works...</h3></div></div></div><p>The default installation of FirewallD makes several preconfigured zones available, for example, <code class="literal">public</code>, <code class="literal">dmz</code>, <code class="literal">work</code>, <code class="literal">home</code>, and <code class="literal">trusted</code>. Different interfaces can be assigned to different zones and have different rules applied. To see all of the available zones and their configuration, we can invoke <code class="literal">firewall-cmd</code> with the <code class="literal">--list-all-zones</code> flag:</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --list-all-zones</strong></span>
</pre><p>Most updates made to the firewall rules will take effect immediately but are temporary. We saw this earlier when we had to update the device's configuration file and restart the service to make a zone change permanent. This lets us experiment with different settings before finalizing the configuration. When configuring services and ports, the <code class="literal">--permanent</code> flag is used to make the changes permanent. If you don't provide the flag, the changes will take effect immediately but will only be temporary (not persist across a system reboot or restart of the firewall service):</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --remove-service=http</strong></span>
</pre><p>Named services are preconfigured port settings that are common to a specific network service and are available for our convenience. For example, SSH traffic commonly consists of TCP packets destined for port 22, so the <code class="literal">ssh</code> service reflects this. In the examples, we used the <code class="literal">http</code> service, which configured port 80, the standard port used to serve web pages. While assigning the port directly has the same effect, services provide convenient, human-readable names and should be used when possible. To get a list of all available services, use <code class="literal">--get-services</code>:</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --get-services</strong></span>
</pre><div class="mediaobject"><img src="graphics/image_02_005.jpg" /><div class="caption"><p>firewall-cmd is a command-line client for configuring firewall rules</p></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note15"></a>Note</h3><p>Named services are defined as XML files under <code class="literal">/usr/lib/firewalld/services</code>. If you want to allow access for some traffic but a service isn't defined, and you would prefer to perform the configuration using a service instead of the port and protocol for the sake of readability, you can create a new service file in this directory. Copy an existing file as your starting point and modify it to suit your needs.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec52"></a>See also</h3></div></div></div><p>For more information on working with FirewallD, refer to the following resources:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>RHEL 7 Migration Planning Guide: Security and Access Control (<a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_%20Linux/7/html/Migration_Planning_Guide/sect-Red_Hat_Enterprise_%20Linux-Migration_Planning_Guide-Security_and_Access_%20Control.html" target="_blank">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_%20Linux/7/html/Migration_Planning_Guide/sect-Red_Hat_Enterprise_%20Linux-Migration_Planning_Guide-Security_and_Access_%20Control.html</a>)</p></li><li style="list-style-type: disc"><p>FirewallD (<a class="ulink" href="http://fedoraproject.org/wiki/FirewallD" target="_blank">http://fedoraproject.org/wiki/FirewallD</a>)</p></li><li style="list-style-type: disc"><p>How To Set Up a Firewall Using FirewallD on CentOS 7 (<a class="ulink" href="https://www.digitalocean.com/community/tutorials/how-to-set-up-a-firewall-using-firewalld-on-centos-7" target="_blank">https://www.digitalocean.com/community/tutorials/how-to-set-up-a-firewall-using-firewalld-on-centos-7</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch02lvl1sec21"></a>Configuring the network firewall using iptables</h2></div></div><hr /></div><p>In this recipe, you'll learn how to replace FirewallD with the iptables service and perform basic firewall configurations. iptables was the default method for managing the firewall's settings in CentOS prior to version 7. Some administrators might prefer iptables because it's within their comfort level or maybe they have several older servers running in the data center and they want to maintain similarity as much as possible.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec53"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection. You'll also need administrative privileges provided by logging in with the <code class="literal">root</code> account.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec54"></a>How to do it...</h3></div></div></div><p>The following steps will allow you to replace FirewallD with the iptables service:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Stop the FirewallD service and disable it:</p><pre class="programlisting">
<span class="strong"><strong>systemctl stop firewalld</strong></span>
<span class="strong"><strong>systemctl mask firewalld</strong></span>
</pre></li><li><p>Install the <code class="literal">iptables-services</code> package which contains the service:</p><pre class="programlisting">
<span class="strong"><strong>yum install iptables-services</strong></span>
</pre></li><li><p>Start the service and register it so that it will start automatically when the system is booted:</p><pre class="programlisting">
<span class="strong"><strong>systemctl start iptables</strong></span>
<span class="strong"><strong>systemctl enable iptables</strong></span>
</pre></li></ol></div><p>The following collection of commands will show you how to perform several basic configuration tasks using <code class="literal">iptables</code>:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Use the <code class="literal">-L</code> flag to print the current configuration. Add the <code class="literal">--line-numbers</code> flag to display each rule's ID number alongside it:</p><pre class="programlisting">
<span class="strong"><strong>iptables -L --line-numbers</strong></span>
</pre></li><li style="list-style-type: disc"><p>Use the following command to allow TCP traffic on port 80 from the <code class="literal">enp0s3</code> interface through the firewall:</p><pre class="programlisting">
<span class="strong"><strong>iptables -A INPUT -i enp0s3 --dport 80 -p tcp -j ACCEPT</strong></span>
</pre></li><li style="list-style-type: disc"><p>To remove the rule that allows TCP traffic on port 80, execute <code class="literal">iptables -L --line-numbers</code> to find the rule's ID and then use the following (replace <code class="literal">##</code> with the rule's ID):</p><pre class="programlisting">
<span class="strong"><strong>iptables -D INPUT ##</strong></span>
</pre></li><li style="list-style-type: disc"><p>Reload iptables after making configuration changes for them to be in effect:</p><pre class="programlisting">
<span class="strong"><strong>systemctl restart iptables</strong></span>
</pre></li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec55"></a>How it works...</h3></div></div></div><p>To replace FirewallD with the iptables service to manage the network firewall, we first stopped and disabled the FirewallD service; we don't want multiple firewall daemons running since it would lead to conflicts. FirewallD uses iptables behind the scenes so iptables is already installed, but the iptables service isn't. So, next we installed the <code class="literal">iptables-services</code> package:</p><pre class="programlisting">
<span class="strong"><strong>yum install iptables-services</strong></span>
</pre><p>We then saw how to perform basic configurations to allow and disallow traffic. For example, the recipe presented the command to add a rule that allows TCP traffic through port <code class="literal">80</code>:</p><pre class="programlisting">
<span class="strong"><strong>iptables -A INPUT -i enp0s3 --dport 80 -p tcp -j ACCEPT</strong></span>
</pre><p>The <code class="literal">-A</code> argument indicates that we wish to add a firewall rule and is followed by the rule type. Possible values are <code class="literal">INPUT</code>, <code class="literal">OUTPUT</code>, and <code class="literal">FORWARD</code>, which apply to incoming traffic, outgoing traffic, and traffic that is routed, respectively (if the system is configured as a router, for example). Since <code class="literal">INPUT</code> is specified, our rule applies to incoming traffic on port <code class="literal">80</code>.</p><p>The <code class="literal">-i</code> argument specifies the network interface that is monitored by the rule. In this case, the rule applies to <code class="literal">enp0s3</code>. Then, <code class="literal">--dport</code> specifies the traffic's destination port, in this case port <code class="literal">80</code>, and <code class="literal">-p</code> specifies the transport protocol, for example, either TCP or UDP.</p><p>The <code class="literal">-j</code> argument is the target action for <span class="strong"><strong>jump to</strong></span>. With iptables, rules are strung together to make chains of filtering logic. Imagine iptables checking traffic against each rule we've specified; if the first rule doesn't match, it goes on to check the next rule, and the next, until a match is found. When the matching rule is found, iptables stops checking and <span class="emphasis"><em>jumpsÂ </em></span>to the desired state. Possible states are <code class="literal">ACCEPT</code> to accept the traffic, <code class="literal">REJECT</code> to actively deny the connection, and <code class="literal">DROP</code> to silently ignore it.</p><p>We also saw how to display the rules that are currently defined using the <code class="literal">-L</code> flag and that using <code class="literal">--line-numbers</code> will display an identifier alongside each rule:</p><pre class="programlisting">
<span class="strong"><strong>iptables -L --line-numbers</strong></span>
</pre><div class="mediaobject"><img src="graphics/image_02_006.jpg" /><div class="caption"><p>iptables accepts or denies traffic based on the configured rules</p></div></div><p>Knowing a rule's identifier is convenient if we want to delete it. By providing <code class="literal">-D</code>, the rule type (<code class="literal">INPUT</code>, <code class="literal">OUTPUT</code>, or <code class="literal">FORWARD</code>), and the ID, we can succinctly remove a rule from the chain:</p><pre class="programlisting">
<span class="strong"><strong>iptables -D INPUT 6</strong></span>
</pre><p>Alternatively, you can respecify the entire rule while substituting <code class="literal">-A</code> with <code class="literal">-D</code> to delete it:</p><pre class="programlisting">
<span class="strong"><strong>iptables -D INPUT -i enp0s3 --dport 80 -p tcp -j ACCEPT</strong></span>
</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec56"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on working with iptables:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>How to Migrate from FirewallD to iptables on CentOS 7 (<a class="ulink" href="https://www.digitalocean.com/community/tutorials/how-to-migrate-from-firewalld-to-iptables-on-centos-7" target="_blank">https://www.digitalocean.com/community/tutorials/how-to-migrate-from-firewalld-to-iptables-on-centos-7</a>)</p></li><li style="list-style-type: disc"><p>How to List and Delete iptables Firewall Rules (<a class="ulink" href="https://www.digitalocean.com/community/tutorials/how-to-list-and-delete-iptables-firewall-rules" target="_blank">https://www.digitalocean.com/community/tutorials/how-to-list-and-delete-iptables-firewall-rules</a>)</p></li><li style="list-style-type: disc"><p>25 Most Frequently Used Linux iptables Rules (<a class="ulink" href="http://www.thegeekstuff.com/2011/06/iptables-rules-examples" target="_blank">http://www.thegeekstuff.com/2011/06/iptables-rules-examples</a>)</p></li><li style="list-style-type: disc"><p>Drop versus reject (<a class="ulink" href="http://www.chiark.greenend.org.uk/~peterb/network/drop-vs-reject" target="_blank">http://www.chiark.greenend.org.uk/~peterb/network/drop-vs-reject</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch02lvl1sec22"></a>Installing a DHCP server</h2></div></div><hr /></div><p>This recipe will show you how to set up your own DHCP server on CentOS. DHCP is used to assign IP addresses and other network configuration details on demand to a client. While a system configured with a static IP address will already know all the necessary networking details, a system configured to use DHCP broadcasts a request on the network and waits to receive a response from the DHCP server.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec57"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection. You'll also need administrative privileges provided by logging in with the <code class="literal">root</code> account.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note16"></a>Note</h3><p>Only one DHCP server should be running on the network to prevent clients from receiving conflicting responses that can result in network instability. Many routers already have a DHCP service running on them, so check for this on your own network before proceeding.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec58"></a>How to do it...</h3></div></div></div><p>Follow these steps to set up a DHCP server:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Install the <code class="literal">dhcp</code> package:</p><pre class="programlisting">
<span class="strong"><strong>yum install dhcp</strong></span>
</pre></li><li><p>Copy the example configuration file provided by the package to serve as the starting point of your server's configuration:</p><pre class="programlisting">
<span class="strong"><strong>cp /usr/share/doc/dhcp-4.2.5/dhcpd.conf.example
       /etc/dhcp/dhcpd.conf</strong></span>
</pre></li><li><p>Open the configuration file using your text editor:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/dhcp/dhcpd.conf</strong></span>
</pre></li><li><p>Modify the configuration with values that make sense for your environment. In particular, you'll want to address the following options: <code class="literal">domain-name</code> and <code class="literal">domain-name-servers</code>, <code class="literal">subnet</code>, the <code class="literal">dynamic-bootp</code> range, <code class="literal">broadcast-address</code>, and <code class="literal">routers</code>. Here is an example configuration for a network of two subnets:</p><pre class="programlisting">
<span class="strong"><strong># option definitions common to all supported networks</strong></span>
<span class="strong"><strong>option domain-name localdomain;</strong></span>
<span class="strong"><strong>option domain-name-servers ns1.localdomain;</strong></span>
<span class="strong"><strong>default-lease-time 600;</strong></span>
<span class="strong"><strong>max-lease-time 7200;</strong></span>
<span class="strong"><strong># This DHCP server is the official DHCP server for the</strong></span>
<span class="strong"><strong># local network</strong></span>
<span class="strong"><strong>authoritative;</strong></span>
<span class="strong"><strong># No service will be given on this subnet, but declaring</strong></span>
<span class="strong"><strong># it helps the server to understand the network topology.</strong></span>
<span class="strong"><strong>subnet 192.168.56.0 netmask 255.255.255.0 {</strong></span>
<span class="strong"><strong>}</strong></span>
<span class="strong"><strong># This is a basic subnet declaration</strong></span>
<span class="strong"><strong>subnet 192.168.56.0 netmask 255.255.255.128 {</strong></span>
<span class="strong"><strong>  range 192.168.56.110 192.168.56.120;</strong></span>
<span class="strong"><strong>     option domain-name-servers ns1.localdomain;</strong></span>
<span class="strong"><strong>     option domain-name "localdomain";</strong></span>
<span class="strong"><strong>     option routers 192.168.56.1;</strong></span>
<span class="strong"><strong>     option broadcast-address 192.168.56.127;</strong></span>
<span class="strong"><strong>}</strong></span>
<span class="strong"><strong># This is the second subnet</strong></span>
<span class="strong"><strong>subnet 192.168.56.128 netmask 255.255.255.128 {</strong></span>
<span class="strong"><strong>     range 192.168.56.200 192.168.56.210;</strong></span>
<span class="strong"><strong>     option domain-name-servers ns2.sub.localdomain;</strong></span>
<span class="strong"><strong>     option domain-name "sub.localdomain";</strong></span>
<span class="strong"><strong>     option routers 192.168.56.129;</strong></span>
<span class="strong"><strong>     option broadcast-address 192.168.56.255;</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></li><li><p>Save your changes and close the file.</p></li><li><p>Start the <code class="literal">dhcp</code> service and enable it to start at system boot:</p><pre class="programlisting">
<span class="strong"><strong>systemctl start dhcpd</strong></span>
<span class="strong"><strong>systemctl enable dhcpd</strong></span>
</pre></li><li><p>Open ports <code class="literal">67</code> and <code class="literal">68</code> in the system's firewall to allow traffic:</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --add-service=dhcp</strong></span>
<span class="strong"><strong>firewall-cmd --reload</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec59"></a>How it works...</h3></div></div></div><p>A system configured to use DHCP will broadcast a request and wait to receive a response from the DHCP server. The server's response lets the client know which IP address, netmask, gateway information, and so on to use on the network. DHCP-provisioned addresses are usually leased, which means that after a set amount of time they expire and the client needs to send another request. The DHCP server, in addition to handing out connection details, must keep track of the addresses that have already been leased so that a client doesn't receive an address that's already in use by another system.</p><p>We began by installing the <code class="literal">dhcpd</code> package, which contains the server and example configuration files. Copying the example configuration to use as a starting point for our own saves us from having to draft the entire configuration from scratch:</p><pre class="programlisting">
<span class="strong"><strong>cp /usr/share/doc/dhcp-4.2.5/dhcpd.conf.example  /etc/dhcp/dhcpd.conf</strong></span>
</pre><p>In the configuration file, there are several places where you need to provide values that make sense for your network. The minimal configuration file provided as an illustration in the recipe reflects a network divided into two subnets. The first subnet is <code class="literal">192.168.56.0/25</code> and the second is <code class="literal">192.168.56.128/25</code>. Each subnet has its own declaration.</p><p>Examining the first subnet declaration, the subnet's ID is <code class="literal">192.168.56.0</code> with a netmask of <code class="literal">255.255.255.128</code>. The <code class="literal">range</code> option will restrict the DHCP server in assigning IP addresses in the range of <code class="literal">192.168.56.110</code> to <code class="literal">120</code> (the other addresses are still valid and are available for static assignment). Subsequent <code class="literal">option</code> entries provide the subnet's broadcast-address and gateway, and override the domain name and nameservers defined globally:</p><pre class="programlisting">
<span class="strong"><strong># This is a basic subnet declaration</strong></span>
<span class="strong"><strong>subnet 192.168.56.0 netmask 255.255.255.128 {</strong></span>
<span class="strong"><strong>  range 192.168.56.110 192.168.56.120;</strong></span>
<span class="strong"><strong>  option domain-name-servers ns1.localdomain;</strong></span>
<span class="strong"><strong>  option domain-name "localdomain";</strong></span>
<span class="strong"><strong>  option routers 192.168.56.1;</strong></span>
<span class="strong"><strong>  option broadcast-address 192.168.56.127;</strong></span>
<span class="strong"><strong>}</strong></span>
</pre><p>Configuring a DHCP server properly requires an understanding of computer networking. It is a complex topic and, as such, we can't discuss every option in detail. I advise you to read the manual page for <code class="literal">dhcpd.conf</code> for extra guidance. The page can be accessed using the <code class="literal">man</code> command:</p><pre class="programlisting">
<span class="strong"><strong>man 5 dhcpd.conf</strong></span>
</pre><div class="mediaobject"><img src="graphics/image_02_007.jpg" /><div class="caption"><p>The configuration file for dhcpd is documented in a manual page</p></div></div><p>Once the DHCP server was configured and running, we then needed to poke a hole in the firewall to allow requests and responses to flow freely. DHCP requests occur using UDP and ports <code class="literal">57</code> and <code class="literal">58</code> (you can allow them using the service defined for FirewallD):</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --add-service=dhcp</strong></span>
<span class="strong"><strong>firewall-cmd --reload</strong></span>
</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec60"></a>See also</h3></div></div></div><p>For more information on setting up a DHCP server, refer to the following resources:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">dhcpd.conf</code> manual page (<code class="literal">man 5 dhcpd.conf</code>)</p></li><li style="list-style-type: disc"><p>RHEL 7 Networking Guide: DHCP Servers (<a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Networking_Guide/ch-DHCP_Servers.html" target="_blank">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Networking_Guide/ch-DHCP_Servers.html</a>)</p></li><li style="list-style-type: disc"><p>Quick Start: Setup CentOS 7 as a DHCP Server (<a class="ulink" href="http://www.yoyoclouds.com/2015/01/quick-start-setup-centos-7-as-dhcp.html" target="_blank">www.yoyoclouds.com/2015/01/quick-start-setup-centos-7-as-dhcp.html</a>)</p></li><li style="list-style-type: disc"><p>Subnet Calculator (<a class="ulink" href="http://www.subnet-calculator.com/" target="_blank">www.subnet-calculator.com</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch02lvl1sec23"></a>Configuring an NFS server to share a filesystem</h2></div></div><hr /></div><p>Network File System (NFS) is a protocol for a distributed filesystem. That is, we can store files to a directory on a remote server and clients can mount the share. The remote directory will appear to the client as if it were local, although all data saved to it resides on the server. This recipe shows you how to configure NFS on a server and expose the storage as a network share. (The next recipe will show you how to configure NFS on a client.)</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec61"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection. You'll also need administrative privileges provided by logging in with the <code class="literal">root</code> account.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec62"></a>How to do it...</h3></div></div></div><p>Follow these steps to set up an NFS server:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Install the <code class="literal">nfs-utils</code> and <code class="literal">libnfsidmap</code> packages:</p><pre class="programlisting">
<span class="strong"><strong>yum install nfs-utils libnfsidmap</strong></span>
</pre></li><li><p>Create a globally accessible directory which will serve as the root of the file share:</p><pre class="programlisting">
<span class="strong"><strong>mkdir -m 777 /var/nfsshare</strong></span>
</pre></li><li><p>Open /<code class="literal">etc/exports</code> and add the following entry to mark the directory for export by NFS. When done, save and close the file:</p><pre class="programlisting">
<span class="strong"><strong>/var/nfsshare 192.168.56.0/24(rw,sync,root_squash)</strong></span>
</pre><p>The <code class="literal">exports</code> file is very picky. Make sure there's no space between the network and the parenthesized options as well as no spaces around the commas that separate the options.</p></li><li><p>Start the necessary services and register them so that they will start when the server boots:</p><pre class="programlisting">
<span class="strong"><strong>      systemctl start rpcbind nfs-server</strong></span>
<span class="strong"><strong>      systemctl enable rpcbind nfs-server
</strong></span>
</pre></li><li><p>Open ports <code class="literal">111</code>, <code class="literal">2048</code>, and <code class="literal">2049</code> in the firewall to allow traffic through:</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --permanent --zone public --add-service rpc-bind</strong></span>
<span class="strong"><strong>firewall-cmd --permanent --zone public --add-service mountd</strong></span>
<span class="strong"><strong>firewall-cmd --permanent --zone public --add-service nfs</strong></span>
<span class="strong"><strong>firewall-cmd --reload</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec63"></a>How it works...</h3></div></div></div><p>In this recipe, you learned how to set up a shared network directory using NFS. After installing the appropriate packages, we created the shared directory, registered it to be exported, and started the necessary system services.</p><p><code class="literal">/etc/exports</code> is the configuration file that manages which filesystems are exported and how. We added an entry that identified the directory we want to export, followed by which clients they are exported to and the options that govern how the export will be treated:</p><pre class="programlisting">
<span class="strong"><strong>/var/nfsshare 192.168.56.0/24(rw,sync,root_squash)</strong></span>
</pre><p>In the example, we make the share available to <code class="literal">192.168.56.0/24</code>, in other words, any host on the network. Alternatively, you can share the directory a single host or a range of hosts. An entry that shares the directory with a specific host looks like the following:</p><pre class="programlisting">
<span class="strong"><strong>/var/nfsshare 192.168.56.101(rw,sync,root_squash)</strong></span>
</pre><p>The <code class="literal">rw++</code> option allows both read and write access to the share. <code class="literal">sync</code> flushes any changes to a file immediately to disk. While writing to disk might make access to the file slower at times, the delay won't be noticeable unless your system is under high load, and it would seem like a fair trade-off for the safety that immediate flushes provide in the event of a crash.</p><p>NFS will effectively squash the root user's ownership when <code class="literal">root_squash</code> is provided by changing the owner to <code class="literal">nfsnobody</code>. This is a security measure that mitigates the risk of a root user on the client system attempting to write a file to the share with root ownership (otherwise a malicious user could store a file and mark it executable where it might be run with root privileges). If you want to squash the ownership of all files to <code class="literal">nfsnobdy</code>, you can use the <code class="literal">all_squash</code> option.</p><p>NFS relies on a few other services, which is why we also enabled rpcbind and opened firewall ports for rpcbind and mountd. NFS works on top of the Remote Procedure Call (RPC) protocol, and rcpind is responsible for mapping the RPC-based services to their ports. An incoming connection from a client first hits the rpcbind service, providing an RPC identifier. Rpcbind resolves the identifier to a particular service (NFS in this case) and redirects the client to the appropriate port. There, mountd handles the request to determine whether the requested share is exported and whether theÂ client is allowed to access it.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec64"></a>See also</h3></div></div></div><p>Refer to the following resources for more information about configuring an NFS server:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The Network Filesystem (<a class="ulink" href="http://www.tldp.org/LDP/nag/node140.html" target="_blank">http://www.tldp.org/LDP/nag/node140.html</a>)</p></li><li style="list-style-type: disc"><p>RHEL 7 Storage Administration Guide: NFS Server Configuration (<a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Storage_Administration_Guide/nfs-serverconfig.html" target="_blank">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Storage_Administration_Guide/nfs-serverconfig.html</a>)</p></li><li style="list-style-type: disc"><p>How to setup NFS Server on CentOS 7 (<a class="ulink" href="http://www.itzgeek.com/how-tos/linux/centos-how-tos/how-to-setup-nfs-server-on-centos-7-rhel-7-fedora-22.html" target="_blank">http://www.itzgeek.com/how-tos/linux/centos-how-tos/how-to-setup-nfs-server-on-centos-7-rhel-7-fedora-22.html</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch02lvl1sec24"></a>Configuring an NFS client to use a shared filesystem</h2></div></div><hr /></div><p>This recipe continues where the previous recipe left off, showing you how to configure NFS on a client system.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec65"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection. It assumes that an NFS server has been configured as explained in the previous recipe. You'll also need administrative privileges provided by logging in with the <code class="literal">root</code> account.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec66"></a>How to do it...</h3></div></div></div><p>Follow these steps to configure an NFS client:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Install the <code class="literal">nfs-utils</code> and <code class="literal">libnfsidmap</code> packages:</p><pre class="programlisting">
<span class="strong"><strong>yum install nfs-utils libnfsidmap</strong></span>
</pre></li><li><p>Create the directory which will serve as the mount point for the remote filesystem:</p><pre class="programlisting">
<span class="strong"><strong>mkdir /mnt/nfs</strong></span>
</pre></li><li><p>Start the <code class="literal">rpcbind</code> service and register it so that it will start when the server boots:</p><pre class="programlisting">
<span class="strong"><strong>systemctl start rpcbind</strong></span>
<span class="strong"><strong>systemctl enable rpcbind</strong></span>
</pre></li><li><p>Mount the NFS share to the mount point:</p><pre class="programlisting">
<span class="strong"><strong>mount -t nfs 192.168.56.100:/var/nfsshare /mnt/nfs</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec67"></a>How it works...</h3></div></div></div><p>Like the server side, the client side of NFS relies on RPC. So, we started and enabled the rpcbind service. The <code class="literal">mount</code> command is then used to mount the remote share:</p><pre class="programlisting">
<span class="strong"><strong>mount -t nfs 192.168.56.100:/var/nfsshare /mnt/nfs</strong></span>
</pre><p>The <code class="literal">-t</code> argument indicates the share's filesystem type, which, of course is,Â <code class="literal">nfs</code>. The location of the remote share is also provided, the IP address of the server and the directory of the shared data separated by a colon. Finally, the mount target is given.</p><p>To manually unmount the share, the <code class="literal">umount</code> command is used with the mount point:</p><pre class="programlisting">
<span class="strong"><strong>umount /mnt/nfs</strong></span>
</pre><p>We can also configure the system to mount the NFS share automatically at boot time. Open <code class="literal">/etc/fstab</code> using your editor and add the following line:</p><pre class="programlisting">
<span class="strong"><strong>192.168.0.100:/var/nfsshare /mnt/nfs/var/nfsshare nfs defaults 0 0</strong></span>
</pre><p>The share will be automatically mounted when the system boots. Since <code class="literal">mount</code> can look up information in <code class="literal">/etc/fstab</code>, the invocation to mount the share manually becomes much simpler once it's registered in this manner. You can now mount the share manually by providing just the <code class="literal">mount</code>:</p><pre class="programlisting">
<span class="strong"><strong>mount /mnt/nfs</strong></span>
</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec68"></a>See also</h3></div></div></div><p>Refer to the following resources for more information about configuring an NFS client:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">mount</code> manual page (<code class="literal">man 8 mount</code>)</p></li><li style="list-style-type: disc"><p>Setting up an NFS Client (<a class="ulink" href="http://www.tldp.org/HOWTO/NFS-HOWTO/client.html" target="_blank">http://www.tldp.org/HOWTO/NFS-HOWTO/client.html</a>)</p></li><li style="list-style-type: disc"><p>RHEL 7 Storage Administration Guide: NFS Client Configuration (<a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Storage_Administration_Guide/nfs-clientconfig.html" target="_blank">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Storage_Administration_Guide/nfs-clientconfig.html</a>)</p></li><li style="list-style-type: disc"><p>How to setup NFS Server on CentOS 7 (<a class="ulink" href="http://www.itzgeek.com/how-tos/linux/centos-how-tos/how-to-setup-nfs-server-on-centos-7-rhel-7-fedora-22.html" target="_blank">http://www.itzgeek.com/how-tos/linux/centos-how-tos/how-to-setup-nfs-server-on-centos-7-rhel-7-fedora-22.html</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch02lvl1sec25"></a>Serving Windows shares with Samba</h2></div></div><hr /></div><p>In this recipe, you will learn how to serve a Windows share from a CentOS system using Samba. Like NFS, a Windows share is a directory on a remote server that a client may access to store files. Samba is a server that understands the SMB protocol used by Windows so that it can export directories that a Windows client can mount.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec69"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection. You'll also need administrative privileges provided by logging in with the <code class="literal">root</code> account.</p><p>The name of your Windows workgroup is needed to configure Samba properly. Before you begin, on your Windows system in your network, run <code class="literal">net config workstation</code> and record the <code class="literal">Workstation domain</code> value:</p><div class="mediaobject"><img src="graphics/image_02_008.jpg" /><div class="caption"><p>net config workstation displays information about the Windows system's workgroup and domain</p></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec70"></a>How to do it...</h3></div></div></div><p>Follow these steps to set up Samba to share directories with Windows systems:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Install the <code class="literal">samba</code> package:</p><pre class="programlisting">
<span class="strong"><strong>yum install samba</strong></span>
</pre></li><li><p>Create a dedicated group for Samba users:</p><pre class="programlisting">
<span class="strong"><strong>groupadd smbgroup</strong></span>
</pre></li><li><p>Create the directory which will serve as the root of the file share. Set its group ownership to the new Samba users group:</p><pre class="programlisting">
<span class="strong"><strong>mkdir -m 770 /var/sambashare</strong></span>
<span class="strong"><strong>chgrp smbgroup /var/sambashare</strong></span>
</pre></li><li><p>Open Samba's configuration file using your text editor:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/samba/smb.conf</strong></span>
</pre></li><li><p>Update the <code class="literal">workgroup</code> parameter in the <code class="literal">[global]</code> section to match the Windows workgroup name. Feel free to review the other parameters in the configuration file as each isÂ clearly documented with helpful comments:</p><pre class="programlisting">
<span class="strong"><strong>Workgroup = WORKGROUP</strong></span>
</pre></li><li><p>At the end of the configuration file, add the following content:</p><pre class="programlisting">
<span class="strong"><strong>[share]</strong></span>
<span class="strong"><strong>path = /var/sambashare</strong></span>
<span class="strong"><strong>guest ok = no</strong></span>
<span class="strong"><strong>valid users = @smbgroup</strong></span>
<span class="strong"><strong>writable = yes
       create mask = 0755
</strong></span>
</pre></li><li><p>Save your changes and close the file.</p></li><li><p>Start the necessary services and register them so that they will start when the server boots:</p><pre class="programlisting">
<span class="strong"><strong>systemctl start smb nmb</strong></span>
<span class="strong"><strong>systemctl enable smb nmb</strong></span>
</pre></li><li><p>Open ports <code class="literal">137</code>-<code class="literal">139</code> and <code class="literal">445</code> to allow the network traffic:</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --permanent --zone public --add-service samba</strong></span>
<span class="strong"><strong>firewall-cmd --reload</strong></span>
</pre></li><li><p>For each user who will connect to the share, assign them to the users group and register the password they will use:</p><pre class="programlisting">
<span class="strong"><strong>usermod -a -G smbgroup tboronczyk</strong></span>
<span class="strong"><strong>smbpasswd -a tboronczyk</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec71"></a>How it works...</h3></div></div></div><p>In this recipe, you learned how to install and configure Samba to share a directory which a Windows client can access.</p><p>We started by doing a bit of research using the <code class="literal">net config</code> command to discover the Windows workgroup that our client belongs to. This is important because two systems on the same network but identifying themselves as part of different workgroups will not be able to communicate with one another. In the example, the workgroup's name was simply <code class="literal">WORKGROUP</code>.</p><p>Next, we installed the <code class="literal">samba</code> package and created a special group named <code class="literal">smbgroup</code>. We'll configure Samba so that any user account on the CentOS system will be able to access the share as long as it's assigned to the <code class="literal">smbgroup</code> group. Then we created the directory we would be sharing and set its group ownership to the new group.</p><p>We then edited Samba's configuration file, specifying the name of the Windows workgroup we looked up earlier for the <code class="literal">workgroup</code> value, and added a section to define the new share. We restricted the share so that only authenticated users belonging to <code class="literal">smbgroup</code> can access it by setting <code class="literal">guest ok</code> to <code class="literal">no</code> and <code class="literal">valid users</code> to <code class="literal">@smbgroup</code>. The <code class="literal">writable</code> entry allows users to create and update files on the share (otherwise the files would be read-only), and the <code class="literal">create mask</code> entry was used to specify the default file permissions that new files will be assigned in the Linux filesystem. The name <code class="literal">share</code> within brackets not only starts that configuration section but also serves as the name the share will be exported as (that is, <code class="literal">\\192.168.56.100\share</code>). You can export multiple shares as long as each name is distinct.</p><p>For each user account that will be used to connect to the share, we made sure it belonged to the <code class="literal">smbgroup</code> and used the <code class="literal">smbpasswd</code> command to specify a password the account would use to authenticate its SMB sessions. This password is maintained separately from the system's credentials and is valid only for authenticating to Samba, so a password different from the account's login password should be chosen.</p><p>Managing Samba users is done using <code class="literal">smbpasswd</code>. The <code class="literal">-a</code> flag adds an entry in Samba's account database, and we can delete a user from the database using the <code class="literal">-x</code> flag:</p><pre class="programlisting">
<span class="strong"><strong>smbpasswd -x tboronczyk</strong></span>
</pre><p>On the Windows system, you can use the <code class="literal">net use</code> command to map the remote share to a drive letter. Once it's mapped, the drive appears in the list of available drives:</p><pre class="programlisting">
<span class="strong"><strong>net use Z: \\192.168.56.100\share /USER:tboronczyk</strong></span>
</pre><p>Alternatively, you can map the drive through the Windows GUI, navigating through <code class="literal">Computer</code> | <code class="literal">Map network drive</code> | <code class="literal">Map network drive</code> in File Explorer while the <span class="strong"><strong>This PC</strong></span> bookmark is selected:</p><div class="mediaobject"><img src="graphics/image_02_009.jpg" /><div class="caption"><p>The Samba share is available as a network mapped drive</p></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec72"></a>See also</h3></div></div></div><p>For more information on working with Samba, refer to the following resources:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">smb.conf</code> manual page (<code class="literal">man 5 smb.conf</code>)</p></li><li style="list-style-type: disc"><p>Using Samba on CentOS With Windows 7/8 (<a class="ulink" href="https://rcollier.me/2013/07/30/using-samba-on-centos-with-windows-78/" target="_blank">https://rcollier.me/2013/07/30/using-samba-on-centos-with-windows-78/</a>)</p></li><li style="list-style-type: disc"><p>Install And Configure Samba Server In CentOS 7 (<a class="ulink" href="http://www.unixmen.com/install-configure-samba-server-centos-7" target="_blank">http://www.unixmen.com/install-configure-samba-server-centos-7</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="chapter" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="ch03"></a>ChapterÂ 3.Â User and Permission Management</h2></div></div></div><p>This chapter contains the following recipes:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Escalating privileges with sudo</p></li><li style="list-style-type: disc"><p>Enforcing password restrictions</p></li><li style="list-style-type: disc"><p>Setting default permissions for new files and directories</p></li><li style="list-style-type: disc"><p>Running binaries as a different user</p></li><li style="list-style-type: disc"><p>Working with SELinux for greater security</p></li></ul></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch03lvl1sec26"></a>Introduction</h2></div></div><hr /></div><p>Each of the recipes in this chapter pertain to users and permissions. You'll learn how to let users temporarily escalate their privileges without requiring the root password and how to enforce complexity requirements for users. You'll also learn how to specify what access permissions are given to new files and directories by default and how the traditional Unix permission system can allow a program to run under a different security context than that of the user who launched it. Finally, we'll look at SELinux, a secondary permission system that hardens the security of your CentOS server.</p></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch03lvl1sec27"></a>Escalating privileges with sudo</h2></div></div><hr /></div><p>The<code class="literal"> root</code> account is Linux's <span class="strong"><strong>god account</strong></span>, and it has the ability to perform pretty much any activity on the system. For security reasons, you should use an unprivileged user account for your day-to-day activities and use <code class="literal">root</code> only when it's necessary for administration tasks. It's also important to keep the root's password secret; the more people who know its password, the harder it is to keep it secret. A quote by Benjamin Franklin comes to mind: Three can keep a secret if two of them are dead.</p><p>If more than one administrator has been tasked with managing a system, keeping <code class="literal">root</code> secure can be difficult. <code class="literal">sudo</code> solves this problem by giving users a way to execute commands with the privileges of another user (most commonly <code class="literal">root</code>). Each of the administrator accounts can be configured using one of the methods presented in this recipe to escalate their privileges temporarily with <code class="literal">sudo</code>, and root's password can remain secret.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec73"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system and administrative access provided by logging in with the <code class="literal">root</code> account. You'll also need one or two unprivileged user accounts to configure (refer to the <code class="literal">useradd</code> man page <code class="literal">man 8 useradd</code> for information on creating user accounts).</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec74"></a>How to do it...</h3></div></div></div><p>One way to allow an unprivileged account the use of <code class="literal">sudo</code> is to assign it a membership in the <code class="literal">wheel</code> group. This is done with the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Use <code class="literal">usermod</code> to add the user account to <code class="literal">wheel</code>:</p><pre class="programlisting">
<span class="strong"><strong>usermod -a -G wheel tboronczyk</strong></span>
</pre></li><li><p>Verify the update using the <code class="literal">groups</code> command. <code class="literal">wheel</code> should list one of the groups which the account is a member of:</p><pre class="programlisting">
<span class="strong"><strong>groups tboronczyk</strong></span>
</pre></li></ol></div><p>Another way to grant access to <code class="literal">sudo</code> is by configuring the sudoers policy which identifies which accounts can use <code class="literal">sudo</code> and in what manner. You can easily add an account to the policy with the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create a new file in the <code class="literal">/etc/sudoers.d</code> directory named after the user account:</p><pre class="programlisting">
<span class="strong"><strong>touch /etc/sudoers.d/tboronczyk</strong></span>
</pre></li><li><p>Open the file and add the following directive. When finished, save your update and close the file:</p><pre class="programlisting">
<span class="strong"><strong>tboronczyk ALL = ALL</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec75"></a>How it works...</h3></div></div></div><p>For a user to use the <code class="literal">sudo</code> command they must be somehow listed in the sudoers policy. This is checked by <code class="literal">sudo</code> to verify whether the account is authorized to perform the attempted action. This recipe presented two ways of accomplishing this: by assigning the user account to the <code class="literal">wheel</code> group (which is already registered in the policy) or by adding the account directly to the policy.</p><p>In the first approach, the <code class="literal">usermod</code> command assigns the user membership in <code class="literal">wheel</code>. The <code class="literal">-G</code> option specifies the name of the group and <code class="literal">-a</code> instructs <code class="literal">usermod</code> to add the user to that group. It's important that you provide <code class="literal">-a</code> since without it the list of assigned groups is overwritten with only what is given with <code class="literal">-G</code> (that is, the account would belong only to <code class="literal">wheel</code>).</p><pre class="programlisting">
<span class="strong"><strong>usermod -a -G wheel tboronczyk</strong></span>
</pre><p>The second approach registers the account with the sudoers policy by creating a file for the user under <code class="literal">/etc/sudoers.d</code>. We alternatively could have added the user's information to the <code class="literal">/etc/sudoers</code> configuration file, but the policy already includes any files found in the <code class="literal">sudoers.d</code> directory as part of its configuration. Creating a file for each user in the directory will be more manageable given a large number of users when it is time to revoke access.</p><p>Both approaches allow a user the use of <code class="literal">sudo</code> to execute commands they wouldn't ordinarily have sufficient rights to. For example:</p><pre class="programlisting">
<span class="strong"><strong>sudo umount /media</strong></span>
</pre><p>The first time a user invokes <code class="literal">sudo</code>, a message is displayed that reminds them to be responsible with their new-found power. The user must provide their password to verify their identity; the verification is cached for five minutes from the last invocation as an extra bit of protection against malicious users who might walk up to a terminal that was carelessly left logged in.</p><div class="mediaobject"><img src="graphics/image_03_001.jpg" /><div class="caption"><p>sudo reminds the user that with great power comes great responsibly</p></div></div><p>The sudoers policy is flexible enough to allow a user account to execute certain commands instead of giving carte blanche access. Recall the configuration directive for our unprivileged user account:</p><pre class="programlisting">
<span class="strong"><strong>tboronczyk ALL = ALL</strong></span>
</pre><p>The username is specified followed by assigning the <code class="literal">ALL</code> alias to <code class="literal">ALL</code>. As you might determine by looking at this, <code class="literal">ALL</code> is the predefined alias that represents all commands. We can redefine the alias for the given user as a list of allowed commands:</p><pre class="programlisting">
<span class="strong"><strong>tboronczyk ALL = /bin/mount /bin/umount</strong></span>
</pre><p>Now the account can invoke any command it normally has access to, but only the <code class="literal">mount</code> and <code class="literal">umount</code> commands with elevated privileges (assuming the account isn't a member of <code class="literal">wheel</code>).</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip17"></a>Note</h3><p>Are you tired of typing <code class="literal">sudo</code> before your commonly-used administrative commands? You can create aliases for a smoother command line experience. Suppose your unprivileged account is allowed to use the <code class="literal">mount</code> and <code class="literal">umount</code> commands with <code class="literal">sudo</code>. Adding the following lines to your <code class="literal">~/.bashrc</code> file will let you invoke them commands without explicitly typing <code class="literal">sudo</code>:</p><pre class="programlisting"><span class="strong"><strong>alias mount sudo /bin/mount</strong></span>
<span class="strong"><strong>alias umount sudo /bin/umount</strong></span>
</pre></div><p>Multiple directives in the policy can apply to an account in which case they are applied additively, first to last. To see this in action, suppose an account already has full <code class="literal">sudo</code> usage by assignment in the <code class="literal">wheel</code> group. By default, the user needs to provide their password to execute a command. We can relax this requirement and allow the user to use <code class="literal">ls</code> to display the contents of restricted directories without a password:</p><pre class="programlisting">
<span class="strong"><strong>tboronczyk ALL = NOPASSWD: /bin/ls</strong></span>
</pre><p>The <code class="literal">wheel</code> group's policy is applied first, establishing the default behavior. Then our new directive uses the <code class="literal">NOPASSWD</code> tag to grant the user unauthenticated access to the <code class="literal">ls</code> command. The user will still need to provide their password for commands such as <code class="literal">mount</code> and <code class="literal">passwd</code> but won't need to provide it to list restricted directories.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec76"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on working with <code class="literal">sudo</code> to temporarily elevate an account's privileges:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">sudo</code> man page (<code class="literal">man 8 sudo</code>)</p></li><li style="list-style-type: disc"><p>The <code class="literal">sudoers</code> man page (<code class="literal">man 5 sudoers</code>)</p></li><li style="list-style-type: disc"><p>Code Snipcademy: Using <code class="literal">sudo</code> and <code class="literal">su</code> and their differences (<a class="ulink" href="https://code.snipcademy.com/tutorials/linux-command-line/permissions/sudo" target="_blank">https://code.snipcademy.com/tutorials/linux-command-line/permissions/sudo</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch03lvl1sec28"></a>Enforcing password restrictions</h2></div></div><hr /></div><p>A weak password can be one of the weakest security points of any system. Simple passwords are susceptible to brute-force attacks and long-lived passwords, if they are compromised, provide a wide window of opportunity for malicious activity. Because of this, it's important to ensure that your users choose sufficiently complex passwords and change them regularly. This recipe shows you how to strengthen your system's security by enforcing various restrictions on users' passwords. You'll learn how to specify the minimum complexity requirements for a password, how long before a password must be changed, and how to lock down an account after a number of failed login attempts.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec77"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system and administrative access, either provided by logging in with the <code class="literal">root</code> account or by using <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec78"></a>How to do it...</h3></div></div></div><p>Follow these steps to enforce password restrictions that will increase the security of your CentOS system:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>The parameters governing password aging are found in <code class="literal">/etc/login.defs</code>; open the file using your text editor of choice:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/login.defs</strong></span>
</pre></li><li><p>Locate the password aging controls section and update the value of <code class="literal">PASS_MAX_DAYS</code>, <code class="literal">PASS_MIN_DAYS</code>, <code class="literal">PASS_MIN_LEN</code>, and <code class="literal">PASS_WARN_AGE</code>:</p><pre class="programlisting">
<span class="strong"><strong>PASS_MAX_DAYS  90</strong></span>
<span class="strong"><strong>PASS_MIN_DAYS  0</strong></span>
<span class="strong"><strong>PASS_MIN_LEN   8</strong></span>
<span class="strong"><strong>PASS_WARN_AGE  15</strong></span>
</pre></li><li><p>Save your changes and close the file.</p></li><li><p>The values specified in <code class="literal">login.defs</code> will be applied to new accounts when they are created. Existing users must have their password parameters set separately using the <code class="literal">chage</code> command:</p><pre class="programlisting">
<span class="strong"><strong>chage --maxdays 90 --mindays 0 --warndays 15 tboronczyk</strong></span>
</pre></li><li><p>The parameters governing the acceptable complexity for passwords are found in <code class="literal">/etc/security/pwquality.conf</code>; open the file for editing:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/security/pwquality.conf</strong></span>
</pre></li><li><p>Uncomment the <code class="literal">minlen</code> value to specify the desired minimum password complexity plus 1. For example, an eight-character password consisting of all lowercase characters would require a <code class="literal">minlen</code> of <code class="literal">9</code>:</p><pre class="programlisting">
<span class="strong"><strong>minlen = 9</strong></span>
</pre></li><li><p>You may uncomment other values and set them as well if you like. Each value is preceded by a brief descriptive comment of what it does. To require a minimum number of characters to be from a certain class (uppercase, lowercase, digits, and other/special), specify the value as a negative number. For example, if passwords require at least one numeric digit and one uppercase character then both <code class="literal">dcredit</code> and <code class="literal">ucredit</code> would be set to <code class="literal">-1</code>:</p><div class="mediaobject"><img src="graphics/image_03_002.jpg" /><div class="caption"><p>Options for configuring your system's password complexity requirements are found in pwquality.conf</p></div></div></li><li><p>Save your changes and close the file.</p></li><li><p>Next we'll update PAM's <code class="literal">password-auth</code> and <code class="literal">system-auth</code> module configurations to lock out an account after a number of unsuccessful login-attempts. Open the file <code class="literal">/etc/pam.d/password-auth</code>:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/pam.d/password-auth</strong></span>
</pre></li><li><p>Update the group of <code class="literal">auth</code> lines at the beginning of the file to read as follows. The second and fourth lines have been added and include <code class="literal">pam_faillock</code> to the authentication stack:</p><pre class="programlisting">
<span class="strong"><strong>auth   required      pam_env.so</strong></span>
<span class="strong"><strong>auth   required      pam_faillock.so preauth silent audit  deny=3
       unlock_time=600</strong></span>
<span class="strong"><strong>auth   sufficient    pam_unix.so nullok try_first_pass</strong></span>
<span class="strong"><strong>auth   [default=die] pam_faillock.so authfail audit deny=3
       unlock_time=600</strong></span>
<span class="strong"><strong>auth   requisite     pam_succeed_if.so uid &gt;= 1000  quiet_success</strong></span>
<span class="strong"><strong>auth   required      pam_deny.so</strong></span>
</pre></li><li><p>Update the group of <code class="literal">account</code> lines to read as follows. The second line has been added to include <code class="literal">pam_faillock</code> to the account stack:</p><pre class="programlisting">
<span class="strong"><strong>account  required   pam_unix.so</strong></span>
<span class="strong"><strong>account  required   pam_faillock.so</strong></span>
<span class="strong"><strong>account  sufficient pam_localuser.com</strong></span>
<span class="strong"><strong>account  sufficient pam_succeed_if.so uid &lt; 1000 quiet</strong></span>
<span class="strong"><strong>account  required   pam_permit.so</strong></span>
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note18"></a>Note</h3><p>Be careful when updating the <code class="literal">password-auth</code> and <code class="literal">system-auth</code> files. The order in which modules are listed in a stack is significant!</p></div></li><li><p>Save your changes and close the file. Then repeat steps 9 to 11 with the file <code class="literal">/etc/pam.d/system-auth</code>.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec79"></a>How it works...</h3></div></div></div><p>Properly configuring the authentication requirements for local accounts is a bit of a fractured experience. First, there's the traditional Unix password files (<code class="literal">/etc/passwd</code> and <code class="literal">/etc/groups</code>) and the <code class="literal">shadow-utils</code> package, which adds shadowing support (<code class="literal">/etc/shadow</code>). Together, these form the core database for local account credentials. In addition, similar to most other modern Linux systems, CentOS uses PAM, a collection of pluggable authentication modules. The PAM stack is configured by default to lookup account information in the shadow file, but it also provides additional functionality that PAM-aware programs can leverage, such as password-strength checking. As an administrator, you're responsible for configuring these services so that they work properly in tandem and operate within the acceptable security guidelines set by your organization.</p><p>In this recipe, we first updated the password aging related controls found in <code class="literal">/etc/logins.def</code>:</p><pre class="programlisting">
<span class="strong"><strong>PASS_MAX_DAYS  90</strong></span>
<span class="strong"><strong>PASS_MIN_DAYS  0</strong></span>
<span class="strong"><strong>PASS_MIN_LEN   8</strong></span>
<span class="strong"><strong>PASS_WARN_AGE  15</strong></span>
</pre><p><code class="literal">PASS_MAX_DAYS</code> defines how much time can pass before a password must be changed. By setting the value to <code class="literal">90</code>, a user must change their password at least once every three months (90 days). <code class="literal">PASS_MIN_DAYS</code> specifies how many days a user must wait to change a new password. Since this value is 0, a user can change their password any time they want-even several times a day if they like. <code class="literal">PASS_WARN_AGE</code> defines how many days in advance a user will be notified of their password's pending expiration as <code class="literal">PASS_MAX_DAYS</code> approaches.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note19"></a>Note</h3><p><code class="literal">PASS_MIN_LEN</code> is supposed to set the minimum password length, but you'll find PAM's password complexity requirements supersede this, making the setting pretty much worthless.</p></div><p>Utilities such as <code class="literal">useradd</code> use these settings as the defaults when creating entries in the password and shadow files. They aren't applied retroactively to existing users so we need to use <code class="literal">chage</code> to update their accounts:</p><pre class="programlisting">
<span class="strong"><strong>chage --maxdays 90 --mindays 0 --warndays 15 tboronczyk</strong></span>
</pre><p><code class="literal">chage</code> can set the minimum and maximum age of a user's password and the notification window for pending expirations, but note the absence of a minimum length requirement.</p><p>We can also use <code class="literal">chage</code> to make a user's password expire immediately so that they must specify a new one the next time they log in. To do so, we provide the <code class="literal">--lastdays</code> argument with a value of 0:</p><pre class="programlisting">
<span class="strong"><strong>chage --lastdays 0 tboronczyk</strong></span>
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip20"></a>Note</h3><p>If you have more than a handful of accounts, you may want to automate using <code class="literal">chage</code> with some basic shell scripting. Here's a series of commands piped together that update all of the existing user accounts in an automated fashion:</p><pre class="programlisting"><span class="strong"><strong>getent shadow | awk -F : 'substr($2, 0, 1) == "$" { print $1 }' | xargs -n 1 chage --maxdays 90 --mindays 0 Â </strong></span>
<span class="strong"><strong>--warndays 15</strong></span>
</pre><p>This works by retrieving the contents of the shadow file and using <code class="literal">awk</code> to split each record using <code class="literal">:</code> as the field separator. <code class="literal">awk</code> looks at the value in the second field (the encrypted password) to see if it begins with <code class="literal">$</code>, indicating the account has a password, to filter out disabled accounts and system accounts without a password. The username from each matching record is then piped to <code class="literal">xargs</code> which then feeds the names one at a time to <code class="literal">chage</code>.</p></div><p>As the PAM module <code class="literal">pam_pwquality</code> checks the complexity of passwords, we specify our password complexity requirements in the module's configuration file, <code class="literal">/etc/security/pwquality.conf</code>. It gauges the quality of a password using a credit system where each character credits a point towards the password's total score. This score then must meet or exceed the value we gave for <code class="literal">minlen</code>.</p><p>The page at <a class="ulink" href="http://wpollock.com/AUnix2/PAM-Help.htm" target="_blank">http://wpollock.com/AUnix2/PAM-Help.htm</a> has a good explanation of how <code class="literal">pam_pwquality</code> calculates a password's complexity. It explains the algorithm as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Add one for each character in the password regardless of the type of the character</p></li><li style="list-style-type: disc"><p>Add one to that for each lowercase letter used, up to a maximum of <code class="literal">lcredit</code></p></li><li style="list-style-type: disc"><p>Add one to that for each uppercase letter used, up to a maximum of <code class="literal">ucredit</code></p></li><li style="list-style-type: disc"><p>Add one to that for each digit used, up to a maximum of <code class="literal">dcredit</code></p></li><li style="list-style-type: disc"><p>Add one to that for each symbol used, up to a maximum of <code class="literal">ocredit</code></p></li></ul></div><p>The page also presents a few complexity calculations for different passwords and is worth reading.</p><p>Then we updated the <code class="literal">password-auth</code> and <code class="literal">system-auth</code> files to lock a user's account after three unsuccessful login attempts. Different authentication stacks need to be configured because different login methods will invoke a different authentication stack (that is, a logging in over SSH as opposed to logging in locally):</p><pre class="programlisting">
<span class="strong"><strong>auth   required      pam_env.so</strong></span>
<span class="strong"><strong>auth   required      pam_faillock.so preauth silent audit deny=3
    unlock_time=600</strong></span>
<span class="strong"><strong>auth   sufficient    pam_unix.so nullok try_first_pass</strong></span>
<span class="strong"><strong>auth   [default=die] pam_faillock.so authfail audit deny=3
    unlock_time=600</strong></span>
<span class="strong"><strong>auth   requisite     pam_succeed_if.so uid &gt;= 1000 quiet_success</strong></span>
<span class="strong"><strong>auth   required      pam_deny.so</strong></span>
<span class="strong"><strong>account  required   pam_unix.so</strong></span>
<span class="strong"><strong>account  required   pam_faillock.so</strong></span>
<span class="strong"><strong>account  sufficient pam_localuser.com</strong></span>
<span class="strong"><strong>account  sufficient pam_succeed_if.so uid &lt; 1000 quiet</strong></span>
<span class="strong"><strong>account  required   pam_permit.so</strong></span>
</pre><p>The <code class="literal">pam_faillock</code> module is added at multiple positions in the authentication stack. The first appearance in the <code class="literal">auth</code> block performs a precheck (<code class="literal">preauth</code>) to see if the account is already locked out The second appearance tallies the failed attempt (<code class="literal">authfail</code>). The argument specified by <code class="literal">deny</code> is the number of failed attempts permitted before locking the account. <code class="literal">unlock_time</code> specifies how much time the module should wait (in seconds) before unlocking the account so that another login attempt can be made. As the example specifies 600 seconds, a user will have to wait 10 minutes for the lockout to expire. The module's appearance in the <code class="literal">account</code> block denies authentication to the locked account.</p><p>The <code class="literal">faillock</code> command is used to view the number of failed login attempts and to unlock an account. To see the failed attempts, invoke the command using the <code class="literal">--user</code> argument to specify the account's username:</p><pre class="programlisting">
<span class="strong"><strong>faillock --user tboronczyk</strong></span>
</pre><p>To manually unlock the account before <code class="literal">unlock_time</code> has elapsed, invoke the command with the <code class="literal">--reset</code> argument:</p><pre class="programlisting">
<span class="strong"><strong>faillock --user tboronczyk --reset</strong></span>
</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec80"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on how user accounts are authenticated and how to enforce password restrictions:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">chage</code> man page (<code class="literal">man 1 chage</code>)</p></li><li style="list-style-type: disc"><p>The shadow file man page (<code class="literal">man 5 shadow</code>)</p></li><li style="list-style-type: disc"><p>The <code class="literal">pam_faillock</code> man page (<code class="literal">man 8 pam_faillock</code>)</p></li><li style="list-style-type: disc"><p>Linux Documentation Project: Putting the Shadow suite to use (<a class="ulink" href="http://tldp.org/HOWTO/Shadow-Password-HOWTO-7.html" target="_blank">http://tldp.org/HOWTO/Shadow-Password-HOWTO-7.html</a>)</p></li><li style="list-style-type: disc"><p>The Linux-PAM System Administrator's Guide (<a class="ulink" href="http://www.linux-pam.org/Linux-PAM-html/Linux-PAM_SAG.html" target="_blank">http://www.linux-pam.org/Linux-PAM-html/Linux-PAM_SAG.html</a>
)</p></li><li style="list-style-type: disc"><p>RHEL Security Guide: Password Security (<a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html-single/Security_Guide/index.html#sec-Password_Security" target="_blank">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html-single/Security_Guide/index.html#sec-Password_Security</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch03lvl1sec29"></a>Setting default permissions for new files and directories</h2></div></div><hr /></div><p>Linux's permissions system governs whether a user can enter a directory or read, write, or execute a file. By setting the permission bits on files and directories, access can be granted or revoked to different users and groups of users. However, it's possible for a user to create a file and expect others in their group to access it, but the initial file permissions prevents this. To help avoid this situation, this recipe teaches you how to set the default permissions for new files and directories by specifying a mask value.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec81"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system and administrative access, either provided by logging in with the <code class="literal">root</code> account or by using <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec82"></a>How to do it...</h3></div></div></div><p>Follow these steps to specify the default permissions for new files and directories:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>To set the mask value globally, open the <code class="literal">/etc/profile</code> file:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/profile</strong></span>
</pre></li><li><p>At the end of the file, add the following directive (adjusting the value as desired). When finished, save and close the file:</p><pre class="programlisting">
<span class="strong"><strong>umask 0007</strong></span>
</pre></li><li><p>To override the global mask and set the mask on a per-user basis, open the user's <code class="literal">~/.bashrc</code> file:</p><pre class="programlisting">
<span class="strong"><strong>vi /home/tboronczyk/.bashrc</strong></span>
</pre></li><li><p>At the end of the file, add the following (again adjusting the value as necessary). Then save and close the file:</p><pre class="programlisting">
<span class="strong"><strong>umask 0007</strong></span>
</pre></li><li><p>To temporarily set the mask only for the duration of your session, execute the <code class="literal">umask</code> command at the command prompt:</p><pre class="programlisting">
<span class="strong"><strong>umask 0007</strong></span>
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note21"></a>Note</h3><p>You can execute <code class="literal">umask</code> at the command prompt without providing a mask value to see what your current mask value is.</p></div></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec83"></a>How it works...</h3></div></div></div><p>This recipe presents three ways a mask value can be set, which is responsible for determining what permissions are set on newly created files and directories. However, to understand how the mask works, you need to understand the traditional read, write, and execute permission system.</p><p>Directories and files in the Linux file system are owned by a user and group, and they are assigned a set of permissions that describe who can access it. When a user tries to access a resource, the system compares its ownership information with requesting user and determines if the requested access should be granted according to the permissions.</p><p>The three permissions are read, write, and execute. Since access to each can be only one of the two values (allowed or disallowed), and because such binary options can be represented with 1 for yes and 0 for no, a sequence of 1's and 0's can be viewed as a bit pattern where each permission is given a different position in the sequence. The following figure shows how a list of binary yes's and no's can be converted to a human-friendly value:</p><div class="mediaobject"><img src="graphics/image_03_003.jpg" /><div class="caption"><p>Binary values represent whether a user has permission to access a resource</p></div></div><p>From the file or directory's perspective, there are three types of users. The user is either the file's owner, a member of the owning group, or neither (everyone else).</p><p>The resource is given a set of permissions for each type of users, as shown in the following figure:</p><div class="mediaobject"><img src="graphics/image_03_004.jpg" /><div class="caption"><p>The full permission set of a file or directory includes the three types of users</p></div></div><p>This is the logic behind the traditional Unix permission system, but don't worry if this seems intimidating at first. Determining the permissions for a class of users is really just a matter of addition. Start with 0 for no access at all. To allow read access, add <code class="literal">4</code>. For write access, add <code class="literal">2</code>. For execute, add <code class="literal">1</code>. These values come from viewing the value of the permission in the bit string as a binary number, but they are easy enough to memorize. Thus, to allow all access, we add <code class="literal">4</code> + <code class="literal">2</code> + <code class="literal">1</code> which equals <code class="literal">7</code>. To allow only read and execute access, <code class="literal">
4
</code>Â + <code class="literal">1</code> equals <code class="literal">5</code>. The more you work with permissions, the more you'll come to recognize certain combinations automatically.</p><p>When a file is created, the system begins with <code class="literal">666</code> as a default value, giving read and write access to all three classes of users. Directories start with <code class="literal">777</code> since the executable permission on a directory is what allows a user to traverse into it. The system then subtracts the creating user's umask value and the result determines what permissions will be assigned to the resource when it's created.</p><p>Suppose we create a new directory and our umask value is <code class="literal">0027</code>. The system subtracts <code class="literal">7</code> from the all other users' field and <code class="literal">2</code> from the group's field. <code class="literal">7</code>Â -Â <code class="literal">7</code> is <code class="literal">0</code>, and <code class="literal">7</code>Â -Â <code class="literal">2</code> is <code class="literal">5</code>, so the default permission for a new directory is <code class="literal">750</code>.</p><p>Because we start with one bit less in the default value for files, it's possible to end up with a negative permission number. If umask masks out all of the permissions using the value <code class="literal">7</code>, but the starting value is <code class="literal">666</code> for files, <code class="literal">6</code>Â -Â <code class="literal">7</code> gives <code class="literal">-1</code>. It doesn't make sense to go beyond 0 so the system treats it as 0. So, a mask of <code class="literal">0027</code> gives us <code class="literal">650</code> for the file's permissions.</p><p>The <code class="literal">/etc/profile</code> and <code class="literal">~/.bashrc</code> files are executed whenever a user logs in to configure their session's environment. Calling <code class="literal">umask</code> in <code class="literal">profile</code> has the effect of setting the mask for all users. <code class="literal">.bashrc</code> is executed after <code class="literal">profile</code> and is user specific; so, its call to <code class="literal">umask</code> overrides the previously set value, setting the mask for that specific user.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec84"></a>See also</h3></div></div></div><p>Refer to the following resources for more information about umask:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Wikipedia: Umask (<a class="ulink" href="http://unix.stackexchange.com/questions/102075/why-are-666-the-default-file-creation-permissions" target="_blank">http://unix.stackexchange.com/questions/102075/why-are-666-the-default-file-creation-permissions</a>)</p></li><li style="list-style-type: disc"><p>Why are 666 the default file creation permissions? (<a class="ulink" href="https://en.wikipedia.org/wiki/Umask" target="_blank">https://en.wikipedia.org/wiki/Umask</a>)</p></li><li style="list-style-type: disc"><p>Controlling file permissions with umask (<a class="ulink" href="http://linuxzoo.net/page/sec_umask.html" target="_blank">http://linuxzoo.net/page/sec_umask.html</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch03lvl1sec30"></a>Running binaries as a different user</h2></div></div><hr /></div><p>Every program on CentOS runs within the environment of a user account regardless of whether the program is executed by a user or run as an automated system process. However, sometimes we want the program to run with different restrictions and access those rights the account is allowed. For example, a user should be able to use the <code class="literal">passwd</code> command to reset their password. The command needs write access to <code class="literal">/etc/passwd</code> but we don't want the user running the command to have such access. This recipe teaches you how setting a program's SUID and SGID permission bits allows it to execute within the environment of a different user.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec85"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or by the use of <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec86"></a>How to do it...</h3></div></div></div><p>Follow these steps to allow a program to execute as a different user:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Identify the file's owner and group details using the <code class="literal">ls</code> command. The third field in its output lists the owner and the fourth field lists the group:</p><pre class="programlisting">
<span class="strong"><strong>ls -l myscript.sh</strong></span>
</pre><div class="mediaobject"><img src="graphics/image_03_005.jpg" /><div class="caption"><p>The -l option displays the file listing in long-form which includes ownership information</p></div></div></li><li><p>If necessary, change the file's ownership using <code class="literal">chown</code> so that the owner is the one whose environment you want the script to execute in:</p><pre class="programlisting">
<span class="strong"><strong>chown newuser:newgroup myscript.sh</strong></span>
</pre></li><li><p>Set the SUID bit to allow the program to run as if it were invoked by its owner:</p><pre class="programlisting">
<span class="strong"><strong>chmod u+s myscript.sh</strong></span>
</pre></li><li><p>Set the SGID bit to allow the program to run as if it were invoked by a member of its group:</p><pre class="programlisting">
<span class="strong"><strong>chmod g+s myscript.sh</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec87"></a>How it works...</h3></div></div></div><p>When a file's SUID and SGID bits are set, the program runs within the environment of its owner or group instead of the user who invoked it. This is usually done with administrative programs that an unprivileged user should have access to but the program itself requires administrative permissions to function properly.</p><p>The bits are set using <code class="literal">chown</code> with <code class="literal">u</code> set to target the SUID bit. A script with the SUID bit set will execute with the privileges its owner has. <code class="literal">g</code> is set to target the SGID bit which allows the script to execute with the privileges of a member of its group. Intuitively, <code class="literal">+</code> sets the bit and <code class="literal">-</code> removes the bit, later allowing the program to execute in the invoking user's environment.</p><pre class="programlisting">
<span class="strong"><strong>chmod u-s myscript.sh</strong></span>
<span class="strong"><strong>chmod g-s myscript.sh</strong></span>
</pre><p>SUID and SGID may be set numerically as well-the value for SUID is 4 and the value for SGID is 2. These can be summed together and appear as the left-most digit in the numeric permission value. For example, the following sets the SUID bit, the read, write, and execute bits for the file's owner; read, write, and execute bits for group members; and read and execute bits for everyone else:</p><pre class="programlisting">
<span class="strong"><strong>chmod 4775 myscript.sh</strong></span>
</pre><p>However, the numeric approach requires you to specify all of the file's permissions. If you need to do that and want to set the SUID or SGID bits at the same time, it's not a problem. Otherwise, it's probably more convenient to use <code class="literal">+</code> or <code class="literal">-</code> to add or subtract the indented bits.</p><p>Setting bits using mnemonic characters with <code class="literal">chmod</code> also works with the standard permissions. <code class="literal">u</code>, <code class="literal">g</code>, and <code class="literal">a</code> target the desired bits for its owner (u for user), group (g for group), and everybody else (a for all). The characters for read access is <code class="literal">r</code>, write <code class="literal">w</code>, and execute <code class="literal">x</code>. Here are a few examples using mnemonic characters:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Allow the file's owner to execute the file:</p><pre class="programlisting">
<span class="strong"><strong>chmod o+x myscript.sh</strong></span>
</pre></li><li style="list-style-type: disc"><p>Allow a group member to read the file:</p><pre class="programlisting">
<span class="strong"><strong>chmod g+r myfile.txt</strong></span>
</pre></li><li style="list-style-type: disc"><p>Prevent everyone who is not the owner or a member of the group from writing to the file:</p><pre class="programlisting">
<span class="strong"><strong>chmod a-w readonly.txt</strong></span>
</pre></li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec88"></a>See also</h3></div></div></div><p>Refer to the following resource for more information about <code class="literal">chmod</code> and setting the SUID and SGID bits.</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">chmod</code> man page (<a class="ulink" href="https://linux.die.net/man/1/chmod" target="_blank">https://linux.die.net/man/1/chmod</a>)</p></li><li style="list-style-type: disc"><p>How to set the SetUID and SetGID bit for files in Linux and Unix (<a class="ulink" href="http://linuxg.net/how-to-set-the-setuid-and-setgid-bit-for-files-in-linux-and-unix/" target="_blank">http://linuxg.net/how-to-set-the-setuid-and-setgid-bit-for-files-in-linux-and-unix/</a>)</p></li><li style="list-style-type: disc"><p>Wikipedia: Setuid (<a class="ulink" href="https://en.wikipedia.org/wiki/Setuid" target="_blank">https://en.wikipedia.org/wiki/Setuid</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch03lvl1sec31"></a>Working with SELinux for greater security</h2></div></div><hr /></div><p>This recipe shows you the basics of working with Security-Enhanced Linux (SELinux), a kernel extension that adds an extra layer of security to your CentOS installation. Because it runs at the kernel level, SELinux can control access beyond the reach of the traditional filesystem permissions, including restricting running processes and other resources.</p><p>Unfortunately, some administrators disable SELinux because admittedly it can be a source of frustration. They're comfortable with the user/group/all and read/write/execute approach and suddenly find themselves at a loss when SELinux blocks something that seems as it should be available. However, the extra layer of security that SELinux provides is worth the effort of investigating such problems and adjusting its policies if necessary.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec89"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>. The demonstrated commands come from the <code class="literal">policycoreutils-python</code> package, so be sure to install the package first using the <code class="literal">yum install policycoreutils-python</code> command.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec90"></a>How to do it...</h3></div></div></div><p>This collection of commands will introduce you to working with SELinux in various contexts, which are as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Use <code class="literal">sestatus</code> to verify whether SELinux is enabled and to see what policy is loaded:</p><div class="mediaobject"><img src="graphics/image_03_006.jpg" /><div class="caption"><p>SELinux is enabled on this system and currently enforcing the targeted policy</p></div></div></li><li style="list-style-type: disc"><p>Use <code class="literal">id -Z</code> to see which SELinux account, role, and domain your account is mapped to.</p></li><li style="list-style-type: disc"><p>Use <code class="literal">ls -Z</code> to see the security context of a file or directory:</p><div class="mediaobject"><img src="graphics/image_03_007.jpg" /><div class="caption"><p>Both id and ls can display security context related information</p></div></div></li><li style="list-style-type: disc"><p>Use <code class="literal">semodule -l</code> to review the list of loaded policy modules in the current policy. The output can be quite lengthy and you may find it beneficial to paginate it using <code class="literal">less</code> or <code class="literal">more</code>:</p><pre class="programlisting">
<span class="strong"><strong>semodule -l | less</strong></span>
</pre></li><li style="list-style-type: disc"><p>Use <code class="literal">semodule -d</code> and provide a module's name to disable a specific policy module:</p><pre class="programlisting">
<span class="strong"><strong>semodule -d mysql</strong></span>
</pre></li></ul></div><p>You can verify that the module is disabled by reviewing the list of policy modules with <code class="literal">semodule -l</code> again. The word <code class="literal">disabled</code> should appear to the right of the module name.</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Use <code class="literal">semodule -e</code> to enable a specific policy module:</p><pre class="programlisting">
<span class="strong"><strong>semodule -e mysql</strong></span>
</pre></li><li style="list-style-type: disc"><p>Use <code class="literal">semanage boolean</code> to selectively enable or disable features of an active module. The <code class="literal">-l</code> argument outputs list of available features with their current and default values:</p><pre class="programlisting">
<span class="strong"><strong>semanage boolean -l | less</strong></span>
</pre></li><li style="list-style-type: disc"><p>Use <code class="literal">-m</code> followed by <code class="literal">--on</code> or <code class="literal">--off</code> and the feature name to affect the desired feature:</p><pre class="programlisting">
<span class="strong"><strong>semanage boolean -m --on deny_ptrace</strong></span>
</pre><div class="mediaobject"><img src="graphics/image_03_008.jpg" /><div class="caption"><p>semanage boolean -l shows which features of a policy module can be toggled on and off</p></div></div></li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec91"></a>How it works...</h3></div></div></div><p>SELinux views the system in terms of objects, subjects, domains, and types. An object is any resource whether it's a file, directory, network port, memory space, and so on. A subject is anything that acts on an object, such as a user or a running program. A domain is the environment in which the subject operates, or in other words the collection of resources available to the subject. Types are simply categories that identify the purpose of an object. Within this framework, SELinux's security policies organize objects into roles and roles into domains.</p><p>Domains are granted or denied access to types. A user is allowed to open a specific file, for example, because they belong to a role in a domain that has permission to open that type of object. To decide whether a user has the ability to do something, SELinux maps the system's user accounts to one of the users (and roles and domains) in its own database. By default, accounts map to SELinux's <code class="literal">unconfined_u</code> user which is assigned the <code class="literal">unconfined_r</code> role and operates in the <code class="literal">unconfined_t</code> domain.</p><p>This recipe showed us that <code class="literal">id -Z</code> can be used to retrieve the user, role, and domain that our user account maps to and <code class="literal">ls -Z</code> retrieves a file's security labeling. Of course, the values displayed by the commands are different depending on the file. For example, the binary file <code class="literal">/bin/cp</code> executes as the <code class="literal">system_u</code> user, is a member of the <code class="literal">object_r</code> role, and is in the <code class="literal">bin_t</code> domain.</p><p>The <code class="literal">sestatus</code> command outputs basic status information about SELinux, such as whether it's enabled, enforcing its policies, and how it's enforcing them. SELinux can run in enforcing mode, in which it actively enforces its policies, or in permissive mode, in which it will not prevent any actions but will log a message if an action would have been prevented by the policy. You can set SELinux to permissive mode with <code class="literal">setenforce 0</code>.</p><p>The <code class="literal">semodule</code> command is used to manage policy modules. For the sake of keeping everything organized, a policy is a collection of modules and each module is concerned with a specific program or activity. There are dedicated modules for the most common applications, such as MySQL, Apache HTTP server, and SSHd, which describe which domains have access to which types. This recipe showed us how we can enable or disable these modules using the <code class="literal">-e</code> and <code class="literal">-d</code> arguments to <code class="literal">semodule</code>:</p><pre class="programlisting">
<span class="strong"><strong>semodule -d mysql</strong></span>
<span class="strong"><strong>semodule -e mysql</strong></span>
</pre><p>Finally, the recipe presented the <code class="literal">semanage</code> command, which manages various aspects of SELinux. We saw its <code class="literal">boolean</code> subcommand, using it to list the specific protections we can toggle on or off.</p><p>It probably goes without saying that while SELinux does a great job in protecting your system by adding an extra layer of access controls, fully understanding it and writing custom policies is a serious undertaking. Entire books have been written on this subject and there is a plethora of resources available online. The SELinux Users and Administrator's Guide that is part of the Red Hat Enterprise Linux 7 documentation and a three-part series introducing the basic concepts of SELinux by DigitalOcean are great starting points, and I've listed their URLs here. I also recommend the book <span class="emphasis"><em>SELinux by Example: Using Security Enhanced Linux</em></span> by David Caplan, Karl MacMillan, and Frank Mayer.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl2sec92"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on working with and better understanding SELinux:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Wikipedia: Security-Enhanced Linux (<a class="ulink" href="https://en.wikipedia.org/wiki/Security-Enhanced_Linux" target="_blank">https://en.wikipedia.org/wiki/Security-Enhanced_Linux</a>)</p></li><li style="list-style-type: disc"><p>SELinux Project Wiki (<a class="ulink" href="http://selinuxproject.org/page/Main_Page" target="_blank">http://selinuxproject.org/page/Main_Page</a>)</p></li><li style="list-style-type: disc"><p>RHEL7 SELinux User's and Administrator's Guide (<a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/SELinux_Users_and_Administrators_Guide/part_I-SELinux.html" target="_blank">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/SELinux_Users_and_Administrators_Guide/part_I-SELinux.html</a>)</p></li><li style="list-style-type: disc"><p>CentOS Wiki: SELinux (<a class="ulink" href="http://wiki.centos.org/HowTos/SELinux" target="_blank">http://wiki.centos.org/HowTos/SELinux</a>)</p></li><li style="list-style-type: disc"><p>An Introduction to SELinux on CentOS 7 (<a class="ulink" href="http://www.digitalocean.com/community/tutorials/an-introduction-to-selinux-on-centos-7-part-1-basic-concepts" target="_blank">http://www.digitalocean.com/community/tutorials/an-introduction-to-selinux-on-centos-7-part-1-basic-concepts</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="chapter" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="ch04"></a>ChapterÂ 4.Â Software Installation Management</h2></div></div></div><p>This chapter contains the following recipes:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Registering the EPEL and Remi repositories</p></li><li style="list-style-type: disc"><p>Prioritizing repositories using the Priorities plugin</p></li><li style="list-style-type: disc"><p>Automating software updates with <code class="literal">yum-cron</code></p></li><li style="list-style-type: disc"><p>Verifying installed RPM packages</p></li><li style="list-style-type: disc"><p>Compiling a program from source</p></li></ul></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec32"></a>Introduction</h2></div></div><hr /></div><p>This chapter presents recipes for managing the installation of software on your CentOS system. You'll learn how to add new package repositories to provide a wider selection of software than what's found in the main CentOS repositories, and also how to prioritize the repositories to control those from which a package is installed. You'll also learn how to automate software updates to keep up with the latest security patches and bug fixes, and how to verify the installed packages to make sure a malicious user hasn't tampered with your software. Finally, you'll learn a skill that's slowly fading but is essential if you want to modify the open source software on your system: how to compile software from source.</p></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec33"></a>Registering the EPEL and Remi repositories</h2></div></div><hr /></div><p>A clean CentOS installation will have the main supported repositories enabled, from which we can install a wide variety of software. We can also register third-party repositories to make additional (or newer) software available to us. This recipe teaches you how to add two such repositories, specifically the popular <span class="strong"><strong>Extra Packages for Enterprise Linux</strong></span> (<span class="strong"><strong>EPEL</strong></span>) and Remi repositories.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec93"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec94"></a>How to do it...</h3></div></div></div><p>To register the EPEL repository, install the epel-release package:</p><pre class="programlisting">
<span class="strong"><strong>yum install epel-release</strong></span>
</pre><p>To register and enable the REMI repository, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Download the repository's configuration package:</p><pre class="programlisting">
<span class="strong"><strong>curl -O http://rpms.famillecollet.com/enterprise/remi-release-7.rpm</strong></span>
</pre></li><li><p>Install the downloaded package:</p><pre class="programlisting">
<span class="strong"><strong>yum install remi-release-7.rpm</strong></span>
</pre></li><li><p>Delete the file since it's no longer needed:</p><pre class="programlisting">
<span class="strong"><strong>rm remi-release-7.rpm</strong></span>
</pre></li><li><p>Open the Remi repository's configuration file:</p><pre class="programlisting">
<span class="strong"><strong>      vi /etc/yum.repos.d/remi.repo
</strong></span>
</pre></li><li><p>Locate the <code class="literal">enabled</code> option in the <code class="literal">[remi]</code> section and change it's value to <code class="literal">1</code> to enable it:</p><pre class="programlisting">
<span class="strong"><strong>enabled=1</strong></span>
</pre></li><li><p>Save your changes and close the file.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec95"></a>How it works...</h3></div></div></div><p>The EPEL repository hosts software packages that complement those in the official CentOS repositories. It can be automatically configured by installing the <code class="literal">epel-release</code> package available in the official repositories:</p><pre class="programlisting">
<span class="strong"><strong>yum install epel-release</strong></span>
</pre><p>Remi is a popular third-party repository providing newer versions of software found in the official repositories. We downloaded the configuration package for the repository from the project's server using <code class="literal">curl</code>:</p><pre class="programlisting">
<span class="strong"><strong>curl -O http://rpms.famillecollet.com/enterprise/remi-release-7.rpm</strong></span>
</pre><p>We used the <code class="literal">-O</code> argument (an uppercase letter <code class="literal">O</code>, not zero) so that the file will be saved to disk, otherwise its contents would be dumped to the screen. The recipe didn't identify a specific directory you should download the file to. You can download it to your <code class="literal">home</code> directory, or even <code class="literal">/tmp</code> if you like, since the file isn't needed after the package is installed.</p><p>After the package is downloaded, we can install it using <code class="literal">yum</code>:</p><pre class="programlisting">
<span class="strong"><strong>yum install remi-release-7.rpm</strong></span>
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note22"></a>Note</h3><p>Many times there are alternative ways to accomplish the same task. For instance, the <code class="literal">rpm</code> command can also be used to install the package after it is downloaded:</p><p>
<span class="strong"><strong><code class="literal">
rpm -iv remi-release-7.rpm</code></strong></span>
</p><p>The <code class="literal">-i</code> argument installs the package and <code class="literal">-v</code> instructs <code class="literal">rpm</code> to be verbose in its output so we can see it's activities.</p></div><p>The <code class="literal">remi-release</code> package installs the configurations for three Remi repositories: the Remi, Safe Remi, and Remi's PHP 7 repositories. Safe Remi is enabled by default because its packages are considered safe to use with the official CentOS-Base repository. However, the Remi repository is disabled so we need to edit <code class="literal">/etc/yum.repos.d/remi.repo</code>:</p><div class="mediaobject"><img src="graphics/image_04_001.jpg" /><div class="caption"><p>The Remi repository is enabled by updating its configuration file</p></div></div><p>REMI is popular for providing newer releasesÂ of PHP. If you want to upgrade your existing PHP installation with a version found in Remi you canÂ enableÂ the desired section in <code class="literal">remi.repo</code> or in <code class="literal">remi-php70.repo</code>.</p><p>After you've installed the EPEL repository and installed and enabled the Remi repository, you can ask yum to list the available repositories. The EPEL and Remi repositories should appear in its output:</p><pre class="programlisting">
<span class="strong"><strong>yum repolist</strong></span>
</pre><div class="mediaobject"><img src="graphics/image_04_002.jpg" /><div class="caption"><p>The EPEL and Remi repositories are enabled and ready to go!</p></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip23"></a>Note</h3><p>Remi uses the same package names as those found in the official CentOS repositories. Like Remi, the IUS repository provides newer versions of software found in the official repositories, but uses different package names. Some managed service providers recommend using IUS over Remi because they update servers nightly and the differing package names help prevent unplanned upgrades. If you're contracted with such a provider and not using the Priorities plugin (discussed in the next recipe), be sure to heed their advice. More information on IUS can be found at their website, <a class="ulink" href="https://ius.io/" target="_blank">https://ius.io/</a>.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec96"></a>See also</h3></div></div></div><p>For more information on the EPEL and Remi repositories, refer to the following resources:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Fedora Project: EPEL (<a class="ulink" href="http://fedoraproject.org/wiki/EPEL" target="_blank">http://fedoraproject.org/wiki/EPEL</a>)</p></li><li style="list-style-type: disc"><p>Remi's RPM repository (<a class="ulink" href="http://rpms.famillecollet.com/" target="_blank">http://rpms.famillecollet.com/</a>)</p></li><li style="list-style-type: disc"><p>Install EPEL and additional repositories on CentOS and Red Hat (<a class="ulink" href="http://www.rackspace.com/knowledge_center/article/install-epel-and-additional-repositories-on-centos-and-red-hat" target="_blank">http://www.rackspace.com/knowledge_center/article/install-epel-and-additional-repositories-on-centos-and-red-hat</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec34"></a>Prioritizing repositories using the Priorities plugin</h2></div></div><hr /></div><p>Although package managers make installing and updating software an almost trivial task, there can still be some pain points if we're not careful. For example, we can configure multiple repositories, including third-party repositories not maintained by CentOS, and the version of a package in one repository can conflict with the same in another. This recipe uses the Priorities plugin to prioritize the repositories we use to help avoid such pitfalls.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec97"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec98"></a>How to do it...</h3></div></div></div><p>Follow these steps to prioritize which repositories <code class="literal">yum</code> downloads software from:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Open the <code class="literal">/etc/yum.conf</code> file with your text editor. Locate the <code class="literal">plugins</code> option and verify that its value is set to <code class="literal">1</code> to enable plugin support. Update the value if necessary:</p><pre class="programlisting">
<span class="strong"><strong>plugins = 1</strong></span>
</pre></li><li><p>Install the <code class="literal">yum-plugin-priorities</code> package:</p><pre class="programlisting">
<span class="strong"><strong>yum install yum-plugin-priorities</strong></span>
</pre></li><li><p>To set a repository's priority, open its respective configuration file found under <code class="literal">/etc/yum.repos.d</code>. Add the <code class="literal">priority</code> option as a new entry within each desired section:</p><pre class="programlisting">
<span class="strong"><strong>priority=10</strong></span>
</pre></li><li><p>When you're finished, save and close the repository's configuration file.</p><div class="mediaobject"><img src="graphics/image_04_003.jpg" /><div class="caption"><p>The CentOS-Base repository is given a relatively high priority for base packages</p></div></div></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec99"></a>How it works...</h3></div></div></div><p>In this recipe, we installed the Priorities plugin and prioritized our repositories by updating their configuration files. By prioritizing one repository over another, we can more easily control the packages and software versions installed on our system.</p><p>First, we checked to make sure Yum's plugin support is enabled. We opened its configuration file at <code class="literal">/etc/yum.conf</code> and verified the value of the <code class="literal">plugins</code> option:</p><pre class="programlisting">
<span class="strong"><strong>plugins = 1</strong></span>
</pre><p>Next, we installed the <code class="literal">yum-plugin-priorities</code> package:</p><pre class="programlisting">
<span class="strong"><strong>yum install yum-plugin-priorities</strong></span>
</pre><p>Priorities comes with its own minimal configuration file at <code class="literal">/etc/yum/plugins/ priorities.conf</code>. There, the <code class="literal">enabled</code> option let's us toggle whether the plugin is active or not. This means we can prioritize the repositories as we like, but temporarily disable prioritization for any reason without removing and then re-adding priority values in the repositories' configuration files:</p><pre class="programlisting">
<span class="strong"><strong>enabled = 1</strong></span>
</pre><p>The last step is to edit the repositories' configuration files found in the <code class="literal">/etc/ yum.repos.d</code> directory. Each repository has its own file, for example, the CentOS-Base repository's file is <code class="literal">/etc/yum.repos.d/CentOS-Base.repo</code>, which configures details about connections and security keys for each channel. To prioritize our repositories, we simply open the desired files and add a new line for the <code class="literal">priority</code> option in the desired sections:</p><pre class="programlisting">
<span class="strong"><strong>priority = 10</strong></span>
</pre><p>Priorities are assigned as a number in the range of <code class="literal">1</code> to <code class="literal">99</code>, whereÂ <code class="literal">1</code> is the highest priority and <code class="literal">99</code> is the lowest priority. Any repository or channel we don't explicitly set a priority for will default to priority <code class="literal">99</code>. Repositories that are meant to work together (like EPEL and Remi) can be assigned the same priority.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note24"></a>Note</h3><p>Don't use consecutive priority numbers, like 1, 2, 3.... Setting priorities as multiples of 5 or 10, for exampleÂ 5, 10, 15... or 10, 20, 30... allows you to later add additional repositories without re-prioritizing existing ones.</p></div><p>When priorities are assigned and enabled and when we try to install or update a package which is found in multiple repositories, the package will be retrieved from whichever repository that has the highest priority. In this way, we can control if a third-party repository can replace important base packages, or if updates from supported CentOS repositories can replace third-party packages on a highly-customized system.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec100"></a>See also</h3></div></div></div><p>Refer to the CentOS Wiki's <code class="literal">yum-plugin-priorities</code> article for more information on the Priorities plugin at <a class="ulink" href="https://wiki.centos.org/PackageManagement/Yum/Priorities" target="_blank">https://wiki.centos.org/PackageManagement/Yum/Priorities</a>.</p></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec35"></a>Automating software updates with yum-cron</h2></div></div><hr /></div><p>We know the importance of staying on top of any security alerts and applying important updates, but it can be a tedious and time-consuming task to make sure all of the software on your CentOS system is updated, especially when you're managing more than one server. This recipe shows you how to automate the update process ensuring your system stays up to date without the need for daily interaction.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec101"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec102"></a>How to do it...</h3></div></div></div><p>To automate software updates using <code class="literal">yum-cron</code>, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Install the <code class="literal">yum-cron</code> package:</p><pre class="programlisting">
<span class="strong"><strong>yum install yum yum-cron</strong></span>
</pre></li><li><p>Start and enable the service:</p><pre class="programlisting">
<span class="strong"><strong>systemctl start yum-cron</strong></span>
<span class="strong"><strong>systemctl enable yum-cron</strong></span>
</pre></li><li><p>Perform a system update to ensure everything is up to date before <code class="literal">yum-cron</code> takes over:</p><pre class="programlisting">
<span class="strong"><strong>yum update</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec103"></a>How it works...</h3></div></div></div><p>Our first action step was to install the <code class="literal">yum-cron</code> package, but you'll notice that the invocation also updates Yum itself. Although we only have to specify <code class="literal">yum-cron</code>, including <code class="literal">yum</code> works around a particular versioning bug (you can read the bug report at <a class="ulink" href="https://bugzilla.redhat.com/show_bug.cgi?id=1293713" target="_blank">https://bugzilla.redhat.com/show_bug.cgi?id=1293713</a>):</p><pre class="programlisting">
<span class="strong"><strong>yum install yum yum-cron</strong></span>
</pre><p>The package installs the <code class="literal">yum-cron</code> command and a daily cron job to trigger it and a <code class="literal">systemctl</code> unit used to enable and disable updating. Starting the service with <code class="literal">systemctl</code> results in the creation of a special lock file. Cron runs the daily cron job every day to invoke <code class="literal">yum-cron</code>, which checks whether the lock file exists. If the file exists, then it knows it should check for updates. Otherwise, it knows daily updating is disabled (the service is stopped) and does nothing.</p><p>The <code class="literal">yum-cron.config</code> configuration file in <code class="literal">/etc/yum</code> can be used to modify the general behavior of <code class="literal">yum-cron</code>. The most important option is <code class="literal">update_cmd</code> because it lets us specify what type of update to perform. It's possible for <code class="literal">yum-cron</code> to perform different update strategies, and if you want to perform a more targeted update beyond the default then you can change the value of the <code class="literal">update_cmd</code> option.</p><p>Servers that fill different roles may require different update strategies; for example, you might want to apply only critical security updates on a production server and leave the other software installed at their specific versions. Comments in the configuration file list what values are valid for <code class="literal">update_cmd</code> and what they mean. <code class="literal">default</code> performs a general system-wide update, whereas a value such asÂ <code class="literal">security</code> only applies security-related updates:</p><pre class="programlisting">
<span class="strong"><strong>update_cmd = security</strong></span>
</pre><p>Also of interest in <code class="literal">yum-cron.conf</code> is the <code class="literal">emit_via</code> option. TheÂ <code class="literal">stdio</code>Â value means any logging messages that may be generated by <code class="literal">yum-cron</code> will be passed through a standard output. Usually, this is captured by cron and written to <code class="literal">/var/log/cron</code>. Cron can be configured to e-mail the output, but you can also specifically configure <code class="literal">yum-cron</code> to e-mail the messages. If you want the output sent to you by <code class="literal">yum-cron</code>, change the value of <code class="literal">emit_via</code> to <code class="literal">email</code> and the value of <code class="literal">email_to</code> to your e-mail address:</p><pre class="programlisting">
<span class="strong"><strong>emit_via = email</strong></span>
<span class="strong"><strong>email_to = tboronczyk@example.com</strong></span>
</pre><div class="mediaobject"><img src="graphics/image_04_004.jpg" /><div class="caption"><p>yum-cron's configuration file lets us specify a specific update policy and notification options</p></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec104"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on automating software updates:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Configure automatic updates (<a class="ulink" href="http://www.certdepot.net/rhel7-configure-automatic-updates" target="_blank">http://www.certdepot.net/rhel7-configure-automatic-updates</a>)</p></li><li style="list-style-type: disc"><p>Enabling automatic updates in CentOS 7 and RHEL 7 (<a class="ulink" href="http://linuxaria.com/howto/enabling-automatic-updates-in-centos-7-and-rhel-7" target="_blank">http://linuxaria.com/howto/enabling-automatic-updates-in-centos-7-and-rhel-7</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec36"></a>Verifying installed RPM packages</h2></div></div><hr /></div><p>It's been said the safest system is one that's <span class="emphasis"><em>"powered off, cast in a block of concrete, and sealed in a lead-lined room with armed guards."</em></span> (Gene Spafford) Your CentOS system is probably concrete-free, which means it's at the risk of attack. This recipe shows you how to audit your system using <code class="literal">rpm</code> to make sure its installed software hasn't been compromised by an attacker.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec105"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec106"></a>How to do it...</h3></div></div></div><p>It is important to first make a backup of the RPM database at <code class="literal">/var/lib/rpm</code>. There are many ways to do this, but for the sake of this example, we'll make an ISO image of the directory which you can then archive or burn to disc:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Install the <code class="literal">genisoimage</code> and <code class="literal">wodim</code> packages for the necessary tools to create ISO images and to burn them to disc:</p><pre class="programlisting">
<span class="strong"><strong>yum install genisoimage wodim</strong></span>
</pre></li><li><p>Create the ISO image with <code class="literal">genisoimage</code>:</p><pre class="programlisting">
<span class="strong"><strong>genisoimage -o rpm-db-bckup.iso -R -v /var/lib/rpm</strong></span>
</pre><p>If desired, burn the image with <code class="literal">wodim</code>:</p><pre class="programlisting">
<span class="strong"><strong>wodim -v dev=/dev/cdrom rpm-db-bckup.iso</strong></span>
</pre></li></ol></div><p>You can delete the ISO file after burning it to disc if you have no plans to use it in the future.</p><p>When the time comes to verify your system, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Make the backup database available. If you've burned the ISO file to disc, and assuming that it's located at <code class="literal">/dev/cdrom</code>, use <code class="literal">mount</code> like this:</p><pre class="programlisting">
<span class="strong"><strong>mount /media /dev/cdrom</strong></span>
</pre></li><li><p>If the backup is an ISO file, use <code class="literal">mount</code> like this:</p><pre class="programlisting">
<span class="strong"><strong>mount -o loop rpm-db-bckup.iso /media</strong></span>
</pre></li><li><p>Verify the integrity of the installed <code class="literal">rpm</code> package against the backup copy of the database. <code class="literal">rpm</code> returns a list of the files that are different from the original package, so a successful audit should have no output:</p><pre class="programlisting">
<span class="strong"><strong>rpm -V --dbpath=/media rpm</strong></span>
</pre></li><li><p>Verify the integrity of all of the packages installed on the system:</p><pre class="programlisting">
<span class="strong"><strong>rpm -Va --dbpath=/media</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec107"></a>How it works...</h3></div></div></div><p>An attacker can alter files and replace programs with malicious copies on your system. Luckily, we can identify these changes using <code class="literal">rpm</code> to verify the integrity of files installed from a package. But to do this, we also need a database that we can trust. The integrity of the database used to compare file details is important because a smart attacker may also think to make changes there as well. It's important to make a read-only backup of the database regularly, perhaps before and after every time you install a new package or install updates. Then you can compare the state of the system's software against a trusted backup and be fully confident with the results.</p><p>You can back up to any medium you wish: a removable USB thumb drive, a writable CD or DVD disc, remote storage, or even a high-capacity tape cartridge. The important thing is that it's trustworthy. The recipe demonstrated making a backup of the <code class="literal">/var/lib/rpm</code> database as an ISO file, which can be burned to disc or copied around as-is and mounted read-only when needed.</p><pre class="programlisting">
<span class="strong"><strong>genisoimage -o rpm-db-bckup.iso -R -v /var/lib/rpm</strong></span>
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note25"></a>Note</h3><p>Long-time Linux users may remember the <code class="literal">mkisofs</code> and <code class="literal">cdrecord</code> programs. <code class="literal">genisoimage</code> and <code class="literal">cdrecord</code> are clones, and the former still exists in CentOS in the form of symlinks pointing to <code class="literal">genisoimage</code> and <code class="literal">cdrecord</code>.</p></div><p>The <code class="literal">-o</code> argument gives the name of the ISO file that will be created. <code class="literal">-R</code> creates the indexes necessary to preserve the length and casing of the filenames in our image, and <code class="literal">-v</code> indicates that <code class="literal">genisoimage</code> should be verbose so that we can see its progress. When it's finished, we'll have the <code class="literal">rpm-db-backup.iso</code> file.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note26"></a>Note</h3><p><code class="literal">rpm-db-bckup.iso</code> is a suitable name if you're going to burn the file to disc and delete it. If you plan on archiving the ISO file instead, you'll want to consider including a timestamp in the name of when the backup was taken so that you can keep things organized. For example, the following command uses <code class="literal">date</code> to include the date and time in the filename:</p><p>
<span class="strong"><strong><code class="literal">genisoimage -o rpm-db-bckup-$(date +"%Y-%m-%d_%H%M").iso -R -v /var/lib/rpm</code></strong></span>
</p></div><p>Next, the recipe showed how to use <code class="literal">wodim</code> to burn the ISO to disc:</p><pre class="programlisting">
<span class="strong"><strong>wodim -v dev=/dev/cdrom rpm-db-bckup.iso</strong></span>
</pre><p>The <code class="literal">-v</code> argument puts <code class="literal">wodim</code> in verbose mode and the <code class="literal">dev</code> argument identifies the CD/DVD drive. The recipe assumed that <code class="literal">/dev/cdrom</code> is the appropriate device and you may need to modify the command depending on your system's configuration.</p><p>To make the trusted database available, we mounted the disc or ISO file. To mount the disc, we would place the disc in the drive and issue the following command (<code class="literal">/dev/cdrom</code> is the device and <code class="literal">/media</code> is the mount point its filesystem will be made available on):</p><pre class="programlisting">
<span class="strong"><strong>mount /dev/cdrom /media</strong></span>
</pre><p>To mount an ISO file, we issue the following command instead:</p><pre class="programlisting">
<span class="strong"><strong>mount -o loop rpm-db-bckup.iso /media</strong></span>
</pre><p>After the trusted database was made available, we used <code class="literal">rpm</code> with the <code class="literal">-V</code> option, which verifies an installed package. By default, <code class="literal">rpm</code> uses the files in <code class="literal">/var/lib/rpm</code> as the database, so we used the <code class="literal">--dbpath</code> option to override this and instead point to our trusted copy:</p><pre class="programlisting">
<span class="strong"><strong>rpm -V -dbpath=/media rpm</strong></span>
</pre><p>While we can provide one or more package names to check, the <code class="literal">-a</code> option will verify all of the packages installed on the system:</p><pre class="programlisting">
<span class="strong"><strong>rpm -Va --dbpath=/media</strong></span>
</pre><p><code class="literal">rpm</code> runs through a series of tests, checking the size of files and their permissions, and reports those that fail one or more tests. No output means the files installed on your system are exactly as they were when they were first installed by the package(s). Otherwise, <code class="literal">rpm</code> displays a dot for those tests that pass and one of the following mnemonic indicators to show which tests fail:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">S</code>: The size of the file has changed</p></li><li style="list-style-type: disc"><p><code class="literal">M</code>: The file's permissions have changed</p></li><li style="list-style-type: disc"><p><code class="literal">5</code>: The MD5 checksum of the file does not match the expected checksum</p></li><li style="list-style-type: disc"><p><code class="literal">L</code>: The symlink has changed</p></li><li style="list-style-type: disc"><p><code class="literal">D</code>: The device has changed</p></li><li style="list-style-type: disc"><p><code class="literal">U</code>: The user owner of the file has changed</p></li><li style="list-style-type: disc"><p><code class="literal">G</code>: The owning group of the file has changed</p></li><li style="list-style-type: disc"><p><code class="literal">T</code>: The file's timestamp has changed</p></li></ul></div><p><code class="literal">rpm</code> will also report if a file is missing.</p><p>However, not all discrepancies are bad. It's up to us to know what changes are acceptable or not. Changes to a configuration file, for example, may be acceptable, but changes to a binary utility are certainly an indication of trouble. <code class="literal">rpm</code> differentiates configuration files by listing <code class="literal">c</code> next to the test results, which helps us differentiate them from other types of files:</p><div class="mediaobject"><img src="graphics/image_04_005.jpg" /><div class="caption"><p>Differences are reported when verifying the integrity of this system's packages</p></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec108"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on verifying the integrity of installed software:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">rpm</code>Â manual page (<code class="literal">man 8 rpm</code>)</p></li><li style="list-style-type: disc"><p>Verifying files with Red Hat's RPM (<a class="ulink" href="http://www.sans.org/security-resources/idfaq/rpm.php" target="_blank">http://www.sans.org/security-resources/idfaq/rpm.php</a>)</p></li><li style="list-style-type: disc"><p>wodim cannot open SCSI drive (<a class="ulink" href="http://www.linuxquestions.org/questions/linux-software-2/wodim-cdrecord-cannot-open-scsi-drive-4175544944/" target="_blank">http://www.linuxquestions.org/questions/linux-software-2/wodim-cdrecord-cannot-open-scsi-drive-4175544944/</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch04lvl1sec37"></a>Compiling a program from source</h2></div></div><hr /></div><p>Modern-day package managers make it easy to install software; with just a single command, we can install a program and its dependencies from any of our configured repositories. Yet an important value in the Linux community and free software movement is the ability to modify your software as you see fit (perhaps you want to fix a bug or add a new feature). For software written in a compiled language, such asÂ C, this often means modifying the program's source code and compiling the code into an executable binary. This recipe walks you through compiling and installing the GNU Hello program.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec109"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection. An unprivileged user account capable of escalating its privileges using <code class="literal">sudo</code> should also be available.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec110"></a>How to do it...</h3></div></div></div><p>Perform the following steps to compile and install the program from the source code:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Using <code class="literal">sudo</code> to elevate your account's privileges, install the <code class="literal">gcc</code> package:</p><pre class="programlisting">
<span class="strong"><strong>sudo yum install gcc</strong></span>
</pre></li><li><p>Download the GNU Hello source code:</p><pre class="programlisting">
<span class="strong"><strong>curl ftp://ftp.gnu.org/gnu/hello/hello-2.10.tar.gz | tar - zx</strong></span>
</pre></li><li><p>Enter the project's directory:</p><pre class="programlisting">
<span class="strong"><strong>cd hello-2.10</strong></span>
</pre></li><li><p>Run the <code class="literal">configure</code> script using the <code class="literal">--help</code> argument to view the project's build options. The output can be quite lengthy and you may find it beneficial to paginate the content using <code class="literal">less</code>:</p><pre class="programlisting">
<span class="strong"><strong>./configure --help | less</strong></span>
</pre></li><li><p>Run the <code class="literal">configure</code> script again, this time specifying any desired build options to generate a <code class="literal">Makefile</code> file:</p><pre class="programlisting">
<span class="strong"><strong>./configure --prefix=/usr/local</strong></span>
</pre></li><li><p>Invoke <code class="literal">make</code> which uses <code class="literal">Makefile</code> as a guide to compile the project:</p><pre class="programlisting">
<span class="strong"><strong>make</strong></span>
</pre></li><li><p>Using <code class="literal">sudo</code> to again escalate your privileges, install the program and its supporting files:</p><pre class="programlisting">
<span class="strong"><strong>sudo make install</strong></span>
</pre></li><li><p>Now, we can run the <code class="literal">hello</code> program to display a friendly greeting:</p><pre class="programlisting">
<span class="strong"><strong>hello</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec111"></a>How it works...</h3></div></div></div><p>This recipe taught you the canonical <code class="literal">configure</code>, <code class="literal">make</code>, and <code class="literal">make install</code> route of compiling and installing software from the source code.</p><p>The minimal CentOS installation does not include a C compiler (a program that translates source code written in the C programming language into a binary, machine-executable format), so the first thing we did was install the GNU Compiler Collection. Because the package will be installed system-wide, elevated privileges were needed for <code class="literal">yum</code>:</p><pre class="programlisting">
<span class="strong"><strong>sudo yum install gcc</strong></span>
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note27"></a>Note</h3><p>Since the GNU Hello project is written in C and includes a pregenerated <code class="literal">configure</code> script, <code class="literal">gcc</code> is all we need. There may be other projects though for which you'll need additional software, such as <code class="literal">autoconf</code>, to generate a <code class="literal">configure</code> scripts, or compiler support for other languages like Fortran, C++, Objective-C, and Go. For a more capable build environment, consider installing the <code class="literal">Development Tools</code> package group:</p><p><span class="strong"><strong><code class="literal">sudo yum groupinstall "Development Tools"</code></strong></span>
</p></div><p>Next, we downloaded a copy of the project's source code from its FTP server. The code is distributed as a compressed archive which we retrieved using <code class="literal">curl</code>. We omitted the <code class="literal">-O</code> argument that we used in previous recipes but piped the output directly to <code class="literal">tar</code> to decompress it. This results in the creation of a directory named <code class="literal">hello-2.10</code> that contains the project's source code:</p><pre class="programlisting">
<span class="strong"><strong>curl ftp://ftp.gnu.org/gnu/hello/hello-2.10.tar.gz | tar -zx</strong></span>
</pre><p>Quite often, a project will include several informative text files, so feel free to look around at the directory's content. Some common files are:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">README</code>: ThisÂ gives a general overview of the project (name, version, description, and so on)</p></li><li style="list-style-type: disc"><p><code class="literal">CHANGELOG</code>: ThisÂ lists the changes made in each release</p></li><li style="list-style-type: disc"><p><code class="literal">INSTALL</code>: ThisÂ contains installation instructions</p></li><li style="list-style-type: disc"><p><code class="literal">LICENCE</code>: ThisÂ contains license information governing the use and distribution of the project's code</p></li></ul></div><p>If the project uses the GNU Autotools build system (which GNU Hello uses), we can expect to find a <code class="literal">configure</code> script in the collection of source files. The job of <code class="literal">configure</code> is to scan our system's build environment to ensure that any necessary tools and dependencies are available and to generate the <code class="literal">Makefile</code> file. <code class="literal">Makefile</code> will contain instructions that compile and install the program, and any options we pass to <code class="literal">configure</code> ultimately find their way into <code class="literal">Makefile</code>.</p><p>To see what options are available to us, we first ran <code class="literal">configure</code> with <code class="literal">--help</code>:</p><pre class="programlisting">
<span class="strong"><strong>./configure --help | less</strong></span>
</pre><p>Some of the options may be unique to the project while others are more general, having to do with setting paths and such as used in later parts of the build process. Some important general options are as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">--prefix</code>: The base hierarchy in which the program and its files will be installed</p></li><li style="list-style-type: disc"><p><code class="literal">--disable-FEATURE</code>: This compiles the program without enabling the target feature that would otherwise be enabled</p></li><li style="list-style-type: disc"><p><code class="literal">--enable-FEATURE</code>: This compiles the program with the optional target feature enabled</p></li><li style="list-style-type: disc"><p><code class="literal">--with-PACKAGE</code>: This links to a specific library needed for some feature</p></li></ul></div><p>The second time we ran <code class="literal">configure</code>, we did so providing the <code class="literal">--prefix</code> option:</p><pre class="programlisting">
<span class="strong"><strong>./configure --prefix=/usr/local</strong></span>
</pre><p>The prefix value of <code class="literal">/usr/local</code> means that this directory will be prefixed to the various paths where the different files will be installed to. For example, when we install the program, the compiled <code class="literal">hello</code> file is copied to <code class="literal">PREFIX/bin</code>, which is <code class="literal">/usr/local/bin</code>, the project's manual page will be installed under <code class="literal">PREFIX/share/man</code>, which is <code class="literal">/usr/local/share/man</code>, and so on.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note28"></a>Note</h3><p>This recipe installs GNU Hello as a system-wide accessible program. But don't forget, you can use the <code class="literal">--prefix </code>option to compile and install files to personal directories too:</p><p>
<span class="strong"><strong><code class="literal">./configure --prefix=/home/tboronczyk/.personal</code></strong></span>
</p></div><p>Once <code class="literal">configure</code> generated <code class="literal">Makefile</code>, we executed those statements with <code class="literal">make</code> to compile the project:</p><pre class="programlisting">
<span class="strong"><strong>make</strong></span>
</pre><p>By default, <code class="literal">make</code> looks for a file named <code class="literal">Makefile</code> in the current directory to run. If for whatever reason the target script is named differently, we can tell <code class="literal">make</code> which file to use with its <code class="literal">-f</code> option:</p><pre class="programlisting">
<span class="strong"><strong>make -f ./Makefile</strong></span>
</pre><p>Also, <code class="literal">Makefile</code>Â files often contain several sets of instructions or targets. Some common targets are as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">all</code>: Compiles the program</p></li><li style="list-style-type: disc"><p><code class="literal">check</code>: Runs any test suites that accompany the project to verify its proper functioning</p></li><li style="list-style-type: disc"><p><code class="literal">clean</code>: Deletes any intermediate files created during the compilation process</p></li><li style="list-style-type: disc"><p><code class="literal">distclean</code>: Deletes the files created during the configuration process or compilation process, leaving only those files in the original distribution</p></li><li style="list-style-type: disc"><p><code class="literal">dist</code>: Creates an archive to distribute the program</p></li><li style="list-style-type: disc"><p><code class="literal">install</code>: Installs the compiled program and any other necessary files to their final home on the system</p></li><li style="list-style-type: disc"><p><code class="literal">uninstall</code>: Deletes files that were installed by <code class="literal">install</code></p></li></ul></div><p>The default target if none are provided is <code class="literal">all</code>.</p><p>Ideally, we don't want to compile software as <code class="literal">root</code> because it's possible for a <code class="literal">Makefile</code> to create arbitrary files in any location, something which can be taken advantage of by an attacker. Executing the file as a standard user blocks this attack vector simply because the unprivileged account doesn't have write-access to sensitive directories. This is why we used <code class="literal">sudo</code> only for the <code class="literal">install</code> target when we moved the program and its files to the directories under <code class="literal">/usr/local</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec112"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on building software:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>GNU Hello (<a class="ulink" href="http://www.gnu.org/software/hello" target="_blank">http://www.gnu.org/software/hello</a>)</p></li><li style="list-style-type: disc"><p>RHEL7 Developer Guide (<a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Developer_Guide/index.html" target="_blank">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Developer_Guide/index.html</a>)</p></li><li style="list-style-type: disc"><p>Autotools Mythbuster (<a class="ulink" href="http://autotools.io/" target="_blank">http://autotools.io/</a>)</p></li><li style="list-style-type: disc"><p>CentOS Wiki: Set up an RPM Build Environment (<a class="ulink" href="http://wiki.centos.org/HowTos/SetupRpmBuildEnvironment" target="_blank">http://wiki.centos.org/HowTos/SetupRpmBuildEnvironment</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="chapter" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="ch05"></a>ChapterÂ 5.Â Managing Filesystems and Storage</h2></div></div></div><p>This chapter contains the following recipes:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Viewing the size of files and available storage</p></li><li style="list-style-type: disc"><p>Setting storage limits for users and groups</p></li><li style="list-style-type: disc"><p>Creating a RAM disk</p></li><li style="list-style-type: disc"><p>Creating a RAID</p></li><li style="list-style-type: disc"><p>Replacing a device in a RAID</p></li><li style="list-style-type: disc"><p>Creating a new LVM volume</p></li><li style="list-style-type: disc"><p>Removing an existing LVM volume</p></li><li style="list-style-type: disc"><p>Adding storage and growing an LVM volume</p></li><li style="list-style-type: disc"><p>Working with LVM snapshots</p></li></ul></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec38"></a>Introduction</h2></div></div><hr /></div><p>The recipes in this chapter focus on leveraging your CentOS system's storage to maintain availability, increase reliability, and to keep your data safe against inevitable disk failures. You'll learn how to determine how much space your files take up and how much storage is still available. Then, you'll see how to put limits in place to ensure that users use the system's storage resources equitably. We'll also create a RAM disk, a memory-based low latency storage for frequently accessed data. Then you'll learn how to create and manage RAID arrays to provide reliable storage, and how to work with LVM volumes to allocate logical drives from storage pools to better utilize your system's total storage capacity.</p></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec39"></a>Viewing the size of files and available storage</h2></div></div><hr /></div><p>Programs and services can behave unexpectedly or stop working entirely when storage space runs tight, so it's important to know how much space is available on our system. This recipe introduces a handful of commands used to determine how large your files and directories are and how much storage is used and is available.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec113"></a>Getting ready</h3></div></div></div><p>This recipe requires a working CentOS system. Administrative privileges may be needed depending on the permissions of the directories and files you want to inspect.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec114"></a>How to do it...</h3></div></div></div><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>To display the storage capacity of a mounted filesystem, use the <code class="literal">df</code> command:</p><pre class="programlisting">
<span class="strong"><strong>df -h /</strong></span>
</pre></li><li style="list-style-type: disc"><p>To view the size of a file, use the <code class="literal">ls</code> command:</p><pre class="programlisting">
<span class="strong"><strong>ls -sh file.txt</strong></span>
</pre></li><li style="list-style-type: disc"><p>To determine the size of a directory (the sum of sizes of all of its files), use the <code class="literal">du</code> command:</p><pre class="programlisting">
<span class="strong"><strong>du -sh ~</strong></span>
</pre></li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec115"></a>How it works...</h3></div></div></div><p>The <code class="literal">df</code> command returns information about how much free space is available on a mounted filesystem. The preceding example asked for details about the root filesystem.</p><pre class="programlisting">
<span class="strong"><strong>df -h /</strong></span>
</pre><p>The <code class="literal">-h</code> argument formats the information in a human-readable format, listing the values as megabytes, gigabytes, and so on, as opposed to block counts. When invoked without any arguments, <code class="literal">df</code> displays its information in 512-byte block counts for all mounted filesystems. We can specify one or more mount points with this command, in which case <code class="literal">df</code> reports only on those filesystems.</p><div class="mediaobject"><img src="graphics/image_05_001.jpg" /><div class="caption"><p>Values presented as megabytes and gigabytes are more informative than when given in block counts</p></div></div><p>The output's first column, labeled <code class="literal">Filesystem</code>, and the last, labeled <code class="literal">Mounted on</code>, identifies the filesystem and mount point it's been made available on, respectively. The <code class="literal">Size</code> column shows the total amount of space the filesystem provides. The <code class="literal">Used</code> column shows how much of that space is occupied and the <code class="literal">Avail</code> column shows how much is still available. <code class="literal">Use%</code> shows how much space is occupied as a percentage.</p><p>While <code class="literal">df</code> gives us a high-level view of our overall storage usage, to view the size of individual files we can use <code class="literal">ls</code>. The command supports a large number of arguments that show meta information for files and directories, such as their ownership details, create time, and size.</p><p>This recipe used the <code class="literal">-s</code> argument to return the file's size and <code class="literal">-h</code> to again display the value in a human-readable format:</p><pre class="programlisting">
<span class="strong"><strong>ls -hs filename.txt</strong></span>
</pre><p>If you use <code class="literal">ls</code> to show the size of a directory, it will likely report 4.0 K regardless of which directory you choose. This is because directories aren't really containers holding files like we usually imagine; a directory is really a special file that contains an index listing the files that are within it. This index occupies a block's worth of storage. <code class="literal">ls</code> reports the amount of space the directory occupies as a file, not the sum of the sizes of its files.</p><p>To view the total size of all of the files in a directory, which is usually what we want when talking about directory size, we need to use the <code class="literal">du</code> command:</p><pre class="programlisting">
<span class="strong"><strong>du -hs ~</strong></span>
</pre><p>The <code class="literal">-s</code> argument prints only the value for the current directory and <code class="literal">-h</code> formats the value in a human-readable format. Without any arguments, <code class="literal">du</code> also displays 512-byte block counts for all files and directories within the current directory. However, directories are treated as containers so the values reflect the block count of all of their contained files. We can also list one or more files or directories, in which case <code class="literal">du</code> reports back only on those targets. By targeting all of the files/directories within a directory and piping the output through <code class="literal">sort</code>, we can use <code class="literal">du</code> to identify targets that consume the most storage:</p><pre class="programlisting">
<span class="strong"><strong>du -hs ./* | sort -hr</strong></span>
</pre><p>sort's <code class="literal">-h</code> argument organizes the human-readable numbers correctly (for example, <code class="literal">4.0K</code> is less than <code class="literal">3M</code> even though 3 is less than 4 in a numerical sort) and <code class="literal">-r</code> reverses the order to display the largest entries first:</p><div class="mediaobject"><img src="graphics/image_05_002.jpg" /><div class="caption"><p>Sorting can help identify what consumes the most storage</p></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec116"></a>See also</h3></div></div></div><p>For more information on the commands mentioned in this recipe, refer to their respective man pages:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">df</code> manual page (<code class="literal">man 1 df</code>)</p></li><li style="list-style-type: disc"><p>The <code class="literal">du</code> manual page (<code class="literal">man 1 du</code>)</p></li><li style="list-style-type: disc"><p>The <code class="literal">ls</code> manual page (<code class="literal">man 1 ls</code>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec40"></a>Setting storage limits for users and groups</h2></div></div><hr /></div><p>Imposing limits on the amount of storage a user can consume is an effective way to manage resources and ensure they are made available to everyone fairly, especially in a multiuser environment. This recipe shows you how to enable quotas and set limits by users and groups.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec117"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with administrative privileges provided by logging in with the <code class="literal">root</code> account or using <code class="literal">sudo</code>. It assumes <code class="literal">/home</code> mounts its own filesystem.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec118"></a>How to do it...</h3></div></div></div><p>Follow these steps to set up quotas and specify storage limits:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Open the <code class="literal">/etc/fstab</code> file for editing:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/fstab</strong></span>
</pre></li><li><p>To enable user quotas, which enforce usage limits based on user accounts, add <code class="literal">uquota</code> to the mount options for <code class="literal">/home</code>. For group quotas, add <code class="literal">gquota</code>. Both <code class="literal">uquota</code> and <code class="literal">gquota</code> can be given together to enable both:</p><pre class="programlisting">
<span class="strong"><strong>/dev/mapper/centos-home /home xfs defaults,uquota,gquota 0  0</strong></span>
</pre></li><li><p>Save your changes and close the file.</p></li><li><p>Reboot the system:</p><pre class="programlisting">
<span class="strong"><strong>shutdown -r +5 'Reboot required for system maintenance'</strong></span>
</pre></li><li><p>When the system reboots, launch the <code class="literal">xfs_quota</code> shell in expert mode:</p><pre class="programlisting">
<span class="strong"><strong>xfs_quota -x /home</strong></span>
</pre></li><li><p>Set limits for a user account using the <code class="literal">limit</code> command:</p><pre class="programlisting">
<span class="strong"><strong>limit bsoft=5g bhard=6g tboronczyk</strong></span>
</pre></li><li><p>Use the <code class="literal">quota</code> command to verify that the user's limits have been set:</p><pre class="programlisting">
<span class="strong"><strong>quota -h tboronczyk</strong></span>
</pre></li><li><p>Set limits for a group using <code class="literal">limit -g</code>:</p><pre class="programlisting">
<span class="strong"><strong>limit -g bsoft=20g bhard=21g users
  </strong></span>
</pre></li><li><p>Use <code class="literal">quota -g</code> to verify that the group's limits have been set:</p><pre class="programlisting">
<span class="strong"><strong>quota -gh users</strong></span>
</pre></li><li><p>Type <code class="literal">quit</code> or press <span class="emphasis"><em><span class="strong"><strong>Ctrl</strong></span></em></span> + <span class="emphasis"><em><span class="strong"><strong>D</strong></span></em></span> to exit the shell:</p><pre class="programlisting">
<span class="strong"><strong>quit</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec119"></a>How it works...</h3></div></div></div><p>Quotas are not enabled by default and must be enabled explicitly in the filesystem's mount options; so, we updated <code class="literal">/etc/fstab</code> and added the <code class="literal">uquota</code> and/or <code class="literal">gquota</code> option for <code class="literal">/home</code>:</p><pre class="programlisting">
<span class="strong"><strong>/dev/mapper/centos-home /home xfs defaults,uquota,gquota 0 0</strong></span>
</pre><p>We should never unmount a filesystem that's in use because we don't want to risk corrupting or losing data. So, it's important that no one else is logged in when we remount <code class="literal">/home</code>. If you're logged in as <code class="literal">root</code> and you're certain you're the only user logged in, you can remount the filesystem with <code class="literal">umount</code> immediately followed by <code class="literal">mount</code>. But if others are logged on, it's best to perform a reboot as the recipe suggests. When the system reboots, it will have automatically mounted <code class="literal">/home</code> and the quota options will be in effect:</p><pre class="programlisting">
<span class="strong"><strong>shutdown -r +5 'Reboot required for server maintenance'</strong></span>
</pre><p>Next, we ran <code class="literal">xfs_quota</code> as an interactive shell to enter commands to manage our quotas. We used the <code class="literal">-x</code> argument to start the shell in expert mode (the commands we need to manage quotas are only available in expert mode) and gave the filesystem's mount point on which we're going to set quotas:</p><pre class="programlisting">
<span class="strong"><strong>xfs_quota -x /home</strong></span>
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note29"></a>Note</h3><p>The traditional quota utilities can be used to manage basic quotas, but <code class="literal">xfs_quota</code> lets us take advantage of the additional quota functionality unique to XFS. For example, using <code class="literal">xfs_quota</code> we can also manage project quotas.</p></div><p>The two commands with the most interest for us are <code class="literal">limit</code> and <code class="literal">quota</code>. <code class="literal">limit</code> is used to set the quota limits and <code class="literal">quota</code> is used to report the quota information.</p><p>We can set four limits with <code class="literal">limit</code>. They are as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">isoft</code>: This sets a soft limit on the number of inodes used</p></li><li style="list-style-type: disc"><p><code class="literal">ihard</code>: This sets a hard limit on the number of inodes used</p></li><li style="list-style-type: disc"><p><code class="literal">bsoft</code>: This sets a soft limit on the number of blocks used</p></li><li style="list-style-type: disc"><p><code class="literal">bhard</code>: This sets a hard limit on the number of blocks used</p></li></ul></div><p>An inode is a data structure used by filesystems to track files and directories. Each file and directory are represented by an inode, so setting a limit on the number of inodes a user can have essentially limits the number of files/directories they can have.</p><p>Blocks represent the physical storage, and setting a quota on the number of blocks for a user limits the amount of storage space their files can consume. The typical block size is 512 bytes, meaning twoÂ blocks are used to store 1 KB of data. The recipe's examples set a soft block limit of 5 GB for the user account and a hard limit of 6 GB. The suffixes <code class="literal">k</code>, <code class="literal">m</code>, and <code class="literal">g</code> are used to specify values as kilobytes, megabytes, and gigabytes, respectively:</p><pre class="programlisting">
<span class="strong"><strong>limit bsoft=5g bhard=5500m tboronczyk</strong></span>
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note30"></a>Note</h3><p>Commands can be run in <code class="literal">xfs_quota</code> without entering the interactive shell by using <code class="literal">-c</code>:</p><p><span class="strong"><strong><code class="literal">xfs_quota -x -c 'limit -u bsoft=5g tboronczyk' /home</code></strong></span></p></div><p>A hard limit specifies a value that the user absolutely cannot surpass. For example, a user with a hard limit of 100 inodes and having 99 files will only be able to create one more file. An attempt to create a file beyond that will be met with an error.</p><p>On the other hand, a soft limit defines a limit a user can surpass for a small amount of time. Once the limit is exceeded, the user enters a grace period. A user with a soft block limit of 5 GB will be able to consume more than 5 GB of storage, but only for a certain amount of time. If they're still violating the limit by the end of the grace period, the soft limit will be treated as a hard limit and they won't be able to save any more data.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note31"></a>Note</h3><p>The grace period is 7Â days by default. We can change this with the <code class="literal">timer</code> command, using <code class="literal">-i</code> to change the inodes timer and <code class="literal">-b</code> to change the block timer:
<span class="strong"><strong><code class="literal">timer -b 3d tboronczyk</code></strong></span>
</p></div><p>To review the current quotas, the <code class="literal">quota</code> command is used. <code class="literal">-h</code> presents the values in human-readable values:</p><pre class="programlisting">
<span class="strong"><strong>quota -h tboronczyk</strong></span>
</pre><p>The default output shows the filesystem and its mount point and the user's block quota details: the number of blocks consumed (under the <span class="strong"><strong>Blocks</strong></span> header), soft limit (<span class="strong"><strong>Quota</strong></span>), hard limit (<span class="strong"><strong>Limit</strong></span>), and the elapsed time of a soft-limit violation's grace period (<span class="strong"><strong>Warn/Time</strong></span>). <code class="literal">-i</code> will retrieve the same information for inode quotas, and <code class="literal">-b</code> and <code class="literal">-i</code> can be used together to display both sets of information at the same time:</p><pre class="programlisting">
<span class="strong"><strong>quota -bih tboronczyk</strong></span>
</pre><div class="mediaobject"><img src="graphics/image_05_003.jpg" /><div class="caption"><p>Block and inode quotas can be displayed at the same time</p></div></div><p>The <code class="literal">limit</code> and <code class="literal">quota</code> commands all default to working with a user's quota, although we can explicitly manage a user's quota using the <code class="literal">-u</code> argument. To manage a group's quota, we use <code class="literal">-g</code>:</p><pre class="programlisting">
<span class="strong"><strong>quota -gh users</strong></span>
</pre><p>As mentioned earlier, <code class="literal">xfs_quota</code> also allows us to manage project quotas. These are essentially limits placed on specific directories that are enforced regardless of user or group ownership. To use project quotas, use the <code class="literal">pquota</code> mount option:</p><pre class="programlisting">
<span class="strong"><strong>/dev/mapper/centos-home /home xfs defaults,uquota,pquota 0 0</strong></span>
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note32"></a>Note</h3><p>Project quotas and group quotas cannot be used together; <code class="literal">mount</code> will fail to mount the filesystem if both <code class="literal">pquota</code> and <code class="literal">gquota</code> are given. Depending on the filesystem, this may prevent your system from booting.</p></div><p>Next, create the file <code class="literal">/etc/projid</code>. Each line is an entry made up of an arbitrary project name and a unique ID number separated by a colon:</p><pre class="programlisting">
<span class="strong"><strong>echo "my_project:42" &gt;&gt; /etc/projid</strong></span>
</pre><p>Then, create the file <code class="literal">/etc/projects</code>. Its entries are made up of the project ID, a separating colon, and the project's directory. Together, the <code class="literal">projects</code> and <code class="literal">projid</code> files define the relationship between the project's name and its directory:</p><pre class="programlisting">
<span class="strong"><strong>echo "42:/home/dev/project" &gt;&gt; /etc/projects</strong></span>
</pre><p>With the two configuration files in place, the final step is to initialize the project's quota tracking in <code class="literal">xfs_quota</code> using <code class="literal">project -c</code>:</p><pre class="programlisting">
<span class="strong"><strong>project -c my_project</strong></span>
</pre><p>With the initial setup steps complete, you can use the <code class="literal">limit</code> and <code class="literal">quota</code> commands to manage the project's quotas using the <code class="literal">-p</code> argument:</p><pre class="programlisting">
<span class="strong"><strong>limit -p bsoft=10g bhard=11g my_project</strong></span>
</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec120"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on working with quotas:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">xfs_quota</code>Â manual page (<code class="literal">man 8 xfs_quota</code>)</p></li><li style="list-style-type: disc"><p>Enable User and Group Disk Quota on CentOS 7 (<a class="ulink" href="http://www.linuxtechi.com/enable-user-group-disk-quota-on-centos-7-rhel-7/" target="_blank">http://www.linuxtechi.com/enable-user-group-disk-quota-on-centos-7-rhel-7/</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec41"></a>Creating a RAM disk</h2></div></div><hr /></div><p>This recipe teaches you how to take advantage of RAM's low latency using a RAM disk, a section of memory made available as if it were a standard storage device. RAM disks often store volatile data that is constantly read and updated in memory. For example, on desktop systems they're used for storing a browser's cache to speed up web surfing. In server environments, RAM disks can store cache data for high-load proxy services to reduce latency.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec121"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with administrative privileges provided by logging in with the <code class="literal">root</code> account or using <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec122"></a>How to do it...</h3></div></div></div><p>Perform the following steps to create and use a RAM disk:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Check whether there is sufficient memory available for the RAM disk using <code class="literal">free</code> command (a practical RAM disk will need to be smaller than the amount of free memory):</p><pre class="programlisting">
<span class="strong"><strong>free -h</strong></span>
</pre></li><li><p>Use <code class="literal">mount</code> to mount a <code class="literal">tmpfs</code> filesystem at the desired mount point, giving the target size as a mount option:</p><pre class="programlisting">
<span class="strong"><strong>mount -t tmpfs -o size=512M tmpfs /mnt</strong></span>
</pre></li><li><p>When the RAM disk is no longer needed, unmount the filesystem:</p><pre class="programlisting">
<span class="strong"><strong>umount /mnt</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec123"></a>How it works...</h3></div></div></div><p>Whenever we access data on a hard drive, its motors must first spin up the storage platters and position the magnetic head at the correct location. These mechanical actions make access painfully slow compared to accessing data already resident in system memory (RAM). Exact measurements depend on the individual system and its hardware, but disk access takes somewhere in the neighborhood of 10 milliseconds or 10,000,000 nanoseconds. Memory access only takes about 200 nanoseconds, so it's safe to say accessing RAM is at least 10,000 times faster than disk even as a low estimate.</p><p>Before creating the RAM disk, you should first review the amount of free memory available on your system using the <code class="literal">free</code> command:</p><pre class="programlisting">
<span class="strong"><strong>free -h</strong></span>
</pre><p><code class="literal">free</code> command responds with how much memory is available and how much memory is in use. The <code class="literal">-h</code> argument formats the output in a human-readable format (listing the values in megabytes and gigabytes instead of bytes). We can see numbers for RAM, swap disks, and any special buffers used by the kernel, but we're really interested in the amount of used and free memory listed by the <code class="literal">Mem</code> and <code class="literal">Swap</code> entries. A low amount of free memory and a high amount of used swap is an indication that we probably won't have sufficient memory for a practical RAM disk:</p><div class="mediaobject"><img src="graphics/image_05_004.jpg" /><div class="caption"><p>With only 1 GB of RAM, this system has resources to support only a relatively small RAM disk</p></div></div><p>Next, we used <code class="literal">mount</code> to make the desired amount of memory available at the given mount point. The recipe used <code class="literal">/mnt</code>, but you're free to use whatever mount point you see fit:</p><pre class="programlisting">
<span class="strong"><strong>mount -t tmpfs -o size=512M tmpfs /mnt</strong></span>
</pre><p>The invocation specifies <code class="literal">tmpfs</code> as the mount device and <code class="literal">/mnt</code> as the mount point. <code class="literal">-t</code> specifies the underlying filesystem, in this case, <code class="literal">tmpfs</code> and <code class="literal">-o</code> specifies our mount options for the filesystem. A list of possible options for the <code class="literal">tmpfs</code> filesystem can be found in the <code class="literal">mount</code> man page, but the most important option is <code class="literal">size</code>, which sets the desired size of the filesystem.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note33"></a>Note</h3><p>It's possible to specify a value for <code class="literal">size</code> that's greater than the amount of available RAM but most of the time this isn't desirable. The extra data is marshaled to swap once RAM is exhausted and this will increase latency, negating the benefits of using a RAM disk in the first place.</p></div><p>Remember, RAM disks serve as low latency temporary storage for volatile data. Because its data is stored in memory, the contents of the disk are lost when either the system shuts down or the disk is unmounted. Never store persistent data to your RAM disk.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec124"></a>See also</h3></div></div></div><p>Refer to the following resources for more information about RAM disks:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">mount</code> manual page (<code class="literal">man 8 mount</code>)</p></li><li style="list-style-type: disc"><p>How to create a RAM disk in Linux (<a class="ulink" href="http://www.jamescoyle.net/how-to/943-create-a-ram-disk-in-linux" target="_blank">http://www.jamescoyle.net/how-to/943-create-a-ram-disk-in-linux</a>)</p></li><li style="list-style-type: disc"><p>What is <code class="literal">/dev/shm</code> and its practical usage? (<a class="ulink" href="http://www.cyberciti.biz/tips/what-is-devshm-and-its-practical-usage.html" target="_blank">http://www.cyberciti.biz/tips/what-is-devshm-and-its-practical-usage.html</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec42"></a>Creating a RAID</h2></div></div><hr /></div><p>In this recipe, you'll learn how to configure a redundant array of disks (RAID). Configuring an array of disks to provide redundant storage is an excellent way to protect your data from drive failures. For example, if your data resides on a single disk and that drive fails, then the data is lost. You'll have to replace the drive and restore the data from your latest backup. But if two disks are in a RAID-1 configuration, your data is mirrored and can still be accessed from the working drive when the other fails. The failure doesn't impact access to the data and you can replace the faulty drive at a more convenient time.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec125"></a>Getting ready</h3></div></div></div><p>This recipe requires a working CentOS system and elevated privileges. It assumes that at least two new disks have been installed (identified as <code class="literal">/dev/sdb</code> and <code class="literal">/dev/sdc</code>) and we will partition and configure them.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec126"></a>How to do it...</h3></div></div></div><p>Perform the following steps to create a RAID:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Use <code class="literal">lsblk</code> to identify the new storage devices.</p></li><li><p>Launch <code class="literal">cfdisk</code> to partition the first drive:</p><pre class="programlisting">
<span class="strong"><strong>cfdisk -z /dev/sdb</strong></span>
</pre><div class="mediaobject"><img src="graphics/image_05_005.jpg" /><div class="caption"><p>cfdisk presents a user-friendly interface for partitioning storage devices</p></div></div></li><li><p>To create a single partition that occupies the entire disk, use the left and right arrow keys to select <code class="literal">New</code> and press <span class="emphasis"><em>Enter.</em></span> Then select <code class="literal">Primary</code> and accept the default size.</p></li><li><p>Select <code class="literal">Write</code> and confirm the action by typing <code class="literal">yes</code> when prompted. Select <code class="literal">Quit</code> to exit <code class="literal">cfdisk</code>.</p></li><li><p>Repeat steps 1 to 4 to partition the second drive.</p></li><li><p>Install the <code class="literal">mdadm</code> package:</p><pre class="programlisting">
<span class="strong"><strong>yum install mdadm</strong></span>
</pre></li><li><p>Use <code class="literal">mdadm -C</code> to create a new array using the two partitions. The following example creates a RAID-1 (mirroring) configuration:</p><pre class="programlisting">
<span class="strong"><strong>mdadm -C md0 -l 1 -n 2 /dev/sdb1 /dev/sdc1</strong></span>
</pre></li><li><p>Use the <code class="literal">-D</code> option to examine the RAID:</p><pre class="programlisting">
<span class="strong"><strong>mdadm -D /dev/md/md0</strong></span>
</pre></li><li><p>Format the RAID using the XFS filesystem with <code class="literal">mkfs.xfs</code>:</p><pre class="programlisting">
<span class="strong"><strong>mkfs.xfs /dev/md/md0</strong></span>
</pre></li><li><p>Mount the RAID for use:</p><pre class="programlisting">
<span class="strong"><strong>mount /dev/md/md0 /mnt</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec127"></a>How it works...</h3></div></div></div><p>There are many ways to configure disks to work together, especially when it comes to things like data mirroring, striping, and parity checking. Some configurations are implemented at the hardware level and others can be implemented using software. This recipe used <code class="literal">mdadm</code> to set up multiple disks in a RAID configuration, specifically RAID-1.</p><p>The Storage Networking Industry Association has standardized several different RAID configurations. Some of the more common configurations are as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>RAID-0</strong></span>: Data is distributed evenly across two or more disks. This configuration offers no redundancy, and the failure of a single disk in the array will result in data loss. However, it offers increased performance since data can be read and written to different disks simultaneously.</p></li><li style="list-style-type: disc"><p><span class="strong"><strong>RAID-1</strong></span>: Data is duplicated between disks. Write activity is slower because the same data must be written to each disk, but this configuration offers excellent redundancy; the data remains accessible as long as there is at least one functioning disk.</p></li><li style="list-style-type: disc"><p><span class="strong"><strong>RAID-5</strong></span>: Blocks of data and parity information are split between two or more disks. If a member of the array fails, parity information on another disk can be used to reconstruct the missing data. Write performance is slower, but read performance is increased since data can be read simultaneously from different disks. This configuration can withstand the failure of a single disk, although the failure of a second disk will result in data loss.</p></li><li style="list-style-type: disc"><p><span class="strong"><strong>RAID-6</strong></span>: This configuration is similar to RAID-5, but maintains an extra parity block. The array can withstand two disk failures before data is lost.</p></li></ul></div><p>There are other standard configurations as well (RAID-2, RAID-3, and so on), and even non-standard configurations, but these are rarely used in practice. As with everything in life, there are trade-offs between the different RAID configurations, and selecting the right configuration for you will depend on how you want to balance redundancy, fault-tolerance, and latency.</p><p><code class="literal">lsblk</code> prints information for the block devices (storage disks) attached to our CentOS system, and it should be relatively easy to identify the names of the new devices simply by looking at the drive sizes and lack of partitions. This recipe assumes that the new devices are <code class="literal">/dev/sdb</code> and <code class="literal">/dev/sdc</code>; you'll need to use whatever is appropriate for your system when invoking the <code class="literal">cfdisk</code> and <code class="literal">mdadm</code> commands:</p><div class="mediaobject"><img src="graphics/image_05_006.jpg" /><div class="caption"><p>Several unconfigured drives are installed on the system</p></div></div><p>A new primary partition is created on each disk that occupies its entire capacity. The recipe uses <code class="literal">cfdisk</code>, a program that offers a console-based graphical interface to manipulate partitions. However, there are other partitioning utilities installed in CentOS that you can use instead if you're comfortable with them, such as <code class="literal">fdisk</code>, <code class="literal">sfdisk</code>, and <code class="literal">parted</code>.</p><p>Once the disks are partitioned, we're ready to configure the RAID. The <code class="literal">mdadm</code> program used to set up and administer RAIDs is installed using <code class="literal">yum</code>:</p><pre class="programlisting">
<span class="strong"><strong>yum install mdadm</strong></span>
</pre><p><code class="literal">mdadm -C</code> creates a new RAID configuration and requires a name to identify it. <code class="literal">md0</code> is used in the recipe which results in creating the device <code class="literal">/dev/md/md0</code>. The other arguments describe the desired configuration:</p><pre class="programlisting">
<span class="strong"><strong>mdadm -C md0 -l 1 -n 2 /dev/sdb1 /dev/sdc1</strong></span>
</pre><p>The <code class="literal">-l</code> (a lower-case L) option specifies the standard RAID level, in this case 1 (the number <code class="literal">1</code>) represents RAID-1. If you wanted to set up RAID-5 instead, you'd use <code class="literal">-l 5</code>. The <code class="literal">-n</code> option specifies the number of partitions the RAID will use, and then we list the partitions. The recipe configures two partitions, <code class="literal">/dev/sdb1</code> and <code class="literal">/dev/sdc1</code>.</p><p><code class="literal">mdadm -D</code> displays information for a given array that's useful in examining the configuration and verifying its health. The output lists details such as the RAID level, available storage size, which partitions make up the array, whether any partitions/devices are failing, resync status, and other useful information:</p><pre class="programlisting">mdadm -D /dev/md/md0
</pre><div class="mediaobject"><img src="graphics/image_05_007.jpg" /><div class="caption"><p>mdadm displays the status of the new RAID configuration</p></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note34"></a>Note</h3><p><code class="literal">mdadm -E</code> retrieves information for one or more partitions that make up the array:</p><p>
<span class="strong"><strong><code class="literal">mdadm -E /dev/sdb1 /dev/sdc1</code></strong></span>
</p></div><p>Next, the storage space is formatted with an XFS filesystem using the <code class="literal">mkfs.xfs</code> command:</p><pre class="programlisting">
<span class="strong"><strong>mkfs.xfs /dev/md/md0</strong></span>
</pre><p>Finally, the RAID-backed storage space is ready for use. The recipe demonstrates mounting it manually with theÂ <code class="literal">mount</code> command, although you can also add an entry to <code class="literal">/etc/fstab</code> for the filesystem to be mounted automatically whenever the system boots up.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec128"></a>See also</h3></div></div></div><p>For more information on setting up RAIDs, refer to the following resources:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">cfdisk</code>Â manual page (<code class="literal">man 8 cfdisk</code>)</p></li><li style="list-style-type: disc"><p>The <code class="literal">mdadm</code>Â manual page (<code class="literal">man 8 mdadm</code>)</p></li><li style="list-style-type: disc"><p>The <code class="literal">mkfs.xfs</code>Â manual page (<code class="literal">man 8 mkfs.xfs</code>)</p></li><li style="list-style-type: disc"><p>Linux RAID Wiki: Linux RAID (<a class="ulink" href="https://raid.wiki.kernel.org/index.php/Linux_Raid" target="_blank">https://raid.wiki.kernel.org/index.php/Linux_Raid</a>)</p></li><li style="list-style-type: disc"><p>Mdadm Cheat Sheet (<a class="ulink" href="http://www.ducea.com/2009/03/08/mdadm-cheat-sheet/" target="_blank">http://www.ducea.com/2009/03/08/mdadm-cheat-sheet/</a>)</p></li><li style="list-style-type: disc"><p>Introduction to RAID (<a class="ulink" href="http://www.tecmint.com/understanding-raid-setup-in-linux/" target="_blank">http://www.tecmint.com/understanding-raid-setup-in-linux/</a>)</p></li><li style="list-style-type: disc"><p>Standard RAID levels (<a class="ulink" href="https://en.wikipedia.org/wiki/Standard_RAID_levels" target="_blank">https://en.wikipedia.org/wiki/Standard_RAID_levels</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec43"></a>Replacing a device in a RAID</h2></div></div><hr /></div><p>When an array member fails, it's important to replace it as soon as possible because the failure of additional drives increases the chance of data loss. This recipe teaches you how to properly replace a bad drive and rebuild the array.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec129"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with administrative privileges provided by logging in with the <code class="literal">root</code> account or using <code class="literal">sudo</code>. It assumes that a RAID-1 configuration has been set up as described in the previous recipe and the drive that will be replaced is <code class="literal">/dev/sdb</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec130"></a>How to do it...</h3></div></div></div><p>Follow these steps to replace a failed disk in a RAID:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Mark the failed partition as faulty with <code class="literal">mdadm</code> using the <code class="literal">-f</code> option:</p><pre class="programlisting">
<span class="strong"><strong>mdadm /dev/md/md0 -f /dev/sdb1</strong></span>
</pre></li><li><p>Remove the partition from the RAID's configuration with <code class="literal">-r</code>:</p><pre class="programlisting">
<span class="strong"><strong>mdadm /dev/md/md0 -r /dev/sdb1</strong></span>
</pre></li><li><p>Physically replace the faulty disk.</p></li><li><p>Partition the new drive with <code class="literal">cfdisk</code>:</p><pre class="programlisting">
<span class="strong"><strong>cfdisk -z /dev/sdb</strong></span>
</pre></li><li><p>Use the <code class="literal">-a</code> option to add the partition to the RAID:</p><pre class="programlisting">
<span class="strong"><strong>mdadm /dev/md/md0 -a /dev/sdb1</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec131"></a>How it works...</h3></div></div></div><p>It's important to replace bad members as soon you become aware of the failure because, depending on the fault tolerance of your configuration, the failure of a second device may result in full data loss.</p><p>A member must be marked faulty before we can safely remove it, so the first step is to fail the partition. To do this, we used <code class="literal">mdadm</code>. The <code class="literal">-f</code> argument specifies the partition we want failed:</p><pre class="programlisting">
<span class="strong"><strong>mdadm /dev/md/md0 -f /dev/sdb1</strong></span>
</pre><p>Then, to remove the partition from the RAID, we used the <code class="literal">-r</code> argument:</p><pre class="programlisting">
<span class="strong"><strong>mdadm /dev/md/md0 -r /dev/sdb1</strong></span>
</pre><p>Now that the device is no longer in use, we can replace the physical drive. Whether the drive can be hot-swapped while the system is running or if a system shutdown is necessary depends on your hardware.</p><p>Once the replacement partition was ready, we added it to the RAID with the <code class="literal">-a</code> argument. The RAID will begin to rebuild itself, distributing data and parity information to the new partition, as soon as the partition is added:</p><pre class="programlisting">
<span class="strong"><strong>mdadm /dev/md/md0 -a /dev/sdb1</strong></span>
</pre><p>The last recipe showed how the <code class="literal">-D</code> (and <code class="literal">-E</code>) argument of <code class="literal">mdadm</code> is used to retrieve status information about the RAID. You can review the output to monitor the rebuild's progress, but a more concise report is available via <code class="literal">/proc/mdstat</code>. The contents show the speed at which the rebuild is being processed and estimate the time it will take for it to complete. Using <code class="literal">watch</code> to repeatedly display <code class="literal">/proc/mdstat</code>, you can create a make-shift dashboard to monitor the process:</p><pre class="programlisting">
<span class="strong"><strong>watch -n 10 -x cat /proc/mdstat</strong></span>
</pre><div class="mediaobject"><img src="graphics/image_05_008.jpg" /><div class="caption"><p>The estimated time for this RAID's rebuild to complete is about an hour and a half</p></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec132"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on replacing failed drives in a RAID:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">mdadm</code>Â manual page (<code class="literal">man 8 mdadm</code>)</p></li><li style="list-style-type: disc"><p>Replacing a failed hard drive in a software RAID (<a class="ulink" href="https://www.howtoforge.com/replacing_hard_disks_in_a_raid1_array" target="_blank">https://www.howtoforge.com/replacing_hard_disks_in_a_raid1_array</a>)</p></li><li style="list-style-type: disc"><p>FiveÂ tips to speed up RAID re-building and re-syncing (<a class="ulink" href="http://www.cyberciti.biz/tips/linux-raid-increase-resync-rebuild-speed.html" target="_blank">http://www.cyberciti.biz/tips/linux-raid-increase-resync-rebuild-speed.html</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec44"></a>Creating a new LVM volume</h2></div></div><hr /></div><p>Logical Volume Manager (LVM) abstracts data storage away from the physical hardware, which lets us configure the partitions on one or more physical drives to act as one logical device. We also have the freedom to later add or remove physical partitions and grow or shrink the logical device. This recipe show's you how to create a new LVM group and a logical device from the group's storage.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec133"></a>Getting ready</h3></div></div></div><p>This recipe requires a working CentOS system and elevated privileges. It assumes that at least two new disks have been installed (identified as <code class="literal">/dev/sdb </code>and <code class="literal">/dev/sdc</code>) and we will partition and configure them.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec134"></a>How to do it...</h3></div></div></div><p>Perform these steps to set up a new LVM group and create a volume:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Use <code class="literal">lsblk</code> to identify the new storage devices.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note35"></a>Note</h3><p>You can set up LVM with RAID storage as well. Skip to step 5 and replace the partitions with RAID devices (for example, <code class="literal">/dev/md/md0</code>) in the given commands.</p></div></li><li><p>Launch <code class="literal">cfdisk</code> to partition the first drive and create a single partition that occupies the entire disk:</p><pre class="programlisting">
<span class="strong"><strong>cfdisk -z /dev/sdb</strong></span>
</pre></li><li><p>Repeat step 2 to partition the second drive.</p></li><li><p>Use <code class="literal">pvcreate</code> to register the new partitions as physical volumes:</p><pre class="programlisting">
<span class="strong"><strong>pvcreate /dev/sdb1 /dev/sdc1</strong></span>
</pre></li><li><p>Verify that the physical volumes are listed in the output of <code class="literal">pvs</code>:</p><pre class="programlisting">
<span class="strong"><strong>pvs</strong></span>
</pre></li><li><p>Using <code class="literal">vgcreate</code>, group the physical volumes to form a volume group:</p><pre class="programlisting">
<span class="strong"><strong>vgcreate vg0 /dev/sdb1 /dev/sdc1</strong></span>
</pre></li><li><p>Verify that the group is listed in the output of <code class="literal">vgs</code>:</p><pre class="programlisting">
<span class="strong"><strong>vgs</strong></span>
</pre></li><li><p>Using <code class="literal">lvcreate</code>, create a logical volume from the storage pool provided by the volume group:</p><pre class="programlisting">
<span class="strong"><strong>lvcreate -n myvol -L 500G vg0</strong></span>
</pre></li><li><p>Format the volume using the XFS filesystem:</p><pre class="programlisting">
<span class="strong"><strong>mkfs.xfs /dev/vg0/myvol</strong></span>
</pre></li><li><p>Mount the volume for use:</p><pre class="programlisting">
<span class="strong"><strong>mount /dev/vg0/myvol /mnt</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec135"></a>How it works...</h3></div></div></div><p>LVM is another approach to configure multiple storage units to work together, focusing on pooling their resources together in a flexible way. These units can be disk partitions, as well as RAID arrays, and so the generic term <span class="emphasis"><em>volume</em></span> is used.</p><p>The recipe starts with the assumption that we have two new disks as our storage volumes and provides steps for identifying the devices and partitioning them using <code class="literal">lsblk</code> and <code class="literal">cfdisk</code>. It uses <code class="literal">/dev/sdb</code> and <code class="literal">/dev/sdc</code> as the devices, but you should use whatever is appropriate for your system. Once the disks are partitioned, we're ready to register the partitions as physical volumes with <code class="literal">pvcreate</code>. The term <span class="emphasis"><em>physical volume</em></span> describes storage available as a physical partition or RAID.</p><pre class="programlisting">
<span class="strong"><strong>pvcreate /dev/sdb1 /dev/sdc1</strong></span>
</pre><p>Next, the physical volumes are grouped as a volume group using <code class="literal">vgcreate</code>. The recipe created a volume group name <code class="literal">vg0</code> using the <code class="literal">sdb1</code> and <code class="literal">sdc2</code> partitions.</p><pre class="programlisting">
<span class="strong"><strong>vgcrate vg0 /dev/sdb1 /dev/sdc1</strong></span>
</pre><p>The desired name for the volume group is passed first to <code class="literal">vgcreate</code>, followed by the physical volumes we want to group together. If <code class="literal">sdb1</code> and <code class="literal">sdc1</code> both have a capacity of 1 TB each, their storage is combined and the volume group will have 2 TB. If we were to later add a 500 GB volume to the group, the group's storage capacity would increase to 2.5 TB.</p><p>The <code class="literal">pvs</code> and <code class="literal">vgs</code> commands return basic information about physical volumes or volume groups, respectively, and the recipe uses them to verify that each registration was successful. <code class="literal">pvs</code> reports the physical volumes that are registered and which group they are assigned to, any attributes, and their storage capacity. <code class="literal">vgs</code> lists the groups, the number of physical volumes that make up each group's pool, the number of logical volumes using storage from the group, and the groups' capacities.</p><div class="mediaobject"><img src="graphics/image_05_009.jpg" /><div class="caption"><p>pvs and vgs are used to review the status of physical volumes and volume groups</p></div></div><p>A new logical volume is created from the pooled storage of the volume group using the <code class="literal">lvcreate</code> command:</p><pre class="programlisting">
<span class="strong"><strong>lvcreate -n myvol -L 500G vg0</strong></span>
</pre><p>The <code class="literal">-n</code> option provides the name for the logical volume and <code class="literal">-L</code> provides the amount of storage to allocate the volume from the pool. The final argument is the name of the volume group used to support the volume. The values given in the recipe's example creates a volume named <code class="literal">myvol</code> with a capacity of 500 GB backed by the <code class="literal">vg0</code> group. Logical volumes are organized under <code class="literal">/dev</code> by group, so the volume is available as <code class="literal">/dev/vg0/myvol</code>.</p><p>Finally, the volume is formatted with the XFS filesystem using <code class="literal">mkfs.xfs</code>:</p><pre class="programlisting">
<span class="strong"><strong>mkfs.xfs /dev/vg0/myvol</strong></span>
</pre><p>The logical volume is now ready for use and can be mounted manually with <code class="literal">mount</code> and/or an entry can be made in /<code class="literal">etc/fstab</code> to mount the volume automatically at system boot time.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec136"></a>See also</h3></div></div></div><p>For more information on getting started with LVM, refer to the following resources:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">lvcreate</code>Â manual page (<code class="literal">man 8 lvcreate</code>)</p></li><li style="list-style-type: disc"><p>The <code class="literal">pvcreate</code>Â manual page (<code class="literal">man 8 pvcreate</code>)</p></li><li style="list-style-type: disc"><p>The <code class="literal">vgcreate</code>Â manual page (<code class="literal">man 8 vgcreate</code>)</p></li><li style="list-style-type: disc"><p>Linux Partition HOWTO (<a class="ulink" href="http://tldp.org/HOWTO/Partition/index.html" target="_blank">http://tldp.org/HOWTO/Partition/index.html</a>)</p></li><li style="list-style-type: disc"><p>LVM made easy (<a class="ulink" href="http://www.tuxradar.com/content/lvm-made-easy" target="_blank">http://www.tuxradar.com/content/lvm-made-easy</a>)</p></li><li style="list-style-type: disc"><p>Manage LVM volumes with System Storage Manager (<a class="ulink" href="http://xmodulo.com/manage-lvm-volumes-centos-rhel-7-system-storage-manager.html" target="_blank">http://xmodulo.com/manage-lvm-volumes-centos-rhel-7-system-storage-manager.html</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec45"></a>Removing an existing LVM volume</h2></div></div><hr /></div><p>The flexibility of LVM allows us to allocate the pooled storage of physical volumes however we see fit. This recipe shows us how to delete a logical volume and free its storage back to the volume group for use by other logical volumes.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec137"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with administrative privileges provided by logging in with the <code class="literal">root</code> account or using <code class="literal">sudo</code>. It assumes that a logical volume has been created as described in the preceding recipe.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec138"></a>How to do it...</h3></div></div></div><p>Perform the following steps to remove an LVM volume:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Unmount the filesystem with <code class="literal">umount</code>:</p><pre class="programlisting">
<span class="strong"><strong>       umount /mnt
</strong></span>
</pre></li><li><p>Open <code class="literal">/etc/fstab</code> and verify that there isn't an entry to automatically mount the filesystem. If there is, remove the entry, save your changes, and close the file.</p></li><li><p>Use <code class="literal">lvremove</code> to delete the logical volume:</p><pre class="programlisting">
<span class="strong"><strong>lvremove vg0/myvol</strong></span>
</pre></li><li><p>Review the output of <code class="literal">vgs</code> to verify the removal.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec139"></a>How it works...</h3></div></div></div><p>Deleting a volume frees its storage back to the volume group, which can then be used to create new logical volumes or support growing an existing volume. This recipe taught you how to destroy a logical volume using the <code class="literal">lvremove</code> command.</p><p>Because a volume can't be freed if it's in use, the first step is to make sure that its filesystem is unmounted. If the filesystem is mounted automatically, its entry in <code class="literal">/etc/fstab</code> should also be removed.</p><p>Next, <code class="literal">lvremove</code> is invoked with the name of the logical volume to free it:</p><pre class="programlisting">
<span class="strong"><strong>lvremove vg0/myvol</strong></span>
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note36"></a>Note</h3><p>You can delete all of the volumes from a pool by providing just the pool name:</p><p>
<span class="strong"><strong><code class="literal">lvremove vg0</code></strong></span>
</p></div><p>The recipe suggests checking the output of <code class="literal">vgs</code> to verify that the logical volume was removed. In the output, the number of logical volumes under the <code class="literal">#LV</code> column should have decreased and the amount of free space under the <code class="literal">VFree</code> column increased appropriately.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec140"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on removing a volume:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">lvremove</code>Â manual page (<code class="literal">man 8 lvremove</code>)</p></li><li style="list-style-type: disc"><p>The <code class="literal">vgs</code>Â manual page (<code class="literal">man 8 vgs</code>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec46"></a>Adding storage and growing an LVM volume</h2></div></div><hr /></div><p>The size of logical volumes doesn't need to be fixed and we're free to allocate more storage for one from its volume group. This recipe teaches us how to add more storage to the group and then grow the size of the logical volume to take advantage of it.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec141"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with administrative privileges provided by logging in with the <code class="literal">root</code> account or using <code class="literal">sudo</code>. It assumes that a new disk has been installed and partitioned (identified as <code class="literal">/dev/sdd1</code>) and a logical group and volume have been configured as described in previous recipes.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec142"></a>How to do it...</h3></div></div></div><p>Follow these steps to add storage and increase the size of an LVM volume:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Register the new partition as a physical volume:</p><pre class="programlisting">
<span class="strong"><strong>pvcreate /dev/sdd1</strong></span>
</pre></li><li><p>Review the output of <code class="literal">pvs</code> to confirm that the volume was registered:</p><pre class="programlisting">
<span class="strong"><strong>pvs</strong></span>
</pre></li><li><p>Use <code class="literal">vgextend</code> to add the physical volume to the desired volume group:</p><pre class="programlisting">
<span class="strong"><strong>vgextend vg0 /dev/sdd1</strong></span>
</pre></li><li><p>Review the output of <code class="literal">vgs</code> to confirm that the volume was added to the group:</p><pre class="programlisting">
<span class="strong"><strong>vgs</strong></span>
</pre></li><li><p>Use <code class="literal">lvextend</code> to increase the size of the desired logical volume:</p><pre class="programlisting">
<span class="strong"><strong>lvextend vg0/myvol -L+500G</strong></span>
</pre></li><li><p>Review the output of <code class="literal">lvs</code> to confirm the new capacity:</p><pre class="programlisting">
<span class="strong"><strong>lvs</strong></span>
</pre></li><li><p>Expand the filesystem with <code class="literal">xfs_grow</code> to use the new capacity:</p><pre class="programlisting">
<span class="strong"><strong>xfs_grow -d /mnt</strong></span>
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note37"></a>Note</h3><p>An XFS filesystem must be mounted to expand its size; if it's not already mounted, you'll need to do so before executing <code class="literal">xfs_grow</code>.</p></div></li><li><p>Confirm the new size of the filesystem using <code class="literal">df</code>:</p><pre class="programlisting">
<span class="strong"><strong>df -h /mnt</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec143"></a>How it works...</h3></div></div></div><p>The recipe assumed that a new partition has been prepared, which was then registered as a physical volume using the <code class="literal">pvcreate</code> command. Then the physical volume was assigned to the <code class="literal">vg0</code> volume group using <code class="literal">vgextend</code>, increasing the group's available storage:</p><pre class="programlisting">
<span class="strong"><strong>vgextend vg0 /dev/sdd1</strong></span>
</pre><p><code class="literal">lvextend</code> was invoked to grow the size of a logical volume, <code class="literal">vg0/myvol</code>:</p><pre class="programlisting">
<span class="strong"><strong>lvextend vg0/myvol -L+500G</strong></span>
</pre><p>The <code class="literal">-L</code> argument specifies the amount of storage to allocate from the pool. It's value can be an absolute value, for example, <code class="literal">-L 500G</code>, in which case the volume will be resized to have that much capacity. A relative value can also be used to increase the volume's current capacity by some amount. The recipe used <code class="literal">-L+500G</code> to grow the size of the logical volume by an additional 500 GB.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note38"></a>Note</h3><p>You will receive an error if you provide a value for <code class="literal">-L</code> less than the logical volume's current capacity because <code class="literal">lvextend</code> only increases the capacity of a volume. The <code class="literal">lvreduce</code> command is used to reduce the size of logical volumes:</p><p>
<span class="strong"><strong><code class="literal">lvreduce vg0/myvol -L 500GB</code></strong></span>
</p><p>Given a straight value, <code class="literal">-L</code> specifies the total capacity for the volume. In the preceding command, the capacity for <code class="literal">vg0/myvol</code> is reduced to <code class="literal">500GB</code>. Given a relative value, for example <code class="literal">-L-500GB</code>, <code class="literal">lvreduce</code> reduces the volume's capacity by the specified amount.</p></div><p>When finished, the logical volume's capacity can be confirmed by inspecting the output of the <code class="literal">lvs</code> command. The command reports the logical volumes that exist and to which group they are assigned, their attributes, storage capacity, and other statistics.</p><div class="mediaobject"><img src="graphics/image_05_010.jpg" /><div class="caption"><p>The capacity of the logical volume has increased but the filesystem needs to be resized to use it</p></div></div><p>Finally, the filesystem needs to be expanded to make use of the additional space available to it with <code class="literal">xfs_growfs</code>. Filesystems must be mountedÂ for the utility to work, and the recipe assumes that it's mounted at <code class="literal">/mnt</code>. The <code class="literal">-d</code> argument instructs <code class="literal">xfs_grow</code> to increase the size of the filesystem as much as possible (the entire size of the volume).</p><pre class="programlisting">
<span class="strong"><strong>xfs_growfs -d /mnt</strong></span>
</pre><p>Alternatively, you can give a specific size with <code class="literal">-D</code>. Its value is given in block counts, so some math will be required to grow the filesystem to the desired size. For example, let's say you have a 1 TB filesystem and the block size is 4,096 bytes (the default). The block count will be 268,435,456 blocks. If you want to grow the filesystem an additional 500 GB, the target block count will be <code class="literal">399507456</code>:</p><pre class="programlisting">
<span class="strong"><strong>xfs_growfs -D 399507456 /mnt</strong></span>
</pre><p>To make life a little easier, here's a table that presents block counts for common sizes:</p><div class="mediaobject"><img src="graphics/image_05_011.jpg" /><div class="caption"><p>These block counts can be used with xfs_growfs to grow an XFS filesystem</p></div></div><p>While it's possible to reduce the size of a logical volume, it's only possible to grow an XFS filesystem. If you want to reduceÂ the size of an XFS-supported volume you'll have to move its data to a safe location, remove and recreate the logical volume with a smaller size, and later move the data back.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec144"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on growing an LVM volume:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">xfs_growfs</code> manual page (<code class="literal">man 8 xfs_growfs</code>)</p></li><li style="list-style-type: disc"><p>Linux guide to the XFS filesystem (<a class="ulink" href="http://landoflinux.com/linux_xfs_filesystem_introduction.html" target="_blank">http://landoflinux.com/linux_xfs_filesystem_introduction.html</a>)</p></li><li style="list-style-type: disc"><p>Extend/Reduce LVM's in Linux (<a class="ulink" href="http://www.tecmint.com/extend-and-reduce-lvms-in-linux/" target="_blank">http://www.tecmint.com/extend-and-reduce-lvms-in-linux/</a>)</p></li><li style="list-style-type: disc"><p>How to grow an XFS-formatted disk (<a class="ulink" href="http://superuser.com/questions/1000092/how-to-grow-xfs-formated-disk/1001486#1001486" target="_blank">http://superuser.com/questions/1000092/how-to-grow-xfs-formated-disk/1001486#1001486</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch05lvl1sec47"></a>Working with LVM snapshots</h2></div></div><hr /></div><p>A logical volume, also called aÂ linear volume, is just one type of volume we can create; LVM also lets us create snapshot volumes. A snapshot volume is associated with a logical volume and keeps track of changes made to the logical volume's data. We can then merge the snapshot back into the logical volume to roll back the data. This recipe will show you how to do just that.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec145"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with administrative privileges provided by logging in with the <code class="literal">root</code> account or using <code class="literal">sudo</code>. It assumes that a logical volume has been configured and sufficient storage exists in its volume group for the snapshot.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec146"></a>How to do it...</h3></div></div></div><p>The following commands show you how to work with LVM snapshots. Before you begin, you should verify that there is sufficient storage available in the volume group to support the snapshot using <code class="literal">vgs</code>.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Use <code class="literal">lvcreate -s</code> to create a snapshot volume:</p><pre class="programlisting">
<span class="strong"><strong>lvcreate -s -L 100M -n myvolsnap vg0/myvol</strong></span>
</pre></li><li><p>A snapshot volume may be deleted using <code class="literal">lvremove</code>:</p><pre class="programlisting">
<span class="strong"><strong>lvremove vg0/myvolsnap</strong></span>
</pre></li><li><p>A snapshot volume may be mounted and accessed with <code class="literal">mount</code>:</p><pre class="programlisting">
<span class="strong"><strong>mount -o ro /dev/vg0/myvolsnap /mnt</strong></span>
</pre></li><li><p>To restore a logical volume to the state it was in when the snapshot was made, make sure neither are mounted and use <code class="literal">lvconvert</code>:</p><pre class="programlisting">
<span class="strong"><strong>lvconvert -v --merge vg0/myvolsnap</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec147"></a>How it works...</h3></div></div></div><p>This recipe presented commands to create a snapshot volume which then tracks the changes made to a logical volume and to merge the snapshot back into the logical volume.</p><p>Snapshots are created using the <code class="literal">lvcreate</code> command with the <code class="literal">-s</code> flag. <code class="literal">-n</code> gives the name for the snapshot and <code class="literal">-L</code> specifies how much storage will be allocated for it from the volume group. The final argument is the logical volume the snapshot is created from:</p><pre class="programlisting">
<span class="strong"><strong>lvcreate -s -L 100M -n myvolsnap vg0/myvol</strong></span>
</pre><p>The values given in the example create a snapshot of <code class="literal">vg0/myvol</code> named <code class="literal">myvolsnap</code> with a capacity of 100 MB. Storage for the snapshot volume is allocated from the same group as its logical volume so that there should be sufficient storage to support the snapshot. Luckily, snapshot volumes don't copy all of the data from the original volume. Instead, they use a copy-on-write strategy where only the differences are recorded to the snapshot when the data is modified.</p><p>If the deltas exceed the snapshot volume's capacity, LVM won't be able to continue to record changes and the snapshot will no longer be valid. For this reason, you should periodically monitor the snapshot's storage usage and either resize the snapshot or discard the snapshot and create a new one with a larger capacity if necessary. As with other volumes, <code class="literal">lvremove</code> is used to delete snapshot volumes:</p><pre class="programlisting">
<span class="strong"><strong>lvremove vg0/myvolsnap</strong></span>
</pre><p>A snapshot can also be mounted and accessed like other logical volumes. LVM transparently reads unmodified data from the original logical volume so that the data appears as a full copy. Depending on the your reasons for creating a snapshot, you may want to use the <code class="literal">ro</code> mount option to mount the volume read-only to prevent inadvertent changes from being introduced:</p><pre class="programlisting">
<span class="strong"><strong>mount -o ro /dev/vg0/myvolsnap /mnt</strong></span>
</pre><p><code class="literal">lvconvert</code> is used to change a volume's type and other characteristics. You should unmount both the logical and snapshot volumes before calling <code class="literal">lvconvert</code> so that the merge process can begin immediately. Otherwise, LVM will schedule the process to begin after both have been unmounted and either the logical or snapshot volume is mounted again.</p><p>To revert the logical volume's data, we target its snapshot volume and use the <code class="literal">--merge</code> option:</p><pre class="programlisting">
<span class="strong"><strong>lvconvert -v --merge vg0/myvolsnap</strong></span>
</pre><p>Merging the snapshot volume's data to its logical volume rolls back the changes to the logical volume's data, basically restoring it to the state it was in at the time the snapshot was created. When finished, the snapshot is automatically deleted. <code class="literal">-v</code> puts <code class="literal">lvconvert</code> into verbose mode, which is useful to monitor its progress and to know when the merge is complete and the snapshot has been deleted.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec148"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on working with snapshots:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">lvconvert</code>Â manual page (<code class="literal">man 8 lvconvert</code>)</p></li><li style="list-style-type: disc"><p>How to take a snapshot logical volume and restore (<a class="ulink" href="http://www.tecmint.com/take-snapshot-of-logical-volume-and-restore-in-lvm/" target="_blank">http://www.tecmint.com/take-snapshot-of-logical-volume-and-restore-in-lvm/</a>)</p></li><li style="list-style-type: disc"><p>How to take volume snapshots (<a class="ulink" href="http://www.unixarena.com/2013/08/linux-lvm-how-to-take-volume-snapshot.html" target="_blank">http://www.unixarena.com/2013/08/linux-lvm-how-to-take-volume-snapshot.html</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="chapter" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="ch06"></a>ChapterÂ 6.Â Allowing Remote Access</h2></div></div></div><p>This chapter contains the following recipes:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Running commands remotely through SSH</p></li><li style="list-style-type: disc"><p>Configuring a more secure SSH login</p></li><li style="list-style-type: disc"><p>Securely connecting to SSH without a password</p></li><li style="list-style-type: disc"><p>Restricting SSH access by user or group</p></li><li style="list-style-type: disc"><p>Protecting SSH with Fail2ban</p></li><li style="list-style-type: disc"><p>Confining sessions to a chroot jail</p></li><li style="list-style-type: disc"><p>Configuring TigerVNC</p></li><li style="list-style-type: disc"><p>Tunneling VNC connections through SSH</p></li></ul></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec48"></a>Introduction</h2></div></div><hr /></div><p>The recipes in this chapter will help you provide remote access to your CentOS system in a security-conscious way. You'll learn how to execute commands on a remote system through SSH, configure the OpenSSH SSH server to increase security surrounding remote logins, and use key-based authentication to connect. You'll also learn how to allow or deny access to different users, configure Fail2ban to automatically block suspected IP addresses to protect your server from brute force attacks better, and restrict users to a chroot jail once they've logged in. The concluding recipes show you how to provide remote access to a complete desktop environment using VNC, and how to secure that access by tunneling VNC traffic through an SSH tunnel.</p></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec49"></a>Running commands remotely through SSH</h2></div></div><hr /></div><p>This recipe shows you how to execute one-shot commands on a remote system through <span class="strong"><strong>Secure Shell</strong></span> (<span class="strong"><strong>SSH</strong></span>). Having the ability to run commands without establishing a full interactive session can be convenient because you can avoid running a second terminal; everything can be done directly from the same command line.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec149"></a>Getting ready</h3></div></div></div><p>This recipe requires a remote system running the OpenSSH server and a local computer with the OpenSSH SSH client installed (both should be installed by default on CentOS). TheÂ examples assume that the remote system is configured with the IP address <code class="literal">192.168.56.100</code>. Also, you will need a user account available on the remote system.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec150"></a>How to do it...</h3></div></div></div><p>The following examples show you how to run commands on a remote system from your local system through SSH:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>To execute a command remotely, use <code class="literal">ssh</code> and specify the hostname or IP address of the target system followed by the command and its arguments:</p><pre class="programlisting">
<span class="strong"><strong>ssh 192.168.56.100 uname -a</strong></span>
</pre></li><li style="list-style-type: disc"><p>To execute the command as a different user, provide a username with the remote system's address:</p><pre class="programlisting">
<span class="strong"><strong>ssh tboronczyk@192.168.56.100 id -un</strong></span>
</pre></li><li style="list-style-type: disc"><p>If the remote command requires <code class="literal">sudo</code>, supply <code class="literal">ssh</code> with the <code class="literal">-t</code> argument:</p><pre class="programlisting">
<span class="strong"><strong>ssh -t 192.168.56.100 sudo mount /mnt</strong></span>
</pre></li><li style="list-style-type: disc"><p>Use the <code class="literal">-X</code> argument to forward the remote system's X11 display to execute a graphical program:</p><pre class="programlisting">
<span class="strong"><strong>ssh -X 192.168.56.100 gnome-calculator</strong></span>
</pre></li><li style="list-style-type: disc"><p>Use quotes when you execute a complex command, for example, a series of commands or when using I/O redirection. This avoids ambiguity between the local and remote shells:</p><pre class="programlisting">
<span class="strong"><strong>ssh 192.168.56.100 "tar tvzf archive.tgz &gt; contents.txt"</strong></span>
</pre></li><li style="list-style-type: disc"><p>You can pipe input from the local system to remote commands that read from stdin:</p><pre class="programlisting">
<span class="strong"><strong>cat foo.txt | ssh 192.168.56.100 "cat &gt; foo.txt"</strong></span>
</pre></li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec151"></a>How it works...</h3></div></div></div><p><code class="literal">ssh</code> is used mainly to log in to a remote system and access an interactive shell because it's possible that many people don't know that commands can be executed remotely without a shell. This recipe presented several examples that illustrate how you can use <code class="literal">ssh</code> to run remote commands, each of which follow this general invocation pattern:</p><pre class="programlisting">
<span class="strong"><strong>ssh [options] [user@]host command</strong></span>
</pre><p>Anything provided after the remote host is accepted as the command to execute remotely by <code class="literal">ssh</code> as demonstrated in the following two examples. The first invokes <code class="literal">uname</code> to print information about the remote system such as the kernel, processor, and operating system, and the second runs <code class="literal">id</code> to display the username of the current effective user ID:</p><pre class="programlisting">
<span class="strong"><strong>ssh 192.168.56.100 uname -a</strong></span>
<span class="strong"><strong>ssh tboronczyk@192.168.56.100 id -un</strong></span>
</pre><p><code class="literal">ssh</code> doesn't launch an interactive shell when running these commands as there's no reason for it to allocate a tty/pseudo-terminal; it acts as the shell itself and routes input and output between the remote and local systems. However, some commands require a terminal to function properly. For example, <code class="literal">sudo</code> uses the terminal to ensure the user's password isn't printed on the screen as they type it. Without a terminal, <code class="literal">sudo</code> refuses to run and reports back that <code class="literal">you must have a tty to run sudo</code>. We can provide the <code class="literal">-t</code> argument when executing such commands to force <code class="literal">ssh</code> to allocate a remote terminal resource:</p><pre class="programlisting">
<span class="strong"><strong>ssh -t 192.168.56.100 sudo mount /mnt</strong></span>
</pre><p>The <code class="literal">-X</code> argument forwards the X11 display and allows us to run graphical programs. The program appears as if it were running in our local desktop environment, although in reality it's running on the remote system:</p><pre class="programlisting">
<span class="strong"><strong>ssh -X 192.168.56.100 "gnome-calculator"</strong></span>
</pre><div class="mediaobject"><img src="graphics/image_06_001.jpg" /><div class="caption"><p>Graphical applications can be run using X11 forwarding</p></div></div><p>To make sure an invocation is interpreted how you intend, you may need to quote commands. This is especially true when using I/O redirection or when you are running multiple commands. To see why, consider the following example:</p><pre class="programlisting">
<span class="strong"><strong>ssh 192.168.56.100 "tar tvzf archive.tgz &gt; contents.txt"</strong></span>
</pre><p><code class="literal">tar</code> outputs a list of files in the archive which is then redirected to create the <code class="literal">contents.txt</code> file. Everything happens remotelyâ€”<code class="literal">tar</code> runs on the remote system and the new file is created on the remote system.</p><p>Now, here's the same invocation but without quoting:</p><pre class="programlisting">
<span class="strong"><strong>ssh 192.168.56.100 tar tvzf archive.tgz &gt; contents.txt</strong></span>
</pre><p><code class="literal">tar</code> still executes remotely, but the local shell interprets the redirect and <code class="literal">contents.txt</code> is created on the local system.</p><p>I/O redirection is possible in both directions. That is, we can pipe input from the local system to the remote system's stdin:</p><pre class="programlisting">
<span class="strong"><strong>cat foo.txt | ssh 192.168.56.100 "cat &gt; foo.txt"</strong></span>
</pre><p>In this example, <code class="literal">foo.txt</code> is read by <code class="literal">cat</code> and the contents are piped to the remote system. There, a remotely running instance of <code class="literal">cat</code> will be waiting to read the input. When it detects the end of the transmission, <code class="literal">cat</code> outputs what it received, which is then redirected to create <code class="literal">foo.txt</code> on the remote system. In essence, we've just made a copy of <code class="literal">foo.txt</code> from the local system to the remote system.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec152"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on running commands remotely through SSH:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">ssh</code>Â manual page (<code class="literal">man 1 ssh</code>)</p></li><li style="list-style-type: disc"><p>Piping with SSH (<a class="ulink" href="http://linux.icydog.net/ssh/piping.php" target="_blank">http://linux.icydog.net/ssh/piping.php</a>)</p></li><li style="list-style-type: disc"><p>Commandlinefu.com SSH commands (<a class="ulink" href="http://www.commandlinefu.com/commands/matching/ssh/c3No/sort-by-votes" target="_blank">http://www.commandlinefu.com/commands/matching/ssh/c3No/sort-by-votes</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec50"></a>Configuring a more secure SSH login</h2></div></div><hr /></div><p>SSH is considered a secure alternative to older protocols, such as Telnet, rsh, and rlogin, because it encrypts the connection between the client and server. This encryption protects the traffic from any ne'er-do-wells who may be eavesdropping on the network. However, your system can still fall victim to the denial of service attacks or a malicious user who takes advantage of an idle session that was carelessly left unattended. This recipe takes the first steps in hardening SSH by updating the server's configuration to increase security surrounding remote logins.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec153"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system running the OpenSSH server. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec154"></a>How to do it...</h3></div></div></div><p>Follow these steps to increase the security of your SSH logins:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Open the SSH server's configuration file with your text editor:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/ssh/sshd_config</strong></span>
</pre></li><li><p>Locate the <code class="literal">LoginGraceTime</code> option. Uncomment it and change its value to <code class="literal">30</code> seconds to limit the amount of time users are given to provide their credentials:</p><pre class="programlisting">
<span class="strong"><strong>LoginGraceTime 30</strong></span>
</pre></li><li><p>Find and uncomment the <code class="literal">PrintLastLog</code> option and change its value to <code class="literal">yes</code> to show the user the time and location of their last login:</p><pre class="programlisting">
<span class="strong"><strong>PrintLastLog yes</strong></span>
</pre></li><li><p>Uncomment the <code class="literal">Banner</code> option and set its value to <code class="literal">/etc/banner</code> to display a login warning to users:</p><pre class="programlisting">
<span class="strong"><strong>Banner /etc/banner</strong></span>
</pre></li><li><p>Save your changes and close the configuration file.</p></li><li><p>Create the <code class="literal">/etc/banner</code> file with the following (or similar) verbiage:</p><pre class="programlisting">
<span class="strong"><strong>This computer system is for authorized use only. All  activity is
logged and monitored. Users accessing this  system without
authority, or in excess of their authority,  may be subject to
criminal, civil, and administrative  action. Continuing to use
this system indicates your consent to these terms and conditions
of use.</strong></span>
</pre></li><li><p>Restart the SSH server for the configuration changes to take effect:</p><pre class="programlisting">
<span class="strong"><strong>systemctl restart sshd.service</strong></span>
</pre></li><li><p>To automatically log out sessions after 10 minutes of inactivity, create the <code class="literal">/etc/profile.d/timeout.sh</code> file with the following:</p><pre class="programlisting">
<span class="strong"><strong>export TMOUT=600</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec155"></a>How it works...</h3></div></div></div><p>The first option we adjusted in the SSH server's configuration file was <code class="literal">LoginGraceTime</code>, to determine how long a user is allowed to enter their username and password. By default, the connection attempt times out if the user doesn't provide their credentials within two minutes. We reduced this time to <code class="literal">30</code> seconds, but you can set a more appropriate value if you find this not to be long enough:</p><pre class="programlisting">
<span class="strong"><strong>LoginGraceTime 30</strong></span>
</pre><p>Then, setting the <code class="literal">PrintLastLog</code> option's value to <code class="literal">yes</code> causes the time and location of the user's last log in to be displayed. This is helpful because an unknown time or location can alert a user if their account has been compromised and is being used for unauthorized access:</p><pre class="programlisting">
<span class="strong"><strong>PrintLastLog yes</strong></span>
</pre><p>Next, we configured a login banner. A strongly-worded warning isn't likely to deter a malicious user, but many organizations require them to be prominently displayed when a user logs in for legal reasons. Such messages are considered to be sufficient notification in some jurisdictions to inform users that their actions are monitored and they should have no expectations of privacy for what they do on the system. This gives the organization better legal standing to prosecute any abuse.</p><p>To display the warning before the login prompt, we set <code class="literal">Banner</code> with the path to a file containing our message. Then we created the file with the desired text:</p><pre class="programlisting">
<span class="strong"><strong>Banner /etc/banner</strong></span>
</pre><div class="mediaobject"><img src="graphics/image_06_002.jpg" /><div class="caption"><p>The user is presented with a banner message before logging in to the remote system</p></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note39"></a>Note</h3><p><code class="literal">nroff</code> can be used to justify the banner's text:</p><p>

<span class="strong"><strong><code class="literal">(echo -e ".ll 75\n.pl 0\n.nh"; cat) | nroff &gt; /etc/banner</code></strong></span>

</p><p><code class="literal">cat</code> reads text from stdin (press <span class="emphasis"><em>
<span class="strong"><strong>Ctrl</strong></span>
</em></span> + <span class="emphasis"><em>
<span class="strong"><strong>D</strong></span>
</em></span> when you're finished) and both the echo'd instructions and the text are piped to <code class="literal">nroff</code> for formatting.</p><p>Â <code class="literal">.ll</code> tells <code class="literal">nroff</code> to set the line length at <code class="literal">75</code> characters. It's a good idea to use a value less than <code class="literal">80</code> because the traditional terminal displays <code class="literal">80</code> characters per line.</p><p><code class="literal">.pl</code> sets the page length, and setting it <code class="literal">0</code> prevents <code class="literal">nroff</code> from adding additional whitespace after the text in an attempt to fill the length of some imaginary printed page.</p><p><code class="literal">.nh</code> prevents <code class="literal">nroff</code> from hyphenating words at the end of a line.</p></div><p>If you want to display the banner after the user logs in instead of before, you can use the message of the day file instead. In this case, uncomment the <code class="literal">PrintMotd</code> option and set its value to <code class="literal">yes</code> and then save your text in <code class="literal">/etc/motd</code>.</p><p>Finally, we created the <code class="literal">/etc/profile.d/timeout.sh</code> file to set the <code class="literal">TMOUT</code> environment variable. Setting <code class="literal">TMOUT</code> under <code class="literal">/etc/profile.d</code> applies it globally to all users when they log in. To target individual users instead, or if you want to override the global value for specific users, you can place the export in their <code class="literal">~/.bash_profile</code> file:</p><pre class="programlisting">
<span class="strong"><strong>export TMOUT=600</strong></span>
</pre><p>Now with the variable set, bash automatically closes the user's session if it's been inactive for the specified amount of time with the message <code class="literal">timed out waiting for input: auto-logout</code>. The value is given in seconds, with the recipe's example closing idle sessions after 10 minutes.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec156"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on tightening security on SSH logins:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">sshd_config</code>Â manual page (<code class="literal">man 5 sshd_config</code>)</p></li><li style="list-style-type: disc"><p>RHEL 7 System Administrator's Guide: OpenSSH (<a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/ch-OpenSSH.html" target="_blank">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/ch-OpenSSH.html</a>)</p></li><li style="list-style-type: disc"><p>CentOS Wiki: Securing OpenSSH (<a class="ulink" href="https://wiki.centos.org/HowTos/Network/SecuringSSH" target="_blank">https://wiki.centos.org/HowTos/Network/SecuringSSH</a>)</p></li><li style="list-style-type: disc"><p>Should I use a login banner? (<a class="ulink" href="http://serverfault.com/questions/24376/should-i-use-a-login-banner-and-if-so-what-should-it-say" target="_blank">http://serverfault.com/questions/24376/should-i-use-a-login-banner-and-if-so-what-should-it-say</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec51"></a>Securely connecting to SSH without a password</h2></div></div><hr /></div><p>This recipe teaches you how to generate a key pair and set up key-based authentication for SSH sessions, allowing you to secretly connect to a remote system without using a password. Key-based authentication is considered more secure than using a password because a weak password can be easy to guess and a strong password can be easy to forget and more likely to be written down. In either case, an attacker has a fairly good chance of discovering a user's password. With key-based authentication, a user must supply the correct private key file, which is practically impossible to crack or spoof.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec157"></a>Getting ready</h3></div></div></div><p>This recipe requires a remote system running the OpenSSH server and a local computer with the OpenSSH SSH client installed. Its examples assume that the remote system is configured with the IP address <code class="literal">192.168.56.100</code>. Also, you will need an available user account on the remote system.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec158"></a>How to do it...</h3></div></div></div><p>Follow these steps to set up key-based authentication for SSH sessions:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>On the local computer, use the <code class="literal">ssh-keygen</code> command to create a pair of authentication keys. Accept the default path/filename for the keys and leave the passphrase empty:</p><pre class="programlisting">
<span class="strong"><strong>ssh-keygen -b 3072 -C "Timothy Boronczyk"</strong></span>
</pre></li><li><p>Create the <code class="literal">.ssh</code> directory if it doesn't already exist in your remote home directory:</p><pre class="programlisting">
<span class="strong"><strong>ssh 192.168.56.100 "mkdir -m 700 .ssh"</strong></span>
</pre></li><li><p>Append the contents of <code class="literal">id_rsa.pub</code> to <code class="literal">.ssh/authorized_keys</code> on the remote system:</p><pre class="programlisting">
<span class="strong"><strong>cat .ssh/id_rsa.pub | ssh 192.168.56.100 "cat &gt;&gt;
       .ssh/authorized_keys"</strong></span>
</pre></li><li><p>Secure the <code class="literal">authorized_keys</code> file's permissions:</p><pre class="programlisting">
<span class="strong"><strong>ssh 192.168.56.100 "chmod 640 .ssh/authorized_keys"</strong></span>
</pre></li><li><p>Verify that you can connect to the remote system without providing a password:</p><pre class="programlisting">
<span class="strong"><strong>ssh 192.168.56.100</strong></span>
</pre></li><li><p>Repeat steps 2 through 5 for any additional remote systems you want to log in to using key-based authentication.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec159"></a>How it works...</h3></div></div></div><p>Key-based authentication is considered more secure than using passwords because it's nearly impractical to crack a suitable encryption key while brute forcing a password is trivial. This recipe used the OpenSSH suite's <code class="literal">ssh-keygen</code> program to generate a new pair of keys, which we then used to authenticate our SSH session:</p><pre class="programlisting">
<span class="strong"><strong>ssh-keygen -b 3072 -C "Timothy Boronczyk"</strong></span>
</pre><p><code class="literal">-C</code> embeds a brief comment in the key which is useful for identifying the owner or purpose of a key and <code class="literal">-b</code> sets the number of bits used for the key's modulus. The more bits used, the larger the number that can be represented, which means greater resistance to cracking attacks. If <code class="literal">-b</code> isn't provided, the default value is 2,048 bits. Based on the estimates of the rate at which computing power increases, 2,048 is generally thought to be suitable until around the year 2030 (researchers developed a successful attack against 1,024-bit keys in 2010). A 3,072-bit key is considered suitable beyond 2030.</p><p>We accepted the suggested <code class="literal">~/.ssh/id_rsa</code> value as the name of the output file when prompted (this is where <code class="literal">ssh</code> looks for our private identity key by default when we connect to a remote server). We also didn't provide a passphrase. If we were to give one, then the key would be encrypted and we'd need to provide the password to decrypt the key every time we wanted to use it.</p><p>When <code class="literal">ssh-keygen</code> is finished, the private key <code class="literal">id_rsa</code> and the public key <code class="literal">id_rsa.pub</code> can be found in the <code class="literal">.ssh</code> directory:</p><div class="mediaobject"><img src="graphics/image_06_003.jpg" /><div class="caption"><p>The pair of keys is generated for password-less authentication</p></div></div><p>Then, we created the <code class="literal">.ssh</code> directory in our home directory on the remote system. You can execute the <code class="literal">mkdir</code> command while being logged in to the remote system, otherwise you can execute the command remotely through SSH:</p><pre class="programlisting">
<span class="strong"><strong>ssh 192.168.56.100 "mkdir -m 700 .ssh"</strong></span>
</pre><p>Next, we added the public key to <code class="literal">.ssh/authorized_keys</code> on the remote system:</p><pre class="programlisting">
<span class="strong"><strong>cat .ssh/id_rsa.pub | ssh 192.168.56.100 "cat &gt;&gt;  .ssh/authorized_keys"</strong></span>
</pre><p>Because proper permissions help ensure the security of your keys, <code class="literal">ssh</code> won't consider them safe to use if the permissions are too lax. The permissions on the <code class="literal">.ssh</code> directory should be read, write, and execute permissions only for the owner (<code class="literal">700</code>), read permissions for the owner and group, and write permissions for the owner (<code class="literal">640</code>) on <code class="literal">authorized_keys</code>. A simple <code class="literal">chmod</code> call ensures that everything is correct:</p><pre class="programlisting">
<span class="strong"><strong>ssh 192.168.56.100 "chmod 640 .ssh/authorized_keys"</strong></span>
</pre><p>When we connect, <code class="literal">ssh</code> sees the <code class="literal">id_rsa</code> file and sends our private key as part of the connection request. The server checks for the corresponding public key in the <code class="literal">authorized_keys</code> file, and if everything matches up then we're authorized and logged in.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec160"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on using key-based authentication with OpenSSH:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>RHEL 7 System Administrator's Guide: OpenSSH (<a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/ch-OpenSSH.html" target="_blank">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/ch-OpenSSH.html</a>)</p></li><li style="list-style-type: disc"><p>SSH password versus key authentication (<a class="ulink" href="http://security.stackexchange.com/questions/33381/ssh-password-vs-key-authentication" target="_blank">http://security.stackexchange.com/questions/33381/ssh-password-vs-key-authentication</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec52"></a>Restricting SSH access by user or group</h2></div></div><hr /></div><p>Depending on the role of your system and which user accounts are configured on it, you may not want all of its registered users to have access through SSH. This recipe shows you how to configure the SSH server to restrict remote user access by explicitly granting or denying the users access.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec161"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system running the OpenSSH server. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec162"></a>How to do it...</h3></div></div></div><p>Follow these steps to restrict users' SSH access:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Open the SSH server's configuration file with your text editor:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/ssh/sshd_config</strong></span>
</pre></li><li><p>Find the <code class="literal">PermitEmptyPasswords</code> option. Uncomment it and set its value to <code class="literal">no</code> to disallow accounts with empty passwords:</p><pre class="programlisting">
<span class="strong"><strong>PermitEmptyPasswords no</strong></span>
</pre></li><li><p>To disallow remote access with the <code class="literal">root</code> account, locate and uncomment the <code class="literal">PermitRootLogin</code> option and set its value to <code class="literal">no</code>:</p><pre class="programlisting">
<span class="strong"><strong>PermitRootLogin no</strong></span>
</pre></li><li><p>Deny remote access for specific user accounts by adding an entry for <code class="literal">DenyUsers</code>. The option's value should be a space-separated list of usernames you want to deny:</p><pre class="programlisting">
<span class="strong"><strong>DenyUsers bbarrera jbhuse mbutterfield</strong></span>
</pre></li><li><p>Deny remote access for users who are members of a specific group by adding an entry for <code class="literal">DenyGroups</code>:</p><pre class="programlisting">
<span class="strong"><strong>DenyGroups users noremote</strong></span>
</pre></li><li><p>Add an <code class="literal">AllowUsers</code> entry to deny access to everyone except those in the list of permitted users:</p><pre class="programlisting">
<span class="strong"><strong>AllowUsers abell tboronczyk</strong></span>
</pre></li><li><p>Add an <code class="literal">AllowGroups</code> entry to deny access to everyone except those in the list of permitted groups:</p><pre class="programlisting">
<span class="strong"><strong>AllowGroups itadmin remote</strong></span>
</pre></li><li><p>Save your changes and close the file.</p></li><li><p>Restart the SSH server for the changes to take effect:</p><pre class="programlisting">
<span class="strong"><strong>systemctl restart sshd.service</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec163"></a>How it works...</h3></div></div></div><p>First, we uncommented <code class="literal">PermitEmptyPasswords</code> and set its value to <code class="literal">no</code>. This prevents user accounts that don't have a password from being used to log in over SSH:</p><pre class="programlisting">
<span class="strong"><strong>PermitEmptyPasswords no</strong></span>
</pre><p>Passwords are the first level of defense in protecting ourselves from malicious attacks using compromised user accounts. Without a strong password, anyone can log in simply by knowing the username. This is a scary thought because usernames can be easily guessed and sometimes are even publicly available in the form of e-mail addresses and so on.</p><p>Next, we uncommented the <code class="literal">PermitRootLogin</code> option and set its value to <code class="literal">no</code>. This prevents <code class="literal">root</code> from establishing an SSH session directly:</p><pre class="programlisting">
<span class="strong"><strong>PermitRootLogin no</strong></span>
</pre><p>Such restrictions were of critical importance when protocols such as Telnet were used because the username and password were often sent across the network in plain textâ€”an attacker could easily monitor the network traffic and capture the password. However, even though SSH makes this concern moot by encrypting its traffic, the password is still vulnerable from brute force cracking attacks. For this reason, it's wise to require users to authenticate using their unprivileged account first and then use <code class="literal">su</code> or <code class="literal">sudo</code> to elevate their privileges when necessary (refer to <a class="link" href="#" linkend="ch03">Chapter 3</a>, <span class="emphasis"><em>User and Permission Management</em></span>).</p><p>The recipe then presented the <code class="literal">DenyUsers</code>, <code class="literal">DenyGroups</code>, <code class="literal">AllowUsers</code>, and <code class="literal">AllowGroups</code> options as a way to restrict SSH access on a larger scale.</p><p>The <code class="literal">DenyUsers</code> option prohibits specific users from logging in. While other user accounts will be able to access the system remotely, the users listed under <code class="literal">DenyUsers</code> will see the message <code class="literal">Permission Denied</code>. The recipe's example denies access to the users <code class="literal">bbarrera</code>, <code class="literal">jbhuse</code>, and <code class="literal">mbutterfield</code>:</p><pre class="programlisting">
<span class="strong"><strong>DenyUsers bbarrera jbhuse mbutterfield</strong></span>
</pre><p>The <code class="literal">DenyGroups</code> option works similarly, but denies users based on their group membership; the following example denies access to anyone who's a member of the <code class="literal">users</code> group or the <code class="literal">noremote</code> group:</p><pre class="programlisting">
<span class="strong"><strong>DenyGroups users noremote</strong></span>
</pre><p>The denial options are useful for blacklisting a small number of users. To block all users except for a select few, we use the allow options. <code class="literal">AllowUsers</code> denies access to everyone except those specified. <code class="literal">AllowGroups</code> is its counterpart allowing only those users who are members of the specified group:</p><pre class="programlisting">
<span class="strong"><strong>AllowUsers abell tboronczyk</strong></span>
<span class="strong"><strong>AllowGroups itadmin remote</strong></span>
</pre><p>The options can also have values that use <code class="literal">*</code> and <code class="literal">?</code> as wildcards. <code class="literal">*</code> matches zero or more characters and <code class="literal">?</code> matches a single character. For example, the following denies all users:</p><pre class="programlisting">
<span class="strong"><strong>DenyUsers *</strong></span>
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note40"></a>Note</h3><p><code class="literal">AllowUsers</code> and <code class="literal">AllowGroups</code> deny all users/groups except the ones they list. Be careful if you depend on SSH to administer your servers because it's very easy to block yourself with these. Before logging out of your current SSH session, check that you can successfully log in using a second terminal. If there's a problem, you'll still be logged in with the first session and will able to fix the issue.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec164"></a>See also</h3></div></div></div><p>Refer to the following for more information on restricting remote SSH access:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">sshd_config</code>Â manual page (<code class="literal">man 5 sshd_config</code>)</p></li><li style="list-style-type: disc"><p>RHEL 7 System Administrator's Guide: OpenSSH (<a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/ch-OpenSSH.html" target="_blank">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/ch-OpenSSH.html</a>)</p></li><li style="list-style-type: disc"><p>SSH how to deny all users except for one? (<a class="ulink" href="http://www.linuxquestions.org/questions/linux-security-4/howto-sshd-deny-all-users-except-for-one-368752/" target="_blank">http://www.linuxquestions.org/questions/linux-security-4/howto-sshd-deny-all-users-except-for-one-368752/</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec53"></a>Protecting SSH with Fail2ban</h2></div></div><hr /></div><p>A determined attacker may try to brute force a user's password to gain access or attempt repeated logins to consume network and system resources as part of a denial of service attack. Fail2ban can help protect you from such attacks by monitoring a server's log files, identifying suspicious activity, and automatically banning the IP addresses responsible for the activity. This recipe teaches you how to install Fail2ban to safeguard your system.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec165"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system running the OpenSSH server. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>. The <code class="literal">fail2ban</code> package is hosted by the EPEL repository; if the repository is not already registered, refer to the <span class="emphasis"><em>Registering the EPEL and Remi repositories</em></span> recipe in <a class="link" href="#" linkend="ch04">Chapter 4</a>, <span class="emphasis"><em>Software InstallationÂ Management</em></span>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec166"></a>How to do it...</h3></div></div></div><p>Follow these steps to protect your system with Fail2ban:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Install the <code class="literal">fail2ban</code> package:</p><pre class="programlisting">
<span class="strong"><strong>yum install fail2ban</strong></span>
</pre></li><li><p>Create the jail configuration file <code class="literal">/etc/fail2ban/jail.local</code> using the following contents:</p><pre class="programlisting">
<span class="strong"><strong>[sshd]</strong></span>
<span class="strong"><strong>enabled=true</strong></span>
<span class="strong"><strong>bantime=86400</strong></span>
<span class="strong"><strong>maxretry=5</strong></span>
</pre></li><li><p>Start the Fail2ban service and enable its automatic start-up when the system boots:</p><pre class="programlisting">
<span class="strong"><strong>systemctl start fail2ban.service</strong></span>
<span class="strong"><strong>systemctl enable fail2ban.service</strong></span>
</pre></li><li><p>To view the <code class="literal">sshd</code> jail's status, use <code class="literal">fail2ban-client</code> with the <code class="literal">status</code> command:</p><pre class="programlisting">
<span class="strong"><strong>fail2ban-client status sshd</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec167"></a>How it works...</h3></div></div></div><p>You've learned how to install Fail2ban and configure automated IP blocking after several failed login attempts. You also learned how to manually ban and unban addresses using <code class="literal">fail2ban-client</code>.</p><p>A Fail2ban jail configuration brings together filter and action definitions to perform an activity whenever certain patterns are observed in a server's log file. Filters specify the pattern definitions for identifying interesting log entries, for example, repeated authentication failures. Actions, on the other hand, define the commands that run when a filter is matched. Fail2ban is shipped with several predefined filters for common servers such as Apache, MySQL, Sendmail, and SSH, and several predefined actions such as managing iptable entries to block and unblock IP addresses, sending e-mail notifications, and triggering DNS updates.</p><p>There are several jails defined in <code class="literal">/etc/fail2ban/jail.conf</code>. To activate the <code class="literal">sshd</code> jail, we created the <code class="literal">jail.local</code> file with entries that override and extend the default jail definition:</p><pre class="programlisting">
<span class="strong"><strong>[sshd]</strong></span>
<span class="strong"><strong>enabled=true</strong></span>
<span class="strong"><strong>bantime=86400</strong></span>
<span class="strong"><strong>maxretry=5</strong></span>
</pre><p>Intuitively, the <code class="literal">enabled</code> option enables or disables the jail. <code class="literal">maxretry</code>, which we set to <code class="literal">5</code>, is the number of failed login attempts permitted before Fail2ban enacts the ban. <code class="literal">bantime</code> sets how long the ban will last, which we set to <code class="literal">86400</code> seconds. With this configuration, users are allowed up to <code class="literal">5</code> failed attempts before their IP address is banned for 24 hours.</p><p>The existing definition from <code class="literal">jail.conf</code> already identifies the default port and the log file location. If you're running SSH on a nonstandard port, you can override the original definition's setting using <code class="literal">port</code>. The location of the SSH's log file can be overridden with <code class="literal">logfile</code>.</p><p><code class="literal">fail2ban-client</code> is used to interact with the Fail2ban service. Its <code class="literal">status</code> command outputs information about the service's current state, and if <code class="literal">status</code> is followed by a jail name then status information about the jail is returned instead. Perhaps of particular interest in the jail's status is a list of IP addresses that have been banned:</p><pre class="programlisting">
<span class="strong"><strong>fail2ban-client status sshd</strong></span>
</pre><div class="mediaobject"><img src="graphics/image_06_004.jpg" /><div class="caption"><p>The jail's status output presents the list of banned addresses</p></div></div><p>The client also has <code class="literal">get</code> and <code class="literal">set</code> commands to inspect and update various properties of the running service. For example, <code class="literal">get sshd bantime</code> returns the configured ban duration. <code class="literal">set sshd bantime</code> temporarily updates the durationÂ until the service is restarted.</p><p>You can manually ban an IP address by setting the jail's <code class="literal">banip</code> property:</p><pre class="programlisting">
<span class="strong"><strong>fail2ban-client set sshd banip 10.25.30.107</strong></span>
</pre><p>To manually unban an address, set <code class="literal">unbanip</code>:</p><pre class="programlisting">
<span class="strong"><strong>fail2ban-client set sshd unbanip 10.25.30.107</strong></span>
</pre><p>Being able to manually unban addresses is important in case a legitimate address is banned for some reason. If there are addresses that should never be blocked, perhaps a test integration server executing failed logins on purpose, or perhaps an administrator's computer, you can identify them using the <code class="literal">ignoreip</code> option in your <code class="literal">jail.local</code> configuration file and Fail2ban will avoid banning those addresses:</p><pre class="programlisting">
<span class="strong"><strong>ignoreip=10.25.30.107</strong></span>
</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec168"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on Fail2ban:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">fail2ban-client</code>Â manual page (<code class="literal">man 1 fail2ban-client</code>)</p></li><li style="list-style-type: disc"><p>Fail2ban Wiki (<a class="ulink" href="http://www.fail2ban.org/wiki/index.php/Main_Page" target="_blank">http://www.fail2ban.org/wiki/index.php/Main_Page</a>)</p></li><li style="list-style-type: disc"><p>Permanently ban repeat offenders with Fail2ban (<a class="ulink" href="http://stuffphilwrites.com/2013/03/permanently-ban-repeat-offenders-fail2ban/" target="_blank">http://stuffphilwrites.com/2013/03/permanently-ban-repeat-offenders-fail2ban/</a>)</p></li><li style="list-style-type: disc"><p>Monitoring the Fail2ban log (<a class="ulink" href="http://www.the-art-of-web.com/system/fail2ban-log/" target="_blank">http://www.the-art-of-web.com/system/fail2ban-log/</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec54"></a>Confining sessions to a chroot jail</h2></div></div><hr /></div><p>This recipe teaches you how to set up a chroot jail. A chroot call changes the user's view of the filesystem hierarchy by setting a particular path as the root; for the user, the path appears as <code class="literal">/</code> and they are unable to traverse beyond it. This creates a sandbox or jail, confining the user to a small branch of the real hierarchy. Chroot jails are commonly used for security purposes, for example, user containment and honeypots and also for application testing and in recovery procedures.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec169"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system running the OpenSSH server. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec170"></a>How to do it...</h3></div></div></div><p>Follow these steps to configure a chroot jail and confine users to it:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Download the <code class="literal">cpchroot</code> script needed to copy commands and their dependencies into the chroot environment:</p><pre class="programlisting">
<span class="strong"><strong>curl -Lo ~/cpchroot tinyurl.com/zyzozdp</strong></span>
</pre></li><li><p>Make the script executable using <code class="literal">chmod</code>:</p><pre class="programlisting">
<span class="strong"><strong>chmod +x ~/cpchroot</strong></span>
</pre></li><li><p>Create the <code class="literal">/jail</code> directory and its subdirectories to mimic a root filesystem:</p><pre class="programlisting">
<span class="strong"><strong>mkdir -p /jail/{dev,home,usr/{bin,lib,lib64,share}}</strong></span>
<span class="strong"><strong>cd /jail</strong></span>
<span class="strong"><strong>ln -s usr/bin bin</strong></span>
<span class="strong"><strong>ln -s usr/lib lib</strong></span>
<span class="strong"><strong>ln -s usr/lib64 lib64</strong></span>
</pre></li><li><p>Execute the <code class="literal">chroot</code> script to copy the desired programs and commands:</p><pre class="programlisting">
<span class="strong"><strong>~/cpchroot /jail bash cat cp find grep less ls
       mkdir mv pwd rm rmdir</strong></span>
</pre></li><li><p>Copy the <code class="literal">terminfo</code> database:</p><pre class="programlisting">
<span class="strong"><strong>cp -R /usr/share/terminfo /jail/usr/share</strong></span>
</pre></li><li><p>Create the special device files under <code class="literal">/jail/dev</code> using <code class="literal">mknod</code>:</p><pre class="programlisting">
<span class="strong"><strong>cd /jail/dev</strong></span>
<span class="strong"><strong>mknod null c 1 3</strong></span>
<span class="strong"><strong>mknod zero c 1 5</strong></span>
<span class="strong"><strong>mknod random c 1 8</strong></span>
</pre></li><li><p>Create a group for chroot'd users:</p><pre class="programlisting">
<span class="strong"><strong>groupadd sandbox</strong></span>
</pre></li><li><p>Open the <code class="literal">/etc/ssh/sshd_config</code> file with your text editor and add the following to the end of the file:</p><pre class="programlisting">
<span class="strong"><strong>       Match Group sandbox
           ChrootDirectory /jail
</strong></span>
</pre></li><li><p>Save your changes and close the configuration file.</p></li><li><p>Restart the SSH server for the changes to take effect:</p><pre class="programlisting">
<span class="strong"><strong>systemctl restart sshd.service</strong></span>
</pre></li></ol></div><p>To create a new chroot'd user, create the user with <code class="literal">useradd</code> and assign them to the <code class="literal">sandbox</code> group:</p><pre class="programlisting">
<span class="strong"><strong>useradd -s /bin/bash -m -G sandbox rdiamond</strong></span>
</pre><p>Then, move their <code class="literal">home</code> directory to reside under the chroot <code class="literal">jail</code>:</p><pre class="programlisting">
<span class="strong"><strong>mv /home/rdiamond /jail/home</strong></span>
</pre><p>To chroot an existing user, assign them to the <code class="literal">sandbox</code> group and move their <code class="literal">home</code> directory to the <code class="literal">jail</code>:</p><pre class="programlisting">
<span class="strong"><strong>usermod -G sandbox bbarrera</strong></span>
<span class="strong"><strong>mv /home/bbarrera /jail/home</strong></span>
</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec171"></a>How it works...</h3></div></div></div><p>Identifying and copying dependencies is tedious and error-prone if done manually. So, I've written a helper script to automate the process of finding and cloning programs with their dependencies into the jail. Our first steps were to download the script using <code class="literal">curl</code> and then make it executable using <code class="literal">chmod</code>:</p><pre class="programlisting">
<span class="strong"><strong>curl -Lo ~/cpchroot tinyurl.com/zyzozdp</strong></span>
<span class="strong"><strong>chmod +x ~/cpchroot</strong></span>
</pre><p>The script is hosted on GitHub, but its direct URL was prohibitively long so I used a URL-shortening service to shorten the address. We need to provide <code class="literal">-L</code> for <code class="literal">curl</code> to follow any redirects (the service responds with a redirect to GitHub) and <code class="literal">-o</code> sets the name of the download, in this case <code class="literal">cpchroot</code>, in your <code class="literal">home</code> directory.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note41"></a>Note</h3><p>If you're having problems because of the URL-shortening service, you can find the direct link by visiting <a class="ulink" href="https://gist.github.com/tboronczyk/00d77b1baafd13daab3b" target="_blank">https://gist.github.com/tboronczyk/00d77b1baafd13daab3b</a>, clicking on the <span class="strong"><strong>Raw</strong></span> button, and then copying the URL that appears in your browser's address bar.</p></div><p>Next, we created the <code class="literal">/jail</code> directory containing a directory structure that mimics the root filesystem. When a user logs in and is chroot'd, they and everything they do will be contained to <code class="literal">/jail</code>. They will not be able to traverse outside that directory, so we need to replicate the directory layout the programs expect:</p><pre class="programlisting">
<span class="strong"><strong>mkdir -p /jail/{dev,home,usr/{bin,lib,lib64,share}}</strong></span>
<span class="strong"><strong>cd /jail</strong></span>
<span class="strong"><strong>ln -s usr/bin bin</strong></span>
<span class="strong"><strong>ln -s usr/lib lib</strong></span>
<span class="strong"><strong>ln -s usr/lib64 lib64</strong></span>
</pre><p>We used <code class="literal">mkdir</code> with the <code class="literal">-p</code> option and took advantage of shell expansion to create most of the layout with a single command. CentOS sets up its top-level <code class="literal">/bin</code>, <code class="literal">/lib</code>, and <code class="literal">/lib64</code> directories as symbolic links to the corresponding directories under <code class="literal">/usr</code>, which we duplicated using <code class="literal">ln</code> within the <code class="literal">/jail</code> directory. The final layout looks like the following one presented:</p><div class="mediaobject"><img src="graphics/image_06_005.jpg" /><div class="caption"><p>The layout of the sandbox root mimics that of the host's root filesystem</p></div></div><p>Next, we used the script to copy the desired commands to the jail. The script does the hard work of finding each program's binary and identifies all of the libraries it depends on, and then it copies everything into the appropriate location in the sandboxed filesystem:</p><pre class="programlisting">
<span class="strong"><strong>~/cpchroot /jail bash cat cp find grep less ls mkdir mv pwd rm rmdir</strong></span>
</pre><p>Its first argument is the directory acting as our chroot'd root, and then following that is a list of one or more programs we want to make available to the user. The recipe provides a dozen programs as an example, and you should feel free to add or omit some as you see fit. At a minimum, you need a shell (<code class="literal">bash</code>). I recommend that you include at least <code class="literal">ls</code> and <code class="literal">pwd</code> so that the user can navigate.</p><p>Then, we copied the <code class="literal">terminfo</code> database to the <code class="literal">jail</code>:</p><pre class="programlisting">
<span class="strong"><strong>cp -R /usr/share/terminfo /jail/usr/share/</strong></span>
</pre><p>Some programs, such as <code class="literal">screen</code>, <code class="literal">less</code>, and <code class="literal">vi</code>, use the <code class="literal">terminfo</code> database to make sure their output displays correctly. The database is a collection of files that describe the capabilities of different terminal types, such as the number of lines per screen, how to clear the screen, what colors are supported, and so on. If this information isn't accessible, users will be warned that the <code class="literal">terminal is not fully functional</code> and the output may be garbled.</p><p>To finish making the <code class="literal">jail</code>, we created the <code class="literal">/dev/null</code>, <code class="literal">/dev/zero</code>, and <code class="literal">/dev/random</code> devices with the <code class="literal">mknod</code> command:</p><pre class="programlisting">
<span class="strong"><strong>cd /jail/dev/</strong></span>
<span class="strong"><strong>mknod null c 1 3</strong></span>
<span class="strong"><strong>mknod zero c 1 5</strong></span>
<span class="strong"><strong>mknod random c 1 8</strong></span>
</pre><p><code class="literal">mknod</code> is used to create special files such as character files and block files. These files are special because they can generate data (as is the case with <code class="literal">null</code> and <code class="literal">zero</code>) or represent physical devices and receive data. Both <code class="literal">null</code> and <code class="literal">zero</code> are character files, as indicated by the letter <code class="literal">c</code>, since we read from them one character at a time. Block files, on the other hand, operate with several characters at a time. A physical storage disk is often represented as a block device.</p><p>We also need to provide a major and minor number when creating a character or block device. These values are predefined and understood by the kernel as to how the device file should behave. <code class="literal">1</code> and <code class="literal">3</code> are the major and minor numbers that define a null device. <code class="literal">1</code> and <code class="literal">5</code> define the file as a null byte source. You can see the full list of major and minor number assignments in the Linux Allocated Device document listed in this recipe's <span class="emphasis"><em>See also</em></span> section.</p><p>After the chroot environment was set up, we turned our attention to configure the SSH server. First, we created the <code class="literal">sandbox</code> group, which can be assigned to any user we want contained:</p><pre class="programlisting">
<span class="strong"><strong>groupadd sandbox</strong></span>
</pre><p>Next, we added a <code class="literal">Match</code> block to the SSH server's configuration file targeting the new group:</p><pre class="programlisting">
<span class="strong"><strong>Match Group sandbox</strong></span>
<span class="strong"><strong>    ChrootDirectory /jail</strong></span>
</pre><p><code class="literal">Match</code> starts a new conditional section in the configuration file that applies only when its condition is matched. In this case, we're matching the user's group to <code class="literal">sandbox</code>. When the user is a member of the group, the <code class="literal">ChrootDirectory</code> option is applied and it sets <code class="literal">/jail</code> as the user's root directory. Now when a user connects, anything they do will be confined to the chroot jail, including actions that happen automatically such as launching an interactive shell (<code class="literal">bash</code>).</p><p>Bash tries to place the user in their <code class="literal">home</code> directory after signing in. However, if their <code class="literal">home</code> directory isn't accessible, the user will see the error message <code class="literal">Could not chdir to home directory</code> and find themselves in the root directory. To avoid this, we moved their <code class="literal">home</code> directory into the <code class="literal">jail</code>:</p><pre class="programlisting">
<span class="strong"><strong>mv /home/jbhuse /jail/home/</strong></span>
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note42"></a>Note</h3><p>You might be tempted to specify the <code class="literal">home</code> directory when creating a new user, as follows:</p><p>
<span class="strong"><strong><code class="literal">useradd -m -D /jail/home/jbhuse -G sandbox jbhuse</code></strong></span>
</p><p>Unfortunately, this doesn't work. The <code class="literal">home</code> directory is created in the desired location, the user is chroot'd, and the path is viewed in relation to <code class="literal">/jail</code> so that bash looks for <code class="literal">/jail/jail/home/jbhuse</code>. This is why the recipe demonstrates moving the <code class="literal">home</code> directory as a second step. The entry in <code class="literal">/etc/passwd</code> stays, <code class="literal">/home/jbhuse</code> is interpreted as <code class="literal">/jail/home/jbhuse</code>, and all is right with the world.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec172"></a>See also</h3></div></div></div><p>Refer to the following for more information on setting up chroot environments:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">sshd_config</code>Â manual page (<code class="literal">man 5 sshd_config</code>)</p></li><li style="list-style-type: disc"><p>How to Configure SFTP with Chroot (<a class="ulink" href="http://www.unixmen.com/configure-sftp-chroot-rhel-centos-7" target="_blank">http://www.unixmen.com/configure-sftp-chroot-rhel-centos-7</a>)</p></li><li style="list-style-type: disc"><p>Safely identify dependencies for chrooting (<a class="ulink" href="http://zaemis.blogspot.com/2016/02/safely-identify-dependencies-for-chroot.html" target="_blank">http://zaemis.blogspot.com/2016/02/safely-identify-dependencies-for-chroot.html</a>)</p></li><li style="list-style-type: disc"><p>Linux allocated devices (<a class="ulink" href="https://www.kernel.org/doc/Documentation/devices.txt" target="_blank">https://www.kernel.org/doc/Documentation/devices.txt</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec55"></a>Configuring TigerVNC</h2></div></div><hr /></div><p>Virtual Network Computing (VNC) works by capturing the display's frame buffer and making it available across the network. This recipe shows you how to install TigerVNC and configure it to provide remote users access to their graphical desktop environment as if they were physically in front of the system.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec173"></a>Getting ready</h3></div></div></div><p>This recipe requires two systems, a CentOS system to host the VNC server (remote system) and a local computer with a VNC client to connect to it. It assumes that the remote system is running the OpenSSH SSH server and a graphical desktop environment such as GNOME or KDE. Administrative privileges are required on the remote server, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>. The local computer is expected to have a VNC client installed.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec174"></a>How to do it...</h3></div></div></div><p>Follow these steps to install and configure TigerVNC:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>On the remote system, install the TigerVNC server package:</p><pre class="programlisting">
<span class="strong"><strong>yum install tigervnc-server</strong></span>
</pre></li><li><p>Copy the example unit file provided with the package to <code class="literal">/etc/systemd/system</code>, adjusting its name to include the username of the person using VNC:</p><pre class="programlisting">
<span class="strong"><strong>cp /usr/lib/systemd/system/vncserver@.service
       /etc/systemd/system/vncserver-tboronczyk@.service</strong></span>
</pre></li><li><p>Open the new unit file with your text editor:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/systemd/system/vncserver-tboronczyk@.service</strong></span>
</pre></li><li><p>Replace the <code class="literal">&lt;USER&gt;</code> placeholder that appears in the <code class="literal">[Service]</code> section's <code class="literal">ExecStart</code> and <code class="literal">PIDFile</code> entries:</p><pre class="programlisting">
<span class="strong"><strong>ExecStart=/usr/sbin/runuser -l tboronczyk -c "/usr/bin/
       vncserver %i"</strong></span>
<span class="strong"><strong>PIDFile=/home/tboronczyk/.vnc/%H%i.pid</strong></span>
</pre></li><li><p>Save your changes and close the file.</p></li><li><p>Repeat steps 2 to 5 for each user who will use VNC to connect to their desktop.</p></li><li><p>Reload systemd's configuration to make it aware of the new unit files:</p><pre class="programlisting">
<span class="strong"><strong>systemctl daemon-reload</strong></span>
</pre></li><li><p>Open ports <code class="literal">5900</code> through <code class="literal">5903</code> in the system's firewall to accept incoming VNC requests:</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --add-service=vnc- server</strong></span>
<span class="strong"><strong>firewall-cmd --reload</strong></span>
</pre></li><li><p>The users using VNC should set the password they'll use to authenticate with the VNC server using <code class="literal">vncpasswd</code>:</p><pre class="programlisting">
<span class="strong"><strong>vncpasswd</strong></span>
</pre></li><li><p>When a user wants to connect, specify a display number after <code class="literal">@</code> in the unit's name when starting TigerVNC:</p><pre class="programlisting">
<span class="strong"><strong>systemctl start vncserver-tboronczyk@:1.service</strong></span>
</pre></li><li><p>Stop the server when it's not in use:</p><pre class="programlisting">
<span class="strong"><strong>systemctl stop vncserver-tboronczyk@.service</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec175"></a>How it works...</h3></div></div></div><p>Along with the VNC server, the <code class="literal">tigervnc-server</code> package installs a <code class="literal">systemd</code> unit file to start and stop the server. However, there's some configuration we need to attend to before using it because the server runs under the user's account to obtain their desktop.</p><p>When TigerVNC starts, it connects to the X server and logs in to the user's desktop just as if the user was sitting in front of the system itself. This means each user needs their own instance of the server running and we need to configure it for each user. We made a copy of the original unit file found under <code class="literal">/usr/lib/systemd/system</code>, one for each user.</p><pre class="programlisting">
<span class="strong"><strong>cp /usr/lib/systemd/system/vncserver@.service /etc/systemd/system/
    vncserver-tboronczyk@.service</strong></span>
</pre><p>The name of the copied file contains the username so that we can keep everything organized. They're placed under <code class="literal">/etc/systemd/system</code> because <code class="literal">systemd</code> looks in <code class="literal">/etc/systemd</code> for units before searching <code class="literal">/usr/lib/systemd</code> (in fact, many entries in <code class="literal">/etc/systemd</code> are symbolic links to their original files under <code class="literal">/usr/lib/systemd</code>). So, placing the copies there lets us keep the original intact and safeguards us from loosing our configuration in the event of an upgrade where the original until file is replaced.</p><div class="mediaobject"><img src="graphics/image_06_006.jpg" /><div class="caption"><p>This system has VNC access configured for several users</p></div></div><p>We replaced any occurrence of the <code class="literal">&lt;USER&gt;</code> placeholder under the <code class="literal">[SERVICE]</code> section in each configuration file with the appropriate username:</p><pre class="programlisting">
<span class="strong"><strong>ExecStart=/usr/sbin/runuser -l tboronczyk -c "/usr/bin/vncserver %i"</strong></span>
<span class="strong"><strong>PIDFile=/home/tboronczyk/.vnc/%H%i.pid</strong></span>
</pre><p>The command specified in the <code class="literal">ExecStart</code> entry is invoked when we start the server using <code class="literal">systemctl start</code>; it uses <code class="literal">runuser</code> to run TigerVNC under the user's account. The <code class="literal">-l</code> (lowercase L) argument provides the username and <code class="literal">-c</code> specifies the command and its arguments that <code class="literal">runuser</code> will execute. The <code class="literal">PIDFile</code> entry specifies the directory in which the running process will keep track of its process ID.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note43"></a>Note</h3><p>Dan Walsh, the author of <code class="literal">runuser</code>, wrote a blog entry entitled <span class="emphasis"><em>runuser vs su</em></span> detailing the backstory behind the command. You can read it online at <a class="ulink" href="http://danwalsh.livejournal.com/55588.html" target="_blank">http://danwalsh.livejournal.com/55588.html</a>.</p></div><p>The <code class="literal">@</code> symbol appearing in the filename has special significance to systemd. Anything after it and before the file suffix is passed to the commands in the unit file replacing <code class="literal">%i</code>. This lets us pass limited information to the server, for example, the display number for TigerVNC to run on. When we start the server as shown in the recipe, <code class="literal">:1</code> is given after <code class="literal">@</code>. The value is parsed by systemd and TigerVNC is started on display 1. If we use <code class="literal">:2</code>, the server will start on display 2. We can start multiple instances of TigerVNC for different users or even for the same user as long as the display is different for each:</p><pre class="programlisting">
<span class="strong"><strong>systemctl start vncserver-tboronczyk@:1.service</strong></span>
</pre><p>Traffic for the display's corresponding port should be allowed by the firewall. Display 0 uses port <code class="literal">5900</code>, display 1 uses port <code class="literal">5901</code>, display 2 uses port <code class="literal">5902</code>, and so on. If you're using FirewallD, the predefined <code class="literal">vnc-server</code> service opens ports <code class="literal">5900</code>-<code class="literal">5903</code>:</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --add-service=vnc-server</strong></span>
</pre><p>If you need additional ports or if you don't need to open the entire range, you can open just what you need using <code class="literal">--add-port</code>:</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --add-port=5901/tcp</strong></span>
</pre><p>The user needs to set a VNC password using <code class="literal">vncpasswd</code> before they can connect to the display. The password must be at least six characters long, although only the first eight characters are significant. Moreover, the password is stored in the user's <code class="literal">~/.vnc/</code> directory. In the light of these issues, it's recommended that the user doesn't use the same password as their account password. It's also wise to run the VNC server only when needed since anyone who knows the display number and password can connect to it.</p><p>The user also needs a VNC client to connect from their local computer. CentOS users can install the <code class="literal">tigervnc</code> package to use TigerVNC's client. Other popular clients are Vinagre for Ubuntu, RealVNC for TightVNC on Windows, and Chicken of the VNC for OS X:</p><pre class="programlisting">
<span class="strong"><strong>yum install tigervnc</strong></span>
</pre><p>The IP address or hostname for the remote system and the display (port) that VNC is running are needed to establish the connection. They can be provided in different ways depending on the client, but the standard format accepted by most clients appends the display to the system's address, for example, <code class="literal">192.168.56.100:1</code>. The user will then be prompted for their password, and if all goes well they'll be connected to the remote display:</p><div class="mediaobject"><img src="graphics/image_06_007.jpg" /><div class="caption"><p>A user prepares to connect to a remote display using VNC</p></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec176"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on running TigerVNC and how systemd uses <code class="literal">@</code> in filenames:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>TigerVNC (<a class="ulink" href="http://tigervnc.org/" target="_blank">http://tigervnc.org/</a>)</p></li><li style="list-style-type: disc"><p>RHEL 7 System Administrator's Guide: TigerVNC (<a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/ch-TigerVNC.html" target="_blank">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/ch-TigerVNC.html</a>)</p></li><li style="list-style-type: disc"><p>ArchWiki: TigerVNC (<a class="ulink" href="https://wiki.archlinux.org/index.php/TigerVNC" target="_blank">https://wiki.archlinux.org/index.php/TigerVNC</a>)</p></li><li style="list-style-type: disc"><p>The <code class="literal">@</code> symbol and <code class="literal">systemctl</code> (<a class="ulink" href="http://superuser.com/questions/393423/the-symbol-and-systemctl-and-vsftpd/393429#393429" target="_blank">http://superuser.com/questions/393423/the-symbol-and-systemctl-and-vsftpd/393429#393429</a>)</p></li><li style="list-style-type: disc"><p>Understanding Systemd Units and Unit Files (<a class="ulink" href="https://www.digitalocean.com/community/tutorials/understanding-systemd-units-and-unit-files" target="_blank">https://www.digitalocean.com/community/tutorials/understanding-systemd-units-and-unit-files</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch06lvl1sec56"></a>Tunneling VNC connections through SSH</h2></div></div><hr /></div><p>The previous recipe showed you how to give remote access to the user's desktop through VNC. However, there are clearly some security concerns if the service is running on an untrusted network. Only the display number and password are required to connect, and the password can be relatively easy for a malicious user to crack given that only the first eight characters are significant. Moreover, the traffic is unencrypted and it may be snooped. To help mitigate these risks, this recipe teaches you how to route the VNC connection through an encrypted SSH tunnel.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec177"></a>Getting ready</h3></div></div></div><p>This recipe requires two systems, a CentOS system hosting the VNC server (remote system) and a local computer with a VNC client to connect to it. It assumes that the remote system is running the OpenSSH SSH server and TigerVNC server and is configured with the IP address <code class="literal">192.168.56.100</code>. It also assumes that you have administrative privileges. The VNC server should be configured as described in the previous recipe. The local computer should have the OpenSSH SSH client (<code class="literal">ssh</code>) and a VNC client installed.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec178"></a>How to do it...</h3></div></div></div><p>Follow these steps to route VNC connections through an encrypted SSH tunnel:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>On the remote server, open a <code class="literal">vncserver@.service</code> configuration file using your text editor:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/systemd/system/vncserver-tboronczyk@.service</strong></span>
</pre></li><li><p>Locate the <code class="literal">ExecStart</code> entry and add the <code class="literal">-localhost</code> argument to the <code class="literal">vncserver</code> command invoked by <code class="literal">runuser</code>:</p><pre class="programlisting">
<span class="strong"><strong>       ExecStart=/usr/sbin/runuser -l tboronczyk -c "/usr/bin/vncserver</strong></span>
<span class="strong"><strong>Â Â Â     -localhost %i"
</strong></span>
</pre></li><li><p>Save your change and close the file.</p></li><li><p>Repeat steps 1 to 3 as necessary for the other users' configuration files.</p></li><li><p>Reload systemd's configuration to make it aware of the updates:</p><pre class="programlisting">
<span class="strong"><strong>systemctl daemon-reload</strong></span>
</pre></li><li><p>Start the VNC server:</p><pre class="programlisting">
<span class="strong"><strong>systemctl start vncserver-tboronczyk@:1.service</strong></span>
</pre></li><li><p>On your local system, establish an SSH session to the server with <code class="literal">-L</code> to define the tunnel:</p><pre class="programlisting">
<span class="strong"><strong>ssh -L 5901:localhost:5901 192.168.56.100</strong></span>
</pre></li><li><p>Connect to the tunnel's local endpoint (<code class="literal">localhost:1</code>) using a VNC client.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec179"></a>How it works...</h3></div></div></div><p>This recipe showed you how to secure VNC by tunneling its traffic through SSH. We configured the TigerVNC server to only accept connections from its localhost and then set up a tunnel on the local client side to route traffic through an SSH connection. This helps mitigate some of the aforementioned security risks because proper authentication is needed to establish the tunnel and encrypt the VNC traffic.</p><p>First, you edited the <code class="literal">ExecStart</code> command in the unit files used to start instances of the VNC server. The <code class="literal">-localhost</code> argument to <code class="literal">vncserver</code> instructs the server to communicate only with the local system; any incoming connections originating from the network will be refused:</p><pre class="programlisting">
<span class="strong"><strong>ExecStart=/usr/sbin/runuser -l tboronczyk -c "/usr/bin/vncserver
    -localhost %i"</strong></span>
</pre><p>On the client side, the user now needs to establish an SSH tunnel using <code class="literal">ssh</code> before they can connect to the remote display:</p><pre class="programlisting">
<span class="strong"><strong>ssh -L 5901:localhost:5901 192.168.56.100</strong></span>
</pre><p>The <code class="literal">-L</code> argument defines the tunnel as <code class="literal">local-port:target-host:target-port</code>. The target host and port represent the final destination in relation to the server <code class="literal">ssh</code> is connected to. For example, we know that the recipe is running the user's desktop on display 1 which uses port <code class="literal">5901</code>. We also know that TigerVNC server is running on <code class="literal">192.168.56.100</code> but configured to listen only to its localhost. This means, we need to connect to <code class="literal">localhost:5901</code> from <code class="literal">192.168.56.100</code>. Thus, <code class="literal">localhost:5901</code> is the target in relation to that system.</p><p>Once the user has an established tunnel, they can minimize the session's terminal. (Don't close it!) <code class="literal">ssh</code> is connected to the remote system while also listening on the local port (also <code class="literal">5901</code>). On the remote server, <code class="literal">ssh</code> has established a second connection to the target host and port. The VNC client will connect to the local port by using the address <code class="literal">localhost:1</code> where the traffic is then routed through the SSH tunnel to the remote server and then forwarded to the final destination.</p><p>The remote system acts as a gateway as traffic travels through it from the client's tunnel to the final destination. Keep in mind, unless a tunnel to the target has also been created on the remote server, the second leg of the data's journey is not encrypted. This isn't a concern for this recipe because the remote and target hosts are the same. If your final destination is anything other than localhost, ensure that the network is trusted or create a second tunnel.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note44"></a>Note</h3><p>Routing traffic with SSH in this fashion can be done to secure other services as well, for example, NFS, FTP, HTTP, POP3, and SMTP. The overall process is the same: configure the server to listen locally and then establish the tunnel on the client.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl2sec180"></a>See also</h3></div></div></div><p>Refer to the following resources to learn more about SSH tunneling:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">ssh</code>Â manual page (<code class="literal">man 1 ssh</code>)</p></li><li style="list-style-type: disc"><p>Securing network traffic with SSH (<a class="ulink" href="https://security.berkeley.edu/resources/best-practices-how-articles/securing-network-traffic-ssh-tunnels" target="_blank">https://security.berkeley.edu/resources/best-practices-how-articles/securing-network-traffic-ssh-tunnels</a>)</p></li><li style="list-style-type: disc"><p>SSH tunneling made easy (<a class="ulink" href="http://www.revsys.com/writings/quicktips/ssh-tunnel.html" target="_blank">http://www.revsys.com/writings/quicktips/ssh-tunnel.html</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="chapter" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="ch07"></a>ChapterÂ 7.Â Working with Databases</h2></div></div></div><p>This chapter contains the following recipes:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Setting up a MySQL database</p></li><li style="list-style-type: disc"><p>Backing up and restoring a MySQL database</p></li><li style="list-style-type: disc"><p>Configuring MySQL replication</p></li><li style="list-style-type: disc"><p>Setting up a MySQL cluster</p></li><li style="list-style-type: disc"><p>Setting up a MongoDB database</p></li><li style="list-style-type: disc"><p>Backing up and restoring a MongoDB database</p></li><li style="list-style-type: disc"><p>Configuring a MongoDB replica set</p></li><li style="list-style-type: disc"><p>Setting up an OpenLDAP directory</p></li><li style="list-style-type: disc"><p>Backing up and restoring an OpenLDAP directory</p></li></ul></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec57"></a>Introduction</h2></div></div><hr /></div><p>This chapter focuses on three databases. First, you'll learn how to install one of the most widely used relational database servers, MySQL. You'll also learn how to set up master-slave replication to maintain mirror copies of your MySQL databases, and how to stand up a MySQL cluster to provide scalable, high-availability data storage. Next, we'll move to the world of NoSQL databases. You'll learn how to install the popular document-oriented database server MongoDB, and how to configure a MongoDB replica set (replication). Then you'll learn how to set up an LDAP directory server using OpenLDAP. For each of these databases, the chapter also has recipes to show you how to perform basic backup and restore tasks to keep your data safe.</p></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec58"></a>Setting up a MySQL database</h2></div></div><hr /></div><p>This recipe shows you how to perform a basic installation of the popular MySQL database server on CentOS. MySQL is the second most widely used database system today, which is found across many different industries providing data storage for everything from dynamic websites to large-scale data warehouses.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec181"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection and administrative privileges either using the <code class="literal">root</code> account or <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec182"></a>How to do it...</h3></div></div></div><p>Follow these steps to install MySQL and create a new database:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Download the repository configuration package for the Oracle-maintained MySQL repository:</p><pre class="programlisting">
<span class="strong"><strong>curl -LO dev.mysql.com/get/mysql57-community-release-el7-
       7.noarch.rpm</strong></span>
</pre></li><li><p>Install the downloaded package:</p><pre class="programlisting">
<span class="strong"><strong>yum install mysql57-community-release-el7-7.noarch.rpm</strong></span>
</pre></li><li><p>Now that the MySQL repository is registered, install the <code class="literal">mysql-community-server</code> package:</p><pre class="programlisting">
<span class="strong"><strong>yum install mysql-community-server</strong></span>
</pre></li><li><p>Start the MySQL server and enable it to start automatically whenever the system reboots:</p><pre class="programlisting">
<span class="strong"><strong>systemctl start mysqld.service</strong></span>
<span class="strong"><strong>systemctl enable mysqld.service</strong></span>
</pre></li><li><p>Open port <code class="literal">3306</code> in the system's firewall to allow outside connections to MySQL:</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --add-service=mysql</strong></span>
<span class="strong"><strong>firewall-cmd --reload</strong></span>
</pre></li><li><p>Retrieve the temporary password for MySQL's <code class="literal">root</code> user from the server's log file:</p><pre class="programlisting">
<span class="strong"><strong>grep "temporary password" /var/log/mysqld.log</strong></span>
</pre></li><li><p>Set a new password for <code class="literal">root</code> using <code class="literal">mysqladmin</code>. When the program prompts for the current password, enter the temporary password found in the logs:</p><pre class="programlisting">
<span class="strong"><strong>mysqladmin -u root -p password</strong></span>
</pre></li><li><p>Use <code class="literal">mysql</code> to connect to the MySQL server using the <code class="literal">root</code> account:</p><pre class="programlisting">
<span class="strong"><strong>mysql -u root -p</strong></span>
</pre></li><li><p>To create a new database, execute a <code class="literal">CREATE DATABASE</code> statement:</p><pre class="programlisting">
<span class="strong"><strong>CREATE DATABASE packt;</strong></span>
</pre></li><li><p>Execute a <code class="literal">CREATE USER</code> statement to create a MySQL user account for working with the database:</p><pre class="programlisting">
<span class="strong"><strong>CREATE USER "tboronczyk"@"localhost" IDENTIFIED  BY "P@$$W0rd";</strong></span>
</pre></li><li><p>Execute a <code class="literal">GRANT</code> statement to assign the appropriate privileges to the account for the new database:</p><pre class="programlisting">
<span class="strong"><strong>GRANT CREATE, DROP, ALTER, LOCK TABLES, INDEX,  INSERT, UPDATE,
       SELECT, DELETE ON packt.* TO </strong></span>
<span class="strong"><strong>"tboronczyk"@"localhost";</strong></span>
</pre></li><li><p>Execute <code class="literal">FLUSH PRIVILEGES</code> to instruct MySQL to rebuild its privileges cache:</p><pre class="programlisting">
<span class="strong"><strong>FLUSH PRIVILEGES;</strong></span>
</pre></li><li><p>Exit the MySQL client and return to the terminal:</p><pre class="programlisting">
<span class="strong"><strong>exit</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec183"></a>How it works...</h3></div></div></div><p>We began by downloading the package that registers the Oracle-maintained MySQL repository on our system. MySQL is installed from the Oracle repository, because the CentOS repositories install MariaDB instead. After a series of acquisitions between 2008 and 2010, the MySQL codebase and trademark became the property of Oracle. Widespread concern over Oracle's stewardship and the future of MySQL prompted one of the original developers of MySQL to fork the project and start MariaDB. In 2014, the Red Hat and CentOS repositories replaced MySQL as the default database with MariaDB (welcome to the world of open-source politics).</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note45"></a>Note</h3><p>MariaDB's goal is to remain a free, open-source project under the GNU GPL license and to be an "enhanced, drop-in replacement" for MySQL. For now, differences between the two are negligible to the casual user. But in the world of forked replacements, it's mainly the programming interfaces and communication protocols that remain compatible. Core functionality may remain the same initially, but new features are added independently as time goes on and the products' feature sets begin to diverge. MariaDB acknowledges this with a jump in versioning numbers. MariaDB 5.1 offers the same features as MySQL 5.1, as does MariaDB 5.5 for MySQL 5.5. However, MariaDB doesn't plan to implement all of MySQL 5.6's features and changed their version number to 10.0. For those keeping score at home, the Oracle-maintained repository hosts MySQL 5.7 at the time of this writing. The CentOS repositories currently offer MariaDB 5.5.</p></div><p>The server that hosts the package assumes that people download the file using a web browser and issues a redirect to begin the download. Since we're using <code class="literal">curl</code>, we supplied the <code class="literal">-L</code> argument to follow the redirects to reach the actual package:</p><pre class="programlisting">
<span class="strong"><strong>curl -LO dev.mysql.com/get/mysql57-community-release-el7-7.noarch.rpm</strong></span>
</pre><p>Next, we installed the downloaded package. Once the repository is registered, we're able to install MySQL with the <code class="literal">mysql-community-server</code> package. The package installs the server binaries, and the client utilities to work with MySQL are installed as dependencies:</p><pre class="programlisting">
<span class="strong"><strong>yum install mysql57-community-release-el7-7.noarch.rpm</strong></span>
<span class="strong"><strong>yum install mysql-community-server</strong></span>
</pre><p>MySQL maintains its own user accounts and its administrative user is named <code class="literal">root</code>. Just like CentOS's <code class="literal">root</code> user, you shouldn't use the account for regular activities; it should be reserved for administrative tasks such as creating new users, granting privileges, and flushing the server's caches. Other less-privileged accounts should be used for everyday activities. To protect the <code class="literal">root</code> account, its password is randomly generated the first time we start the MySQL server. We needed to search the log file where MySQL recorded the password so that we can set a new password of our own choosing:</p><pre class="programlisting">
<span class="strong"><strong>grep "temporary password" /var/log/mysqld.log</strong></span>
</pre><p>Knowing the temporary password, we used <code class="literal">mysqladmin</code> to change it. The <code class="literal">-u</code> option gives the username of the MySQL account, <code class="literal">-p</code> prompts us for the account's password, and <code class="literal">password</code> is the utility's subcommand used to change passwords. We entered the temporary password when prompted for the original and then we were asked to enter and confirm the new password:</p><pre class="programlisting">
<span class="strong"><strong>mysqladmin -u root -p password</strong></span>
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note46"></a>Note</h3><p>A random default password for <code class="literal">root</code> is a new behavior starting with MySQL 5.6, which writes the password to <code class="literal">/root/.mysql_secret</code>, whereas 5.7 writes it to the log file. In older versions, and thus MariaDB since 5.5 is installed by the CentOS repositories, the password is empty.
The <code class="literal">validate_password</code> plugin is also activated in MySQL 5.7. It requires the password to be eight characters or more with at least one number, one upper and one lowercase character, and one special character (that is, punctuation). Consider these requirements when choosing root's new password.</p></div><div class="mediaobject"><img src="graphics/image_07_001.jpg" /><div class="caption"><p>The temporary password is needed to set root's permanent password</p></div></div><p>There are several clients that we can use to connect to MySQL and interact with our databases. This recipe used <code class="literal">mysql</code> since it will have been installed by default as a dependency. Again, <code class="literal">-u</code> identifies the account's username and <code class="literal">-p</code> prompts us for its password:</p><pre class="programlisting">
<span class="strong"><strong>mysql -u root -p</strong></span>
</pre><p>When running in interactive mode, the client displays the prompt <code class="literal">mysql&gt;</code> at which we submit our SQL statements. After each query, the client displays the server's response, how long the statement took to execute, and if the server reported any errors or warnings.</p><p>We issued a <code class="literal">CREATE DATABASE</code> statement at the prompt to create the new database named <code class="literal">packt</code>:</p><pre class="programlisting">
<span class="strong"><strong>CREATE DATABASE packt;</strong></span>
</pre><p>Then we created a new user account with <code class="literal">CREATE USER</code> to avoid using <code class="literal">root</code> for our day-to-day work. The account is named <code class="literal">tboronczyk</code> and is allowed to authenticate from the localhost:</p><pre class="programlisting">
<span class="strong"><strong>CREATE USER "tboronczyk"@"localhost" IDENTIFIED BY "P@$$w0rd";</strong></span>
</pre><p>A system's hostname or IP address can replace <code class="literal">localhost</code> if the account will connect to the server from a different system. MySQL treats each username and hostname pair to be separate accounts though, for example <code class="literal">tboronczyk@localhost</code> and <code class="literal">tboronczyk@ 192.168.56.100</code> are different accounts and can have different privileges assigned to them.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note47"></a>Note</h3><p>You can use wildcards in the hostname to create an account that can connect from multiple systems. The <code class="literal">%</code> wildcard matches zero or more characters, so it can be used to represent any system:</p><p>
<span class="strong"><strong><code class="literal">CREATE USER "tboronczyk"@"%" IDENTIFIED BY "P@$$w0rd";</code></strong></span>
</p></div><p>New accounts are created without any privileges, so we must assign them by executing a <code class="literal">GRANT</code> statement:</p><pre class="programlisting">
<span class="strong"><strong>GRANT CREATE, DROP, ALTER, LOCK TABLES, INSERT, UPDATE, SELECT,
DELETE ON packt.* TO "tboronczyk"@"localhost";</strong></span>
</pre><p>The statement assigns the following privileges to the user for all tables (denoted by <code class="literal">*</code>) in the <code class="literal">packt</code> database:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">CREATE</code>: This allows the user to create databases and tables</p></li><li style="list-style-type: disc"><p><code class="literal">DROP</code>: This allows the user to delete entire tables and databases</p></li><li style="list-style-type: disc"><p><code class="literal">ALTER</code>: This allows the user to change the definition of an existing table</p></li><li style="list-style-type: disc"><p><code class="literal">LOCK TABLES</code>: This allows the user to lock a table for exclusive read or write access</p></li><li style="list-style-type: disc"><p><code class="literal">INDEX</code>: This allows the user to create table indexes</p></li><li style="list-style-type: disc"><p><code class="literal">INSERT</code>: This allows the user to add records to a table</p></li><li style="list-style-type: disc"><p><code class="literal">UPDATE</code>: This allows the user to update records in a table</p></li><li style="list-style-type: disc"><p><code class="literal">SELECT</code>: This allows the user to retrieve records from a table</p></li><li style="list-style-type: disc"><p><code class="literal">DELETE</code>: This allows the user to delete records from a table</p></li></ul></div><p>A full list of privileges and what they permit a user to do can be found in the official MySQL documentation online at <a class="ulink" href="http://dev.mysql.com/doc/refman/5.7/en/grant.html" target="_blank">http://dev.mysql.com/doc/refman/5.7/en/grant.html</a>.</p><p>Next, we instructed MySQL to rebuild its privileges cache using <code class="literal">FLUSH PRIVILEGES</code>:</p><pre class="programlisting">    FLUSH PRIVILEGES;
</pre><p>When MySQL starts up, it caches the user and permissions information in memory (you'll recall from <a class="link" href="#" linkend="ch05">Chapter 5</a>, <span class="emphasis"><em>Managing Filesystems and Storage</em></span>, that reading from memory is much faster than reading from disk) and then checks the cache every time a user performs an action to verify if they have sufficient privileges. We need to tell MySQL to update its cache whenever we create or delete a user account or grant or revoke an account's privileges, or else our changes will go unnoticed until the next time MySQL starts.</p><p>When using <code class="literal">mysql</code> to connect to MySQL, you may frequently invoke it with additional options. A common option is <code class="literal">-h</code>, which identifies the hostname or IP address of the remote server if MySQL is running on a different system. <code class="literal">-e</code> executes a statement directly instead of launching <code class="literal">mysql</code> in interactive mode. Also, to work with a specific database, the name can be given either after the rest of the command or you can use <code class="literal">-D</code> to specify it. The following example demonstrates all of these by connecting to the MySQL server on <code class="literal">192.168.56.100</code> and executing a <code class="literal">SELECT</code> statement against its <code class="literal">sakila</code> database:</p><pre class="programlisting">
<span class="strong"><strong>mysql -u tboronczyk -p -h 192.168.56.100 -D sakila -e "SELECT
last_name, first_name FROM actor"</strong></span>
</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec184"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on working with MySQL:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">mysql</code> manual page (<code class="literal">man 1 mysql</code>)</p></li><li style="list-style-type: disc"><p>MySQL 5.7 reference manual (<a class="ulink" href="http://dev.mysql.com/doc/refman/5.7/en" target="_blank">http://dev.mysql.com/doc/refman/5.7/en</a>)</p></li><li style="list-style-type: disc"><p>Jump Start MySQL (<a class="ulink" href="http://www.amazon.com/Jump-Start-MySQL-Timothy-Boronczyk/dp/0992461286" target="_blank">http://www.amazon.com/Jump-Start-MySQL-Timothy-Boronczyk/dp/0992461286</a>)</p></li><li style="list-style-type: disc"><p>MySQL Tutorial (<a class="ulink" href="http://www.mysqltutorial.org/" target="_blank">http://www.mysqltutorial.org/</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec59"></a>Backing up and restoring a MySQL database</h2></div></div><hr /></div><p>This recipe shows you how to back up your MySQL databases using <code class="literal">mysqldump</code>. The utility connects to the MySQL server, queries the structure of the database and its data, and outputs the data in the form of SQL statements. The backup can then be used to restore the database or populate a new database with the data.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec185"></a>Getting ready</h3></div></div></div><p>This recipe requires a running MySQL server and access to either MySQL's <code class="literal">root</code> user or another user with the necessary privileges to perform the backup.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec186"></a>How to do it...</h3></div></div></div><p>Follow these steps to make a backup of a MySQL database:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Connect to the MySQL database you want to back up:</p><pre class="programlisting">
<span class="strong"><strong>mysql -u root -p packt</strong></span>
</pre></li><li><p>Execute a <code class="literal">FLUSH TABLES</code> statement to set the database's tables read-only:</p><pre class="programlisting">
<span class="strong"><strong>FLUSH TABLES WITH READ LOCK;</strong></span>
</pre></li><li><p>Open a second terminal, leaving the first one active with the <code class="literal">mysql</code> client still running.</p></li><li><p>In the new terminal, use <code class="literal">mysqldump</code> to export the table definitions and data:</p><pre class="programlisting">
<span class="strong"><strong>mysqldump -u root -p packt &gt; backup.sql</strong></span>
</pre></li><li><p>Return to the first terminal once the backup is complete and exit <code class="literal">mysql</code> to unlock the tables.</p><p>Because the backup consists of SQL statements, you can recreate the database by importing the statements with <code class="literal">mysql</code>:</p><pre class="programlisting">
<span class="strong"><strong>mysql -u root -p packt &lt; backup.sql</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec187"></a>How it works...</h3></div></div></div><p>The consequences of lost data can range from mild irritation to serious economic repercussions, so it's important to protect yourself with backups. Just think what would happen if your bank lost all of your financial records! The more important your data is to you and the more difficult it is to be recreated if it were to be lost, the more important it is to have backups in case something bad happens.</p><p>Prior to making the backup, we connected to the server and executed <code class="literal">FLUSH TABLES</code>. The statement forces MySQL to finalize any data updates that may be pending and then sets the tables read-only to prevent modifications to the data while the backup is in progress. This ensures that the data in our backup is consistent:</p><pre class="programlisting">
<span class="strong"><strong>FLUSH TABLES WITH READ LOCK;</strong></span>
</pre><p>The tables remain read-only until we release the lock, either by executing an <code class="literal">UNLOCK TABLES</code> statement or by terminating the connection to the MySQL server, so we left the current session running and opened a second terminal to perform the backup. While the tables are read-only, any queries that retrieve data will execute, but those that update or insert data will be blocked.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note48"></a>Note</h3><p>Consider setting up MySQL replication as described in the <span class="emphasis"><em>Configuring MySQL replication</em></span>Â recipe and then back up the slave's copy of the database to avoid any downtime. Stop replication on the slave, use <code class="literal">mysqldump</code> to export the data, and then resume replication. The master's tables don't need to be locked and any changes made on the master while replication is suspended will be replicated once the slave comes back online.</p></div><p>Then, we used <code class="literal">mysqldump</code> to export all of the table definitions and data from the database:</p><pre class="programlisting">
<span class="strong"><strong>mysqldump -u root -p packt &gt; backup.sql</strong></span>
</pre><p>Keep yourself organized by including the date in your backup filenames:</p><pre class="programlisting">
<span class="strong"><strong>mysqldump -u root -p packt &gt; backup-$(date +%F).sql</strong></span>
</pre><p><code class="literal">mysqldump</code> queries the database to retrieve the data, so whichever account we use to perform the backup, it must have the necessary privileges. What exactly those permissions are, ultimately depends on your database's schema. For example, the account needs the <code class="literal">SHOW VIEW</code> privilege if your database uses views. The same holds true for the account used to restore the database. You should keep this in mind if you want to use dedicated accounts for your backup and restore activities.</p><p>To back up only certain tables, you can list them after the database. For example, the following backs up the <code class="literal">customers</code> and <code class="literal">addresses</code> tables:</p><pre class="programlisting">
<span class="strong"><strong>mysqldump -u root -p packt customers addresses &gt; backup.sql</strong></span>
</pre><p>There are also several options you can provide to <code class="literal">mysqldump</code> that affect what it includes in the backup. Here's a list of some of the more commonly used ones:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">--no-add-drop-table</code>: This does not include a <code class="literal">DROP TABLE</code> statement before any <code class="literal">CREATE TABLE</code> statements in the output. Without dropping a table first, the import process may fail on the <code class="literal">CREATE TABLE</code> statement when the backup is restored on a system that already has the tables defined.</p></li><li style="list-style-type: disc"><p><code class="literal">--events</code>: This exports the definitions for any stored events associated with the database.</p></li><li style="list-style-type: disc"><p><code class="literal">--hex-blob</code>: This outputs binary values using the hexadecimal notation. This can help protect against certain byte sequences being incorrectly interpreted, causing a restore to fail.</p></li><li style="list-style-type: disc"><p><code class="literal">--tables</code>: This backs up only the specific tables. This is an alternate way of specifying tables instead of listing them after the database name.</p></li><li style="list-style-type: disc"><p><code class="literal">--routines</code>: This exports the definitions for any stored procedures associated with the database.</p></li><li style="list-style-type: disc"><p><code class="literal">--where</code>: This is a <code class="literal">WHERE</code> condition used to return only specific rows. For example, <code class="literal">--tables customers --where "last_name LIKE 'B%'"</code> will only export rows from the <code class="literal">customers</code> table for customers whose last name starts with B.</p></li></ul></div><p>You can find a complete list of options in the online documentation at <a class="ulink" href="http://dev.mysql.com/doc/refman/5.7/en/mysqldump.html" target="_blank">http://dev.mysql.com/doc/refman/5.7/en/mysqldump.html</a>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec188"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on making backups with <code class="literal">mysqldump</code>:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">mysqldump</code> manual page (<code class="literal">man 1 mysqldump</code>)</p></li><li style="list-style-type: disc"><p>MySQL 5.7 Reference Manual: <code class="literal">mysqldump</code> (<a class="ulink" href="http://dev.mysql.com/doc/refman/5.7/en/mysqldump.html" target="_blank">http://dev.mysql.com/doc/refman/5.7/en/mysqldump.html</a>)</p></li><li style="list-style-type: disc"><p>Backup and Restore MySQL Database Using <code class="literal">mysqldump</code> (<a class="ulink" href="http://www.thegeekstuff.com/2008/09/backup-and-restore-mysql-database-using-mysqldump" target="_blank">http://www.thegeekstuff.com/2008/09/backup-and-restore-mysql-database-using-mysqldump</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec60"></a>Configuring MySQL replication</h2></div></div><hr /></div><p>This recipe teaches you how to configure MySQL's master-slave replication to maintain mirror copies of your databases in near real time.</p><p>To replicate data, the master MySQL server records details about any changes that take place (inserts, updates, and so on) to a file known as the binary log. Each slave server connects to the master's system, reads the information from the log file, and then duplicates the change to maintain their own local copy of the database. Each slave server is responsible for itself, which means we can bring a slave down for maintenance without affecting the availability of the master. Once it comes back online, the slave resumes replication from where it left off.</p><p>Replication can be useful in many situations. For example, if a full copy of the database is maintained on a slave, you can swap out the master server with little effort for a failover or disaster-recovery situation. For environments where scalability and performance are a concern, write operations can be performed by the master while intensive read operations can be handled by a collection of read-only slaves behind a load balancer.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec189"></a>Getting ready</h3></div></div></div><p>This recipe demonstrates how to configure MySQL replication using two systems. The first system is the master MySQL server, which we'll assume has the IP address <code class="literal">192.168.56.100</code>. The second system is the slave server and has the address <code class="literal">192.168.56.101</code>. You'll need administrative access on both systems either using the <code class="literal">root</code> account or <code class="literal">sudo</code> to complete the configuration.</p><p>Both systems should have MySQL installed as discussed by the earlier <span class="emphasis"><em>Setting up a MySQL database</em></span> recipe. If you're setting up replication after one or more databases have already been created on the master, follow the <span class="emphasis"><em>Backing up and restoring a MySQL database</em></span> recipe to back them up and import them to the slave before configuring replication. This ensures that replication starts with all databases in sync.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec190"></a>How to do it...</h3></div></div></div><p>Follow these steps to configure master-slave replication for MySQL:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Use your text editor to open the master MySQL server's configuration file at <code class="literal">/etc/my.cnf</code>:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/my.cnf</strong></span>
</pre></li><li><p>In the <code class="literal">[mysqld]</code> section, add a new entry for the <code class="literal">server-id</code> option and set its value to <code class="literal">1</code>:</p><pre class="programlisting">
<span class="strong"><strong>server-id = 1</strong></span>
</pre></li><li><p>Locate the <code class="literal">log_bin</code> option and uncomment it:</p><pre class="programlisting">
<span class="strong"><strong>log_bin</strong></span>
</pre></li><li><p>Save your changes and close the configuration file.</p></li><li><p>Restart the server so that the changes will take effect:</p><pre class="programlisting">
<span class="strong"><strong>systemctl restart mysqld.service</strong></span>
</pre></li><li><p>Connect to the master server using <code class="literal">mysql</code> and create a new account for slaves to use. The account requires the <code class="literal">REPLICATION SLAVE</code> privilege:</p><pre class="programlisting">
<span class="strong"><strong>CREATE USER "slave"@"192.168.56.101" IDENTIFIED BY "S3CR3t##";</strong></span>
<span class="strong"><strong>GRANT REPLICATION SLAVE ON *.* TO "slave"@"192.168.56.101";</strong></span>
<span class="strong"><strong>FLUSH PRIVILEGES;</strong></span>
</pre></li><li><p>Execute <code class="literal">SHOW MASTER STATUS</code> to determine the master's current position in writing to the binary log. Note the values returned for <code class="literal">File</code> and <code class="literal">Position</code>, as the information will be required to configure the slave:</p><pre class="programlisting">
<span class="strong"><strong>SHOW MASTER STATUS;</strong></span>
</pre><div class="mediaobject"><img src="graphics/image_07_002.jpg" /><div class="caption"><p>The master's status includes the name of the log file and the server's write position</p></div></div></li><li><p>Use your editor to open the slave's configuration file. Add a new entry for the <code class="literal">server-id</code> option and set its value to <code class="literal">2</code>:</p><pre class="programlisting">
<span class="strong"><strong>server-id = 2</strong></span>
</pre></li><li><p>Add an entry for the <code class="literal">read-only</code> option:</p><pre class="programlisting">
<span class="strong"><strong>read-only</strong></span>
</pre></li><li><p>Save your changes and close the file.</p></li><li><p>Restart the slave for the changes to take effect:</p><pre class="programlisting">
<span class="strong"><strong>systemctl restart mysqld.service</strong></span>
</pre></li><li><p>To configure communication with the master, connect to the slave using <code class="literal">mysql</code>, and execute a <code class="literal">CHANGE MASTER</code> statement. The values should reflect those returned by <code class="literal">SHOW MASTER STATUS</code> in step 7:</p><pre class="programlisting">
<span class="strong"><strong>CHANGE MASTER TO</strong></span>
<span class="strong"><strong>     MASTER_HOST = "192.168.56.100",</strong></span>
<span class="strong"><strong>     MASTER_USER = "slave",</strong></span>
<span class="strong"><strong>     MASTER_PASSWORD = "S3CR3t##",    </strong></span>
<span class="strong"><strong>     MASTER_LOG_FILE = "localhost-bin.000003",</strong></span>
<span class="strong"><strong>     MASTER_LOG_POS = 1235;</strong></span>
</pre></li><li><p>Start the replication process by executing <code class="literal">START SLAVE</code> on the slave system:</p><pre class="programlisting">
<span class="strong"><strong>START SLAVE;</strong></span>
</pre></li><li><p>Execute <code class="literal">SHOW SLAVE STATUS</code> to verify replication is running. The values returned for <code class="literal">Slave_IO_Running</code> and <code class="literal">Slave_SQL_Running</code> should both be <code class="literal">Yes</code>:</p><pre class="programlisting">
<span class="strong"><strong>SHOW SLAVE STATUS\G</strong></span>
</pre><p><code class="literal">SHOW SLAVE STATUS</code> returns a fair amount of information-listed as a table, column wrapping makes the output impossible to read. Using <code class="literal">\G</code> to execute the statement (as opposed to the semicolon) will make <code class="literal">mysql</code> display the results vertically which, in this case, is much more readable.</p></li><li><p>To stop replication, execute <code class="literal">STOP SLAVE</code> on the slave system.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec191"></a>How it works...</h3></div></div></div><p>Configuration began in the master's <code class="literal">/etc/my.cnf</code> file, where we added the <code class="literal">server-id</code> option to give the server a numeric identifier. Each server in the replication setup uses this value to identify itself to the others, so it must be unique across the environment. Then, we uncommented the <code class="literal">log_bin</code> option to instruct the server to record the details of each change to the binary log.</p><div class="mediaobject"><img src="graphics/image_07_003.jpg" /><div class="caption"><p>The master server's configuration file sets the server identifier and enables logging</p></div></div><p>Next, we created a dedicated account on the master server and granted it the <code class="literal">REPLICATION SLAVE</code> privilege. The slave will use this account to connect to the master and read from the log:</p><pre class="programlisting">
<span class="strong"><strong>CREATE USER "slave"@"192.168.56.101" IDENTIFIED BY "S3CR3t##";</strong></span>
<span class="strong"><strong>GRANT REPLICATION SLAVE ON *.* TO "slave"@"192.168.56.101";</strong></span>
</pre><p>Finally, we executed <code class="literal">SHOW MASTER STATUS</code> command. The values of <code class="literal">File</code> and <code class="literal">Position</code> in the result identify the name of the binary log file and the server's current position in it. As the master writes to the log, the position increases and the suffix attached to the log's filename changes when the log files are rotated. We need to know the current position so we can configure the slave to begin reading/replicating from that point onward.</p><p>On the slave, we set the server's unique identifier and added the <code class="literal">read-only</code> option in the configuration file. If someone were to make a change in the slave's database that conflicts with an incoming update from the binary log, then replication would break. The <code class="literal">read-only</code> option is a safeguard that prevents users from updating the slave databases directly, ensuring all updates come from the master.</p><p>Next, we set up the slave's replication process using <code class="literal">CHANGE MASTER</code> statement. The <code class="literal">CHANGE MASTER</code> statement identifies the master, sets the username and password the slave will use to connect, and identifies the name of the log and the current position to start replicating from:</p><pre class="programlisting">
<span class="strong"><strong>CHANGE MASTER TO</strong></span>
<span class="strong"><strong>  MASTER_HOST = "192.168.56.100",</strong></span>
<span class="strong"><strong>  MASTER_USER = "slave",</strong></span>
<span class="strong"><strong>  MASTER_PASSWORD = "S3CR3t##",    </strong></span>
<span class="strong"><strong>  MASTER_LOG_FILE = "localhost-bin.000003",</strong></span>
<span class="strong"><strong>  MASTER_LOG_POS = 1235;</strong></span>
</pre><p>Replication is started with <code class="literal">START SLAVE</code> and stopped with <code class="literal">STOP SLAVE</code>. The <code class="literal">SHOW SLAVE STATUS</code> returns information about the current state of replication:</p><div class="mediaobject"><img src="graphics/image_07_004.jpg" /><div class="caption"><p>We can check the slave's status to see whether replication is running without any issues</p></div></div><p>MySQL creates two background processes when replication is running-one communicates with the master (the IO process) and the other executes the SQL statements to maintain the local database (the SQL process). The <code class="literal">Slave_IO_Running</code> value shows whether the communication process is running or not, while the value of <code class="literal">Slave_SQL_Running</code> reflects whether or not the execution process is running. Both values should be <code class="literal">Yes</code> when replication is running.</p><p>If there's a problem with replication, the <code class="literal">Last_IO_Error</code> and <code class="literal">Last_SQL_Error</code> entries will report any errors thrown for their respective processes. You can also tell how far behind the slave is from the master by comparing the values of the <code class="literal">Master_Log_File</code> and <code class="literal">Read_Master_Log_Pos</code> fields with what the <code class="literal">SHOW MASTER STATUS</code> returns.</p><p>The current configuration enables the slave to replicate every database from the master, but we can also restrict replication to certain databases by adding the <code class="literal">replicate-do-db</code> entries in the slave's <code class="literal">my.cnf</code> file. Multiple entries may be given, which will have one entry per database:</p><pre class="programlisting">
<span class="strong"><strong>replicate-do-db = packt</strong></span>
<span class="strong"><strong>replicate-do-db = acme</strong></span>
<span class="strong"><strong>replicate-do-db = sakila</strong></span>
</pre><p>Alternatively, we can use the <code class="literal">replicate-ignore-db</code> option to replicate everything except specific databases:</p><pre class="programlisting">
<span class="strong"><strong>replicate-ignore-db = mysql</strong></span>
</pre><p>Replication can be filtered at the table-level as well, targeting and ignoring specific tables in a database using the <code class="literal">replicate-do-table</code> and <code class="literal">replicate-ignore-table</code> options:</p><pre class="programlisting">
<span class="strong"><strong>replicate-do-table = acme.customers</strong></span>
<span class="strong"><strong>replicate-do-table = acme.addresses</strong></span>
</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec192"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on replicating MySQL databases:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>MySQL 5.7 Reference Manual: Replication (<a class="ulink" href="http://dev.mysql.com/doc/refman/5.7/en/replication.html" target="_blank">http://dev.mysql.com/doc/refman/5.7/en/replication.html</a>)</p></li><li style="list-style-type: disc"><p>MySQL Replication on RHEL 7 (<a class="ulink" href="https://www.youtube.com/watch?v=kIfRXshR2zc" target="_blank">https://www.youtube.com/watch?v=kIfRXshR2zc</a>)</p></li><li style="list-style-type: disc"><p>MySQL High Availability Architectures (<a class="ulink" href="http://skillachie.com/2014/07/25/mysql-high-availability-architectures" target="_blank">http://skillachie.com/2014/07/25/mysql-high-availability-architectures</a>)</p></li><li style="list-style-type: disc"><p>Replication Tips and Tricks in MySQL (<a class="ulink" href="http://www.linux-mag.com/id/1661/" target="_blank">http://www.linux-mag.com/id/1661/</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec61"></a>Standing up a MySQL cluster</h2></div></div><hr /></div><p>This recipe guides you through the process of setting up a MySQL cluster. Clustered databases meet the challenges of scalability and high-availability by partitioning the data across multiple systems and maintaining replicas to avoid single points of failure.</p><p>The members of a cluster are referred to as nodes. There are three node types in a MySQL cluster: data nodes, API nodes, and the management node. Data nodes are responsible for storing data. Users and processes then connect to an API node to access the database. The management node manages the cluster as a whole. Although multiple nodes can be installed on the same system, for example, both an API node and a data node may be hosted on the same system. However, hosting multiple data nodes on the same system is obviously not a good idea because it negates MySQL's efforts to distribute the data.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec193"></a>Getting ready</h3></div></div></div><p>This recipe demonstrates how to deploy a MySQL cluster using four systems. The first system will host the management node and we'll assume that it has the IP address <code class="literal">192.168.56.100</code>. The second system will host the API node and have the address <code class="literal">192.168.56.101</code>. The remaining systems will be configured with data nodes and use the addresses <code class="literal">192.168.56.102</code> and <code class="literal">192.168.56.103</code>. You'll need administrative access on all four systems either using the <code class="literal">root</code> account or <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec194"></a>How to do it...</h3></div></div></div><p>Follow these steps to set up a clustered MySQL database:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Download the cluster archive from the MySQL website and extract its packages using <code class="literal">tar</code>:</p><pre class="programlisting">
<span class="strong"><strong>curl -L dev.mysql.com/get/Downloads/MySQL-Cluster-7.4/
       MySQL-Cluster-gpl-7.4.10-1.el7.x86_64.rpm-bundle.tar | tar  x</strong></span>
</pre></li><li><p>On each system, install <code class="literal">perl-Data-Dumper</code> and replace the installed <code class="literal">mariadb-libs</code> package with the downloaded <code class="literal">MySQL-Cluster-shared</code> package:</p><pre class="programlisting">
<span class="strong"><strong>yum install perl-Data-Dumper MySQL-Cluster-shared-gpl-*.rpm</strong></span>
<span class="strong"><strong>yum erase mariadb-libs</strong></span>
</pre></li><li><p>Install the <code class="literal">MySQL-Cluster-server</code> and <code class="literal">MySQL-Cluster-client</code> packages on each system:</p><pre class="programlisting">
<span class="strong"><strong>yum install MySQL-Cluster-{server,client}-gpl-*.rpm</strong></span>
</pre></li><li><p>On the system hosting the management node, create the <code class="literal">/var/lib/mysql-cluster</code> directory:</p><pre class="programlisting">
<span class="strong"><strong>mkdir /var/lib/mysql-cluster</strong></span>
</pre></li><li><p>Create the cluster's configuration file for the management node at <code class="literal">/var/lib/mysql-cluster/config.ini</code> as follows:</p><pre class="programlisting">
<span class="strong"><strong>[ndbd default]</strong></span>
<span class="strong"><strong>NoOfReplicas = 2</strong></span>
<span class="strong"><strong>DataMemory = 100M</strong></span>
<span class="strong"><strong>IndexMemory = 10M</strong></span>
<span class="strong"><strong>ServerPort = 2202</strong></span>
<span class="strong"><strong>[ndb_mgmd]</strong></span>
<span class="strong"><strong>hostname = 192.168.56.100</strong></span>
<span class="strong"><strong>[mysqld]</strong></span>
<span class="strong"><strong>hostname = 192.168.56.101</strong></span>
<span class="strong"><strong>[ndbd]</strong></span>
<span class="strong"><strong>hostname = 192.168.56.102</strong></span>
<span class="strong"><strong>[ndbd]</strong></span>
<span class="strong"><strong>hostname = 192.168.56.103</strong></span>
</pre></li><li><p>Start the management node:</p><pre class="programlisting">
<span class="strong"><strong>ndb_mgmd -f /var/lib/mysql-cluster/config.ini</strong></span>
</pre></li><li><p>Open port <code class="literal">1186</code> in the management node system's firewall:</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --add-port=1186/tcp</strong></span>
<span class="strong"><strong>firewall-cmd --reload</strong></span>
</pre></li><li><p>On each data node's system, create the file <code class="literal">/etc/my.cnf</code> using the following:</p><pre class="programlisting">
<span class="strong"><strong>[mysql_cluster]</strong></span>
<span class="strong"><strong>ndb-connectstring = 192.168.56.100</strong></span>
</pre></li><li><p>Start each data node:</p><pre class="programlisting">
<span class="strong"><strong>ndbd</strong></span>
</pre></li><li><p>Open port <code class="literal">2202</code> in the data nodes' systems' firewall:</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --add-port=2202/tcp</strong></span>
<span class="strong"><strong>firewall-cmd --reload</strong></span>
</pre></li><li><p>Create <code class="literal">/etc/my.cnf</code> on the system hosting the API node using the following:</p><pre class="programlisting">
<span class="strong"><strong>[mysqld]</strong></span>
<span class="strong"><strong>ndbcluster</strong></span>
<span class="strong"><strong>default-storage-engine = ndbcluster</strong></span>
<span class="strong"><strong>[mysql_cluster]</strong></span>
<span class="strong"><strong>ndb-connectstring = 192.168.56.100</strong></span>
</pre></li><li><p>Start MySQL server as the API node:</p><pre class="programlisting">
<span class="strong"><strong>mysqld_safe &amp;</strong></span>
</pre></li><li><p>Retrieve the <code class="literal">root</code> account's temporary password that was created when the MySQL server was installed. It's recorded in <code class="literal">/root/.mysql_secret</code>:</p><pre class="programlisting">
<span class="strong"><strong>cat /root/.mysql_secret</strong></span>
</pre></li><li><p>Set a new password for the root account using <code class="literal">mysqladmin</code>. When prompted for the current password, enter the one identified in the previous step:</p><pre class="programlisting">
<span class="strong"><strong>mysqladmin -u root -p password</strong></span>
</pre></li><li><p>Open port <code class="literal">3306</code> in the API node system's firewall:</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --add-service=mysql</strong></span>
<span class="strong"><strong>firewall-cmd --reload</strong></span>
</pre></li><li><p>Verify the status of the cluster using the <code class="literal">ndb_mgm</code> client on the system hosting the management node:</p><pre class="programlisting">
<span class="strong"><strong>ndb_mgm -e SHOW</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec195"></a>How it works...</h3></div></div></div><p>This recipe taught you how to set up a MySQL clustered database with two data nodes: one API node and one management node. The management node consists of the <code class="literal">ndb_mgmd</code> process that provides configuration information to the other nodes and monitors them. On the data nodes, the <code class="literal">ndbd</code> process handles the storage, partitioning, and replication of the clustered data. A MySQL server aware of the management node and the data nodes acts as the API node through which users can work with the clustered database.</p><p>The packages available in the Oracle-maintained repository are built without support for Network Database (NDB), so we first downloaded an archive from the MySQL website that has packages whichÂ will install a version of MySQL that supports NDB/clustering:</p><pre class="programlisting">
<span class="strong"><strong>curl -L dev.mysql.com/get/Downloads/MySQL-Cluster-7.4/MySQL-
Cluster-gpl-7.4.10-1.el7.x86_64.rpm-bundle.tar | tar x</strong></span>
</pre><p>MySQL abstracts the details of exactly how data is physically organized and manipulated, delegating this to its various storage engines. Different engines have different abilities. Since the NDBÂ engine is the one that implements clustering, we need a build that supports the engine. Instead of writing curl's output to a file as we've done in other recipes, this time we piped the output directly to <code class="literal">tar</code> with the <code class="literal">x</code> argument to expand the archive on the fly.</p><p>Afterwards, we installed the <code class="literal">perl-Data-Dumper</code> package from the CentOS repository and replaced the <code class="literal">mariadb-libs</code> package already installed with the just downloaded <code class="literal">MySQL-Cluster-shared</code> package on each system:</p><pre class="programlisting">
<span class="strong"><strong>yum install perl-Data-Dumper MySQL-Cluster-shared-gpl-*.rpm</strong></span>
<span class="strong"><strong>yum erase mariadb-libs</strong></span>
</pre><p>The <code class="literal">MySQL-Cluster-shared</code> package provides the shared libraries used by other programs to work with MySQL. These libraries replace the MariaDB version installed from the CentOS repositories by default and save us from experiencing library conflicts that would prevent a clean install. Since it's no longer needed afterwards, we uninstalled the <code class="literal">mariadb-libs</code> package.</p><p>Some of the post-installation steps performed by Yum after it installs the <code class="literal">MySQL-Cluster-server</code> package are scripted in Perl and use Perl's <code class="literal">Data::Dumper</code> module. This makes the <code class="literal">Perl-Data-Dumper</code> package a dependency for the <code class="literal">MySQL-Cluster-server</code> package. However, a bug causes Yum to miss this, so we installed the package ourselves so that the <code class="literal">MySQL-Cluster-server</code> package's installation will proceed smoothly. It wouldn't prevent the package from installing, but it would have required us to complete some additional configuration steps manually.</p><p>With the requirements in place, we then installed the <code class="literal">MySQL-Cluster-server</code> and <code class="literal">MySQL-Cluster-client</code> packages on each system:</p><pre class="programlisting">
<span class="strong"><strong>yum install MySQL-Cluster-{server,client}-gpl-*.rpm</strong></span>
</pre><p>Configuration for the overall cluster is pretty much centralized with the management node in <code class="literal">/var/lib/mysql-cluster/config.ini</code>. The file is divided into several sections, the first being <code class="literal">[ndb default]</code>, which provides the default configuration values that should be used for the cluster. The values here apply to each node of the cluster unless overridden by a more specific directive in the respective node's configuration section:</p><pre class="programlisting">
<span class="strong"><strong>[ndbd default]</strong></span>
<span class="strong"><strong>NoOfReplicas = 2</strong></span>
<span class="strong"><strong>DataMemory = 100M</strong></span>
<span class="strong"><strong>IndexMemory = 10M</strong></span>
<span class="strong"><strong>ServerPort = 2202</strong></span>
</pre><p>The <code class="literal">NoOfReplicas</code> option sets the number of replicas in the cluster. Its value may be set to <code class="literal">1</code> or <code class="literal">2</code>, although <code class="literal">2</code> is the recommended value. Recall that not only a clustered database is partitioned across the data nodes but it is also replicated; each node hosts a partition typically <span class="emphasis"><em>1/n</em></span> the size of the database (where <span class="emphasis"><em>n</em></span> is the number of data nodes) and also a replica of the other nodes. The cluster can still function if a system goes offline because its data is still available in the replica. A value of <code class="literal">1</code> for <code class="literal">NoOfReplicas</code> means that there would be only one copy of the database (no replica) and the availability of the database depends on all data nodes being up.</p><p>The data nodes hold their working copy of the database in RAM to reduce latency while periodically syncing the data to disk. The <code class="literal">DataMemory</code> option specifies how much RAM should be reserved for the data by the nodes and <code class="literal">IndexMemory</code> specifies how much memory should be reserved for primary keys and unique indexes. Whatever values you provide, be sure that sufficient resources are available to avoid RAM swapping.</p><p>The <code class="literal">ServerPort</code> option specifies the port number the nodes will use to communicate with one another. By default, MySQL would dynamically allocate ports to make it easier to run multiple nodes on the same system, but since this recipe runs each node on its own host system and we need to know the port to allow traffic through the firewall, we specified the port ourselves.</p><p>The subsequent sections in the configuration use the <code class="literal">hostname</code> option to specify the addresses at which the management node (via the <code class="literal">[ndb_mgmtd]</code> section), the API node (the <code class="literal">[mysqld]</code> section), and the data nodes (the <code class="literal">[ndbd]</code> section) are running. As made evident by the multiple <code class="literal">[ndbd]</code> sections, multiple sections of the same type will appear if there is more than one node of that type running in the cluster:</p><pre class="programlisting">
<span class="strong"><strong>[ndb_mgmd]</strong></span>
<span class="strong"><strong>hostname = 192.168.56.100</strong></span>
<span class="strong"><strong>[mysqld]</strong></span>
<span class="strong"><strong>hostname = 192.168.56.101</strong></span>
<span class="strong"><strong>[ndbd]</strong></span>
<span class="strong"><strong>hostname = 192.168.56.102</strong></span>
<span class="strong"><strong>[ndbd]</strong></span>
<span class="strong"><strong>hostname = 192.168.56.103</strong></span>
</pre><p>On the remaining systems, <code class="literal">/etc/my.cnf</code> is created as the configuration file used by the data nodes and the API node. Each includes a <code class="literal">[mysql_cluster]</code> section, which gives the <code class="literal">ndb-connectstring</code> option:</p><pre class="programlisting">
<span class="strong"><strong>[mysql_cluster]</strong></span>
<span class="strong"><strong>ndb-connectstring = 192.168.56.100</strong></span>
</pre><p>The <code class="literal">ndb-connectstring</code> option specifies the address of the system that hosts the management node. As the data and API nodes come online, they communicate with the manager to receive their configuration information. If your cluster has more than one management node, the additional nodes can be listed in the connection string separated by commas:</p><pre class="programlisting">
<span class="strong"><strong>ndb-connectstring = "192.168.56.100,192.168.56.105,192.168.56.106"</strong></span>
</pre><p>Additionally, the API node's configuration includes the <code class="literal">[mysqld]</code> section. It includes the <code class="literal">ndbcluster</code> option to enable the NDB engine and the <code class="literal">default-storage-engine</code> option instructing MySQL to use NDB to manage all new tables unless otherwise specified in the table's <code class="literal">CREATE TABLE</code> statement:</p><pre class="programlisting">
<span class="strong"><strong>[mysqld]</strong></span>
<span class="strong"><strong>ndbcluster</strong></span>
<span class="strong"><strong>default-storage-engine = ndbcluster</strong></span>
</pre><p>When a user or process creates a new table with the <code class="literal">CREATE TABLE</code> statement, they can specify which of MySQL's storage engines should be used to manage its data with the <code class="literal">ENGINE</code> directive, for example:</p><pre class="programlisting">
<span class="strong"><strong>CREATE TABLE users (</strong></span>
<span class="strong"><strong>    id INTEGER UNSIGNED NOT NULL PRIMARY KEY,</strong></span>
<span class="strong"><strong>    first_name VARCHAR(50) NOT NULL DEFAULT '',</strong></span>
<span class="strong"><strong>    last_name VARCHAR(50) NOT NULL DEFAULT ''</strong></span>
<span class="strong"><strong>)</strong></span>
<span class="strong"><strong>ENGINE = NDBCluster;</strong></span>
</pre><p>The default engine is InnoDB engine. However, only data in NDB-managed tables make their way to the cluster. If a table is managed by another engine, the data resides locally on the API node and is not available to other nodes in the cluster. To prevent unexpected problems and any confusion this can cause, we changed the default engine so that tables will use the NDB engine when the <code class="literal">ENGINE</code> directive isn't provided.</p><p>The order in which nodes are started when bringing up the MySQL cluster is important, since one node may depend on the others. The management node is started first, followed by the data nodes, and then the API node.</p><p>The password for MySQL's root account on the API node is randomly generated the first time the server is started, and it is written to the <code class="literal">/root/.mysql_secret</code> file, just as we used <code class="literal">mysqladmin</code> to change it in the <span class="emphasis"><em>Setting up a MySQL database</em></span> recipe:</p><pre class="programlisting">
<span class="strong"><strong>cat /root/.mysql_secret</strong></span>
<span class="strong"><strong>mysqladmin -u root -p password</strong></span>
</pre><p>The <code class="literal">SHOW</code> command sent to the <code class="literal">ndb_mgm</code> client on the management node's system allows us to view the status of the cluster and ensure everything is up and running as it should be. The client can be invoked in interactive mode, or commands can be passed to it directly using the <code class="literal">-e</code> argument:</p><pre class="programlisting">
<span class="strong"><strong>ndb_mgm -e SHOW</strong></span>
</pre><div class="mediaobject"><img src="graphics/image_07_005.jpg" /><div class="caption"><p>The status of the MySQL cluster can be viewed using the ndb_mgm client</p></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec196"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on working with MySQL clusters:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>MySQL Reference Manual: MySQL Cluster Core Concepts (<a class="ulink" href="http://dev.mysql.com/doc/refman/5.7/en/mysql-cluster-basics.html" target="_blank">http://dev.mysql.com/doc/refman/5.7/en/mysql-cluster-basics.html</a>)</p></li><li style="list-style-type: disc"><p>MySQL Reference Manual: MySQL Cluster Installation (<a class="ulink" href="http://dev.mysql.com/doc/refman/5.7/en/mysql-cluster-installation.htm" target="_blank">http://dev.mysql.com/doc/refman/5.7/en/mysql-cluster-installation.htm</a>l)</p></li><li style="list-style-type: disc"><p>MySQL Reference Manual: MySQL Cluster Nodes, Node Groups, Replicas, and Partitions (<a class="ulink" href="http://dev.mysql.com/doc/refman/5.7/en/mysql-cluster-nodes-groups.html" target="_blank">http://dev.mysql.com/doc/refman/5.7/en/mysql-cluster-nodes-groups.html</a>)</p></li><li style="list-style-type: disc"><p>MySQL Reference Manual: Online Backup of MySQL Cluster (<a class="ulink" href="http://dev.mysql.com/doc/refman/5.7/en/mysql-cluster-backup.html" target="_blank">http://dev.mysql.com/doc/refman/5.7/en/mysql-cluster-backup.html</a>)</p></li><li style="list-style-type: disc"><p>Set Up a MySQL Cluster the Easy Way (<a class="ulink" href="http://youtube.com/watch?v=64jtbkuPtv" target="_blank">http://youtube.com/watch?v=64jtbkuPtv</a>c)</p></li><li style="list-style-type: disc"><p><span class="emphasis"><em>High Availability MySQL Cookbook</em></span> by Alex Davies (<a class="ulink" href="https://www.packtpub.com/big-data-and-business-intelligence/high-availability-mysql-cookbook" target="_blank">https://www.packtpub.com/big-data-and-business-intelligence/high-availability-mysql-cookbook</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec62"></a>Setting up a MongoDB database</h2></div></div><hr /></div><p>Although relational databases have dominated the world of data storage, there have always been other systems that specialize in alternative ways of working with data, for example document and object-oriented databases, key-value databases, and hierarchical databases. The popularity of these alternative databases has experienced a resurgence thanks to the recent <span class="emphasis"><em>NoSQL</em></span> and <span class="emphasis"><em>Big Data</em></span> movements. This recipe teaches you how to install MongoDB, a modern document-oriented database system.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec197"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection and administrative privileges by either using the <code class="literal">root</code> account or <code class="literal">sudo</code>. It also assumes you have registered the EPEL repository (see the <span class="emphasis"><em>Registering the EPEL and Remi repositories</em></span> recipe in <a class="link" href="#" linkend="ch04">Chapter 4</a>, <span class="emphasis"><em>Software InstallationÂ Management</em></span>).</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec198"></a>How to do itâ€¦</h3></div></div></div><p>Follow these steps to install MongoDB and create a new database:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Install the <code class="literal">mongodb-server</code> and <code class="literal">mongodb</code> packages from the EPEL repository:</p><pre class="programlisting">
<span class="strong"><strong>yum install mongodb-server mongodb</strong></span>
</pre></li><li><p>Open <code class="literal">/etc/mongod.conf</code> with your text editor:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/mongod.conf</strong></span>
</pre></li><li><p>Locate the <code class="literal">auth</code> entry and uncomment it, making sure its value is <code class="literal">true</code>:</p><pre class="programlisting">
<span class="strong"><strong># Run with/without security</strong></span>
<span class="strong"><strong>auth = true</strong></span>
</pre></li><li><p>Locate the <code class="literal">bind-ip</code> option and comment it out:</p><pre class="programlisting">
<span class="strong"><strong>       # Comma separated list of ip addresses to listen on
       # bind_ip = 127.0.0.1</strong></span>
</pre></li><li><p>Save your changes to the configuration file and close it.</p></li><li><p>Start the MongoDB server and enable it to start automatically whenever the system reboots:</p><pre class="programlisting">
<span class="strong"><strong>systemctl start mongod.service</strong></span>
<span class="strong"><strong>systemctl enable mongod.service</strong></span>
</pre></li><li><p>Open port <code class="literal">27017</code> in the system's firewall:</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --add-port=27017/tcp</strong></span>
<span class="strong"><strong>firewall-cmd --reload</strong></span>
</pre></li><li><p>Connect to the MongoDB server with <code class="literal">mongo</code>:</p><pre class="programlisting">
<span class="strong"><strong>mongo</strong></span>
</pre></li><li><p>Set <code class="literal">admin</code> as the active database:</p><pre class="programlisting">
<span class="strong"><strong>use admin</strong></span>
</pre></li><li><p>Execute <code class="literal">createUser()</code> to create a new user for managing user accounts:</p><pre class="programlisting">
<span class="strong"><strong>db.createUser({</strong></span>
<span class="strong"><strong>  user: "admin",</strong></span>
<span class="strong"><strong>     pwd: "P@$$W0rd",</strong></span>
<span class="strong"><strong>     roles: [{ role: "userAdminAnyDatabase", db: "admin" }]</strong></span>
<span class="strong"><strong>})</strong></span>
</pre></li><li><p>Authenticate yourself using the newly created <code class="literal">admin</code> account:</p><pre class="programlisting">
<span class="strong"><strong>db.auth({ user: "admin", pwd: "P@$$W0rd" })</strong></span>
</pre></li><li><p>Set <code class="literal">packt</code> as the active database:</p><pre class="programlisting">
<span class="strong"><strong>use packt</strong></span>
</pre></li><li><p>Create a user account for working with the database:</p><pre class="programlisting">
<span class="strong"><strong>db.createUser({</strong></span>
<span class="strong"><strong>  user: "tboronczyk",</strong></span>
<span class="strong"><strong>     pwd: "S3CR3t##",</strong></span>
<span class="strong"><strong>     roles: [{ role: "readWrite", db: "packt" }]</strong></span>
<span class="strong"><strong>})</strong></span>
</pre></li><li><p>Exit the client and return to the terminal:</p><pre class="programlisting">
<span class="strong"><strong>exit</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec199"></a>How it works...</h3></div></div></div><p>MongoDB is the most popular in its class of databases and is used by many high-profile companies, including eBay, Craigslist, SAP, and Yandex. The necessary packages are available in the EPEL repository; <code class="literal">mongodb-server</code> contains the MongoDB server application and the <code class="literal">mongodb</code> package contains the client and other utilities for working with the server and databases:</p><pre class="programlisting">
<span class="strong"><strong>yum install mongodb-server mongodb</strong></span>
</pre><p>MongoDB runs without security enabled by default and anyone may perform any action against any database. To prevent this, we enabled security by uncommenting the <code class="literal">auth</code> option in MongoDB's configuration file (<code class="literal">/etc/mongod.conf</code>). Once security is enabled, users must authenticate themselves before they can work with a database, and the server verifies that the account has the right to perform the requested action:</p><pre class="programlisting">
<span class="strong"><strong>auth = true</strong></span>
</pre><p>The current configuration permits MongoDB to listen for connections only on the loop-back interface (<code class="literal">127.0.0.1</code>), so we also commented out the <code class="literal">bind_ip</code> option:</p><pre class="programlisting">
<span class="strong"><strong># bind_ip = 127.0.0.1</strong></span>
</pre><p>Left unbound, MongoDB will be accessible via all of the system's addresses. Alternatively, if the system has multiple addresses (perhaps the system has multiple interfaces or you've implemented the <span class="emphasis"><em>Binding multiple addresses to a single Ethernet device</em></span>Â recipe inÂ <a class="link" href="#" linkend="ch02">Chapter 2</a>, <span class="emphasis"><em>Networking</em></span>) and you want MongoDB to respond on only one of them, you can leave the option active with the desired IP address as its value.</p><p>After updating the configuration file, we started the server and opened MongoDB's default port in the system's firewall to allow remote connections:</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --add-port=27017/tcp</strong></span>
<span class="strong"><strong>firewall-cmd --reload</strong></span>
</pre><p>Next, we used the <code class="literal">mongo</code> client to establish a connection to the MongoDB server running on the localhost:</p><pre class="programlisting">
<span class="strong"><strong>mongo</strong></span>
</pre><p>We set <code class="literal">admin</code> as the active database and executed the <code class="literal">createUser()</code> method to create an administrator account dedicated to managing MongoDB's database users:</p><pre class="programlisting">
<span class="strong"><strong>use admin</strong></span>
<span class="strong"><strong>db.createUser({</strong></span>
<span class="strong"><strong>  user: "admin",</strong></span>
<span class="strong"><strong>  pwd: "P@$$W0rd",</strong></span>
<span class="strong"><strong>  roles: [{ role: "userAdminAnyDatabase", db: "admin" }]</strong></span>
<span class="strong"><strong>})</strong></span>
</pre><p>The <code class="literal">createUser()</code> method accepts a document with properties listing the new account's username (<code class="literal">user</code>), password (<code class="literal">pwd</code>), and roles (<code class="literal">roles</code>) and adds it to the <code class="literal">system.users</code> collection in the active database (<code class="literal">admin</code>). User accounts are stored at the database level and the database storing a user's details is known as that user's authentication database. Users may work with other databases, but they must authenticate against their authentication database first. Even if their usernames are the same, accounts created in different databases are considered separate and may have different permissions.</p><p>The <code class="literal">roles</code> property is an array of objects, each listing a role that the user is a member of when they work with the given database. In the case of <code class="literal">admin</code>, the user is a member of the <code class="literal">userAdminAnyDatabase</code> role. MongoDB's permission system is based on role-based access control (RBAC). The focus of RBAC is on users and what roles they play as opposed to granting individual permissions to each account. Permissions are assigned to a role and then user accounts are given membership in the role inheriting its permissions.</p><p><code class="literal">userAdminAnyDatabase</code> is a built-in role configured with the necessary permissions to create and delete user accounts, assign membership in a role, and manage user passwords for any database. MongoDB ships with several predefined roles besides <code class="literal">userAdminAnyDatabase</code>. They include the following:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">dbAdmin</code>: These users are responsible for administering the database</p></li><li style="list-style-type: disc"><p><code class="literal">userAdmin</code>: These users are responsible for administering other users</p></li><li style="list-style-type: disc"><p><code class="literal">read</code>: These are users that only read documents from the database</p></li><li style="list-style-type: disc"><p><code class="literal">readWrite</code>: These are users who read documents and also need write access to insert/modify them</p></li><li style="list-style-type: disc"><p><code class="literal">dbOwner</code>: These are users who own the database (combines the <code class="literal">dbAdmin</code>, <code class="literal">userAdmin</code>, and <code class="literal">readWrite</code> roles)</p></li></ul></div><p>There are also the <code class="literal">backup</code> and <code class="literal">restore</code> roles for users responsible for performing database backups, roles for managing MongoDB clusters, and additional global versions of some of the aforementioned roles, such as <code class="literal">readAnyDatabase</code>, for users who need read-access to all of MongoDB's databases. A complete list of roles can be found in the official documentation online at <a class="ulink" href="https://docs.mongodb.com/manual/reference/built-in-roles/" target="_blank">https://docs.mongodb.com/manual/reference/built-in-roles/</a>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note49"></a>Note</h3><p>The principles of least privilege encourage us to avoid over-using the global roles; it's better to create users that work with their own databases. If an account needs to work with a database outside its authentication database, multiple roles can be assigned as follows:</p><pre class="programlisting">Â  <span class="strong"><strong>db.createUser({</strong></span>
<span class="strong"><strong> Â  Â  user: "tboronczyk",</strong></span>
<span class="strong"><strong> Â  Â  pwd: "S3CR3t##",</strong></span>
<span class="strong"><strong> Â  Â  roles: [</strong></span>
<span class="strong"><strong> Â  Â  Â  { role: "read", db: "admin" },</strong></span>
<span class="strong"><strong> Â  Â  Â  { role: "readWrite", db: "packt" },</strong></span>
<span class="strong"><strong> Â  Â  Â  { role: "readWrite", db: "acme" }</strong></span>
<span class="strong"><strong> Â  Â  ]</strong></span>
<span class="strong"><strong> Â  })</strong></span>
</pre></div><p>Next, we used the new <code class="literal">admin</code> user to create a new user for the <code class="literal">packt</code> database (and to create the <code class="literal">packt</code> database itself as a side effect):</p><pre class="programlisting">
<span class="strong"><strong>db.auth("admin", "P@$$W0rd")</strong></span>
<span class="strong"><strong>use packt</strong></span>
<span class="strong"><strong>db.createUser({</strong></span>
<span class="strong"><strong>  user: "tboronczyk",</strong></span>
<span class="strong"><strong>  pwd: "S3CR3t##",</strong></span>
<span class="strong"><strong>  roles: [{ role: "readWrite", db: "packt" }]</strong></span>
<span class="strong"><strong>})</strong></span>
</pre><p>Databases and collections are implicitly created by MongoDB when the first document is inserted, and since MongoDB stores new users in the active database, setting <code class="literal">packt</code> as the active database and creating a user is enough to trigger its creation.</p><p>The <code class="literal">auth()</code> method assumes that the active database is the authentication database for the provided credentials. In this instance, authentication is successful because <code class="literal">admin</code> was already the active database; attempting to authenticate as <code class="literal">admin</code> after switching to <code class="literal">packt</code> would fail. However, the identity persists after authentication until the next time we call <code class="literal">auth()</code> or we exit the client. So, even though we switched databases, we're still operating within the roles and privileges of the <code class="literal">admin</code> database's <code class="literal">admin</code> user.</p><p>Although the recipe connected to the server with a bare <code class="literal">mongo</code> invocation, the active database can be specified on the command line. <code class="literal">mongo</code> also offers several options, for example, to connect to a MongoDB server running on a different system and provide authentication credentials. <code class="literal">--host</code> identifies the remote hostname or IP address where MongoDB is running, and the <code class="literal">--username</code> and <code class="literal">--password</code> options allow you to provide your account's authentication details:</p><pre class="programlisting">
<span class="strong"><strong>mongo --host 192.168.56.100 --username tboronczyk --password ""  packt</strong></span>
</pre><p>If the database is given in the invocation when <code class="literal">--username</code> and <code class="literal">--password</code> are used as well, MongoDB assumes that the database is the account's authentication database. If the account belongs to another database, its authentication database can be given using the <code class="literal">--authenticationDatabase</code> option:</p><pre class="programlisting">
<span class="strong"><strong>mongo --authenticationDatabase admin --username admin --password
    ""  packt</strong></span>
</pre><p>The <code class="literal">--password</code> option expects a value, but MongoDB will prompt you for a password when its value is empty. I suggest that you use an empty string (<code class="literal">""</code>) for the value, as I have done here, to force the password prompt.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note50"></a>Note</h3><p>Never enter a password as part of a command's invocation for security reasons. The password may appear in the output of <code class="literal">ps</code> while the command is running and will also appear in your shell's history.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec200"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on working with MongoDB:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The MongoDB manual (<a class="ulink" href="http://docs.mongodb.org/manual" target="_blank">http://docs.mongodb.org/manual</a>)</p></li><li style="list-style-type: disc"><p>MongoDB Manual: Role-Based Access Control (<a class="ulink" href="http://docs.mongodb.org/manual/core/authorization" target="_blank">http://docs.mongodb.org/manual/core/authorization</a>)</p></li><li style="list-style-type: disc"><p>MongoDB Tutorial for Beginners (<a class="ulink" href="http://www.youtube.com/watch?v=W-WihPoEbR4" target="_blank">http://www.youtube.com/watch?v=W-WihPoEbR4</a>)</p></li><li style="list-style-type: disc"><p>Wikipedia: Role-based access control (<a class="ulink" href="https://en.wikipedia.org/wiki/Role-based_access_control" target="_blank">https://en.wikipedia.org/wiki/Role-based_access_control</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec63"></a>Backing up and restoring a MongoDB database</h2></div></div><hr /></div><p>This recipe teaches you how to back up a MongoDB database using the <code class="literal">mongodump</code> utility and restore it using <code class="literal">mongorestore</code>.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec201"></a>Getting ready</h3></div></div></div><p>This recipe requires a running MongoDB server and access to a user account with membership in the <code class="literal">userAdmin</code> role.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec202"></a>How to do it...</h3></div></div></div><p>Follow these steps to back up a MongoDB database:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Connect to MongoDB as a user with membership in the <code class="literal">userAdmin</code> role:</p><pre class="programlisting">
<span class="strong"><strong>mongo --username admin --password "" admin</strong></span>
</pre></li><li><p>Create an account with membership in the <code class="literal">backup</code> and <code class="literal">restore</code> roles to be used for creating and restoring backups:</p><pre class="programlisting">
<span class="strong"><strong>db.createUser({</strong></span>
<span class="strong"><strong>     user: "backupusr",</strong></span>
<span class="strong"><strong>     pwd: "B@CK&amp;4th",</strong></span>
<span class="strong"><strong>     roles: [</strong></span>
<span class="strong"><strong>       { role: "backup", db: "admin" },</strong></span>
<span class="strong"><strong>       { role: "restore", db: "admin" }</strong></span>
<span class="strong"><strong>     ]</strong></span>
<span class="strong"><strong>})</strong></span>
</pre></li><li><p>Use <code class="literal">mongodump</code> on the command-line to export a MongoDB database:</p><pre class="programlisting">
<span class="strong"><strong>mongodump --authenticationDatabase admin --username  backupusr
       --password "" --db packt</strong></span>
</pre></li><li><p>To restore a database from the backup made by <code class="literal">mongodump</code>, use the <code class="literal">mongorestore</code> program:</p><pre class="programlisting">
<span class="strong"><strong>mongorestore --authenticationDatabase admin --username  backupusr
       --password "" --drop --db packt dump/packt</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec203"></a>How it works...</h3></div></div></div><p>The account used to make a backup must have the privileges assigned to the <code class="literal">backup</code> role and the restore account must have those assigned to the <code class="literal">restore</code> role. So, we connected to the MongoDB server and created an account with membership in both roles prior to using the utilities:</p><pre class="programlisting">
<span class="strong"><strong>db.createUser({</strong></span>
<span class="strong"><strong>  user: "backupusr",</strong></span>
<span class="strong"><strong>  pwd: "B@CK&amp;4th",</strong></span>
<span class="strong"><strong>  roles: [</strong></span>
<span class="strong"><strong>    { role: "backup", db: "admin" },</strong></span>
<span class="strong"><strong>    { role: "restore", db: "admin" }</strong></span>
<span class="strong"><strong>  ]</strong></span>
<span class="strong"><strong>})</strong></span>
</pre><p>The new account is then used with <code class="literal">mongodump</code> to back up our database:</p><pre class="programlisting">
<span class="strong"><strong>mongodump --authenticationDatabase admin --username backupusr
    --password "" --db packt</strong></span>
</pre><p>The preceding invocation exports everything in the <code class="literal">packt</code> database as specified by the <code class="literal">--db</code> argument. If <code class="literal">--db</code> is not given, <code class="literal">mongodump</code> exports all of the available databases except for the server's <code class="literal">local</code> database. It's possible to export just a specific collection from the database using the <code class="literal">--collection</code> argument:</p><pre class="programlisting">
<span class="strong"><strong>mongodump --db packt --collection authors</strong></span>
</pre><p>By default, <code class="literal">mongodump</code> creates a local directory named <code class="literal">dump</code> to organize the exported data. Within <code class="literal">dump</code> exists a directory for each exported database and within that are two files for each collection. The first file is a BSON file, a binary JSON-like format used because it offers a richer set of data types than JSON does. For example, JSON doesn't define a date type. Whereas JSON offers only a single numeric type, BSON supports 32 and 64-bit integers and doubles. The second file is a metadata JSON file that stores details about the collection, such as any collection options or index definitions.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note51"></a>Note</h3><p><code class="literal">mongodump</code> will overwrite any existing files if the <code class="literal">dump</code> directory already exists. To avoid problems, you can specify a different location with the Â 
Â <code class="literal">--out</code> argument:</p><p><span class="strong"><strong><code class="literal">mongodump --db packt --out dump-$(date +%F)</code></strong></span>
</p></div><div class="mediaobject"><img src="graphics/image_07_006.jpg" /><div class="caption"><p>The exported collection data is organized by database in the dump directory</p></div></div><p>The path to the collection files is then given to <code class="literal">mongorestore</code> to import the data dumped by <code class="literal">mongodump</code>. The database to which the collections will be inserted is named using the <code class="literal">--db</code> argument:</p><pre class="programlisting">
<span class="strong"><strong>mongorestore --authenticationDatabase admin --username backupusr
    --password "" --drop --db packt dump/packt</strong></span>
</pre><p><code class="literal">mongorestore</code> only inserts the data; if documents with the same <code class="literal">_id</code> field already exist in a collection then those records are skipped, not updated. This may or may not be desired depending on the circumstances. So to be sure that the restored data matches what was exported, the <code class="literal">--drop</code> argument is used, which instructs <code class="literal">mongorestore</code> to drop the existing collection first before importing the backup.</p><p>Apart from <code class="literal">mongodump</code> and <code class="literal">mongorestore</code>, there is also <code class="literal">mongoexport</code> and <code class="literal">mongoimport</code>. <code class="literal">mongoexport</code> exports a collection's data to either a JSON or CSV file and <code class="literal">mongoimport</code> imports data from these formats. Keep in mind however that JSON's type system (and certainly "types" in CSV) is less granular than BSON's and some fidelity can be lost. For reliable backups, <code class="literal">mongodump</code> and <code class="literal">mongorestore</code> are preferred.</p><p>The default export format of <code class="literal">mongoexport</code> is JSON. To export a collection's data to CSV instead, use the <code class="literal">--csv</code> argument:</p><pre class="programlisting">
<span class="strong"><strong>mongoexport --db packt --collection titles --csv --out titles.csv</strong></span>
</pre><p>Specific fields can be targeted for export as well by providing a comma-separated list of names using the <code class="literal">--fields</code> argument:</p><pre class="programlisting">
<span class="strong"><strong>mongoexport --db packt --collection titles --fields isbn,title,
    authors,year,language,pages --csv --out titles.csv</strong></span>
</pre><p>Some arguments worth noting when importing data with <code class="literal">mongoimport</code> are <code class="literal">--type</code>, which specifies the import file's type (either JSON for CSV), <code class="literal">--headerline</code> - to skip the first row of data in the case of column headers in a CSV file, <code class="literal">--fields</code> - to import only specific fields from the file, and <code class="literal">--upsert</code>, which performs an upsert action on existing documents instead of skipping them:</p><pre class="programlisting">
<span class="strong"><strong>mongoimport --db packt --collection titles --fields isbn,title,
    authors --type csv --upsert &lt; titles.csv</strong></span>
</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec204"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on backing up and restoring MongoDB databases:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">mongodump</code> manual page (<code class="literal">man 1 mongodump</code>)</p></li><li style="list-style-type: disc"><p>The <code class="literal">mongorestore</code> manual page (<code class="literal">man 1 mongorestore</code>)</p></li><li style="list-style-type: disc"><p>The <code class="literal">mongoexport</code> manual page (<code class="literal">man 1 mongoexport</code>)</p></li><li style="list-style-type: disc"><p>The <code class="literal">mongoimport</code> manual page (<code class="literal">man 1 mongoimport</code>)</p></li><li style="list-style-type: disc"><p>MongoDB Manual: MongoDB Backup Methods (<a class="ulink" href="http://docs.mongodb.org/manual/core/backups" target="_blank">http://docs.mongodb.org/manual/core/backups</a>)</p></li><li style="list-style-type: disc"><p>BSON: Binary JSON (<a class="ulink" href="http://bsonspec.org/" target="_blank">http://bsonspec.org/</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec64"></a>Configuring a MongoDB replica set</h2></div></div><hr /></div><p>This recipe teaches you how to configure replication using MongoDB replica sets.</p><p>When replication is performed using replica sets, one installation of MongoDB identifies as the primary server while others in the cluster are secondaries. The primary server accepts writes, which are replicated to the secondaries, while the secondaries service read requests. If the primary server goes down, the secondary servers automatically call a quorum and promote one of the secondaries to fill the primary's role. The old primary rejoins the cluster when it comes back on line. This configuration provides redundancy, distributed read/write access, and automatic failover for high-availability.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec205"></a>Getting ready</h3></div></div></div><p>This recipe demonstrates configuring replica sets using three systems. The first system will be the cluster's primary server and we assume that its IP address is <code class="literal">192.168.56.100</code>. The other two systems will be secondary servers using the addresses <code class="literal">192.168.56.102</code> and <code class="literal">192.168.56.103</code>. MongoDB should be installed on all three systems. You'll also need administrative access to complete the configuration and access to a user account with membership in theÂ <code class="literal">userAdmin</code> role.</p><p>MongoDB replication relies on hostnames. Before you begin this recipe, make sure that the systems are accessible to one another by the hostname. If the systems are inaccessible and you are unable to add the necessary records to your network's DNS, you can override local resolution for the hosts in question by adding entries to <code class="literal">/etc/hosts</code>, similarly to the following:</p><pre class="programlisting">
<span class="strong"><strong>192.168.56.100 benito benito.localdomain</strong></span>
<span class="strong"><strong>192.168.56.101 javier javier.localdomain</strong></span>
<span class="strong"><strong>192.168.56.102 geomar geomar.localdomain</strong></span>
</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec206"></a>How to do it...</h3></div></div></div><p>Follow these steps to configure replication using MongoDB replica sets:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>On the primary system, navigate to <code class="literal">/var/lib/mongodb</code> and use <code class="literal">openssl</code> to create a shared secret. This secret serves as the password each server will use to authenticate itself as a member of the replication cluster:</p><pre class="programlisting">
<span class="strong"><strong>cd /var/lib/mongodb</strong></span>
<span class="strong"><strong>openssl rand 756 -base64 -out rs0.key</strong></span>
</pre></li><li><p>Secure the file's permissions; it should be owned by <code class="literal">mongodb</code> and only readable by its owner:</p><pre class="programlisting">
<span class="strong"><strong>chown mongodb.mongodb rs0.key</strong></span>
<span class="strong"><strong>chmod 600 rs0.key</strong></span>
</pre></li><li><p>Open <code class="literal">/etc/mongod.conf</code> with your text editor:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/mongod.conf</strong></span>
</pre></li><li><p>Locate the <code class="literal">replSet</code> option, uncomment it, and assign it the value <code class="literal">rs0</code>:</p><pre class="programlisting">
<span class="strong"><strong># Arg is &lt;setname&gt;[/&lt;optionalseedhostlist&gt;]</strong></span>
<span class="strong"><strong>replSet = rs0</strong></span>
</pre></li><li><p>Uncomment the <code class="literal">keyFile</code> option and provide the path to the file containing the shared password:</p><pre class="programlisting">
<span class="strong"><strong># Private key for cluster authentication</strong></span>
<span class="strong"><strong>keyFile = /var/lib/mongodb/rs0.key</strong></span>
</pre></li><li><p>Save your changes and close the file.</p></li><li><p>Restart the MongoDB server:</p><pre class="programlisting">
<span class="strong"><strong>systemctl restart mongod.service</strong></span>
</pre></li><li><p>Copy the shared secret to each of the secondary systems:</p><pre class="programlisting">
<span class="strong"><strong>scp rs0.key 192.168.56.101:/var/lib/mongodb/rs0.key</strong></span>
<span class="strong"><strong>scp rs0.key 192.168.56.102:/var/lib/mongodb/rs0.key</strong></span>
</pre></li><li><p>Repeat steps 2-7 on each of the other secondary systems.</p></li><li><p>Connect to the primary MongoDB server and create an account with membership in the <code class="literal">clusterManager</code> role to be used for configuring and managing the replica cluster:</p><pre class="programlisting">
<span class="strong"><strong>db.createUser({</strong></span>
<span class="strong"><strong>  user: "repladmin",</strong></span>
<span class="strong"><strong>     pwd: "dupl1C@t3",</strong></span>
<span class="strong"><strong>     roles: [{ role: "clusterManager", db: "admin" }]</strong></span>
<span class="strong"><strong>})</strong></span>
</pre></li><li><p>Authenticating yourself using the <code class="literal">repladmin</code> user:</p><pre class="programlisting">
<span class="strong"><strong>db.auth("repladmin", "dupl1C@t3")</strong></span>
</pre></li><li><p>Use the <code class="literal">rs.initiate()</code> method to initialize the cluster:</p><pre class="programlisting">
<span class="strong"><strong>rs.initiate()</strong></span>
</pre></li><li><p>Register the secondary members using <code class="literal">rs.add()</code>:</p><pre class="programlisting">
<span class="strong"><strong>rs.add("192.168.56.101")</strong></span>
<span class="strong"><strong>rs.add("192.168.56.102")</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec207"></a>How it works...</h3></div></div></div><p>Clusters must contain an odd number of servers because there has to be a majority vote to approve a secondary's proposal to take on the role of primary if the primary server becomes unavailable. Three servers were used, which is the minimum number for a cluster that provides proper redundancy and availability.</p><p>Cluster members identify themselves to one another using a shared replica set name and password, which we provide in each server's <code class="literal">mongod.conf</code> configuration file. The name is specified using the <code class="literal">replSet</code> option:</p><pre class="programlisting">
<span class="strong"><strong>replSet = rs0</strong></span>
</pre><p>The password value can be anything up to 1,024 characters. For security reasons, a long random string is preferred for resistance against brute force and dictionary attacks. We can generate such values using <code class="literal">openssl rand</code>:</p><pre class="programlisting">
<span class="strong"><strong>openssl rand 756 -base64 -out rs0.key</strong></span>
</pre><p><code class="literal">rand</code> generates the number of random bytes we request, in this case 756 bytes. <code class="literal">-base64</code> encodes them using the Base64 encoding scheme to represent the bytes safely as plain text. Encoding incurs some overhead, and Base64 encodes three bytes as four characters and pads the result when less than three bytes are available. So, Base64-encoding the 765 random bytes results in 1,024 characters of text suitable for our needs.</p><p>The resulting key file containing the password is copied to each system. Its ownership is set to the system's <code class="literal">mongodb</code> user and access permissions to the file are revoked for everyone except that user:</p><pre class="programlisting">
<span class="strong"><strong>chown mongodb.mongodb rs0.key</strong></span>
<span class="strong"><strong>chmod 600 rs0.key</strong></span>
</pre><p>The file is specified in the configuration file using the <code class="literal">keyFile</code> option:</p><pre class="programlisting">
<span class="strong"><strong>keyFile = /var/lib/mongodb/rs0.key</strong></span>
</pre><p>Management of the cluster requires permissions assigned to the <code class="literal">clusterManager</code> role, so we then created an account with membership in that role, and then we authenticated ourselves using the new account:</p><pre class="programlisting">
<span class="strong"><strong>db.createUser({</strong></span>
<span class="strong"><strong>  user: "repladmin",</strong></span>
<span class="strong"><strong>  pwd: "dupl1C@t3",</strong></span>
<span class="strong"><strong>  roles: [{ role: "clusterManager", db: "admin" }]</strong></span>
<span class="strong"><strong>})</strong></span>
<span class="strong"><strong>db.auth("repladmin", "dupl1C@t3")</strong></span>
</pre><p>We started the cluster using <code class="literal">rs.initiate()</code> on the primary server and then registered the secondary servers using <code class="literal">rs.add()</code>:</p><pre class="programlisting">
<span class="strong"><strong>rs.initiate()</strong></span>
<span class="strong"><strong>rs.add("192.168.56.101")</strong></span>
<span class="strong"><strong>rs.add("192.168.56.102")</strong></span>
</pre><p>After <code class="literal">rs.initiate()</code> is invoked, you'll notice the mongo client's prompt changes to <code class="literal">rs0:primary</code> to notify us that we're connected to the primary server in the <code class="literal">rs0</code> replication group. If you were to log in to a secondary server, the prompt would read <code class="literal">rs0:secondary</code>.</p><p>Alternatively, the cluster can be configured by passing an object that specifies the secondary servers as an argument to <code class="literal">rs.initiate()</code>. The object's <code class="literal">_id</code> property is the name of the set and the <code class="literal">members</code> property is an array of secondary hosts:</p><pre class="programlisting">
<span class="strong"><strong>rs.initiate({</strong></span>
<span class="strong"><strong>  _id : "rs0",</strong></span>
<span class="strong"><strong>  members : [</strong></span>
<span class="strong"><strong>    {_id : 0, host : "192.168.56.100"},</strong></span>
<span class="strong"><strong>    {_id : 1, host : "192.168.56.101"},</strong></span>
<span class="strong"><strong>    {_id : 2, host : "192.168.56.102"}</strong></span>
<span class="strong"><strong>  ]</strong></span>
<span class="strong"><strong>})</strong></span>
</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec208"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on working with MongoDB replica sets:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>MongoDB Manual: Replication (<a class="ulink" href="http://docs.mongodb.org/manual/core/replication-introduction" target="_blank">http://docs.mongodb.org/manual/core/replication-introduction</a>)</p></li><li style="list-style-type: disc"><p>MongoDB Replication and Replica Sets (<a class="ulink" href="http://www.youtube.com/watch?v=CsvbG9tykC4" target="_blank">http://www.youtube.com/watch?v=CsvbG9tykC4</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec65"></a>Setting up an OpenLDAP directory</h2></div></div><hr /></div><p>This recipe teaches you how to install OpenLDAP, an open-source implementation of an X.500 directory server. The X.500 series of protocols was developed in the late 1980s to support the storage and lookup of names, e-mail addresses, computer systems, and other entities in a hierarchical fashion. Each entry is a node in a directory information tree (DIT) and is identified by its distinguished name (DN). Information about the entry is represented as key/value pairs known as attributes.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec209"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection and administrative privileges either by using the <code class="literal">root</code> account or <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec210"></a>How to do it...</h3></div></div></div><p>Follow these steps to set up an OpenLDAP directory:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Install the <code class="literal">openldap-server</code> and <code class="literal">openldap-clients</code> packages:</p><pre class="programlisting">
<span class="strong"><strong>yum install openldap-servers openldap-clients</strong></span>
</pre></li><li><p>Copy the database configuration file included with OpenLDAP to the server's data directory. Ensure the file is owned by the <code class="literal">ldap</code> user:</p><pre class="programlisting">
<span class="strong"><strong>cp /usr/share/openldap-servers/DB_CONFIG.example
       /var/lib/ldap/DB_CONFIG</strong></span>
<span class="strong"><strong>chown ldap.ldap /var/lib/ldap/DB_CONFIG</strong></span>
</pre></li><li><p>Use <code class="literal">slappasswd</code> to generate a password hash for OpenLDAP's <code class="literal">Manager</code> account. Enter the desired password when prompted:</p><pre class="programlisting">
<span class="strong"><strong>slappasswd</strong></span>
</pre></li><li><p>Start the LDAP server and optionally enable it to start automatically whenever the system reboots:</p><pre class="programlisting">
<span class="strong"><strong>systemctl start slapd.service</strong></span>
<span class="strong"><strong>systemctl enable slapd.service</strong></span>
</pre></li><li><p>Open port <code class="literal">389</code> in the system's firewall to allow outside connections to the server:</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --add-service=ldap</strong></span>
<span class="strong"><strong>firewall-cmd --reload</strong></span>
</pre></li><li><p>Create the file <code class="literal">config.ldif</code> using the following content. The DIT's suffix is based on the domain <code class="literal">ldap.example.com</code> and the value for <code class="literal">olcRootPW</code> is the password hash obtained in step 3:</p><pre class="programlisting">
<span class="strong"><strong>dn: olcDatabase={2}hdb,cn=config</strong></span>
<span class="strong"><strong>changetype: modify</strong></span>
<span class="strong"><strong>replace: olcSuffix</strong></span>
<span class="strong"><strong>olcSuffix: dc=ldap,dc=example,dc=com</strong></span>
<span class="strong"><strong>-</strong></span>
<span class="strong"><strong>replace: olcRootDN</strong></span>
<span class="strong"><strong>olcRootDN: cn=Manager,dc=ldap,dc=example,dc=com</strong></span>
<span class="strong"><strong>-</strong></span>
<span class="strong"><strong>add: olcRootPW</strong></span>
<span class="strong"><strong>olcRootPW: {SSHA}cb0i4Kwzvd5tBlxEtwB50myPIUKI3bkp</strong></span>
<span class="strong"><strong>dn: olcDatabase={1}monitor,cn=config</strong></span>
<span class="strong"><strong>changetype: modify</strong></span>
<span class="strong"><strong>replace: olcAccess</strong></span>
<span class="strong"><strong>olcAccess: {0}to * by dn.base="gidNumber=0+uidNumber=0,</strong></span>
<span class="strong"><strong>    cn=peercred,cn=external,cn=auth" read by dn.base="cn=</strong></span>
<span class="strong"><strong>    Manager,dc=ldap,dc=example,dc=com" read by * none</strong></span>
</pre></li><li><p>Invoke <code class="literal">ldapmodify</code> to execute the operations in <code class="literal">config.ldif</code>:</p><pre class="programlisting">
<span class="strong"><strong>ldapmodify -Y EXTERNAL -H ldapi:/// -f config.ldif</strong></span>
</pre></li><li><p>Use <code class="literal">ldapadd</code> to import the <code class="literal">cosine</code>, <code class="literal">inetorgperson</code>, and <code class="literal">nis</code> schemas found in <code class="literal">/etc/openldap/schema</code>:</p><pre class="programlisting">
<span class="strong"><strong>cd /etc/openldap/schema</strong></span>
<span class="strong"><strong>ldapadd -Y EXTERNAL -H ldapi:/// -f cosine.ldif</strong></span>
<span class="strong"><strong>ldapadd -Y EXTERNAL -H ldapi:/// -f inetorgperson.ldif</strong></span>
<span class="strong"><strong>ldapadd -Y EXTERNAL -H ldapi:/// -f nis.ldif</strong></span>
</pre></li><li><p>Create the file <code class="literal">root.ldif</code> with the following content:</p><pre class="programlisting">
<span class="strong"><strong>dn: dc=ldap,dc=example,dc=com</strong></span>
<span class="strong"><strong>objectClass: dcObject</strong></span>
<span class="strong"><strong>objectClass: organization</strong></span>
<span class="strong"><strong>o: My Company's LDAP Database</strong></span>
</pre></li><li><p>Use <code class="literal">ldapadd</code> to import <code class="literal">root.ldif</code>, authenticating yourself with the <code class="literal">Manager</code> account:</p><pre class="programlisting">
<span class="strong"><strong>ldapadd -D "cn=Manager,dc=ldap,dc=example,dc=com" -W -H
       ldapi:/// -f root.ldif</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec211"></a>How it works...</h3></div></div></div><p>We first installed the <code class="literal">openldap-server</code> package, which contains the LDAP server (<code class="literal">slapd</code>) and some supporting utilities, and the <code class="literal">openldap-clients</code> package, which installed the basic utilities used for working with the directory server:</p><pre class="programlisting">
<span class="strong"><strong>yum install openldap-servers openldap-clients</strong></span>
</pre><p>OpenLDAP uses the Berkeley DB (BDB/HDB) database for backend data storage, indexing, and caching. The database is configured separately from the directory server and an example configuration file is installed along with the server. We copied the example into the server's data directory but left it with its default values; the defaults are fine to start with although you'll want to review the settings periodically after you deploy OpenLDAP to ensure the best performance (<code class="literal">man 5 slapd-bdb</code> provides descriptions of the file's configuration options):</p><pre class="programlisting">
<span class="strong"><strong>cp /usr/share/openldap-servers/DB_CONFIG.example
    /var/lib/ldap/DB_CONFIG</strong></span>
</pre><p>The directory's administrative user <code class="literal">Manager</code> doesn't have an assigned password at first. OpenLDAP expects the password to be hashed so we created a suitable value using <code class="literal">slappasswd</code>:</p><pre class="programlisting">
<span class="strong"><strong>slappasswd</strong></span>
</pre><p>The default hashing algorithm used by <code class="literal">slappasswd</code> is salted SHA (SSHA) as indicated by the <code class="literal">{SSHA}</code> prefix in its output. It's possible to hash the password using a different algorithm if required by specifying it using the <code class="literal">-h</code> argument. The possible values are <code class="literal">{CRYPT}</code>, <code class="literal">{MD5}</code>, <code class="literal">{SMD5}</code> (salted MD5), <code class="literal">{SHA}</code>, or <code class="literal">{SSHA}</code>. The salted algorithms are preferred over their nonsalted counterparts because the randomly generated salt <code class="literal">slappasswd</code> incorporates into the hash makes the hash resistant to rainbow attacks.</p><p>OpenLDAP has deprecated its file-based configuration approach in favor of online configuration, storing parameters in a config DIT so that they can be updated without needing to restart the directory server for the changes to take effect. So after starting the server, we wrote the necessary operations to <code class="literal">config.ldif</code> that will make our updates and then executed them as a batch with <code class="literal">ldapmodify</code>:</p><pre class="programlisting">
<span class="strong"><strong>ldapmodify -Y EXTERNAL -H ldapi:// -f config.ldif</strong></span>
</pre><p>The <code class="literal">-H</code> argument provides one or more URIs for the servers we want to connect to. We can specify the transport protocol, hostname or IP address, and port, but the URI is not a full RFC-4516 style LDAP URI (other components such as the base DN are given using other arguments). The supported protocols are <code class="literal">ldap</code>, <code class="literal">ldaps</code> (LDAP over SSL), and <code class="literal">ldapi</code> (LDAP over IPC/unix-socket). No hostname is required to access the local host, so just <code class="literal">ldapi://</code> is used.</p><p>The <code class="literal">-Y</code> argument specifying <code class="literal">EXTERNAL</code> as the authentication mechanism allows the use of mechanisms external to the server's SASL methods. When paired with <code class="literal">ldapi</code>, <code class="literal">EXTERNAL</code> uses our login session's username to authenticate us.</p><p>The default behavior for <code class="literal">ldapmodify</code> is to read input from STDIN, but the <code class="literal">-f</code> argument can specify an input file instead. Since the statements are rather verbose, using an input file is a great idea because you can review them for any mistakes beforehand. If you do want to provide them via STDIN however, I recommend that you use the <code class="literal">-c</code> argument to run <code class="literal">ldapmodify</code> in "continuous mode". The program terminates when it encounters an error by default, but in continuous mode it will keep running. This will give you the opportunity to resubmit the operation if there's a problem, without reconnecting:</p><pre class="programlisting">
<span class="strong"><strong>ldapmodify -Y EXTERNAL -H ldapi:/// -c</strong></span>
</pre><p>Our first operation changed the DIT's suffix from the default <code class="literal">dc=my-domain,dc=com</code> to something more appropriate. The recipe uses <code class="literal">ldap.example.com</code> for example purposes, but of course you may substitute your own domain accordingly:</p><pre class="programlisting">
<span class="strong"><strong>dn: olcDatabase={2}hdb,cn=config</strong></span>
<span class="strong"><strong>changetype: modify</strong></span>
<span class="strong"><strong>replace: olcSuffix</strong></span>
<span class="strong"><strong>olcSuffix: dc=ldap,dc=example,dc=com</strong></span>
</pre><p>The suffix is stored in the <code class="literal">olcSuffix</code> attribute of the <code class="literal">olcDatabase={2}hdb,cn= config</code> entry and represents the top level of the DIT. Traditionally, the suffix is based on a domain name and is expressed as a series of domain components (DC), so the domain <code class="literal">ldap.example.com</code> becomes <code class="literal">dc=ldap,dc=example,dc=com</code>.</p><p>The suffix appears in a few other places, so we needed to update those as well - the <code class="literal">olcRootDN</code> attribute, which lists the name of the DIT's administrative user, and in the permission statement in <code class="literal">olcAccess</code> that grants access to <code class="literal">Manager</code> and the system's <code class="literal">root</code> account. Additionally, we added the <code class="literal">olcRootPW</code> attribute that stores the Manager's password hash. We don't have to specify the DN multiple times for attributes on same entry. Rather, we can separate the operations with a single hyphen:</p><pre class="programlisting">
<span class="strong"><strong>replace: olcRootDN</strong></span>
<span class="strong"><strong>olcRootDN: cn=Manager,dc=ldap,dc=example,dc=com</strong></span>
<span class="strong"><strong>-</strong></span>
<span class="strong"><strong>add: olcRootPW</strong></span>
<span class="strong"><strong>olcRootPW: {SSHA}3NhShraRoA+MaOGSrjWTzK3fX0AIq+7P</strong></span>
<span class="strong"><strong>dn: olcDatabase={1}monitor,cn=config</strong></span>
<span class="strong"><strong>changetype: modify</strong></span>
<span class="strong"><strong>replace: olcAccess</strong></span>
<span class="strong"><strong>olcAccess: {0}to * by dn.base="gidNumber=0+uidNumber=0,</strong></span>
<span class="strong"><strong> cn=peercred,cn=external,cn=auth" read by dn.base="cn=</strong></span>
<span class="strong"><strong> Manager,dc=ldap,dc=example,dc=com" read by * none</strong></span>
</pre><p>Next, we imported the <code class="literal">cosine</code>, <code class="literal">nis</code>, and <code class="literal">inetorgperson</code> schemas. Creating new schemas from scratch can be a daunting task as a fair amount of planning is required to identify what types are needed and what PEN/OIDs should be allocated. Importing these schemas provided with OpenLDAP gives us access to various useful predefined types:</p><pre class="programlisting">
<span class="strong"><strong>ldapadd -Y EXTERNAL -H ldapi:/// -f cosine.ldif</strong></span>
<span class="strong"><strong>ldapadd -Y EXTERNAL -H ldapi:/// -f inetorgperson.ldif</strong></span>
<span class="strong"><strong>ldapadd -Y EXTERNAL -H ldapi:/// -f nis.ldif</strong></span>
</pre><p><code class="literal">cosine</code> defines a standard X.500 directory services schema that was originally developed for the COSINE PARADISE Project and is outlined in RFC-4524. It gives us types such as <code class="literal">document</code> and <code class="literal">domain</code> objects and attributes such as <code class="literal">host</code>, <code class="literal">mail</code>, and <code class="literal">documentAuthor</code>. <code class="literal">inetorgperson</code> defines the <code class="literal">inetOrgPerson</code> class, a person object that attempts to "meet the requirements found in today's Internet and intranet directory service deployments" as described by RFC-2798 and RFC-4524. <code class="literal">nis</code> defines a Network Information Services schema with user and host attributes useful for setting up centralized authentication, such as <code class="literal">uidNumber</code>, <code class="literal">gidNumber</code>, <code class="literal">ipNetworkNumber</code>, and <code class="literal">ipNetmaskNumber</code>.</p><p>If you look at the contents of these files, you'll find that object identifiers (OIDs) play an important role in schema definitions, providing globally unique identification of various object classes and attributes. OIDs are a string of numbers separated by dots, read left to right, with each position representing a level in the distributed hierarchy. Top levels of the hierarchy are maintained by various standards bodies and registry authorities, and Internet Assigned Numbers Authority (IANA) allows individuals to register for their own branch under the OID <code class="literal">1.3.6.1.4.1</code>. For example, <code class="literal">1.3.6.1.4.1.4203</code> is assigned to the OpenLDAP project.</p><p>Finally, we need to define the domain component object (<code class="literal">dcObject</code>) first. This object is the root of our local branch of the directory under which future entries can be added. If your experience centers mostly on working with relational databases such as MySQL or with modern NoSQL databases such as MongoDB, you can think of <code class="literal">dcObject</code> as the database:</p><pre class="programlisting">
<span class="strong"><strong>dn: dc=ldap,dc=example,dc=com</strong></span>
<span class="strong"><strong>objectClass: dcObject</strong></span>
<span class="strong"><strong>objectClass: organization</strong></span>
<span class="strong"><strong>o: My Company's LDAP Database</strong></span>
</pre><p>While using <code class="literal">ldapadd</code> to import the definition, we provided the <code class="literal">-D</code> argument to specify the <code class="literal">Manager</code> account and <code class="literal">-W</code> to be prompted for the account's password:</p><pre class="programlisting">
<span class="strong"><strong>ldapadd -D "cn=Manager,dc=ldap,dc=example,dc=com" -W -H ldapi:///
    -f root.ldif</strong></span>
</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec212"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on working with OpenLDAP:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">ldapmodify</code> manual page (<code class="literal">man 1 ldapmodify</code>)</p></li><li style="list-style-type: disc"><p>OpenLDAP (<a class="ulink" href="http://www.openldap.org/" target="_blank">http://www.openldap.org/</a>)</p></li><li style="list-style-type: disc"><p>Understanding the LDAP Protocol, Data Hierarchy, and Entry Components (<a class="ulink" href="http://www.digitalocean.com/community/tutorials/understanding-the-ldap-protocol-data-hierarchy-and-entry-components" target="_blank">http://www.digitalocean.com/community/tutorials/understanding-the-ldap-protocol-data-hierarchy-and-entry-components</a>)</p></li><li style="list-style-type: disc"><p>How to Use LDIF Files to Make Changes to an OpenLDAP System (<a class="ulink" href="http://www.digitalocean.com/community/tutorials/how-to-use-ldif-files-to-make-changes-to-an-openldap-system" target="_blank">http://www.digitalocean.com/community/tutorials/how-to-use-ldif-files-to-make-changes-to-an-openldap-system</a>)</p></li><li style="list-style-type: disc"><p>How to Get Your Own LDAP OID (<a class="ulink" href="http://ldapwiki.willeke.com/wiki/How%20To%20Get%20Your%20Own%20LDAP%20OID" target="_blank">http://ldapwiki.willeke.com/wiki/How%20To%20Get%20Your%20Own%20LDAP%20OID</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch07lvl1sec66"></a>Backing up and restoring an OpenLDAP database</h2></div></div><hr /></div><p>This recipe teaches you how to back up an OpenLDAP database by exporting the directory to an LDIF file, which can then be imported later to restore the database.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec213"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection and administrative privileges either using the <code class="literal">root</code> account or <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec214"></a>How to do it...</h3></div></div></div><p>To back up an LDAP directory, export the directory using the <code class="literal">slapcat</code> utility:</p><pre class="programlisting">
<span class="strong"><strong>slapcat -b "dc=ldap,dc=example,dc=com" -l backup.ldif</strong></span>
</pre><p>To rebuild the directory from an export, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Stop the LDAP server:</p><pre class="programlisting">
<span class="strong"><strong>service stop slapd.service</strong></span>
</pre></li><li><p>Import the file using <code class="literal">slapadd</code>:</p><pre class="programlisting">
<span class="strong"><strong>slapadd -f backup.ldif</strong></span>
</pre></li><li><p>Ensure the data files are owned by the <code class="literal">ldap</code> user:</p><pre class="programlisting">
<span class="strong"><strong>chown -R ldap.ldap /var/lib/ldap/*</strong></span>
</pre></li><li><p>Restart the LDAP server:</p><pre class="programlisting">
<span class="strong"><strong>service restart slapd.service</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec215"></a>How it works...</h3></div></div></div><p><code class="literal">slapcat</code> exports the LDAP database's contents to LDIF-formatted output. The content is sent to STDOUT by default, so you should either capture it using the shell's redirect operators (<code class="literal">&gt;</code> or <code class="literal">&gt;&gt;</code>) or using the command's <code class="literal">-l</code> (lowercase L) argument, which specifies the name of an output file:</p><pre class="programlisting">
<span class="strong"><strong>slapcat -b "dc=ldap,dc=example,dc=com" -l backup.ldif</strong></span>
</pre><p>The suffix of the targeted directory is given using the <code class="literal">-b</code> argument. If there are any subordinate directories, they'll be exported as well by default. To eliminate subordinates from the export and to export only the top-level directory contents, use the <code class="literal">-g</code> argument:</p><pre class="programlisting">
<span class="strong"><strong>slapcat -b "dc=ldap,dc=example,dc=com" -g -l backup.ldif</strong></span>
</pre><p><code class="literal">slapcat</code> returns entries in the order it encounters them while scanning the database. This means it's possible for an object's definition to appear in the export after that of an entity who's attributes reference it. This isn't a problem for <code class="literal">slapadd</code> because of how it imports data as opposed to <code class="literal">ldapadd</code>, so the former utility should be used to restore the directory. Otherwise you'll have to edit the file to ensure the ordering won't pose a problem; something I'm sure you'll agree isn't appealing given the format's verbosity:</p><pre class="programlisting">
<span class="strong"><strong>slapadd -f backup.ldif</strong></span>
</pre><p>When performing exports and imports, the LDAP server should not be running. This makes any write actions impossible during the process to guarantee the integrity and consistency of the data.</p><p><code class="literal">slapadd</code> writes files directly to the server's data directory so that the files will be owned by <code class="literal">root</code> (the user account used to run <code class="literal">slapadd</code>), so their ownership needs to be set to <code class="literal">ldap</code> after the import but before the server is started so that the process can access them:</p><pre class="programlisting">
<span class="strong"><strong>chown -R ldap.ldap /var/lib/ldap/*</strong></span>
</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec216"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on working with OpenLDAP backups:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>OpenLDAP FAQ-O-Matic: How do I backup my directory (<a class="ulink" href="http://www.openldap.org/faq/data/cache/287.html" target="_blank">http://www.openldap.org/faq/data/cache/287.html</a>)</p></li><li style="list-style-type: disc"><p>OpenLDAP Administrator's Guide: Maintenance (<a class="ulink" href="http://www.openldap.org/doc/admin24/maintenance.html" target="_blank">http://www.openldap.org/doc/admin24/maintenance.html</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="chapter" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="ch08"></a>ChapterÂ 8.Â Managing Domains and DNS</h2></div></div></div><p>This chapter contains the following recipes:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Setting up BIND as a resolving DNS server</p></li><li style="list-style-type: disc"><p>Configuring BIND as an authoritative DNS server</p></li><li style="list-style-type: disc"><p>Writing a reverse lookup zone file</p></li><li style="list-style-type: disc"><p>Setting up a slave DNS server</p></li><li style="list-style-type: disc"><p>Configuring <code class="literal">rndc</code> to control BIND</p></li></ul></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch08lvl1sec67"></a>Introduction</h2></div></div><hr /></div><p>In this chapter, you'll find recipes that cover working with BIND in various capacities to manage your domain infrastructure better. You'll learn how to configure BIND as a resolving DNS server capable of caching lookup results which can help reduce latency, and also how to configure BIND as an authoritative DNS server to provide authoritative responses publicly for your domain or for resources on your private intranet. Also discussed are handling reverse lookup requests and ensuring your resources remain accessible by configuring redundant, secondary authoritative DNS servers that perform master/slave-style transfers of zone records. Finally, you'll learn how to set up and use <code class="literal">rndc</code>, a very useful administration client for BIND servers.</p></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch08lvl1sec68"></a>Setting up BIND as a resolving DNS server</h2></div></div><hr /></div><p>This recipe teaches you how to set up a resolving DNS server using BIND. Domain Name Service (DNS) is the unsung workhorse of the Internet, which translates memorable names such as <code class="literal">facebook.com</code> and <code class="literal">google.com</code> to IP addresses such as <code class="literal">172.217.18.238</code> and <code class="literal">31.13.76.68</code>.</p><p>Communication across the Internet uses IP addresses to identify systems, but numbers are hard for people to remember. For example, it's easier for us to remember <code class="literal">google.com</code> than <code class="literal">172.217.18.238</code> (or the IPv6 address <code class="literal">2607:f8b0:4006:80e::200e</code>). So, when you type <code class="literal">google.com</code> in your browser's address bar, your system queries a DNS server to resolve the name to its IP address and then requests the page from the web server at that address. When you write an e-mail, a DNS server retrieves the IP address of the recipient's mail server before the message is sent.</p><p>A resolving DNS server maintained by your service provider is probably the first server to receive such lookup requests and it will respond immediately if it already happens to know the address. If not, it contacts the DNS servers in the requested domain's parent zone and receives either a referral to the authoritative DNS server of the requested domain or to servers in the next zone in the DNS hierarchy. If the request reaches the top of the hierarchy without being referred to an authoritative server, then the domain doesn't exist. Otherwise, the authoritative server sends the address back to your resolving server. The resolver then caches the response so that future lookups will complete faster.</p><p>Depending on your network and how many servers are involved in resolving an address, DNS lookups can become a significant source of latency. Address records should be found within the first one or two hops, and the resolving server should be physically close to the user for best performance. Because of this, setting up a local DNS server to cache lookup results can greatly improve how users experience the speed of your network.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec217"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection. It assumes that the system is configured with the IP address <code class="literal">192.168.56.10</code>. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec218"></a>How to do it...</h3></div></div></div><p>Follow these steps to install BIND as a resolving DNS server:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Install the <code class="literal">bind</code> and <code class="literal">bind-util</code> packages:</p><pre class="programlisting">
<span class="strong"><strong>yum install bind bind-utils</strong></span>
</pre></li><li><p>Open BIND's configuration file at <code class="literal">/etc/named.conf</code> with your text editor:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/named.conf</strong></span>
</pre></li><li><p>Find the <code class="literal">listen-on</code> option inside the braces of <code class="literal">options</code>. Update its list to reflect the system's IP addresses BIND will use:</p><pre class="programlisting">
<span class="strong"><strong>listen-on port 53 { 127.0.0.1; 192.168.56.10; };</strong></span>
</pre></li><li><p>Change the value of <code class="literal">listen-on-v6</code> similarly if you want to service IPv6 requests. Otherwise, update the value to <code class="literal">none</code>:</p><pre class="programlisting">
<span class="strong"><strong>listen-on-v6 port 53 { none; }</strong></span>
</pre></li><li><p>Update the <code class="literal">allow-query</code> option with the list of IP addresses that BIND is allowed to accept requests from:</p><pre class="programlisting">
<span class="strong"><strong>allow-query { localhost; 192.168.56.0/24; };</strong></span>
</pre></li><li><p>Save your changes to the configuration file and close it.</p></li><li><p>Start BIND with <code class="literal">systemctl</code>, optionally enable it to start automatically when the system reboots:</p><pre class="programlisting">
<span class="strong"><strong>systemctl start named.service</strong></span>
<span class="strong"><strong>systemctl enable named.service</strong></span>
</pre></li><li><p>Enable FirewallD's <code class="literal">dns</code> service to open port <code class="literal">53</code> to TCP and UDP traffic:</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --add-service=dns</strong></span>
<span class="strong"><strong>firewall-cmd --reload</strong></span>
</pre></li><li><p>Request a lookup using <code class="literal">dig</code> to test the configuration:</p><pre class="programlisting">
<span class="strong"><strong>dig @192.168.56.10 google.com A</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec219"></a>How it works...</h3></div></div></div><p>BIND is configured as a resolving DNS server by default but we still want to update a few options to define how it accepts lookup requests. The first change is to the <code class="literal">listen-on*</code> options found in the <code class="literal">options</code> section which specify the port and network interface BIND listens on for requests. <code class="literal">listen-on</code> applies to IPv4 networks and <code class="literal">listen-on-v6</code> applies to IPv6. In both cases, the standard port for DNS traffic is port <code class="literal">53</code>:</p><pre class="programlisting">
<span class="strong"><strong>listen-on port 53 { 127.0.0.1; 192.168.56.10; };</strong></span>
<span class="strong"><strong>listen-on-v6 port 53 { none; }</strong></span>
</pre><p>Next, we updated the <code class="literal">allow-query</code> option, providing a whitelist of systems that BIND may accept requests from. Addresses can be provided individually or written in CIDR notation:</p><pre class="programlisting">
<span class="strong"><strong>allow-query { localhost; 92.168.56.0/24; }</strong></span>
</pre><p>Using the predefined values such as <code class="literal">any</code>, <code class="literal">localhost</code>, <code class="literal">localnets</code>, and <code class="literal">none</code> is also acceptable. Intuitively, <code class="literal">any</code> represents all addresses, allowing BIND to listen on all of the system's configured addresses or accept requests from any source, whereas <code class="literal">none</code> disallows everything. <code class="literal">localhost</code> represents all of the system's addresses and <code class="literal">localnets</code> represents all addresses on all of the networks the system is a member of.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note52"></a>Note</h3><p>Be careful that the <code class="literal">local</code> in <code class="literal">localhost</code> and <code class="literal">localnets</code> doesn't give you a false sense of security. If your system is connected to multiple networks, for example, a public network (such as the Internet) and a private internal network, both of them are considered local. Allowing access from untrusted networks is a serious risk without the necessary security measures in place because an open DNS server can be abused by malicious users intent on carrying out several types of denial of service attacks.</p></div><p>After BIND's configuration is updated and it's up and running, we can test everything by sending a lookup request with <code class="literal">dig</code> and inspect the response:</p><pre class="programlisting">
<span class="strong"><strong>dig @192.168.56.10 google.com A</strong></span>
</pre><p>Requests can be sent to a specific DNS server with <code class="literal">dig</code> by providing the targeted server's address prefixed by <code class="literal">@</code>. If a DNS server isn't given in the invocation, <code class="literal">dig</code> will send the request to the servers listed in your system's <code class="literal">/etc/resolve.conf</code> file.</p><p>After the address of the DNS server, we gave the resource name we're interested in followed by the desired record type. In the preceding example, the Address (<code class="literal">A</code>) record for <code class="literal">google.com</code> is sought. Other types can be queried too, such as the Name Server (<code class="literal">NS</code>) and Mail Exchange (<code class="literal">MX</code>) records.</p><div class="mediaobject"><img src="graphics/image_08_001.jpg" /><div class="caption"><p>dig queries the DNS servers and displays their response</p></div></div><p>The response from <code class="literal">dig</code> is organized into several sections. The <span class="strong"><strong>ANSWER SECTION</strong></span>Â shows the <code class="literal">A</code> record we requested. The <span class="strong"><strong>AUTHORITY SECTION</strong></span>Â lists the authoritative DNS servers configured for the requested domain, and the <span class="strong"><strong>ADDITIONAL SECTION</strong></span>Â shows the IP addresses of the authoritative servers. Various metadata is included throughout, such as which flags were set in the request, which DNS server was queried, and how long the lookup took to complete.</p><p>When you're satisfied with the testing results, you can configure the systems on your network to use the new DNS server. This is typically done by adding a <code class="literal">nameserver</code> entry in each system's <code class="literal">/etc/resolv.conf</code> file that provides the DNS server's address:</p><pre class="programlisting">
<span class="strong"><strong>nameserver 192.168.56.10</strong></span>
</pre><p><code class="literal">resolv.conf</code> may be dynamically generated depending on how the system's interfaces are configured. If this is the case, any changes you make in the file will be overwritten. You'll need to inspect the interfaces' configuration files (for example, <code class="literal">/etc/sysconf/network-scripts/ifcfg-enp0s3</code>), and if <code class="literal">PEERDNS</code> is set to <code class="literal">yes</code> then <code class="literal">resolv.conf</code> is maintained by the network manager. Add the <code class="literal">DNS</code> entry in the interface's configuration and the DNS server's address will make its way into <code class="literal">resolve.conf</code> the next time the interface is brought up:</p><pre class="programlisting">
<span class="strong"><strong>DNS=192.168.56.10</strong></span>
</pre><p>Bounce the interface after updating the configuration for the change to take effect and verify the contents of <code class="literal">resolve.conf</code>:</p><pre class="programlisting">
<span class="strong"><strong>ifdown enp0s3 &amp;&amp; ifup enp0s3</strong></span>
<span class="strong"><strong>cat /etc/resolv.conf</strong></span>
</pre><p>Resolving DNS servers are sometimes called recursive servers because they send lookup requests to each level in the zone hierarchy until they find an answer. Forwarding DNS servers function similarly to resolving/recursive servers, in that both types accept lookup requests and cache the results for expediency; however, forwarding servers send their requests to another DNS server and wait for the response, delegating the resolution process instead of tracking down the answer itself. This can offload a lot of the network chatter produced by a resolving DNS server trying to service a request.</p><p>To configure BIND to run as a forwarding DNS server, open <code class="literal">/etc/named.conf</code> again and add the <code class="literal">forwarders</code> and <code class="literal">forward</code> options to the <code class="literal">options</code> block:</p><pre class="programlisting">
<span class="strong"><strong>forwarders { 8.8.8.8; 8.8.4.4; };</strong></span>
<span class="strong"><strong>forward only;</strong></span>
</pre><p>The <code class="literal">forwarders</code> option provides a list of DNS servers responsible for resolving lookup requests. The example identifies Google's public DNS servers but your service provider should also maintain public DNS servers that you can use if you prefer.</p><p><code class="literal">forward only</code> forces BIND to forward requests to the responsible servers listed in <code class="literal">forwarders</code>. Only when the responsible server fails to return an address or a referral, will BIND contact the root servers for the domain's authoritative DNS servers and service the request itself. Recursion isn't completely turned off on a forwarding server but it is greatly reduced.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec220"></a>See also</h3></div></div></div><p>The following resources will provide you with more information on how DNS works and how to configure BIND:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">dig</code>Â manual page (<code class="literal">man 1 dig</code>)</p></li><li style="list-style-type: disc"><p>An Introduction to DNS Terminology (<a class="ulink" href="http://www.digitalocean.com/community/tutorials/an-introduction-to-dns-terminology-components-and-concepts" target="_blank">http://www.digitalocean.com/community/tutorials/an-introduction-to-dns-terminology-components-and-concepts</a>)</p></li><li style="list-style-type: disc"><p>DNS for Rocket Scientists (<a class="ulink" href="http://www.zytrax.com/books/dns/" target="_blank">http://www.zytrax.com/books/dns/</a>)</p></li><li style="list-style-type: disc"><p>How DNS Works (<a class="ulink" href="http://howdns.works/" target="_blank">http://howdns.works/</a>)</p></li><li style="list-style-type: disc"><p>BIND 9 Administrator Reference Manual (<a class="ulink" href="http://www.isc.org/downloads/bind/doc/" target="_blank">http://www.isc.org/downloads/bind/doc/</a>)</p></li><li style="list-style-type: disc"><p>RHEL 7 Networking Guide: BIND (<a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Networking_Guide/sec-BIND.html" target="_blank">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Networking_Guide/sec-BIND.html</a>)</p></li><li style="list-style-type: disc"><p>DNS &amp; BIND by Cricket Liu and Paul Albitz (<a class="ulink" href="http://shop.oreilly.com/product/9780596100575.do" target="_blank">http://shop.oreilly.com/product/9780596100575.do</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch08lvl1sec69"></a>Configuring BIND as an authoritative DNS server</h2></div></div><hr /></div><p>A benefit to hierarchical structures is that the responsibility for subordinate nodes can be delegated. Although the Internet Corporation for Assigned Names and Numbers (ICANN) has authority over the DNS directory, it delegates the responsibility to accredited registrars for top-level domains, such as <code class="literal">com</code>, <code class="literal">net</code>, and <code class="literal">org</code>, and delegates to the appropriate governmental agencies for country top-level domains, such as <code class="literal">ca</code>, <code class="literal">de</code>, and <code class="literal">es</code>. Registrars delegate responsibility to you when you register a domain and you may further delegate the responsibility for your subdomains however you please. Each boundary formed by delegating responsibility creates what is known as a DNS zone.</p><p>This recipe teaches you how to configure BIND to operate as an authoritative DNS server for your zone. If you recall the previous recipe's discussion on how a DNS request propagates, you'll remember that authoritative servers have the final say for a resolution. This is because its information comes from outside the DNS system, from an administrator who manually configures the zone's information. You'll also learn how to write a zone file with information such as mapping hostnames to IP addresses, which, I promise, isn't as scary as it might look at first glance.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec221"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with BIND configured as a resolving DNS server, as described in the previous recipe (BIND's configuration will be updated to operate as an authoritative server). Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p><p>Following the advice of RFC-2606 (Reserved Top Level DNS Names), I'll use the <code class="literal">example.com</code> domain for illustration. If you have your own domain name then feel free to substitute. Also for the sake of illustration, the recipe will reflect a network of various servers that handle the different services one commonly finds in a domain, such as e-mail servers and web servers. The systems are as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">ns1</code>: Hosts the domain's primary authoritative DNS server with the IP address <code class="literal">192.168.56.10</code> (this is the system we'll be working on)</p></li><li style="list-style-type: disc"><p><code class="literal">ns2</code>: Hosts a secondary authoritative DNS server with the address <code class="literal">192.168.56.20</code></p></li><li style="list-style-type: disc"><p><code class="literal">mail</code>: Hosts the primary e-mail server with the address <code class="literal">192.168.56.12</code></p></li><li style="list-style-type: disc"><p><code class="literal">mail2</code>: Hosts a secondary e-mail server with the address <code class="literal">192.168.56.22</code></p></li><li style="list-style-type: disc"><p><code class="literal">www</code>: Hosts a web and FTP server with the address <code class="literal">192.168.56.100</code></p></li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec222"></a>How to do it...</h3></div></div></div><p>Follow these steps to configure BIND as an authoritative DNS server:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Open <code class="literal">/etc/named.conf</code> with your text editor:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/named.conf</strong></span>
</pre></li><li><p>Verify that the <code class="literal">listen-on*</code> and <code class="literal">allow-query</code> options are configured as described in the previous recipe:</p><pre class="programlisting">
<span class="strong"><strong>listen-on port 52 { 127.0.0.1; 192.168.56.10; };</strong></span>
<span class="strong"><strong>listen-on-v6 port 52 { none; };</strong></span>
<span class="strong"><strong>allow-query { 192.168.56.0/24; };</strong></span>
</pre></li><li><p>Change the value of the <code class="literal">recursion</code> option to <code class="literal">no</code> to disable BIND's recursive lookup behavior completely:</p><pre class="programlisting">
<span class="strong"><strong>recursion no;</strong></span>
</pre></li><li><p>At the end of the file, add the following zone configuration:</p><pre class="programlisting">
<span class="strong"><strong>zone "example.com." in {</strong></span>
<span class="strong"><strong>       type master;</strong></span>
<span class="strong"><strong>       file "/var/named/zones/example.com.fwd";</strong></span>
<span class="strong"><strong>       allow-transfer { none; };</strong></span>
<span class="strong"><strong>};</strong></span>
</pre></li><li><p>Save your changes and close the file.</p></li><li><p>Create the <code class="literal">/var/named/zones</code> directory:</p><pre class="programlisting">
<span class="strong"><strong>mkdir /var/named/zones</strong></span>
</pre></li><li><p>Create the zone file <code class="literal">/var/named/zones/example.com.fwd</code> with the following content (our discussion in <span class="emphasis"><em>How it works...</em></span> will help you understand the meaning of each record):</p><pre class="programlisting">
<span class="strong"><strong>$TTL 1d</strong></span>
<span class="strong"><strong>$ORIGIN example.com.</strong></span>
<span class="strong"><strong>; start of authority resource record</strong></span>
<span class="strong"><strong>@       IN SOA   ns1 hostmaster.example.com. (</strong></span>
<span class="strong"><strong>                    2016041501 ; serial</strong></span>
<span class="strong"><strong>                    12h        ; refresh</strong></span>
<span class="strong"><strong>                    5m         ; retry</strong></span>
<span class="strong"><strong>                    2w         ; expire</strong></span>
<span class="strong"><strong>                    3h)        ; negative TTL</strong></span>
<span class="strong"><strong>; nameserver records</strong></span>
<span class="strong"><strong>           IN NS    ns1</strong></span>
<span class="strong"><strong>           IN NS    ns2</strong></span>
<span class="strong"><strong>ns1     IN A     192.168.56.10 </strong></span>
<span class="strong"><strong>ns2     IN A     192.168.56.20</strong></span>
<span class="strong"><strong>; mail records</strong></span>
<span class="strong"><strong>@       IN MX    10 mail</strong></span>
<span class="strong"><strong>           IN MX    20 mail2</strong></span>
<span class="strong"><strong>mail    IN A     192.168.56.12</strong></span>
<span class="strong"><strong>mail2   IN A     192.168.56.22</strong></span>
<span class="strong"><strong>; webserver records</strong></span>
<span class="strong"><strong>@       IN A     192.168.56.100</strong></span>
<span class="strong"><strong>www     IN CNAME @</strong></span>
<span class="strong"><strong>ftp     IN CNAME @</strong></span>
</pre></li><li><p>Ensure that the directory and zone file have the correct ownership and access permissions:</p><pre class="programlisting">
<span class="strong"><strong>chown root.named /var/named/zones</strong></span>
<span class="strong"><strong>chmod 750 /var/named/zones</strong></span>
<span class="strong"><strong>chmod 640 /var/named/zones/*</strong></span>
</pre></li><li><p>Restart BIND for the configuration changes to take effect:</p><pre class="programlisting">
<span class="strong"><strong>systemctl restart named.service</strong></span>
</pre></li><li><p>Request a lookup using dig to test the configuration:</p><pre class="programlisting">
<span class="strong"><strong>dig @192.168.56.10 example.com SOA</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec223"></a>How it works...</h3></div></div></div><p>The only records an authoritative DNS server should serve are those with authoritative information about its zones, so we began by disabling <code class="literal">recursion</code> in BIND's configuration file. When disabled, BIND won't forward requests or try to resolve a lookup request for non-authoritative records:</p><pre class="programlisting">
<span class="strong"><strong>recursion off;</strong></span>
</pre><p>Then we added a short section at the end of the configuration file that specifies how the BIND server should function for the <code class="literal">example.com.</code> zone:</p><pre class="programlisting">
<span class="strong"><strong>zone "example.com." in {</strong></span>
<span class="strong"><strong>    type master;</strong></span>
<span class="strong"><strong>    file "/var/named/zones/example.com.fwd";</strong></span>
<span class="strong"><strong>    allow-transfer { none; };</strong></span>
<span class="strong"><strong>};</strong></span>
</pre><p>The section starts with the keyword <code class="literal">zone</code> to denote a zone configuration and is followed by the zone's name given as a fully qualified domain name (FQDN). FQDNs always end with a dot because they include all of the delegated paths, including the root. Since the root of the DNS system doesn't have a name, its separator appears as a trailing dot. Thus, <code class="literal">example.com.</code> is fully qualified but <code class="literal">example.com</code> is not. (Some people misuse the term FQDN when they're really talking about partially qualified domain names. This is one of my irrational pet peeves so consider yourself warned.)</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note53"></a>Note</h3><p>Thinking about how you navigate the filesystem can help you understanding the difference between the fully qualified and partially qualified names. Navigation, when the absolute (fully qualified) path <code class="literal">/var/named</code> is given, begins at the root of the filesystem, descends into the <code class="literal">var</code> directory, and then into <code class="literal">named</code>. The root directory has no name other than its separator. However, the relative (partially qualified) path <code class="literal">var/named</code> doesn't start with the separator. Its navigation begins where the current directory happens to be at the moment. Domain names are similar, but they list traverse the hierarchy backwards toward the root, and the dot is used as a separator instead of a slash.</p></div><p>The <code class="literal">type master</code> option specifies this server as the zone's primary authoritative DNS server. A common deployment strategy sets up several authoritative servers in a master/slave configuration. An administrator updates the zone information on the primary, which is identified as the master; the information is then transferred to one or more slaves acting as secondary authoritative DNS servers. You'll learn how to set this up in the <span class="emphasis"><em>Setting up a slave DNS server</em></span>Â recipe, but for now we'll only focus on the primary server.</p><p>The <code class="literal">allow-transfers</code> option lists the slave systems this server is allowed to respond to when a request is received for zone information transfers, but since we don't (yet) have a secondary authoritative DNS server configured, we've used <code class="literal">none</code> to disable transfers. This helps to protect us from a specific type of denial of service attack. Resource records are small enough to fit in a UDP packet or two during normal lookup activity, but zone transfers transmit all of the records in bulk over TCP. Malicious users repeatedly sending transfer requests in quick succession can saturate your network.</p><p>The zone's information is stored in a text file known as a <span class="strong"><strong>zone file</strong></span> whose location is given with the <code class="literal">file</code> option. The convention followed in this chapter places the files in a <code class="literal">zone</code> directory under <code class="literal">/var/named</code> and uses <code class="literal">fwd</code> and <code class="literal">rev</code> as file extensions to indicate whether the file is a forward lookup or a reverse lookup zone file. Thus, our file is saved as <code class="literal">/var/named/zones/example.com.fwd</code>.</p><p>This recipe's file is a forward zone file because it maps names to their IP addresses. A reverse lookup zone maps the inverse relationship, which is addresses to names. They are discussed in the <span class="emphasis"><em>Writing a reverse lookup zone file</em></span> recipe.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note54"></a>Note</h3><p>I've seen a handful of different conventions followed when it comes to naming zone files. Some administrators use <code class="literal">zon</code> or <code class="literal">zone</code> as the file's extension. Some will separate the zone files in the directories named
<code class="literal">fwd-zone</code> and <code class="literal">rev-zone</code>. Honestly, it really doesn't matter what you do as long as you stay consistent <code class="literal">systemctl restart named.servicent</code> and your files are well organized.</p></div><p><code class="literal">$TTL</code> is the first directive given in the zone file and gives the default length of time a resolving DNS server may cache records it receives from the authoritative server. Specific records may provide their own TTL, which overrides this default value:</p><pre class="programlisting">
<span class="strong"><strong>$TTL 14400</strong></span>
</pre><p>The <code class="literal">$ORIGIN</code> directive provides the FQDN identifying the zone. Any <code class="literal">@</code> appearing in the file will be replaced by the value of <code class="literal">$ORIGIN</code>:</p><pre class="programlisting">
<span class="strong"><strong>$ORIGIN example.com.</strong></span>
</pre><p>The remaining entries are collectively called resource records and are made up of a series of fields in the order <code class="literal">name ttl class type values</code>. The <code class="literal">name</code> field gives the name of the resource that owns the record. If blank, its value defaults to the name used in the previous record. <code class="literal">ttl</code> is also optional, defaulting to the value of <code class="literal">$TTL</code>. And for our purposes, <code class="literal">class</code> will always be <code class="literal">IN</code> because we're writing the Internet resource records. The other classes are <code class="literal">CH</code> for Chaos and <code class="literal">HS</code> for Hesiod but they aren't in widespread use.</p><p>The first record in the file must be the start of authority (<code class="literal">SOA</code>) record which identifies that this server is the authoritative DNS server for the zone. The values for a <code class="literal">SOA</code> record are the name of the primary authoritative server for the zone (we supplied <code class="literal">ns1</code>), an e-mail address for the person responsible for the zone (<code class="literal">hostmaster.example.com.</code>), a serial number (<code class="literal">2016041501</code>), refresh duration (<code class="literal">12h</code>), retry duration (<code class="literal">5m</code>), expiration duration (<code class="literal">2w</code>), and the length of time negative responses (sent when the requested record doesn't exist) from the server can be cached (<code class="literal">3h</code>). Records are usually written as single-line entries, but parentheses permit us to split the record over several lines:</p><pre class="programlisting">
<span class="strong"><strong>; start of authority resource record</strong></span>
<span class="strong"><strong>@       IN SOA   ns1 hostmaster.example.com. (</strong></span>
<span class="strong"><strong>                 2016041501 ; serial</strong></span>
<span class="strong"><strong>                 12h        ; refresh</strong></span>
<span class="strong"><strong>                 5m         ; retry</strong></span>
<span class="strong"><strong>                 2w         ; expire</strong></span>
<span class="strong"><strong>                 3h)        ; negative TTL</strong></span>
</pre><p>The <code class="literal">@</code> variable that would normally appear in the e-mail addresses is changed to a dot in <code class="literal">hostmaster.example.com.</code> because <code class="literal">@</code> has special meaning in zone files. Also notice which names are fully qualified. Names that aren't fully qualified will have the FQDN appended automatically, so <code class="literal">ns1</code> is understood as <code class="literal">ns1.example.com.</code>. If the e-mail address's domain part wasn't fully qualified then <code class="literal">hostmaster.example.com</code> would be treated as <code class="literal">hostmaster.example.com.example.com.</code>, which certainly isn't what we want.</p><p>Values beyond that in the <code class="literal">SOA</code> record are primarily of interest to the slave DNS servers. The refresh value informs the slave how often it should try to refresh its copy of the zone file. The retry duration tells the slave how long it should wait between connection attempts if the master is unreachable, and the expiry value specifies how long the slave can satisfy lookup requests as an authoritative server with its copy of the zone file if contact with the master is completely lost. The negative TTL is the length of time a resolver should cache negative responses from a DNS server, for example, <code class="literal">NXDOMAIN</code> and <code class="literal">NODATA</code> responses.</p><p>The serial number is an arbitrary that 10-digit value slaves can use to differentiate this version of the zone file from previous versions. Anytime you update the file, you must also update the serial number. A popular convention is to use the current date followed by a sequence counter. For example, April 15, 2016 is written as <code class="literal">20160415</code> and then two additional digits are added to identify multiple updates during the same day (<code class="literal">2016041501</code>, <code class="literal">2016041502</code>, <code class="literal">2016041503</code>, and so on).</p><p>Next, we gave the <code class="literal">NS</code> records that identify the zone's authoritative DNS servers. The <code class="literal">SOA</code> and <code class="literal">NS</code> records are mandatory in every zone file:</p><pre class="programlisting">
<span class="strong"><strong>; nameserver records</strong></span>
<span class="strong"><strong>        IN NS    ns1</strong></span>
<span class="strong"><strong>        IN NS    ns2</strong></span>
<span class="strong"><strong>ns1     IN A     192.168.56.10 </strong></span>
<span class="strong"><strong>ns2     IN A     192.168.56.20</strong></span>
</pre><p>The <code class="literal">NS</code> records identify the names of the authoritative servers. In the preceding example, we defined <code class="literal">n1</code> and <code class="literal">n2</code> as the zone's authoritative DNS servers which are understood as <code class="literal">ns1.example.com.</code> and <code class="literal">ns2.example.com.</code> since they are not fully qualified. The <code class="literal">A</code> records map a name to its address (<code class="literal">AAAA</code> is used for IPv6 addresses). The records we wrote in the example say <code class="literal">ns1.example.com.</code> can be reached at <code class="literal">192.168.56.10</code> and <code class="literal">ns2.example.com.</code> can be reached at <code class="literal">192.168.56.20</code>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note55"></a>Note</h3><p>The <code class="literal">NS</code> records belong to the zone but I left the first field of the <code class="literal">NS</code> records blank since the field defaults to the name used in the last record. In this case, the name happens to be <code class="literal">@</code> from the <code class="literal">SOA</code> record (which is <code class="literal">$ORIGIN</code>). Any of the following alternatives mean the same and are equally acceptable:</p><pre class="programlisting">
<span class="strong"><strong>@ IN NS n1</strong></span>
<span class="strong"><strong>$ORIGIN IN NS n1</strong></span>
<span class="strong"><strong>example.com. IN NS n1</strong></span></pre><p>However, be careful because the <code class="literal">MX</code> records also belong to the zone. As we begin the next set of records, the last name is <code class="literal">ns2</code> from that server's <code class="literal">A</code> record. This means the first <code class="literal">MX</code> record must provide either <code class="literal">@</code>, <code class="literal">$ORIGIN</code>, or <code class="literal">example.com.</code>.</p></div><p>The <code class="literal">MX</code> records define the names of the servers responsible for handling e-mail for the zone. The mailers are assigned a relative preference and a client will try to communicate with the mail server with the lowest preference first. If the server is unreachable, the client attempts to connect to the next lowest until it exhausts the list:</p><pre class="programlisting">
<span class="strong"><strong>; mail records</strong></span>
<span class="strong"><strong>@       IN MX    10 mail</strong></span>
<span class="strong"><strong>        IN MX    20 mail2</strong></span>
<span class="strong"><strong>mail    IN A     192.168.56.12</strong></span>
<span class="strong"><strong>mail2   IN A     192.168.56.22</strong></span>
</pre><p>Our configuration defines the principal mail server <code class="literal">mail.example.com.</code> with the IP address <code class="literal">192.168.56.12</code> and a relative preference of 10. The second server, perhaps a backup in the event of an outage, is <code class="literal">mail2.example.com.</code> at <code class="literal">192.168.56.22</code> with a preference of 20.</p><p>Last, we defined records that identify our zone's web server and other aliases for the system:</p><pre class="programlisting">
<span class="strong"><strong>; webserver records</strong></span>
<span class="strong"><strong>@       IN A     192.168.56.100</strong></span>
<span class="strong"><strong>www     IN CNAME @</strong></span>
<span class="strong"><strong>ftp     IN CNAME @</strong></span>
</pre><p>The ubiquity of <code class="literal">www</code> appearing at the beginning of URLs has waned since the good old days of the dot-com era. Still, many zones resolve the addresses both with and without <code class="literal">www</code> to the same IP. Our configuration does the same, returning <code class="literal">192.168.56.100</code> for lookups of both <code class="literal">example.com</code> or <code class="literal">www.example.com</code>. This is accomplished by creating the <code class="literal">A</code> record that maps the domain to the web server's address and then a Canonical Name (<code class="literal">CNAME</code>) record that aliases <code class="literal">www</code> to the domain's <code class="literal">A</code> record. Our configuration also aliases <code class="literal">ftp</code> to the <code class="literal">A</code> record so that users can upload their site's files to the web server using the address <code class="literal">ftp.example.com</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec224"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on running a DNS server and managing your domain:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>BIND 9 Administrator Reference Manual (<a class="ulink" href="http://www.isc.org/downloads/bind/doc" target="_blank">http://www.isc.org/downloads/bind/doc</a>)</p></li><li style="list-style-type: disc"><p>Five Basic Mistakes Not to Make in DNS (<a class="ulink" href="http://archive.oreilly.com/pub/a/sysadmin/2007/04/26/5-basic-mistakes-not-to-make-in-dns.html" target="_blank">http://archive.oreilly.com/pub/a/sysadmin/2007/04/26/5-basic-mistakes-not-to-make-in-dns.html</a>)</p></li><li style="list-style-type: disc"><p>BIND for the Small LAN (<a class="ulink" href="http://www.madboa.com/geek/soho-bind" target="_blank">http://www.madboa.com/geek/soho-bind</a>)</p></li><li style="list-style-type: disc"><p>RFC-1034: Domain Concepts and Facilities (<a class="ulink" href="https://tools.ietf.org/html/rfc1034" target="_blank">https://tools.ietf.org/html/rfc1034</a>)</p></li><li style="list-style-type: disc"><p>RFC-1035: Domain Names-Implementation and Specification (<a class="ulink" href="https://tools.ietf.org/html/rfc1035" target="_blank">https://tools.ietf.org/html/rfc1035</a>)</p></li><li style="list-style-type: disc"><p>RFC-1912: Common DNS Operational and Configuration Errors (<a class="ulink" href="https://tools.ietf.org/html/rfc1912" target="_blank">https://tools.ietf.org/html/rfc1912</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch08lvl1sec70"></a>Writing a reverse lookup zone file</h2></div></div><hr /></div><p>Until now we've treated DNS requests as forward facing lookups, translating resource names like <code class="literal">www.example.com</code> to an IP address. However, services can also ask a DNS server to resolve information in the opposite direction by providing an IP address and want to know what name it's associated with. Reverse lookups such as these are especially useful for logging or authentication and security purposes. For example, a system can query a DNS server to verify that a client really is connecting from the system they claim. To accommodate such requests, this recipe shows you how to write a reverse lookup zone file.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec225"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with BIND installed and configured as described in the previous recipes. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec226"></a>How to do it...</h3></div></div></div><p>Follow these steps to add a reverse lookup zone:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Open BIND's configuration file:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/named.conf</strong></span>
</pre></li><li><p>Add the following zone entry:</p><pre class="programlisting">
<span class="strong"><strong>zone "56.168.192.in-addr.arpa." in {</strong></span>
<span class="strong"><strong>       type master;</strong></span>
<span class="strong"><strong>       file "/var/named/zones/example.com.rev";</strong></span>
<span class="strong"><strong>       allow-transfer { none; };</strong></span>
<span class="strong"><strong>};</strong></span>
</pre></li><li><p>Save your changes and close the configuration file.</p></li><li><p>Create the <code class="literal">/etc/named/zones/example.com.rev</code> file with the following content:</p><pre class="programlisting">
<span class="strong"><strong>$TTL 1d</strong></span>
<span class="strong"><strong>$ORIGIN 56.168.192.in-addr.arpa.</strong></span>
<span class="strong"><strong>; start of authority</strong></span>
<span class="strong"><strong>@   IN SOA  ns1.example.com. hostmaster.example.com. (</strong></span>
<span class="strong"><strong>               2016041501 ; serial</strong></span>
<span class="strong"><strong>               12h        ; refresh</strong></span>
<span class="strong"><strong>               5m         ; retry</strong></span>
<span class="strong"><strong>               2w         ; expire</strong></span>
<span class="strong"><strong>               3h)        ; error TTL</strong></span>
<span class="strong"><strong>; nameservers</strong></span>
<span class="strong"><strong>       IN NS   ns1.example.com.</strong></span>
<span class="strong"><strong>       IN NS   ns2.example.com.</strong></span>
<span class="strong"><strong>10  IN PTR  ns1.example.com.</strong></span>
<span class="strong"><strong>20  IN PTR  ns2.example.com.</strong></span>
<span class="strong"><strong>; mail servers</strong></span>
<span class="strong"><strong>12  IN PTR  mail.example.com.</strong></span>
<span class="strong"><strong>22  IN PTR  mail2.example.com.</strong></span>
<span class="strong"><strong>; web servers</strong></span>
<span class="strong"><strong>100 IN PTR  example.com.</strong></span>
<span class="strong"><strong>100 IN PTR  www.example.com.</strong></span>
<span class="strong"><strong>100 IN PTR  ftp.example.com.</strong></span>
</pre></li><li><p>Ensure that the zone file has the correct ownership and access permissions:</p><pre class="programlisting">
<span class="strong"><strong>chown root.named /var/named/zones/example.com.rev</strong></span>
<span class="strong"><strong>chmod 640 /var/named/zones/example.com.rev</strong></span>
</pre></li><li><p>Restart BIND for the configuration changes to take effect:</p><pre class="programlisting">
<span class="strong"><strong>systemctl restart named.service</strong></span>
</pre></li><li><p>Perform a reverse DNS lookup using <code class="literal">dig</code> to test the zone:</p><pre class="programlisting">
<span class="strong"><strong>dig @192.168.56.10 -x 192.168.56.100</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec227"></a>How it works...</h3></div></div></div><p>Reverse lookup zones are just like any other zones defined by a zone file. So, hopefully nothing in this recipe came as a big surprise to you. Nevertheless, there are still a few points worth reviewing.</p><p>First, the zone's name is constructed by combining the network's address with the special domain <code class="literal">in-addr.arpa</code>, which is used to define reverse-mapped IP addresses (<code class="literal">ip6.arpa</code> is used for IPv6). The order of the address's octets is reversed to maintain consistency with domain names that read from the most specific to the most broad. Thus, <code class="literal">56.168.192.in-addr.arpa.</code> is the FQDN for reverse lookups on addresses in the <code class="literal">192.168.56/24</code> address space:</p><pre class="programlisting">
<span class="strong"><strong>zone "56.168.192.in-addr.arpa." in {</strong></span>
<span class="strong"><strong>    type master;</strong></span>
<span class="strong"><strong>    file "/etc/named/zones/example.com.rev";</strong></span>
<span class="strong"><strong>    allow-transfer { none; };</strong></span>
<span class="strong"><strong>};</strong></span>
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note56"></a>Note</h3><p>This recipe names the zone file as <code class="literal">example.com.rev</code> so that it will sort alongside the forward zone file <code class="literal">example.com.fwd</code> in directory listings. Other conventions might name the file as <code class="literal">56.168.192.in-addr.arpa.zone</code>. Again, regardless of whatever convention you choose, the key thing is to be consistent.</p></div><p>Keep in mind the expansion and substitution rules we've discussed when writing a reverse zone file, most importantly that partially qualified names are interpreted in the context of <code class="literal">$ORIGIN</code>. We can get away writing just the primary authoritative DNS server's hostname in a forward lookup zone's <code class="literal">SOA</code> record, but we need to make sure that the names are fully qualified in a reverse file to prevent them from being treated as <code class="literal">ns1.56.168.192.in-addr.arpa.</code>:</p><pre class="programlisting">
<span class="strong"><strong>; start of authority</strong></span>
<span class="strong"><strong>@   IN SOA  ns1.example.com. hostmaster.example.com. (</strong></span>
<span class="strong"><strong>            2016041501 ; serial</strong></span>
<span class="strong"><strong>            12h        ; refresh</strong></span>
<span class="strong"><strong>            5m         ; retry</strong></span>
<span class="strong"><strong>            2w         ; expire</strong></span>
<span class="strong"><strong>            3h)        ; error TTL</strong></span>
</pre><p>A pointer record (<code class="literal">PTR</code>) relates an IP address back to a resource name. Apart from the <code class="literal">SOA</code> and <code class="literal">NS</code> records (as they are mandatory records in any zone file), the only other type of record that can appear in a reverse file is <code class="literal">PTR</code>. A consequence of this is that multiple records are needed to correctly inverse any aliases created with the <code class="literal">CNAME</code> records in the forward file. Since we used <code class="literal">www</code> and <code class="literal">ftp</code> as aliases for <code class="literal">example.com.</code>, which resolve to <code class="literal">192.168.56.100</code>, three records for the address appears in the reverse zone file as follows:</p><pre class="programlisting">
<span class="strong"><strong>100 IN PTR  example.com.</strong></span>
<span class="strong"><strong>100 IN PTR  www.example.com.</strong></span>
<span class="strong"><strong>100 IN PTR  ftp.example.com.</strong></span>
</pre><p>We can test the zone configuration with <code class="literal">dig</code> using the <code class="literal">-x</code> argument:</p><pre class="programlisting">
<span class="strong"><strong>dig @192.168.56.10 -x 192.168.56.100</strong></span>
</pre><p><code class="literal">-x</code> lets <code class="literal">dig</code> know that we're performing a reverse lookup. We provide the IP address as we would normally write it and <code class="literal">dig</code> will reverse its octets and append the <code class="literal">in-addr.arpa</code> domain for us when it sends the request.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec228"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on working with reverse zones and lookups:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>BIND 9 Administrator Reference Manual (<a class="ulink" href="http://www.isc.org/downloads/bind/doc/" target="_blank">http://www.isc.org/downloads/bind/doc/</a>)</p></li><li style="list-style-type: disc"><p>DNS Reverse Mapping (<a class="ulink" href="http://www.zytrax.com/books/dns/ch3/" target="_blank">http://www.zytrax.com/books/dns/ch3/</a>)</p></li><li style="list-style-type: disc"><p>Classless <code class="literal">in-addr.arpa.</code>Â delegation (<a class="ulink" href="http://www.indelible.org/ink/classless" target="_blank">http://www.indelible.org/ink/classless</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch08lvl1sec71"></a>Setting up a slave DNS server</h2></div></div><hr /></div><p>Redundancy is important to ensure key services remain available in the event of an issue. As DNS is one of the most critical components of a network, whether it's a private intranet or the public Internet, having only one authoritative DNS server is unwise. In fact, IANA's <span class="emphasis"><em>Technical Requirements for Authoritative Name Servers</em></span> document states that there must be a minimum of two different authoritative name servers for the zone. This recipe shows you how to configure a second BIND installation to act as a secondary authoritative server that receives its zone information from the primary in a master/slave configuration. A lookup request can then be satisfied by either server and be considered an authoritative response.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec229"></a>Getting ready</h3></div></div></div><p>This recipe requires two CentOS systems with BIND installed and configured as described in earlier recipes. Use the network described by the <span class="emphasis"><em>Configuring BIND as an authoritative DNS server</em></span> recipe. This recipe assumes that the system to serve as the master is configured as <code class="literal">192.168.56.10</code> and the slave is <code class="literal">192.168.56.20</code>. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec230"></a>How to do it...</h3></div></div></div><p>Follow these steps to configure BIND as a secondary authoritative DNS server that receives its zone information from the primary:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>On the system running the slave instance of BIND, open <code class="literal">named.conf</code> and configure the <code class="literal">example.com.</code> zone as follows:</p><pre class="programlisting">
<span class="strong"><strong>zone "example.com." in {</strong></span>
<span class="strong"><strong>       type slave;</strong></span>
<span class="strong"><strong>       file "/var/named/slaves/example.com.fwd";</strong></span>
<span class="strong"><strong>       masters { 192.168.56.10; };</strong></span>
<span class="strong"><strong>       allow-transfer { none; };</strong></span>
<span class="strong"><strong>       notify no;</strong></span>
<span class="strong"><strong>};</strong></span>
</pre></li><li><p>Configure its reverse zone as follows:</p><pre class="programlisting">
<span class="strong"><strong>zone "56.168.192.in-addr.arpa." in {</strong></span>
<span class="strong"><strong>       type slave;</strong></span>
<span class="strong"><strong>       file "/var/named/slaves/example.com.rev";</strong></span>
<span class="strong"><strong>       masters { 192.168.56.10; };</strong></span>
<span class="strong"><strong>       allow-transfer { none; };</strong></span>
<span class="strong"><strong>       notify no;</strong></span>
<span class="strong"><strong>};</strong></span>
</pre></li><li><p>Save your changes and close the file.</p></li><li><p>Restart the slave for the configuration changes to take effect:</p><pre class="programlisting">
<span class="strong"><strong>systemctl restart named.service</strong></span>
</pre></li><li><p>On the system running the master instance of BIND, open <code class="literal">named.conf</code>.</p></li><li><p>Update the <code class="literal">example.com.</code> zone's <code class="literal">allow-transfer</code> entry with the addresses of the slave. The zone's configuration should look like this:</p><pre class="programlisting">
<span class="strong"><strong>zone "example.com." in {</strong></span>
<span class="strong"><strong>       type master;</strong></span>
<span class="strong"><strong>       file "/var/named/zones/example.com.fwd";</strong></span>
<span class="strong"><strong>       allow-transfer { 192.168.56.20; };</strong></span>
<span class="strong"><strong>};</strong></span>
</pre></li><li><p>Make the same change to the reverse zone configuration:</p><pre class="programlisting">
<span class="strong"><strong>zone "56.168.192.in-addr.arpa." in {</strong></span>
<span class="strong"><strong>       type master;</strong></span>
<span class="strong"><strong>       file "/var/named/zones/example.com.rev";</strong></span>
<span class="strong"><strong>       allow-transfer { 192.168.56.20; };</strong></span>
<span class="strong"><strong>};</strong></span>
</pre></li><li><p>Save the changes and close the file.</p></li><li><p>Restart the master for the configuration changes to take effect:</p><pre class="programlisting">
<span class="strong"><strong>systemctl restart named.service</strong></span>
</pre></li><li><p>On the slave, test the configuration using <code class="literal">dig</code> to request a zone transfer:</p><pre class="programlisting">
<span class="strong"><strong>dig @192.168.56.10 example.com. AXFR</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec231"></a>How it works...</h3></div></div></div><p>Slave servers request a zone transfer when notified by the primary authoritative DNS server that the zone's records have changed and when the copy of the zone file maintained by the slave expires according to the <code class="literal">SOA</code> record. In this recipe, we began with two systems running BIND and edited their configurations to allow the transfer. We began on the system targeted as the slave, configuring both the forward and reverse lookup zones we've worked with earlier:</p><pre class="programlisting">
<span class="strong"><strong>zone "example.com." in {</strong></span>
<span class="strong"><strong>    type slave;</strong></span>
<span class="strong"><strong>    file "/var/named/slaves/example.com.fwd";</strong></span>
<span class="strong"><strong>    masters { 192.168.56.10; };</strong></span>
<span class="strong"><strong>    allow-transfer { none; };</strong></span>
<span class="strong"><strong>    notify no;</strong></span>
<span class="strong"><strong>};</strong></span>
<span class="strong"><strong>zone "56.168.192.in-addr.arpa." in {</strong></span>
<span class="strong"><strong>    type slave;</strong></span>
<span class="strong"><strong>    file "/var/named/slaves/example.com.rev";</strong></span>
<span class="strong"><strong>    masters { 192.168.56.10; };</strong></span>
<span class="strong"><strong>    allow-transfer { none; };</strong></span>
<span class="strong"><strong>    notify no;</strong></span>
<span class="strong"><strong>};</strong></span>
</pre><p>The <code class="literal">type slave</code> option instructs this server to act as a secondary server for the zone. Since designating the master and slave is done on a per-zone basis, it's possible for the same instance of BIND to be the master for one zone and a slave for another. The <code class="literal">masters</code> option provides the address of the primary server.</p><p>The <code class="literal">file</code> option provides the location where BIND will write the transferred zone information. Not only is it good for the organization to keep the transferred zones separate from any primary zone files on the system, but it's also good for security. BIND needs write permissions to the directory to save the transferred files, but the primary zone files should be read-only to anyone except the administrator (that is, <code class="literal">root</code>) as a safeguard from any tampering. Our configuration saves them to <code class="literal">/var/named/slaves</code>, which was created when we installed the <code class="literal">bind</code> package and already has the appropriate permissions.</p><p>The <code class="literal">allow-transfers</code> option lists the systems this server is allowed to respond to for zone transfer requests. To protect ourselves from possible abuse, we set the value to none, which disallows transfers from the secondary server. All transfers will be serviced by the primary authoritative DNS server, and even then it will only send them to the slave.</p><p>BIND sends a notification to the secondary authoritative servers listed in a zone's <code class="literal">NS</code> records each time the zone is reloaded. There's no reason for the slave to send a notification to other secondaries (if you configure more than one slave) because they are already notified by the primary, so we turned off this behavior with <code class="literal">notify no</code>.</p><p>However, if you want you can send notifications to other servers along with those listed in the zone file with the <code class="literal">also-notify</code> option. This is useful if you have additional secondary servers which you don't want to make public with <code class="literal">NS</code> records or if you want to notify some other automated process. Simply provide the addresses of the servers you want to notify with <code class="literal">also-notify</code>:</p><pre class="programlisting">
<span class="strong"><strong>also-notify { 192.168.56.200; 192.168.68.200; };</strong></span>
</pre><p>To notify only those servers listed in <code class="literal">also-notify</code> and not the secondary authoritative servers, set <code class="literal">notify</code> to <code class="literal">explicit</code>:</p><pre class="programlisting">
<span class="strong"><strong>also-notify { 192.168.56.200; 192.168.68.200; };</strong></span>
<span class="strong"><strong>notify explicit;</strong></span>
</pre><p>Next, we updated the master's configuration, giving the slave's address with <code class="literal">allow-transfers</code> to permit the master to respond to zone transfer requests from the slave:</p><pre class="programlisting">
<span class="strong"><strong>zone "example.com." in {</strong></span>
<span class="strong"><strong>    type master;</strong></span>
<span class="strong"><strong>    file "/var/named/zones/example.com.fwd";</strong></span>
<span class="strong"><strong>    allow-transfer { 192.168.56.20; };</strong></span>
<span class="strong"><strong>};</strong></span>
</pre><p>After restarting BIND for our changes take effect, we can test the configuration by using <code class="literal">dig</code> to request a zone transfer from the master while on the slave system:</p><pre class="programlisting">
<span class="strong"><strong>dig @192.168.56.10 example.com. AXFR</strong></span>
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note57"></a>Note</h3><p>Remember to increment the serial number in the <code class="literal">SOA</code> record whenever you update a zone configuration. The slave checks the serial before updating its zone information and won't update it if the value hasn't changed.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec232"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on configuring and working with zone transfers:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>BIND 9 Administrator Reference Manual (<a class="ulink" href="http://www.isc.org/downloads/bind/doc/" target="_blank">http://www.isc.org/downloads/bind/doc/</a>)</p></li><li style="list-style-type: disc"><p>DNS for Rocket Scientists (<a class="ulink" href="http://www.zytrax.com/books/dns/" target="_blank">http://www.zytrax.com/books/dns/</a>
)</p></li><li style="list-style-type: disc"><p>Technical requirements for authoritative name servers (<a class="ulink" href="http://www.iana.org/help/nameserver-requirements" target="_blank">http://www.iana.org/help/nameserver-requirements</a>)</p></li><li style="list-style-type: disc"><p>How the AXFR protocol works (<a class="ulink" href="http://cr.yp.to/djbdns/axfr-notes.html" target="_blank">http://cr.yp.to/djbdns/axfr-notes.html</a>)</p></li><li style="list-style-type: disc"><p>A Pattern for DNS Architecture (<a class="ulink" href="http://www.allgoodbits.org/articles/view/5" target="_blank">http://www.allgoodbits.org/articles/view/5</a>
)</p></li><li style="list-style-type: disc"><p>Securing an Internet Name Server (<a class="ulink" href="http://resources.sei.cmu.edu/library/asset-view.cfm?assetid=52493" target="_blank">http://resources.sei.cmu.edu/library/asset-view.cfm?assetid=52493</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch08lvl1sec72"></a>Configuring rndc to control BIND</h2></div></div><hr /></div><p><code class="literal">rndc</code> is the client utility for managing BIND servers. However, before you can use it, both <code class="literal">rndc</code> and BIND need to be configured. This recipe shows you how to configure them and then shows you a few commands for managing the server's cache.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec233"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with BIND installed and configured as described in the previous recipes. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec234"></a>How to do it...</h3></div></div></div><p>Follow these steps to configureÂ <code class="literal">rndc:</code></p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Use the <code class="literal">rndc-confgen</code> utility to generate the necessary key file:</p><pre class="programlisting">
<span class="strong"><strong>rndc-confgen -a -c /etc/rndc.key</strong></span>
</pre></li><li><p>Create the <code class="literal">/etc/rndc.conf</code> file with the following content:</p><pre class="programlisting">       include "/etc/rndc.key";
       options {
           default-key "rndc-key";
           default-server 127.0.0.1;
           default-port 953;
       };
</pre></li><li><p>Ensure the correct ownership and access permissions for <code class="literal">rndc.key</code> and <code class="literal">rndc.conf</code>:</p><pre class="programlisting">
<span class="strong"><strong>chown root.named /etc/rndc*</strong></span>
<span class="strong"><strong>chmod 640 /etc/rndc*</strong></span>
</pre></li><li><p>Open <code class="literal">/etc/named.conf</code> and add the following configuration settings after the closing brace of the <code class="literal">options</code> block:</p><pre class="programlisting">       include "/etc/rndc.key";
       controls {
           inet 127.0.0.1 port 953 allow { 127.0.0.1; } keys {
           "rndc-key"; };
       };
</pre></li><li><p>Restart BIND for the configuration changes to take effect:</p><pre class="programlisting">
<span class="strong"><strong>systemctl restart named.service</strong></span>
</pre></li><li><p>Test the configuration by using <code class="literal">rndc</code> to request BIND's status:</p><pre class="programlisting">
<span class="strong"><strong>rndc status</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec235"></a>How it works...</h3></div></div></div><p>Communication between <code class="literal">rndc</code> and BIND requires a shared key for authorization. So, first we used <code class="literal">rndc-confgen</code> to create one. In a normal operation without arguments, the program generates the key and necessary configuration fragments and dumps everything to the screen. You can cut and paste sections of the output into the appropriate files, but if you only have access with a terminal and keyboard then this could prove difficult. Instead, we ran the program with <code class="literal">-a</code> for it to generate the key's definition and dump it to its own configuration file and we'll type the other configuration pieces manually. The <code class="literal">-c</code> argument simply specifies our desired name for the key definition's file:</p><pre class="programlisting">
<span class="strong"><strong>rndc-confgen -a -c /etc/rndc.key</strong></span>
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note58"></a>Note</h3><p>Some people report that <code class="literal">rndc-confgen</code> appears to crash on their system. If you experience this, the most likely reason is that it's waiting for sufficient data to generate the secret, but the entropy pool for <code class="literal">/dev/random</code> is starved which causes <code class="literal">rndc-confgen</code> to wait. Terminate the process and try again using <code class="literal">-r</code> to specify <code class="literal">/dev/urandom </code>as an alternate source:</p><p>
<span class="strong"><strong><code class="literal">rndc-confgen -a -c /etc/rndc.key -r /dev/urandom</code></strong></span></p></div><p>A quick peek inside <code class="literal">/etc/rndc.key</code> reveals the key's definition as follows:</p><pre class="programlisting">
<span class="strong"><strong>key "rndc-key" {</strong></span>
<span class="strong"><strong>    algorithm hmac-md5;</strong></span>
<span class="strong"><strong>    secret "YBmUKeobRMlAOUjCqMcb6g==";</strong></span>
<span class="strong"><strong>};</strong></span>
</pre><p><code class="literal">rndc</code> uses a configuration file of its own. So, next we created <code class="literal">/etc/rndc.conf</code>:</p><pre class="programlisting">
<span class="strong"><strong>include "/etc/rndc.key";</strong></span>
<span class="strong"><strong>options {</strong></span>
<span class="strong"><strong>    default-key "rndc-key";</strong></span>
<span class="strong"><strong>    default-server 127.0.0.1;</strong></span>
<span class="strong"><strong>    default-port 953;</strong></span>
<span class="strong"><strong>};</strong></span>
</pre><p>We include the key definition from <code class="literal">rndc.key</code> and specify it as the default key for <code class="literal">rndc</code> to use. We also specified the local loopback address as the default server and 953 as the default port. With these configuration options, <code class="literal">rndc</code> attempts to connect to the locally running BIND server without the need for us to provide extra arguments at the command line.</p><p>Last, we BIND to allow and authenticate rndc's connection requests. So, we again include the key definition and add a <code class="literal">controls</code> block in <code class="literal">named.conf</code>:</p><pre class="programlisting">
<span class="strong"><strong>include "/etc/rndc.key";</strong></span>
<span class="strong"><strong>controls {</strong></span>
<span class="strong"><strong>    inet 127.0.0.1 port 953 allow {127.0.0.1;} keys {"rndc-key";};</strong></span>
<span class="strong"><strong>};</strong></span>
</pre><p>The <code class="literal">inet</code> statement specifies which addresses are allowed to connect and the keys they need to authenticate. The first address lists which address BIND will listen on for connection requests. The configuration is intentionally restrictive for the sake of security and only allows us to use <code class="literal">rndc</code> locallyâ€”BIND listens on the local address and services commands sent from the local address.</p><p>If you want to use <code class="literal">rndc</code> for remote administration, I recommend you against opening access and instead use SSH to log into the remote system and it's copy of <code class="literal">rndc</code>. BIND's control channel remains closed to anyone up to no good, you don't need to distribute copies of the key file, and communication between the two systems is encrypted:</p><pre class="programlisting">
<span class="strong"><strong>ssh 192.168.56.10 rndc status</strong></span>
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note59"></a>Note</h3><p>You can save typing by creating an <code class="literal">alias</code>:</p><p>
<span class="strong"><strong><code class="literal">alias rndc-ns1="ssh 192.168.56.10 rndc"</code></strong></span>
<span class="strong"><strong><code class="literal">rndc-ns1 status</code></strong></span>
</p></div><p>When invoked without a subcommand, <code class="literal">rndc</code> displays a usage message enumerating the actions we can perform. The <code class="literal">status</code> command outputs BIND's current status including how many zones are configured, if any zone transfers are in progress, and in the case of a resolving DNS server, how many queries it's currently trying to resolve through recursion:</p><pre class="programlisting">
<span class="strong"><strong>rndc status</strong></span>
</pre><div class="mediaobject"><img src="graphics/image_08_002.jpg" /><div class="caption"><p>rndc is used to manage BIND DNS servers</p></div></div><p>You may find the <code class="literal">flush</code> command useful if you're running a resolving DNS server. It removes all of the cached lookup information from BIND's cache. If you want to clear only the records related to a particular domain, you can use <code class="literal">flushname</code>:</p><pre class="programlisting">
<span class="strong"><strong>rndc flushname google.com</strong></span>
</pre><p>The <code class="literal">reload</code> and <code class="literal">refresh</code> commands are useful with authoritative servers. The <code class="literal">reload</code> command causes BIND to reparse zone files after they've been updated without restarting the server. Unless a specific zone is given, all zones will be reloaded:</p><pre class="programlisting">
<span class="strong"><strong>rndc reload example.com.</strong></span>
</pre><p>In the case of slave DNS servers, we can force BIND to update its copy of a zone file if it's stale using the <code class="literal">refresh</code> command:</p><pre class="programlisting">
<span class="strong"><strong>rndc refresh example.com.</strong></span>
</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl2sec236"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on using <code class="literal">rndc</code>:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">rndc</code>Â manual page (<code class="literal">man 8 rndc</code>)</p></li><li style="list-style-type: disc"><p>RHEL 7 Networking Guide: BIND (<a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Networking_Guide/sec-BIND.html" target="_blank">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Networking_Guide/sec-BIND.html</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="chapter" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="ch09"></a>ChapterÂ 9.Â Managing E-mails</h2></div></div></div><p>This chapter contains the following recipes:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Configuring Postfix to provide SMTP services</p></li><li style="list-style-type: disc"><p>Adding SASL to Postfix with Dovecot</p></li><li style="list-style-type: disc"><p>Configuring Postfix to use TLS</p></li><li style="list-style-type: disc"><p>Configuring Dovecot for secure POP3 and IMAP access</p></li><li style="list-style-type: disc"><p>Targeting spam with SpamAssassin</p></li><li style="list-style-type: disc"><p>Routing messages with Procmail</p></li></ul></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch09lvl1sec73"></a>Introduction</h2></div></div><hr /></div><p>In this chapter, you'll find recipes to help you set up and secure e-mail services for your domain. You'll learn how to set up Postfix to run as an SMTP server and then learn how to configure it to support SASL authentication and TLS encryption. Then we'll configure Dovecot which will provide users access to their e-mail over the POP3 and IMAP protocols. Finally, you'll learn how to set up SpamAssassin and Procmail to reduce the amount of spam that makes it way to your inbox.</p></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch09lvl1sec74"></a>Configuring Postfix to provide SMTP services</h2></div></div><hr /></div><p>This recipe teaches you how to configure Postfix as a basic e-mail server for your domain. E-mail is one of the oldest Internet services and has become one its most pervasive services. Moreover, e-mail can be one of the most difficult services to manage.</p><p>Using the Simple Mail Transport Protocol (SMTP), an e-mail message passes through many processes from its starting point on its way to your inbox. When someone writes you a message, they use an e-mail client to compose the message. The client sends the message to their mail server which looks up the <code class="literal">MX</code> records for your domain and relays the message to your mail server for delivery. Once the message is received by your mail server, it's delivered to your mail directory on the server. At least that's the basic idea. A message can be relayed by any number of intermediate servers between the sender's server and your mail server; servers can be configured to send mail, receive mail, or both. Different protocols are used to retrieve the messages from the server (POP3 and IMAP) than those used to send them, and trying to stay one step ahead of spammers can add a fair amount of complexity.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note60"></a>Note</h3><p>Because of the complexity of the e-mail ecosystem and being a mail server administrator is often more than a full-time job, I can only present to you the basics. Later recipes will teach you how to add authentication and encryption to your setup, there will still be much to explore and learn. I strongly recommend that you take advantage of the additional resources mentioned in the <span class="emphasis"><em>See also</em></span> section after each recipe.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec237"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>. You'll want to have a couple of user accounts available on the system for testing purposes as well.</p><p>Because <code class="literal">MX</code> records are used to resolve the mail server's address during the delivery process, it's assumed that you have either completed the previous chapter's recipes or have, otherwise, configured your own DNS records. The IP address <code class="literal">192.168.56.20</code> is used here in keeping with the example network outlined in the <span class="emphasis"><em>Configuring BIND as an authoritative DNS server</em></span> recipe in <a class="link" href="#" linkend="ch08">Chapter 8</a>, <span class="emphasis"><em>Managing Domains and DNS</em></span>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec238"></a>How to do it...</h3></div></div></div><p>Follow these steps to set up Postfix:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Use a text editor to open Postfix's configuration file <code class="literal">/etc/postfix/main.cf</code>:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/postfix/main.cf</strong></span>
</pre></li><li><p>Find the example <code class="literal">myhostname</code> parameters. Delete the leading <code class="literal">#</code> character to uncomment one of the examples and update its value with your qualified hostname:</p><pre class="programlisting">
<span class="strong"><strong>myhostname = mail.example.com</strong></span>
</pre></li><li><p>Locate the example <code class="literal">mydomain</code> parameter and uncomment and edit it, setting your domain name as its value:</p><pre class="programlisting">
<span class="strong"><strong>       mydomain = example.com
</strong></span>
</pre></li><li><p>Find the <code class="literal">inet_interfaces</code> parameters. Place an <code class="literal">#</code> in front of the <code class="literal">localhost</code> entry to comment it out and then uncomment the <code class="literal">all</code> entry:</p><pre class="programlisting">
<span class="strong"><strong>inet_interfaces = all</strong></span>
<span class="strong"><strong>#inet_interfaces = $myhostname</strong></span>
<span class="strong"><strong>#inet_interfaces = $myhostname, localhost</strong></span>
<span class="strong"><strong>#inet_interfaces = localhost</strong></span>
</pre></li><li><p>Find the <code class="literal">mydestination</code> parameters and comment out the first entry. Uncomment the one that includes <code class="literal">$mydomain</code> in its list:</p><pre class="programlisting">
<span class="strong"><strong>#mydestination = $myhostname, localhost.$mydomain,  localhost</strong></span>
<span class="strong"><strong>mydestination = $myhostname, localhost.$mydomain,  localhost,
       $mydomain</strong></span>
<span class="strong"><strong>#mydestination = $myhostname, localhost.$mydomain,  localhost,</strong></span>
<span class="strong"><strong>#       $mydomain mail.$mydomain, www.$mydomain,  ftp.$mydomain</strong></span>
</pre></li><li><p>Find the example <code class="literal">mynetworks</code> parameters. Uncomment one of the entries and edit it so that the value reflects your network:</p><pre class="programlisting">
<span class="strong"><strong>mynetworks = 192.168.56.0/24, 127.0.0.0/8</strong></span>
</pre></li><li><p>Find the example <code class="literal">home_mailbox</code> parameters and uncomment the entry with the <code class="literal">Maildir/</code> value:</p><pre class="programlisting">
<span class="strong"><strong>home_mailbox = Maildir/</strong></span>
</pre></li><li><p>Save your changes and close the file.</p></li><li><p>Start the Postfix server and optionally enable it to start automatically whenever the system reboots:</p><pre class="programlisting">
<span class="strong"><strong>systemctl start postfix.service</strong></span>
<span class="strong"><strong>systemctl enable postfix.service</strong></span>
</pre></li><li><p>Open port <code class="literal">25</code> in the system's firewall to allow outside connections to Postfix:</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --add-service=smtp</strong></span>
<span class="strong"><strong>firewall-cmd --reload</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec239"></a>How it works...</h3></div></div></div><p>CentOS systems have Postfix installed by default, using it as a local mail transfer agent. To reconfigure it to act as our domain's mail server, we updated several parameters in its configuration file, <code class="literal">/etc/postfix/main.cf</code>.</p><p>First, we updated the <code class="literal">myhostname</code> parameter to provide our system's qualified domain name (the hostname and domain name):</p><pre class="programlisting">
<span class="strong"><strong>myhostname = mail.example.com</strong></span>
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note61"></a>Note</h3><p>Comments in the configuration file refer to a FQDN, but we know better because FQDNs require a trailing dot. If you do provide a true FQDN as the value, Postfix will fail to start stating that the parameter's value is bad.</p></div><p>The <code class="literal">mydomain</code> parameter specifies the domain that this system is a member of and that Postfix is handling e-mail for. Although Postfix will try to determine the domain name based on the system's qualified hostname, it's not a bad idea to explicitly define it with <code class="literal">mydomain</code> to be certain it's correct:</p><pre class="programlisting">
<span class="strong"><strong>mydomain = example.com</strong></span>
</pre><p>The <code class="literal">inet_interface</code> parameter identifies the network interfaces that Postfix will listen on for connections. The original configuration accepts connections only from the localhost; so we updated it to listen on all interfaces, although you may want to specify something more specific if your system is connected to multiple networks:</p><pre class="programlisting">
<span class="strong"><strong>inet_interfaces = all</strong></span>
</pre><p>The <code class="literal">mydestination</code> parameter lists the zones for which Postfix will accept mail for final delivery. We changed the original configuration to include our domain:</p><pre class="programlisting">
<span class="strong"><strong>mydestination = $myhostname, localhost.$mydomain, localhost,  $mydomain</strong></span>
</pre><p>If necessary, you should add other values to the list to identify all of the system's hostnames, similar to what's shown in the last example,Â <code class="literal">mydestination</code>, in the set. This is important to prevent Postfix from trying to relay messages to itself, thinking they're destined for a different domain when they're really not:</p><pre class="programlisting">
<span class="strong"><strong>mydestination = $myhostname, localhost.$mydomain, localhost,
    $mydomain, mail.$mydomain, www.$mydomain, ftp.$mydomain</strong></span>
</pre><p>The <code class="literal">mynetworks</code> parameter identifies the trusted networks Postfix can relay messages for. This is the first line of defense against spammers abusing your mail server because Postfix will refuse to accept messages for delivery if they're not for our domain and if they're received from a system outside one of the trusted networks:</p><pre class="programlisting">
<span class="strong"><strong>mynetworks = 192.168.56.0/24, 127.0.0.0/8</strong></span>
</pre><p>Finally, we set the messages' delivery destination using the <code class="literal">home_mailbox</code> parameter:</p><pre class="programlisting">
<span class="strong"><strong>home_mailbox = Maildir/</strong></span>
</pre><p>Messages are traditionally appended to the user's file in <code class="literal">/var/spool/mail</code> in what is known as the <span class="strong"><strong>mbox</strong></span> format. The Maildir format stores messages individually in a subdirectory in the user's Maildir directory. Postfix delivers mail to the spool by default. We can convert messages between the two formats, but choosing Maildir now makes things a bit easier when we configure user access over IMAP in a later recipe.</p><p>Once Postfix is restarted, we can send a test message to verify that the server's configuration is correct. There are several ways to do this of course. The easiest is to use a command-line e-mail client such as <code class="literal">mailx</code> to send the message. <code class="literal">mailx</code> isn't installed by default but is available via <code class="literal">yum</code>:</p><pre class="programlisting">
<span class="strong"><strong>yum install mailx</strong></span>
</pre><p>Invoke <code class="literal">mailx</code> to send a message. The <code class="literal">-s</code> argument provides the message's subject and <code class="literal">-r</code> provides the sender's address (your own e-mail address). Then the recipient's address follows after the arguments:</p><pre class="programlisting">
<span class="strong"><strong>mailx -r abell@example.com -s "Test email" tboronczyk@example.com</strong></span>
</pre><p><code class="literal">mailx</code> reads the message from <code class="literal">stdin</code>. A simple "hello world" or "this is a test" should be sufficient for testing purposes; when you're done typing, type a period on its own line or press <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>D</em></span>:</p><p>If all goes well, <code class="literal">mailx</code> sends the mail to Postfix for delivery which in turn delivers it to the user's mail directory in <code class="literal">/home/&lt;username&gt;/Maildir/new</code>. Check the directory and output the file's contents to make sure the message was delivered:</p><pre class="programlisting">
<span class="strong"><strong>ls /home/tboronczyk/Maildir/new</strong></span>
<span class="strong"><strong>cat /home/tboronczyk/Maildir/new/146284221.Vfd00I188f5ceM9593.mail</strong></span>
</pre><div class="mediaobject"><img src="graphics/image_09_001.jpg" /><div class="caption"><p>Received messages are delivered to the user's Maildir directory</p></div></div><p>Alternatively, we can connect directly to Postfix using a Telnet client. Typing raw commands to send an e-mail is slightly more involved than sending one using <code class="literal">mailx,</code> but is preferred because it offers you more flexibility and greater visibility into how Postfix responds. This can prove invaluable when trying to troubleshoot a problem.</p><p>No Telnet client is installed by default, so first you'll need to use <code class="literal">yum</code> to install <code class="literal">telnet</code>:</p><pre class="programlisting">
<span class="strong"><strong>yum install telnet</strong></span>
</pre><p>Then use <code class="literal">telnet</code> to connect to the server on port <code class="literal">25</code>, the port reserved for SMTP:</p><pre class="programlisting">
<span class="strong"><strong>telnet mail.example.com 25</strong></span>
</pre><p>The <code class="literal">MAIL FROM</code> command is used to provide the sender's e-mail address and <code class="literal">RCPT TO</code> to provide the recipient's address. After each is entered, Postfix should respond with a <code class="literal">250 Ok</code> status:</p><pre class="programlisting">
<span class="strong"><strong>MAIL FROM: tboronczyk@example.com</strong></span>
<span class="strong"><strong>250 2.1.0 Ok</strong></span>
<span class="strong"><strong>RCPT TO: abell@example.com</strong></span>
<span class="strong"><strong>250 2.1.0 Ok</strong></span>
</pre><p><code class="literal">DATA</code> begins the message's content. Postfix accepts everything we type as the message until we type a single period on its own line:</p><pre class="programlisting">
<span class="strong"><strong>DATA</strong></span>
<span class="strong"><strong>352 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;</strong></span>
<span class="strong"><strong>Subject: Test email</strong></span>
<span class="strong"><strong>Hello world! This is a test.</strong></span>
<span class="strong"><strong>.</strong></span>
<span class="strong"><strong>250 2.0.0 Ok: queued as 705486E22E</strong></span>
</pre><p>Then, to close the connection, type <code class="literal">QUIT</code>:</p><pre class="programlisting">
<span class="strong"><strong>QUIT</strong></span>
<span class="strong"><strong>221 2.0.0 Bye</strong></span>
<span class="strong"><strong>Connection closed by foreign host.</strong></span>
</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec240"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on working with Postfix:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>RHEL 7 System Administrator's Guide: Mail Transport Agents (<a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/s1-email-mta.html" target="_blank">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/s1-email-mta.html</a>)</p></li><li style="list-style-type: disc"><p>RFC-5321: Simple Mail Transport Protocol (<a class="ulink" href="https://tools.ietf.org/html/rfc5321" target="_blank">https://tools.ietf.org/html/rfc5321</a>)</p></li><li style="list-style-type: disc"><p>Mbox vs Maildir: Mail Storage Formats (<a class="ulink" href="http://www.linuxmail.info/mbox-maildir-mail-storage-formats/" target="_blank">http://www.linuxmail.info/mbox-maildir-mail-storage-formats/</a>)</p></li><li style="list-style-type: disc"><p>Setup a Local Mail Server in CentOS 7 (<a class="ulink" href="http://www.unixmen.com/setup-a-local-mail-server-in-centos-7" target="_blank">http://www.unixmen.com/setup-a-local-mail-server-in-centos-7</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch09lvl1sec75"></a>Adding SASL to Postfix with Dovecot</h2></div></div><hr /></div><p>If a mail server relays a message to another domain (that is, the recipient's address is not in our domain) and the message originates from outside our network, the server is known as an open relay. Spammers are constantly on the lookout for open relays because such permissive behavior is easy to take advantage of, and Postfix tries to protect us by default by only relaying messages that come from our network. Unfortunately, it's not practical to restrict legitimate users from sending e-mail through the server only when they're on our network. This recipe teaches you how to add Simple Authentication and Security Layer (SASL) authentication to Postfix's configuration using Dovecot. Postfix will then happily relay messages for our users authenticated users, regardless of their network location, while still refusing to do so for anyone else.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec241"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with Postfix configured as described in the previous recipe. Administrative privileges are also required, either by logging in with the root account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec242"></a>How to do it...</h3></div></div></div><p>Follow these steps to secure Postfix to SASL:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Install the <code class="literal">dovecot</code> package:</p><pre class="programlisting">
<span class="strong"><strong>yum install dovecot</strong></span>
</pre></li><li><p>Open the <code class="literal">/etc/dovecot/conf.d/10-master.conf</code> file with your text editor:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/dovecot/conf.d/10-master.conf</strong></span>
</pre></li><li><p>Locate the <code class="literal">unix_listener</code> section for /<code class="literal">var/spool/postfix/private/auth</code>. Uncomment the section by removing the leading <code class="literal">#</code> characters:</p><pre class="programlisting">
<span class="strong"><strong># Postfix smtp-auth</strong></span>
<span class="strong"><strong>unix_listener /var/spool/postfix/private/auth {</strong></span>
<span class="strong"><strong>     mode = 0666</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></li><li><p>Update <code class="literal">mode</code> to <code class="literal">0660</code> and add the parameters <code class="literal">user</code> and <code class="literal">group</code> to the section with the value <code class="literal">postfix</code>:</p><pre class="programlisting">
<span class="strong"><strong># Postfix smtp-auth</strong></span>
<span class="strong"><strong>unix_listener /var/spool/postfix/private/auth {</strong></span>
<span class="strong"><strong>     mode = 0660</strong></span>
<span class="strong"><strong>     user = postfix</strong></span>
<span class="strong"><strong>     group = postfix</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></li><li><p>Save your changes and close the file.</p></li><li><p>Open the <code class="literal">/etc/dovecot/conf.d/10-auth.conf</code> file with your text editor:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/dovecot/conf.d/10-auth.conf</strong></span>
</pre></li><li><p>Locate the <code class="literal">auth_mechanisms</code> option and add <code class="literal">login</code> to its value:</p><pre class="programlisting">
<span class="strong"><strong>auth_mechanisms = plain login</strong></span>
</pre></li><li><p>Save the changes and close the file.</p></li><li><p>Start the Dovecot server and optionally enable it to start automatically whenever the system reboots:</p><pre class="programlisting">
<span class="strong"><strong>systemctl start dovecot.service</strong></span>
<span class="strong"><strong>systemctl enable dovecot.service</strong></span>
</pre></li><li><p>Open the <code class="literal">/etc/postfix/main.cf</code> file with your text editor:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/postfix/main.cf</strong></span>
</pre></li><li><p>At the end of the configuration file, add the following options and values:</p><pre class="programlisting">
<span class="strong"><strong>smtpd_sasl_auth_enable = yes</strong></span>
<span class="strong"><strong>smtpd_sasl_type = dovecot</strong></span>
<span class="strong"><strong>smtpd_sasl_path = private/auth</strong></span>
<span class="strong"><strong>smtpd_sasl_security_options = noanonymous</strong></span>
</pre></li><li><p>Save the changes and close the file.</p></li><li><p>Restart Postfix:</p><pre class="programlisting">
<span class="strong"><strong>systemctl restart postfix.service</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec243"></a>How it works...</h3></div></div></div><p>Dovecot is a primarily a mail retrieval server offering users access to their e-mail using the POP and IMAP protocols, and it also allows Postfix to hook into its SASL authentication mechanism. We'll need a retrieval server for users to fetch their e-mail from the system, and Dovecot and Postfix integrate nicely, so choosing Dovecot over other options makes sense.</p><p>Dovecot's configuration is organized into various files, each file addressing a particular feature or bit of functionality. For this recipe, we needed to update the master configuration file <code class="literal">/etc/dovecot/conf.d/10-master.conf</code> and the authentication configuration file <code class="literal">/etc/dovecot/conf.d/10-auth.conf</code>.</p><p>In <code class="literal">10-master.conf</code>, we located the <code class="literal">unix_listener</code> parameter that defines the SMTP authentication service that will be shared with Postfix. Uncommenting it will create the socket file <code class="literal">/var/spool/postfix/private/auth</code> over which Dovecot and Postfix will communicate. We then updated the <code class="literal">mode</code> parameter and added the <code class="literal">user</code> and <code class="literal">group</code> parameters to secure the socket's ownership and access permissions:</p><pre class="programlisting">
<span class="strong"><strong>unix_listener /var/spool/postfix/private/auth {</strong></span>
<span class="strong"><strong>  mode = 0660</strong></span>
<span class="strong"><strong>  user = postfix</strong></span>
<span class="strong"><strong>  group = postfix</strong></span>
<span class="strong"><strong>}</strong></span>
</pre><p>In <code class="literal">10-auth.conf</code>, we located the <code class="literal">auth_mechanism</code> parameter and added <code class="literal">login</code> to its value. This parameter sets the list of mechanisms Dovecot uses, and <code class="literal">login</code> is the mechanism used specifically for SMTP authentication:</p><pre class="programlisting">
<span class="strong"><strong>auth_mechanisms = plain login</strong></span>
</pre><p><code class="literal">plain</code> allows users to provide their username and password in plain text. <code class="literal">login</code> is also considered a plain text mechanism, but don't worry; you'll learn how to secure that in the next recipe.</p><p>The final bit of configuration involves adding the necessary SASL-related parameters to Postfix's <code class="literal">main.cf</code> file:</p><pre class="programlisting">
<span class="strong"><strong>smtpd_sasl_auth_enable = yes</strong></span>
<span class="strong"><strong>smtpd_sasl_type = dovecot</strong></span>
<span class="strong"><strong>smtpd_sasl_path = private/auth</strong></span>
<span class="strong"><strong>smtpd_sasl_security_options = noanonymous</strong></span>
</pre><p><code class="literal">smtpd_sasl_auth_enable</code> enables SASL authentication and <code class="literal">smtpd_sasl_type</code> informs Postfix that it will be using Dovecot's authentication service. The <code class="literal">smtpd_sasl_path</code> parameter specifies the path to the socket file that is used to communicate with Dovecot relative to Postfix's working directory. <code class="literal">smtpd_sasl_security_options</code> prohibits anonymous connections and requires everyone to be authenticated.</p><p>Postfix expects the username and password to be Base64 encoded so that we need to encode them before we can test our configuration with Telnet. <code class="literal">base64</code> can be used, but be careful not to introduce a trailing newline when you provide the original values. After invoking <code class="literal">base64</code>, you can enter your username or password on <code class="literal">stdin</code> and immediately press <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>D</em></span> twice, but do not press <span class="emphasis"><em>Enter</em></span>. You may want to redirect base64's output to a separate file you can dump later to more readily distinguish the encoded value from the original, since they'll appear to run together in the terminal without the newline:</p><pre class="programlisting">
<span class="strong"><strong>base64 &gt; ./username</strong></span>
<span class="strong"><strong>tboronczyk</strong></span>
<span class="strong"><strong>base64 &gt; ./password</strong></span>
<span class="strong"><strong>P@$$W0rd</strong></span>
<span class="strong"><strong>cat ./username ./password</strong></span>
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note62"></a>Note</h3><p>Despite the hassle of "newline vigilance", this approach is better than piping the value as follows:</p><p><span class="strong"><strong><code class="literal">echo -n tboronczyk | base64</code></strong></span></p><p>The command's invocation will be retained in your shell's history. While this is fine for usernames, sensitive data such as passwords should never be provided on the command line as part of a command for this very reason.</p></div><p>After connecting to the server with <code class="literal">telnet</code> on port <code class="literal">25</code>, send the <code class="literal">AUTH LOGIN</code> command to initiate the authentication. Postfix should respond with <code class="literal">VXNlcm5hbWU6</code> which is the Base64 encoded value for <code class="literal">Username:</code>:</p><pre class="programlisting">
<span class="strong"><strong>AUTH LOGIN</strong></span>
<span class="strong"><strong>334 VXNlcm5hbWU6</strong></span>
</pre><p>Provide your encoded username and press <span class="emphasis"><em>Enter</em></span>. Postfix then responds with <code class="literal">UGFzc3dvcmQ6</code>, which, as you probably have already guessed, is the encoded version of <code class="literal">Password:</code>. After you provide the encoded password, you'll be informed if the authentication was successful:</p><div class="mediaobject"><img src="graphics/image_09_002.jpg" /><div class="caption"><p>The authentication exchange expects credentials to be Base64 encoded</p></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec244"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on Postfix, Dovecot, and SASL:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The Dovecot Homepage (<a class="ulink" href="http://www.dovecot.org/" target="_blank">http://www.dovecot.org/</a>
)</p></li><li style="list-style-type: disc"><p>RFC 4422: Simple Authentication and Security Layer (<a class="ulink" href="https://tools.ietf.org/html/rfc4422" target="_blank">https://tools.ietf.org/html/rfc4422</a>)</p></li><li style="list-style-type: disc"><p>Postfix SASL How-To (<a class="ulink" href="http://www.postfix.org/SASL_README.html" target="_blank">http://www.postfix.org/SASL_README.html</a>)</p></li><li style="list-style-type: disc"><p>25, 465, 587... What Port Should I Use? (<a class="ulink" href="http://blog.mailgun.com/25-465-587-what-port-should-i-use/" target="_blank">http://blog.mailgun.com/25-465-587-what-port-should-i-use/</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch09lvl1sec76"></a>Configuring Postfix to use TLS</h2></div></div><hr /></div><p>Implementing authentication for mail relaying is an important step in securing your mail server. But as you learned in the previous recipe, the user's name and password are sent in clear text. Base64-encoding encodes binary data using only ASCII characters, which allows for non-ASCII characters in a user's password for example, but encoding isn't encryption. If traffic between the user's mail client and the server happens over an untrusted network, a malicious user can easily capture the credentials and masquerade as the user. This recipe further secures Postfix by configuring Transport Layer Security (TLS) encryption to protect the communication from eavesdropping.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec245"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with Postfix configured as described in previous recipes. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec246"></a>How to do it...</h3></div></div></div><p>Follow these steps to configure Postfix to use TLS:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Generate a new key file and security certificate with <code class="literal">openssl</code>:</p><pre class="programlisting">
<span class="strong"><strong>openssl req -newkey rsa:2048 -nodes \</strong></span>
<span class="strong"><strong>     -keyout /etc/pki/tls/private/mail.example.key \</strong></span>
<span class="strong"><strong>     -x509 -days 730 -subj "/CN=mail.example.com" -text \</strong></span>
<span class="strong"><strong>     -out /etc/pki/tls/certs/mail.example.pem</strong></span>
</pre></li><li><p>Use your text editor to open the <code class="literal">/etc/postfix/main.cf</code> file:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/postfix/main.cf</strong></span>
</pre></li><li><p>At the end of the file, add the following options and values:</p><pre class="programlisting">
<span class="strong"><strong>smtpd_tls_security_level = may</strong></span>
<span class="strong"><strong>smtpd_tls_cert_file = /etc/pki/tls/certs/mail.example.pem</strong></span>
<span class="strong"><strong>smtpd_tls_key_file = /etc/pki/tls/private/mail.example.key</strong></span>
</pre></li><li><p>Save your changes and close the file.</p></li><li><p>Restart Postfix:</p><pre class="programlisting">
<span class="strong"><strong>systemctl restart postfix.service</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec247"></a>How it works...</h3></div></div></div><p>An encryption key and a security certificate that confirms the ownership of the key are needed for SSL/TLS communications. A self-signed certificate is sufficient for personal use or for use with services on a private network, so this recipe shows us how to generate this ourselves using <code class="literal">openssl</code>:</p><pre class="programlisting">
<span class="strong"><strong>openssl req -newkey rsa:2048 -nodes \
  -keyout /etc/pki/tls/private/mail.example.key \
  -x509 -days 730 -subj "/CN=mail.example.com" -text \
  -out /etc/pki/tls/certs/mail.example.pem</strong></span>
</pre><p>The <code class="literal">req</code> option makes a new certificate request and <code class="literal">-newkey</code> asks <code class="literal">openssl</code> to generate a new private key and to use that key when it signs the certificate (this is what we mean when we say self-signed certificate). <code class="literal">rsa:2048</code> says the key will be a 2,048-bit RSA key. 2,048-bit keys are generally considered sufficiently resistant against attacks until around the year 2030 based on estimates of the rate at which computing power increases. 3,072-bit keys are considered suitable beyond that. <code class="literal">-nodes</code> prevents the key file from being encrypted with a passphrase. It's important not to encrypt the key file with a passphrase because Postfix needs to access the key. If it were encrypted, we'd need to provide the passphrase to decrypt the key every time we start Postfix.</p><p><code class="literal">-x509</code> specifies that the certificate will be an X.509 certificate (the type used by SSL and TLS connections) and <code class="literal">-days</code> sets the certificate's expiration date to a number of days in the future, in this case 730 days (3 years). <code class="literal">-subj</code> is used to specify the value for the certificate's <code class="literal">CN</code> (common name) field, which should be the hostname or the IP address of the system the certificate identifies. Alternatively, you can omit the argument and <code class="literal">openssl</code> will prompt you interactively for values for a number of other fields as well. Finally, the <code class="literal">-text</code> argument specifies that the certificate should be encoded as text as this is the format Postfix expects:</p><div class="mediaobject"><img src="graphics/image_09_003.jpg" /><div class="caption"><p>More identifying information can be embedded within a certificate</p></div></div><p>A self-signed certificate basically says, <span class="emphasis"><em>here's my encryption key. You know it's mine because I said so.</em></span> If your system's services are intended for public consumption, you'll most likely need to invest in a certificate signed by a trusted Certificate Authority (CA). Trusted certificates say, <span class="emphasis"><em>you can trust the key is mine because a mutual friend will vouch for me</em></span>. To obtain a trusted certificate, you need a certificate signing request (CSR):</p><pre class="programlisting">
<span class="strong"><strong>openssl req -new -newkey rsa:2048 -nodes \</strong></span>
<span class="strong"><strong>  -keyout mail.example.key -out mail.example.csr</strong></span>
</pre><p>Then, you send your money and the CSR to the CA. After a short wait, you'll receive your certificate.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note63"></a>Note</h3><p>By depending on the CA and the specifics of the request, trusted certificates can become quite expensive. And trust isn't what it used to be either. A scandal erupted when it was uncovered that employees at a prominent CA were signing forged certificates, reportedly for internal testing purposes. One can only wonder at the lack of oversight given to the Web of trust. Hopefully, the worst is behind us. Browser vendors are starting to push for stricter guidelines and more auditing. There are also projects such as <span class="emphasis"><em>Let's Encrypt</em></span> which enable secure trusted certificates to be automatically generated for free.</p></div><p>Next, we added the necessary configuration parameters to Postfix's <code class="literal">main.cf</code> file:</p><pre class="programlisting">
<span class="strong"><strong>    smtpd_tls_security_level = may
    smtpd_tls_cert_file = /etc/pki/tls/certs/mail.example.pem
    smtpd_tls_key_file = /etc/pki/tls/private/mail.example.key
</strong></span>
</pre><p><code class="literal">smtp_tls_security_level</code> configures Postfix's enforcing behavior in relation to the encrypted connection. <code class="literal">may</code> enables opportunistic TLSâ€”the server advertises that encryption and clients can take advantage of it but its use is not required. You may also set the parameter to <code class="literal">encrypt</code> to make the use of encryption mandatory.</p><p><code class="literal">smtpd_tls_cert_file</code> and <code class="literal">smtpd_tls_key_file</code> specify the paths to the self-signed certificate and the encryption key we generated earlier, respectively. If you're using trusted certificates then you'll also need to provide the <code class="literal">smtpd_tls_CAfile</code> parameter with a value that identifies the signing CA's public certificate.</p><p>If you find that negotiating the secure connection is slow, there are a few tuning parameters you can try. For example, we can explicitly specify the source of entropy that Postfix is using with <code class="literal">tls_random_source</code>:</p><pre class="programlisting">
<span class="strong"><strong>    tls_random_source = dev:/dev/urandom
</strong></span>
</pre><p>Also, we can cache details of the encrypted session between the server and mail client. The <code class="literal">smtpd_tls_session_cache_database</code> parameter defines the file in which Postfix will store the cached details and <code class="literal">smtpd_tls_session_cache_timeout</code> specifies how long the session can be cached. This reduces the overhead of establishing a new session each time the client connects:</p><pre class="programlisting">
<span class="strong"><strong>    smtpd_tls_session_cache_database =
      btree:/var/lib/postfix/smtpd_tls_cache
    smtpd_tls_session_cache_timeout = 3600s
</strong></span>
</pre><p>To test the configuration, you can connect using telnet and issue the <code class="literal">STARTTLS</code> command. Postfix should respond that it's ready to start negotiating the secure connection:</p><pre class="programlisting">
<span class="strong"><strong>STARTTLS</strong></span>
<span class="strong"><strong>220 Ready to start TLS</strong></span>
</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec248"></a>See also</h3></div></div></div><p>Refer to the following resources for working with Postfix and TLS:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Postfix TLS Support (<a class="ulink" href="http://www.postfix.org/TLS_README.html" target="_blank">http://www.postfix.org/TLS_README.html</a>)</p></li><li style="list-style-type: disc"><p>Wikipedia: Public Key Infrastructure (<a class="ulink" href="https://en.wikipedia.org/wiki/Public_key_infrastructure" target="_blank">https://en.wikipedia.org/wiki/Public_key_infrastructure</a>)</p></li><li style="list-style-type: disc"><p>OpenSSL Essentials: Working with SSL Certificates, Private Keys, and CSRs (<a class="ulink" href="https://www.digitalocean.com/community/tutorials/openssl-essentials-working-with-ssl-certificates-private-keys-and-csrs" target="_blank">https://www.digitalocean.com/community/tutorials/openssl-essentials-working-with-ssl-certificates-private-keys-and-csrs</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch09lvl1sec77"></a>Configuring Dovecot for secure POP3 and IMAP access</h2></div></div><hr /></div><p>When you check your e-mail, the e-mail program connects to your mail server to see if there are any new messages in your mail directory. If its configured to used the Post Office Protocol (POP3), it downloads the messages locally and deletes them from the server. If it's configured to use Internet Message Access Protocol (IMAP), the mail remains on the server and you manage it remotely.</p><p>Dovecot handles both protocols out of the box. Since we've already installed Dovecot for its SASL functionality, we could just open the standard ports for POP3 and IMAP traffic in the system's firewall and be done. However, the connections would be unencrypted and information would be transmitted across the network in plain text. This recipe teaches you how to secure these connections with SSL.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec249"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with Postfix and Dovecot configured as described in previous recipes. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec250"></a>How to do it...</h3></div></div></div><p>Follow these steps to configure access to Dovecot:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Open <code class="literal">/etc/dovecot/dovecot.conf</code> with your text editor:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/dovecot/dovecot.conf</strong></span>
</pre></li><li><p>Locate the <code class="literal">protocols</code> parameter. Remove the leading <code class="literal">#</code> character and set its value to <code class="literal">imaps pop3s</code>:</p><pre class="programlisting">
<span class="strong"><strong>protocols = imaps pop3s</strong></span>
</pre></li><li><p>Save the changes and close the file.</p></li><li><p>Open <code class="literal">/etc/dovecot/conf.d/10-ssl.conf</code> with your text editor:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/dovecot/conf.d/10-ssl.conf</strong></span>
</pre></li><li><p>Locate the <code class="literal">ssl</code> parameter and set its value to <code class="literal">yes</code>:</p><pre class="programlisting">
<span class="strong"><strong>       ssl = yes</strong></span>
</pre></li><li><p>Locate the <code class="literal">ssl_cert</code> and <code class="literal">ssl_key</code> parameters. Update their values with the paths to your certificate and key files (note that both paths are preceded with <code class="literal">&lt;</code>):</p><pre class="programlisting">
<span class="strong"><strong>ssl_cert = &lt;/etc/pki/tls/certs/mail.example.pem</strong></span>
<span class="strong"><strong>ssl_key = &lt;/etc/pki/tls/private/mail.example.key</strong></span>
</pre></li><li><p>Save the changes and close the file.</p></li><li><p>Restart Dovecot for the changes to take effect:</p><pre class="programlisting">
<span class="strong"><strong>systemctl restart dovecot.service</strong></span>
</pre></li><li><p>Open port <code class="literal">993</code> for IMAP over SSL and port <code class="literal">995</code> for POP3 over SSL in the firewall:</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --permanent --add-service=imaps \</strong></span>
<span class="strong"><strong>     --add-service=pop3s</strong></span>
<span class="strong"><strong>firewall-cmd --reload</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec251"></a>How it works...</h3></div></div></div><p>Dovecot makes it easy to secure the traffic for POP3 and IMAP connections; in fact, configuring it only took a few seconds. We first edited the <code class="literal">protocols</code> parameter <code class="literal">/etc/dovecot/dovecot.conf</code> to let Dovecot know that we want these protocols to be secured:</p><pre class="programlisting">
<span class="strong"><strong>protocols = imaps pop3s</strong></span>
</pre><p>Then we updated <code class="literal">/etc/dovecot/conf.d/10-ssl.conf</code> to enable SSL to use the <code class="literal">ssl</code> parameter and to identify a certificate and encryption key using <code class="literal">ssl_cert</code> and <code class="literal">ssl_key</code>. Since Postfix and Dovecot are running on the same system and we already generated a key and certificate for Postfix, we can reference the same files in Dovecot's configuration. Dovecot uses the leading <code class="literal">&lt;</code> in front of the paths to specify that it should use the file's content for the parameter's value and not the literal string itself:</p><pre class="programlisting">
<span class="strong"><strong>ssl = yes</strong></span>
<span class="strong"><strong>ssl_cert = &lt;/etc/pki/tls/certs/mail.example.pem</strong></span>
<span class="strong"><strong>ssl_key = &lt;/etc/pki/tls/private/mail.example.key</strong></span>
</pre><p>Dovecot will still allow non-SSL access to POP and IMAP (on ports <code class="literal">110</code> and <code class="literal">143</code>, respectively) from connections originating from the localhost, but once we restart it for the configuration changes to take effect, all other users will need to use SSL to access their messages.</p><p>We can use <code class="literal">mailx</code> to test the configuration. First, we'll check POP3:</p><pre class="programlisting">
<span class="strong"><strong>mailx -f pop3s://tboronczyk@mail.example.com</strong></span>
</pre><p>The <code class="literal">-f</code> argument specifies the directory that <code class="literal">mailx</code> will read from to retrieve our messages. Given as a URI, the value instructs <code class="literal">mailx</code> to read the default directory for our user on the <code class="literal">mail.example.com</code> system using POP3 over SSL (<code class="literal">pop3s</code>).</p><p>The command is the same to check IMAP apart from changing the URI's protocol:</p><pre class="programlisting">
<span class="strong"><strong>mailx -f imaps://tboronczyk@mail.example.com</strong></span>
</pre><p>Because we're using a self-signed certificate, <code class="literal">mailx</code> will complain that the certificate has not been marked as trusted by the user and prompt us whether we want to continue. Respond with <code class="literal">y </code>to this and you'll then be prompted for the user's password. <code class="literal">mailx</code> then displays the user's inbox. Exit the program by entering <code class="literal">quit</code> at the prompt:</p><div class="mediaobject"><img src="graphics/image_09_004.jpg" /><div class="caption"><p>mailx can be used to test our configuration of POP3 and IMAP over SSL</p></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note64"></a>Note</h3><p>If <code class="literal">mailx</code> complains that it's missing the <code class="literal">nss-config-dir</code> variable, you can define it on the command line using <code class="literal">-S</code>. The value should be a path to the certificate databases that <code class="literal">mailx</code> can use to verify certificate trust:</p><pre class="programlisting"><span class="strong"><strong>mailx -S nss-config-dir=/etc/pki/nssdb \</strong></span>
<span class="strong"><strong>Â  Â -f pop3s://tboronczyk@mail.example.com</strong></span></pre></div><p>When we first configured Postfix, we adjusted its <code class="literal">home_mailbox</code> parameter to store messages in separate directories. I acknowledged this was optional at that time but it would make things easier and cleaner when we set up retrieval access. If you didn't set <code class="literal">home_mailbox</code> at that time, incoming messages are appended to the user's mail spool file under <code class="literal">/var/spool/mail</code> and some additional configuration is necessary for Dovecot to access them. These changes can be made in <code class="literal">/etc/dovecot/conf.d/10-mail.conf</code>.</p><p>Alternatively, you can convert the spool file to separate messages in a <code class="literal">Maildir</code> directory at this time. First, install the <code class="literal">mb2md</code> package:</p><pre class="programlisting">
<span class="strong"><strong>yum install ftp://ftp.pbone.net/mirror/atrpms.net/el7-
    x86_64/atrpms/stable/mb2md-3.20-2.at.noarch.rpm</strong></span>
</pre><p>Open the <code class="literal">/etc/postfix/main.cf</code> file and locate the <code class="literal">home_mailbox</code> parameter. Remove the leading <code class="literal">#</code> character from the entry with the value <code class="literal">Maildir/</code>:</p><pre class="programlisting">
<span class="strong"><strong>home_mailbox = Maildir/</strong></span>
</pre><p>Save your changes and then restart Postfix for the update to take effect. Then, for each account, invoke <code class="literal">mb2md</code> to convert the spool file. The utility needs to be run as the target user, so use <code class="literal">su</code> to temporarily switch to that user's context:</p><pre class="programlisting">
<span class="strong"><strong>su -l -c "mb2md -m" tboronczyk</strong></span>
</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec252"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on the different topics discussed in this recipe, including Dovecot, POP3, and IMAP.</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The<code class="literal"> mailx</code>Â manual page (<code class="literal">man 1 mailx</code>)</p></li><li style="list-style-type: disc"><p>The Dovecot Homepage (<a class="ulink" href="http://www.dovecot.org/" target="_blank">http://www.dovecot.org/</a>)</p></li><li style="list-style-type: disc"><p>RFC 3501: Internet Message Access Protocol (<a class="ulink" href="https://tools.ietf.org/html/rfc3501" target="_blank">https://tools.ietf.org/html/rfc3501</a>)</p></li><li style="list-style-type: disc"><p>RFC 1939: Post Office Protocol (<a class="ulink" href="https://tools.ietf.org/html/rfc1939" target="_blank">https://tools.ietf.org/html/rfc1939</a>)</p></li><li style="list-style-type: disc"><p>Converting Mbox Mailboxes to Maildir format (<a class="ulink" href="http://batleth.sapienti-sat.org/projects/mb2md/" target="_blank">http://batleth.sapienti-sat.org/projects/mb2md/</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch09lvl1sec78"></a>Targeting spam with SpamAssassin</h2></div></div><hr /></div><p>Some estimates propose that over 90% of all e-mail is unsolicited advertisements (spam)! Regardless of whether these estimates are correct or not, there's no denying that spam is a huge problem. Unwanted messages cause extra load on mail servers, consume storage space, and can even be a security risk. Also, while there have been many attempts to legally manage spam, such attempts have largely failed.</p><p>This recipe teaches you how to set up SpamAssassin to identify spam messages. SpamAssassin filters incoming messages by checking for various spam hallmarks, such as missing headers and invalid return addresses, and uses heuristics to analyze the message content. Each check contributes to the message's overall spam score, and if this score exceeds the defined threshold then the message is labeled spam.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec253"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with Postfix configured as described in the previous recipe. Administrative privileges are also required, either by logging in with the root account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec254"></a>How to do it...</h3></div></div></div><p>Follow these steps to identify spam using SpamAssassin:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Install the <code class="literal">spamassassin</code> package:</p><pre class="programlisting">
<span class="strong"><strong>yum install spamassassin</strong></span>
</pre></li><li><p>Start SpamAssassin and optionally enable it to start automatically whenever the system reboots:</p><pre class="programlisting">
<span class="strong"><strong>systemctl start spamassassin.service</strong></span>
<span class="strong"><strong>systemctl enable spamassassin.service</strong></span>
</pre></li><li><p>Create SpamAssassin's Bayesian classifier database:</p><pre class="programlisting">
<span class="strong"><strong>sa-learn --sync</strong></span>
</pre></li><li><p>Create an unprivileged system user account that Postfix can use to communicate with SpamAssassin:</p><pre class="programlisting">
<span class="strong"><strong>useradd -r -s /sbin/nologin spamd</strong></span>
</pre></li><li><p>Open Postfix's <code class="literal">master.cf</code> file for editing:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/postfix/master.cf</strong></span>
</pre></li><li><p>Locate the line that defines the <code class="literal">smtp</code> service and append the <code class="literal">-o</code> argument specifying <code class="literal">spamassassin</code> as a content filter:</p><pre class="programlisting">
<span class="strong"><strong>smtp inet n - n - - smtpd -o content_filter=spamassassin</strong></span>
</pre></li><li><p>At the end of the configuration file, add the definition for the <code class="literal">spamassassin</code> filter:</p><pre class="programlisting">
<span class="strong"><strong>spamassassin unix - n n - - pipe user=spamd  argv=/usr/bin/spamc -e
       /usr/sbin/sendmail -oi -f ${sender}  ${recipient}</strong></span>
</pre></li><li><p>Save your changes and close the file.</p></li><li><p>Restart Postfix for the updates to the configuration to take effect:</p><pre class="programlisting">
<span class="strong"><strong>systemctl restart postfix.service</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec255"></a>How it works...</h3></div></div></div><p>The initial installation of SpamAssassin is pretty straightforward. We installed the <code class="literal">spamassassin</code> package and started and enabled the <code class="literal">spamassassin</code> service which runs the <code class="literal">spamd</code> daemon. The client program <code class="literal">spamc</code> is used to communicate with the daemon, and the rest of the recipe's steps focused on configuring Postfix to use <code class="literal">spamc</code> to score the e-mail message.</p><p>We created a new user account named <code class="literal">spamd</code> for Postfix to use when it invokes <code class="literal">spamc</code>. The account is intended to be a noninteractive system account, so we provided the <code class="literal">-r</code> argument. This causes no <code class="literal">home</code> directory to be created and the account's user ID to be assigned a value less than 100. The <code class="literal">-s</code> argument gives <code class="literal">/sbin/nologin</code> as the account's shell to prevent someone from logging in using the account:</p><pre class="programlisting">
<span class="strong"><strong>useradd -r -s /sbin/nologin spamd</strong></span>
</pre><p>For Postfix to pass messages to SpamAssassin, we need to define a new <code class="literal">spamassassin</code> service in its <code class="literal">master.cf</code> configuration file and ask Postfix to use the service as a content filter. The organization of <code class="literal">master.cf</code> is much different from the configuration files we've seen beforeâ€”each line defines a process in the mail delivery pipeline and certain properties about it.</p><p>The first active entry in the file is for the <code class="literal">smtp</code> service and looks like this:</p><pre class="programlisting">
<span class="strong"><strong>smtp inet n - n - - smtpd</strong></span>
</pre><p>The first column is the name of the service and the second column specifies how the service will communicate. For example, <code class="literal">inet</code> signifies that the process uses a TCP/IP socket while <code class="literal">unix</code> signifies that it uses a local unix-domain socket. The next three columns indicate whether the process is private (only accessible to Postfix), runs without administrative privileges, and is chrooted. Their values can be <code class="literal">y</code> for yes, <code class="literal">n</code> for no, or <code class="literal">-</code> for Postfix's default value. The remaining columns provide a wakeup timer for processes that run at time intervals, the limit for the number of instances that can be running at the same time, and the command that's invoked to provide the service.</p><p>To set our <code class="literal">spamassassin</code> service as a filter, we updated the <code class="literal">smtp</code> service's command with the <code class="literal">-o</code> option to set the <code class="literal">content_filter</code> parameter with the name of our service:</p><pre class="programlisting">
<span class="strong"><strong>smtp inet n - n - - smtpd -o content_filter=spamassassin</strong></span>
</pre><p>Then we defined the <code class="literal">spamassassin</code> service at the bottom of the file:</p><pre class="programlisting">
<span class="strong"><strong>spamassassin unix - n n - - pipe user=spamd argv=/usr/bin/spamc -e
/usr/sbin/sendmail -oi -f ${sender} ${recipient}</strong></span>
</pre><p>The <code class="literal">pipe</code> command is part of Postfix's delivery system with the purpose of piping messages to external processes. The <code class="literal">user</code> argument specifies the name of the user account the invoked process will run under and <code class="literal">argv</code> is the command and its arguments that will be run. Our definition references the <code class="literal">spamd</code> user we created earlier and pipes the message to the <code class="literal">spamc</code> client.</p><p>After the message is reviewed by <code class="literal">spamd</code>, <code class="literal">spamc</code> returns the message to stdout by default. To avoid losing the message, we pipe the output to another process to deliver the message. <code class="literal">-e</code> instructs <code class="literal">spamc</code> to pipe the output for handling, in this case to a program named <code class="literal">sendmail</code>.</p><p>Sendmail is another mail server that's quite older than Postfix. It dominated the e-mail landscape for decades, and as such many programs attempt to interface with it to send mail. This instance of <code class="literal">sendmail</code> is actually Postfix's Sendmail compatibility interface which allows other processes to think they're calling Sendmail when in fact they're really working with Postfix. The <code class="literal">-oi</code> argument for <code class="literal">sendmail</code> instructs the mail server to treat lines with a single dot as regular input and not interpret it as the end of the message. The <code class="literal">-f</code> argument sets the from address of the message to the value of <code class="literal">${sender}</code>, a special variable populated by Postfix with the sender's e-mail address, and the message is sent to <code class="literal">${recipient}</code>, the recipient's e-mail address.</p><p>To test the configuration, we can send an e-mail message with the following subjectâ€”it's a known value that SpamAssassin always marks as spam:</p><pre class="programlisting">
<span class="strong"><strong>XJS*C4JDBQADN1.NSBN3*2IDNEN*GTUBE-STANDARD-ANTI-UBE-TEST- EMAIL*C.34X</strong></span>
</pre><div class="mediaobject"><img src="graphics/image_09_005.jpg" /><div class="caption"><p>An e-mail is sent with a known signature in the subject line to test SpamAssassin</p></div></div><p>When you check the message in your inbox, you'll notice that SpamAssassin will have prepended <code class="literal">[SPAM]</code> to the subject line, allowing you to easily identify unwanted messages. It also adds additional headers to the message that summarizes its findings that lead it to the conclusion that the message is spam:</p><div class="mediaobject"><img src="graphics/image_09_006.jpg" /><div class="caption"><p>SpamAssassin updates a message's subject line and adds additional headers to explain why it thinks the message is spam</p></div></div><p>Keep in mind that the world of spam is constantly in flux; programmers are working hard to build better spam filters, but spammers are working just as hard to find ways to circumvent them. For this reason, it's important to keep SpamAssassin's database up to date. A cron job is added when SpamAssassin is installed that will update its database daily, but you can also run an update manually any time you like by running:</p><pre class="programlisting">
<span class="strong"><strong>sa-update</strong></span>
</pre><p>If SpamAssassin is falsely identifying a large amount of legitimate messages as spam or vice versa, you can train it's Bayesian classifier to better identify unwanted messages using <code class="literal">sa-learn</code>. We can provide a collection of messages we know are spam and identify them as such with the <code class="literal">--spam</code> argument, and good messages with <code class="literal">--ham</code> for the program to study:</p><pre class="programlisting">
<span class="strong"><strong>sa-learn --ham /home/tboronczyk/Maildir/cur</strong></span>
<span class="strong"><strong>sa-learn --spam /home/tboronczyk/Mail/.Spam</strong></span>
</pre><p><code class="literal">sa-learn</code> keeps track of the messages it's seen. If you have previously indicated that a message is spam and then later use it as ham, the program will remove it from its spam database, and vice versa if you indicate an e-mail is good but later decide it should be used as spam.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec256"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on working with SpamAssassin:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">sa-learn</code>Â manual page (<code class="literal">man 1 sa-learn</code>)</p></li><li style="list-style-type: disc"><p>SpamAssassin Home Page (<a class="ulink" href="http://spamassassin.apache.org/" target="_blank">http://spamassassin.apache.org/</a>)</p></li><li style="list-style-type: disc"><p>Rum SpamAssassin with Postfix (<a class="ulink" href="http://howto.gumph.org/content/run-spamassassin-with-postfix/" target="_blank">http://howto.gumph.org/content/run-spamassassin-with-postfix/</a>)</p></li><li style="list-style-type: disc"><p>Stop Spam on your Postfix Server with SpamAssassin (<a class="ulink" href="https://www.linux.com/learn/stop-spam-your-postfix-server-spamassassin" target="_blank">https://www.linux.com/learn/stop-spam-your-postfix-server-spamassassin</a>)</p></li><li style="list-style-type: disc"><p>Bayes Theorem Explained Like You're Five (<a class="ulink" href="https://www.youtube.com/watch?v=2Df1sDAyRvQ" target="_blank">https://www.youtube.com/watch?v=2Df1sDAyRvQ</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch09lvl1sec79"></a>Routing messages with Procmail</h2></div></div><hr /></div><p>Depending on your preferences, tagging messages as spam may not be enough. Maybe you'll want to set up a rule in your e-mail client that moves any unwanted messages from your inbox to a dedicated spam directory. Or maybe you want such routing to happen automatically on the server. We can configure this using Procmail, a mail filtering and delivery agent.</p><p>In this recipe, we'll look at how to configure Procmail to route messages. We'll scan incoming mail, looking for a special header that SpamAssassin adds to messages if it thinks they're spam and then deliver them to a separate directory instead of the inbox.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec257"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with Postfix configured as described in the previous recipes. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec258"></a>How to do it...</h3></div></div></div><p>Follow these steps to set up Procmail to route messages:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create the <code class="literal">/etc/procmailrc</code> file with the following content:</p><pre class="programlisting">
<span class="strong"><strong>MAILDIR=$HOME/Maildir</strong></span>
<span class="strong"><strong>DEFAULT=$MAILDIR/new</strong></span>
<span class="strong"><strong>INCLUDERC=/etc/mail/spamassassin/spamassassin-spamc.rc</strong></span>
<span class="strong"><strong>:0</strong></span>
<span class="strong"><strong>* ^X-Spam-Status: Yes</strong></span>
<span class="strong"><strong>.Spam</strong></span>
</pre></li><li><p>Create each user's spam directory:</p><pre class="programlisting">
<span class="strong"><strong>echo Spam &gt;&gt; /home/tboronczyk/Maildir/subscriptions</strong></span>
<span class="strong"><strong>mkdir /home/tboronczyk/Maildir/.Spam</strong></span>
</pre></li><li><p>If you created the user's spam directory as <code class="literal">root</code>, fix the directory and subscription file's ownership and permissions:</p><pre class="programlisting">
<span class="strong"><strong>chown tboronczyk /home/tboronczyk/Maildir/subscriptions</strong></span>
<span class="strong"><strong>chmod 0600 /home/tboronczyk/Maildir/subscriptions</strong></span>
<span class="strong"><strong>chown tboronczyk.tboronczyk /home/tboronczyk/Maildir/.Spam</strong></span>
<span class="strong"><strong>chmod 0700 /home/tboronczyk/Maildir/.Spam</strong></span>
</pre></li><li><p>Open Postfix's <code class="literal">main.cf</code> configuration file with your editor:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/postfix/main.cf</strong></span>
</pre></li><li><p>Locate the example <code class="literal">mailbox_command</code> parameters. Uncomment the second example and correct its path to the <code class="literal">procmail</code> executable:</p><pre class="programlisting">
<span class="strong"><strong>mailbox_command = /bin/procmail -a "$EXTENSION"</strong></span>
</pre></li><li><p>Save the changes and close the file.</p></li><li><p>Restart Postfix for the updated configuration to take effect:</p><pre class="programlisting">
<span class="strong"><strong>systemctl restart postfix.service</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec259"></a>How it works...</h3></div></div></div><p>Like Postfix, Procmail is installed by default on CentOS systems. However, we need to create its configuration file for it to be useful to us. The main configuration file is <code class="literal">/etc/procmailrc</code> and we start it by defining the <code class="literal">MAILDIR</code>, <code class="literal">DEFAULT</code>, and <code class="literal">INCLUDERC</code> variables.</p><pre class="programlisting">
<span class="strong"><strong>MAILDIR=$HOME/Maildir</strong></span>
<span class="strong"><strong>DEFAULT=$MAILDIR/new</strong></span>
<span class="strong"><strong>INCLUDERC=/etc/mail/spamassassin/spamassassin-spamc.rc</strong></span>
</pre><p><code class="literal">MAILDIR</code> provides the location of the user's mail directory. <code class="literal">procmailrc</code> is a global configuration file and we use <code class="literal">$HOME</code> to denote the user's home directory in which <code class="literal">Maildir</code> resides. <code class="literal">DEFAULT</code> provides the default location for incoming mail, which is the mail directory's <code class="literal">new</code> directory.</p><p><code class="literal">INCLUDERC</code> gives the name of other files that should be included when Procmail processes the configuration file. In this case, SpamAssassin installs a configuration file to integrate with Procmail which we reference.</p><p>The second part of the configuration appears as a cryptic incantationâ€”the definition of a matching rule. In Procmail parlance, they're called recipes:</p><pre class="programlisting">
<span class="strong"><strong>:0</strong></span>
<span class="strong"><strong>* ^X-Spam-Status: Yes</strong></span>
<span class="strong"><strong>.Spam</strong></span>
</pre><p>More than one rule can be given in the configuration file, in which case they are processed in the order in which they appear, top to bottom.</p><p>All rules begin with <code class="literal">:0</code> and contain conditions followed by an action. Here, the condition starts with <code class="literal">*</code> to specify a regular expression pattern that Procmail will search the message and its headers for. The action line then lists the directory that matching messages will be delivered to. If it's given as a relative path, the directory considered will be relative to <code class="literal">$MAILDIR</code>. Thus, the rule asks Procmail to route any messages flagged with the <code class="literal">X-Spam-Status</code> header by SpamAssassin to the user's <code class="literal">Maildir/.Spam</code> directory.</p><p>The original Maildir specification only allows the <code class="literal">new</code>, <code class="literal">cur</code>, and <code class="literal">tmp</code> directories, but others have augmented it to support additional directories. The user can either create their spam directory through their e-mail client over IMAP, in which case all of the details are worked out by Dovecot. Alternatively, we can create it for them in the filesystem. When we create a directory manually, the <code class="literal">subscriptions</code> file must list the additional directories, one entry per line, for them to be visible in the user's mail client. The directories themselves are then named with a leading dot:</p><pre class="programlisting">
<span class="strong"><strong>echo Spam &gt;&gt; /home/tboronczyk/Maildir/subscriptions</strong></span>
<span class="strong"><strong>mkdir /home/tboronczyk/Maildir/.Spam</strong></span>
</pre><p>Procmail also allows for per-user actions as well. For example, if only one user wants to have flagged messages moved to their spam folder, the matching rule can be moved from the global configuration under <code class="literal">/etc</code> to a file named <code class="literal">.procmailrc</code> in their <code class="literal">home</code> directory. It's still recommended that you keep the variable definitions in the global configuration so that they'll be available to all users, as Procmail executes the global file first and then the user's local <code class="literal">.procmailrc</code> if it's available.</p><p>Various flags can be given after <code class="literal">:0</code> that modify how Procmail behaves or how the rule is interpreted. For example, Procmail only search the message's headers by default. To search the message's body, we need to provide the <code class="literal">B</code> flag. The following rule is an example that searches the message's body for the text "Hello World" and routes the matching messages to <code class="literal">/dev/null</code>:</p><pre class="programlisting">
<span class="strong"><strong>:0 B</strong></span>
<span class="strong"><strong>* Hello World</strong></span>
<span class="strong"><strong>/dev/null</strong></span>
</pre><p>Some flags you may find useful are:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">H</code>: Search the message's headers</p></li><li style="list-style-type: disc"><p><code class="literal">B</code>: Search the message's body</p></li><li style="list-style-type: disc"><p><code class="literal">D</code>: Match the regular expression in a case-sensitive manner</p></li><li style="list-style-type: disc"><p><code class="literal">e</code>: Only execute the rule if the rule immediately preceding it was unsuccessful</p></li><li style="list-style-type: disc"><p><code class="literal">c</code>: Create a copy of the message</p></li><li style="list-style-type: disc"><p><code class="literal">h</code>: Only send the message's header to a piped program</p></li><li style="list-style-type: disc"><p><code class="literal">b</code>: Only send the message's body to a piped program</p></li></ul></div><p>If the action begins with <code class="literal">|</code> then the value is interpreted as a command and the message is piped to it. Here's an example that sends a copy of any messages received from the human resources department to the printer by piping it through <code class="literal">lpr</code>:</p><pre class="programlisting">
<span class="strong"><strong>:0 c</strong></span>
<span class="strong"><strong>* ^From: hr-dept@example.com</strong></span>
<span class="strong"><strong>| lpr</strong></span>
</pre><p>If the action begins with <code class="literal">!</code> then the value is seen as an e-mail and the message is forwarded. This example routes an e-mail from a known recipient to a personal e-mail account instead:</p><pre class="programlisting">
<span class="strong"><strong>:0</strong></span>
<span class="strong"><strong>* ^From: secret-admirer@example.com</strong></span>
<span class="strong"><strong>! tboronczyk@another-example.com</strong></span>
</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl2sec260"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on Procmail:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The<code class="literal"> procmail</code>Â manual page (<code class="literal">man 1 procmail</code>)</p></li><li style="list-style-type: disc"><p>The <code class="literal">procmailrc</code> file manual page (<code class="literal">man 5 procmailrc</code>)</p></li><li style="list-style-type: disc"><p>Timo's Promail tips and recipes (<a class="ulink" href="http://www.netikka.net/tsneti/info/proctips.php" target="_blank">http://www.netikka.net/tsneti/info/proctips.php</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="chapter" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="ch10"></a>ChapterÂ 10.Â Managing Web Servers</h2></div></div></div><p>This chapter contains the following recipes:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Installing Apache HTTP Server and PHP</p></li><li style="list-style-type: disc"><p>Configuring name-based virtual hosting</p></li><li style="list-style-type: disc"><p>Configuring Apache to serve pages over HTTPS</p></li><li style="list-style-type: disc"><p>Enabling overrides and performing URL rewriting</p></li><li style="list-style-type: disc"><p>Installing NGINX as a load balancer</p></li></ul></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch10lvl1sec80"></a>Introduction</h2></div></div><hr /></div><p>This chapter contains recipes for working with the Apache HTTP Server to serve websites. You'll first learn how to install the server as well as PHP, a very common server-side scripting engine used to generate dynamic web content. Then you'll see how to serve multiple sites with the same server instance using name-based virtual hosting, encrypt the connection and serve content over HTTPS, and how to rewrite incoming URLs on the fly. We'll finish with looking at NGINX and its use as a reverse proxy to decrease load on the server while at the same time speeding up access to our sites for the user.</p></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch10lvl1sec81"></a>Installing Apache HTTP Server and PHP</h2></div></div><hr /></div><p>You may have heard the acronym LAMP which stands for Linux, Apache, MySQL, and PHP. It refers to the popular pairing of technologies for providing websites and web applications. This recipe teaches you how to install the Apache HTTP Server (Apache for short) and configure it to work with PHP to serve dynamic web content.</p><p>First released over twenty years ago, Apache was one of the first web servers and it continues to be one of the most popular. Its task in the LAMP stack is to interact with the user by responding to their requests for web resources. Perhaps one of its selling points is its design that allows its functionality to be expanded with modules. Many modules exist, from <code class="literal">mod_ssl</code>, which adds HTTPS support to <code class="literal">mod_rewrite</code>, which allows you to modify the request URL on the fly.</p><p>PHP is a scripting language for creating dynamic web content. It works behind the scenes and the output of a script is usually served by Apache to satisfy a request. PHP was commonly installed as a module (<code class="literal">mod_php</code>) that embedded the language's interpreter into Apache's processing, but nowadays, running PHP as a standalone process is preferred. This is the approach we'll take in this recipe.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec261"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection. It assumes that the system is configured with the IP address <code class="literal">192.168.56.100</code>. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p><p>Note that the official CentOS repositories install PHP 5.4. The Remi repositories offer 5.5, 5.6, and 7.0 if you want to install a newer release. To install one of the 5.x versions, open the <code class="literal">/etc/yum.repos.d/remi.repo</code> file, locate the <code class="literal">enabled</code> option in the <code class="literal">[remi-php55]</code> or <code class="literal">[remi-php56]</code> section and set its value to <code class="literal">1</code>. For 7.0, update the <code class="literal">enabled</code> option found in <code class="literal">/etc/yum.repos.d/remi-php70.repo</code>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note65"></a>Note</h3><p>What happened to PHP 6? <span class="emphasis"><em>It's a long story...</em></span>. The team of volunteers developing PHP was working on version 6, but the initiative faced many hurdles and was eventually shelved. To prevent confusion between the latest release and any blog postings that were written about PHP 6, it was decided that its version number would be bumped to 7. In short, PHP 6 did exist but never achieved a proper release status and most of the cool features planned for 6 made it into PHP 5.3, 5.4, and 7.0.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec262"></a>How to do it...</h3></div></div></div><p>Follow these steps to install Apache HTTP Server and PHP:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Install the <code class="literal">httpd</code> and <code class="literal">php-fpm</code> packages:</p><pre class="programlisting">
<span class="strong"><strong>yum install httpd php-fpm</strong></span>
</pre></li><li><p>Open Apache's configuration file with your text editor:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/httpd/conf/httpd.conf</strong></span>
</pre></li><li><p>Locate the <code class="literal">ServerName</code> option. Remove <code class="literal">#</code> appearing at the start of the line to uncomment it and then change the option's value to reflect your server's hostname or IP address:</p><pre class="programlisting">
<span class="strong"><strong>ServerName 192.168.56.100:80</strong></span>
</pre></li><li><p>Find the <code class="literal">DirectoryIndex</code> option and add <code class="literal">index.php</code> to the list:</p><pre class="programlisting">
<span class="strong"><strong>       &lt;IfModule dir_module&gt;
          DirectoryIndex index.html index.php
       &lt;/IfModule&gt;
</strong></span>
</pre></li><li><p>At the end of the file, add the following configuration:</p><pre class="programlisting">
<span class="strong"><strong>       &lt;IfModule proxy_fcgi_module&gt;
          ProxyPassMatch ^/(.*\.php)$
          fcgi://127.0.0.1:9000/var/www/html/$1
       &lt;/IfModule&gt;
</strong></span>
</pre></li><li><p>Save your changes to the configuration and close the file.</p></li><li><p>Verify that <code class="literal">mod_proxy</code> (listed as <code class="literal">proxy_module</code>) and <code class="literal">mod_proxy_fcgi</code> (<code class="literal">proxy_fcgi_module)</code> extension modules are enabled:</p><pre class="programlisting">
<span class="strong"><strong>httpd -M | grep proxy</strong></span>
</pre></li><li><p>Both modules should appear in the output.</p></li><li><p>Start Apache and PHP's FPM service and enable them to start automatically when your system reboots:</p><pre class="programlisting">
<span class="strong"><strong>systemctl start httpd.service php-fpm.service</strong></span>
<span class="strong"><strong>systemctl enable httpd.service php-fpm.service</strong></span>
</pre></li><li><p>Open port <code class="literal">80</code> in the system's firewall to allow HTTP requests through:</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --add-service=http</strong></span>
<span class="strong"><strong>firewall-cmd --reload</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec263"></a>How it works...</h3></div></div></div><p>There are several ways to integrate PHP with Apache's HTTP server to generate dynamic web content. Historically, using Apache's <code class="literal">mod_php</code> module was the way to go, but now the preferred approach is to run PHP as a separate process, which the web server communicates with using the FastCGI protocol. So, we installed the <code class="literal">httpd</code> package for the Apache HTTP Server and the <code class="literal">php-fpm</code> package for the PHP interpreter and its process manager:</p><pre class="programlisting">
<span class="strong"><strong>yum install httpd php-fpm</strong></span>
</pre><p>The PHP FastCGI Process Manager (FPM) is included in the core PHP distributions as of version 5.3. Separating PHP from Apache encourages a more scalable architecture, and using a persistent PHP process reduces CPU overhead because a new interpreter doesn't have to be spawned for each request.</p><p>Apache's main configuration file is <code class="literal">/etc/httpd/conf/httpd.conf</code>, in which we updated the <code class="literal">ServerName</code> option to reflect our server's hostname or IP address. While this step isn't strictly necessary, if we don't set the option then the server will write warning messages to its log files. Besides, it's useful for the server to be able to identify itself:</p><pre class="programlisting">
<span class="strong"><strong>ServerName 192.168.56.100:80</strong></span>
</pre><p>Next, we updated for the <code class="literal">DirectoryIndex</code> option by adding <code class="literal">index.php</code> to its list of values. When the user requests a resource that resolves to a directory, the server will look in that directory for a file that matches one of the names in the <code class="literal">DirectoryIndex</code> list. If found, Apache will return that file to satisfy the request. This behavior is what allows visitors to access a website's home page with a URL such as <code class="literal">www.example.com</code> rather than <code class="literal">www.example.com/index.html</code>:</p><pre class="programlisting">
<span class="strong"><strong>DirectoryIndex index.html index.php</strong></span>
</pre><p>The order in which files are listed is significant. For example, if both <code class="literal">index.html</code> and <code class="literal">index.php</code> exist in the directory then <code class="literal">index.html</code> will be returned because it's listed before <code class="literal">index.php</code> in the option's list.</p><p>Then we navigated to the end of the file to add the following proxy configuration. If the regular expression of <code class="literal">ProxyPassMatch</code> matches the incoming request then the server retrieves the given URL and returns that content instead:</p><pre class="programlisting">
<span class="strong"><strong>    &lt;IfModule proxy_fcgi_module&gt;
      ProxyPassMatch ^/(.*\.php)$ fcgi://127.0.0.1:9000/var/www/html/$1
    &lt;/IfModule&gt;
</strong></span>
</pre><p>Regular expressions are written using a special notation that describes how to match text. Most characters are matched literally, but some have special meaning:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">.</code>: This matches any character. The pattern <code class="literal">bu.</code> matches against the text <code class="literal">bud</code>, <code class="literal">bug</code>, <code class="literal">bun</code>, <code class="literal">bus</code>, and so on.</p></li><li style="list-style-type: disc"><p><code class="literal">+</code>: This matches the preceding element one or more times. The pattern <code class="literal">fe+t</code> matches <code class="literal">fet</code>, <code class="literal">feet</code>, and <code class="literal">feeet</code> and so on but not <code class="literal">ft</code>.</p></li><li style="list-style-type: disc"><p><code class="literal">*</code>: This optionally matches the preceding element any number of times. The pattern <code class="literal">fe*t</code> matches <code class="literal">ft</code>, <code class="literal">fet</code>, <code class="literal">feet</code>, <code class="literal">feeet</code>, and so on.</p></li><li style="list-style-type: disc"><p><code class="literal">?</code>: This optionally matches the preceding element once. The pattern <code class="literal">colou?r</code> matches <code class="literal">color</code> and <code class="literal">colour</code>.</p></li><li style="list-style-type: disc"><p><code class="literal">^</code>: This anchors the match to the beginning of the line. The pattern <code class="literal">^abc</code> only matches <code class="literal">abc</code> if <code class="literal">abc</code> appears at the beginning of the text (<code class="literal">^</code> has special significance when used in <code class="literal">[ ]</code>).</p></li><li style="list-style-type: disc"><p><code class="literal">$</code>: This anchors the match to the end of the line. The pattern <code class="literal">xyz$</code> only matches <code class="literal">xyz</code> if <code class="literal">xyz</code> appears at the end of the line.</p></li><li style="list-style-type: disc"><p><code class="literal">[ ]</code>: This matches any of the characters given within the brackets. The pattern <code class="literal">co[lr]d</code> matches <code class="literal">cold</code> and <code class="literal">cord</code>. When the first character in <code class="literal">[ ]</code> is <code class="literal">^</code> then the list is negated; <code class="literal">co[^lr]d</code> matches <code class="literal">coed</code> but not <code class="literal">cold</code> or <code class="literal">cord</code>.</p></li><li style="list-style-type: disc"><p><code class="literal">( )</code>: This groups elements and captures matches. The pattern <code class="literal">jump(ed)?</code> matches <code class="literal">jump</code> and <code class="literal">jumped</code>.</p></li></ul></div><p>If you want any of these special characters to be matched literally then you should escape them with a leading backslash, for example <code class="literal">foo\.html</code> will match <code class="literal">foo.html</code> instead of <code class="literal">fooahtml</code>, <code class="literal">foobhtml</code>, and so on.</p><p>Special numeric variables like <code class="literal">$1</code> and <code class="literal">$2</code> contain the value of any captured matches. The order in which they are populated are the order in which the parentheses capture a match, thus <code class="literal">(foo)\.(html)</code> sets <code class="literal">$1</code> to <code class="literal">foo</code> and <code class="literal">$2</code> to <code class="literal">html</code>.</p><p>With this understanding, you should now be able to decipher that the regular expression <code class="literal">^/(.*\.php)$</code> captures the path and filename of the requested resource that end with the extension <code class="literal">.php</code>. The <code class="literal">$1</code> variable represents the captured path, so a request for <code class="literal">/about/staff.php</code> will be proxied asÂ <code class="literal">fcgi://127.0.0.1:9000/var/www/html/about
/staff.php</code> where PHP's Fast-CGI listener is listening to the local interface on port <code class="literal">9000</code>.</p><p>Apache's functionality is often extended through modules, and as a safeguard it's a good practice to wrap module-specific configuration options in an <code class="literal">IfModule</code> block. The opening of such blocks contain the name of the module and appear in angle brackets <code class="literal">&lt; &gt;</code>. The block's closing appears as <code class="literal">&lt;/IfModule&gt;</code> just like closing an HTML element.</p><p>The directory out of which the server serves files from is set by the option <code class="literal">DocumentRoot</code>. The default value is <code class="literal">/var/www/html</code>, so any files we place there or in a subdirectory within it will be accessible. As an example to illustrate this, the distribution includes a sample <code class="literal">index.html</code> file, which we can use to verify that the server is running correctly; copy the <code class="literal">/usr/share/httpd/noindex/index.html</code> file to <code class="literal">/var/www/html</code>:</p><pre class="programlisting">
<span class="strong"><strong>cp /usr/share/httpd/noindex/index.html /var/www/html</strong></span>
</pre><p>Then, open your browser and navigate to the domain or IP address of the system. You should see the welcome page:</p><div class="mediaobject"><img src="graphics/image_10_001.jpg" /><div class="caption"><p>You can copy Apache's default index page to the web directory to test whether the server is up and running</p></div></div><p>For PHP, you need to place a PHP file where it can be read by the Fast-CGI service. The proxy URL is <code class="literal">fcgi://127.0.0.1:9000/var/www/html/$1</code>, so that we can place our PHP files in <code class="literal">/var/www/html</code> as well.</p><p>Create the <code class="literal">info.php</code> file with the following content:</p><pre class="programlisting">
<span class="strong"><strong>    &lt;?php
    phpinfo();
</strong></span>
</pre><p>Now save the file and then navigate to the page in your browser. You should see the output of PHP's <code class="literal">phpinfo()</code> function providing detailed information on how PHP is configured and which of its modules are available:</p><div class="mediaobject"><img src="graphics/image_10_002.jpg" /><div class="caption"><p>PHP reports information about its environment and the request</p></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note66"></a>Note</h3><p>For security purposes, it's recommended that you delete the welcome <code class="literal">index.html</code> file if you copied it over and the <code class="literal">info.php</code> script after you verify everything works. The information they present can give malicious users more information about the set up of your web server than you'd like them to have.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec264"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on working with Apache and PHP:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Apache HTTP Server Project (<a class="ulink" href="http://httpd.apache.org/" target="_blank">http://httpd.apache.org/</a>)</p></li><li style="list-style-type: disc"><p>The PHP home page (<a class="ulink" href="http://php.net/" target="_blank">http://php.net/</a>)</p></li><li style="list-style-type: disc"><p>Apache <code class="literal">mod_proxy_fcgi</code>Â documentation (<a class="ulink" href="http://httpd.apache.org/docs/current/mod/mod_proxy_fcgi.html" target="_blank">http://httpd.apache.org/docs/current/mod/mod_proxy_fcgi.html</a>)</p></li><li style="list-style-type: disc"><p>Httpd Wiki: PHP-FPM (<a class="ulink" href="http://wiki.apache.org/httpd/PHP-FPM" target="_blank">http://wiki.apache.org/httpd/PHP-FPM</a>)</p></li><li style="list-style-type: disc"><p>RFC-2616: HTTP/1.1 (<a class="ulink" href="http://www.rfc-base.org/txt/rfc-2616.txt" target="_blank">http://www.rfc-base.org/txt/rfc-2616.txt</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch10lvl1sec82"></a>Configuring name-based virtual hosting</h2></div></div><hr /></div><p>As you may recall from our discussions surrounding DNS in <a class="link" href="#" linkend="ch08">Chapter 8</a>, <span class="emphasis"><em>Managing Domains and DNS</em></span> a user's browser needs to translate a website's hostname to its IP address via DNS lookups before it can connect and retrieve the desired web content. You may also recall that this doesn't have to be a one-to-one mapping-more than one site can resolve to the same IP address. Apache is flexible enough so that the same server can serve more than one site by a configuration known as name-based virtual hosting.</p><p>This recipe teaches you how to set up name-based virtual hosting. Each site has it's own configuration (often kept in its own configuration file for better organization). Based on the site name that appears in the request, Apache then selects from the available configurations to properly serve the desired site.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec265"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection and running Apache as described in the previous recipe. Because we'll be connecting to the server via a domain name instead of an IP address, you'll need to make sure the name resolves to the correct address by updating your DNS records or adding entries to <code class="literal">/etc/hosts</code> first. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec266"></a>How to do it...</h3></div></div></div><p>Follow these steps to set up name-based virtual hosting:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Open Apache's configuration file with your text editor:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/httpd/conf/httpd.conf</strong></span>
</pre></li><li><p>At the bottom of the file, add the following <code class="literal">Include</code> option:</p><pre class="programlisting">
<span class="strong"><strong>Include sites/*.conf</strong></span>
</pre></li><li><p>Save the updated configuration and close the file.</p></li><li><p>Create the <code class="literal">sites</code> directory referenced in the configuration:</p><pre class="programlisting">
<span class="strong"><strong>mkdir /etc/httpd/sites</strong></span>
</pre></li><li><p>Create a virtual host configuration file within the new <code class="literal">sites</code> directory for your first site:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/httpd/sites/www.example.conf</strong></span>
</pre></li><li><p>Add the following code to the site's configuration file:</p><pre class="programlisting">
<span class="strong"><strong>       &lt;VirtualHost *:80&gt;
         ServerName www.example.com
         DocumentRoot "/var/www/example.com/www/html"

         &lt;IfModule proxy_fcgi_module&gt;
            ProxyPassMatch ^/(.*\.php)$
            fcgi://127.0.0.1:9000/var/www/example.com/www/html/$1
         &lt;/IfModule&gt;
       &lt;/VirtualHost&gt;
</strong></span>
</pre></li><li><p>Save your changes and close the file.</p></li><li><p>Create the site's document root referenced in the configuration options:</p><pre class="programlisting">
<span class="strong"><strong>mkdir -p /var/www/example.com/www/html</strong></span>
</pre></li><li><p>Repeat steps 4-8 for each additional site you will be hosting, using the host or domain name to create a unique directory path for each site.</p></li><li><p>Restart the HTTP server for the configuration changes to take effect:</p><pre class="programlisting">
<span class="strong"><strong>systemctl restart httpd.service</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec267"></a>How it works...</h3></div></div></div><p>Configuring Apache to serve multiple domains is a matter of creating a <code class="literal">VirtualHost</code> definition for each site. This recipe organizes the definitions in their own file under the directory <code class="literal">/etc/httpd/sites</code> and then references them in the main <code class="literal">httpd.conf</code> configuration file using an <code class="literal">Include</code> directive:</p><pre class="programlisting">
<span class="strong"><strong>Include sites/*.conf</strong></span>
</pre><p>How you organize your sites is up to you. This recipe uses a scheme where each site is served from a path based on the domain name followed by the subdomain rooted in <code class="literal">/var/www</code>. The path <code class="literal">/var/www/example.com/www/html</code> contains the files for the site at <code class="literal">www.example.com</code>. Files for the site at <code class="literal">web.example.com</code> would be placed in <code class="literal">/var/www/example.com/web/html</code>. The <code class="literal">html</code> directory is simply the web-accessible root for the site. By including it instead of serving files out of <code class="literal">example.com/www</code> directly, we can place any supporting files outside the root which aren't mean to be accessed directly (for example, a script with configuration options for a PHP website), but still keep them organized with the rest of the site's files.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note67"></a>Note</h3><p>Naming the publicly accessible directory root <code class="literal">html</code> is a convention, but its one that I find outdated since more than just HTML files are often served. I often name my own root directories <code class="literal">public</code> or <code class="literal">public_files</code> and update their references in the configuration file accordingly.</p></div><p>Each definition for a virtual host is contained within a <code class="literal">VirtualHost</code> block. The opening provides the IP address of the interface on which the server is listening followed by the port number. <code class="literal">*</code> indicates that the definition applies to all of the system's interfaces and <code class="literal">80</code> is the default port for HTTP traffic:</p><pre class="programlisting">
<span class="strong"><strong>    &lt;VirtualHost *:80&gt;
</strong></span>
</pre><p>Options that don't appear explicitly in the definition are assumed to have the same settings as found in the main configuration, so at a minimum, the <code class="literal">ServerName</code> and <code class="literal">DocumentRoot</code> options need to be defined to make the definition unique. If you're using PHP, you'll want to provide the <code class="literal">ProxyPassMatch</code> option as well so that the requests are mapped to the correct PHP files:</p><pre class="programlisting">
<span class="strong"><strong>    &lt;VirtualHost *:80&gt;
      ServerName www.example.com
      DocumentRoot "/var/www/example.com/www/html"
      &lt;IfModule proxy_fcgi_module&gt;
        ProxyPassMatch ^/(.*\.php)$ fcgi://127.0.0.1:9000/var/www/
        example.com/www/html/$1
      &lt;/IfModule&gt;
    &lt;/VirtualHost&gt;
</strong></span>
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note68"></a>Note</h3><p>The order in which the virtual host definitions are loaded is somewhat important; the first one loaded acts as the default and will handle any requests that do not match any of the virtual hosts definitions. Prefixing the configuration files numerically, for example <code class="literal">10-www.example.conf</code>, can help you control the loading order.</p></div><p>Each request is logged to <code class="literal">/var/log/httpd/access_log</code> and any errors are logged to <code class="literal">error_log</code>. Of course, this is fine if you're only serving one site. But when serving multiple sites, you may find it beneficial to route log entries to different files for different sites. The <code class="literal">CustomLog</code> option names a file where the access and general logging messages are written to and the format of the entries. <code class="literal">ErrorLog</code> specifies the file where the error messages are written. Both of these options can appear in a virtual host's configuration:</p><pre class="programlisting">    &lt;VirtualHost *:80&gt;
      ServerName www.example.com
      DocumentRoot "/var/www/example.com/www/html"
      CustomLog "/var/log/httpd/example.com/www/access_log" "%h %u
      %t "%r" %&gt;s %b"
      ErrorLog  "/var/log/httpd/example.com/www/error_log"
      &lt;IfModule proxy_fcgi_module&gt;
        ProxyPassMatch ^/(.*\.php)$ fcgi://127.0.0.1:9000/var/www/
        example.com/www/html/$1
      &lt;/IfModule&gt;
    &lt;/VirtualHost&gt;
</pre><p>The second argument to <code class="literal">CustomLog</code> can be the format string itself or an alias that represents the format string. Format strings simply define what details are contained in the logged messages.</p><p>There's a slew of format specifiers available which are all documented in the Apache HTTPd Server's documentation. Here's a list of some of the more common ones you may use, while you can find a complete list online at <a class="ulink" href="http://httpd.apache.org/docs/current/mod/mod_log_config.html#formats" target="_blank">http://httpd.apache.org/docs/current/mod/mod_log_config.html#formats</a>):</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">%b</code>: This is the size of the response (in bytes) served back to the client</p></li><li style="list-style-type: disc"><p><code class="literal">%D</code>: This is the time taken to process the request in milliseconds (<code class="literal">%T</code> represents the time taken in seconds)</p></li><li style="list-style-type: disc"><p><code class="literal">%h</code>: This is the IP or hostname of the requesting system</p></li><li style="list-style-type: disc"><p><code class="literal">%H</code>: This is the protocol used to make the request</p></li><li style="list-style-type: disc"><p><code class="literal">%m</code>: This is the method used to make the request</p></li><li style="list-style-type: disc"><p><code class="literal">%q</code>: This is the query string portion of the requested URI</p></li><li style="list-style-type: disc"><p><code class="literal">%r</code>: This is the first line of the request</p></li><li style="list-style-type: disc"><p><code class="literal">%&gt;s</code>: This is the request's final status code (<code class="literal">%s</code> represents the initial status for requests that are redirected)</p></li><li style="list-style-type: disc"><p><code class="literal">%t</code>: This is the time when the request was received</p></li><li style="list-style-type: disc"><p><code class="literal">%u</code>: This is the username for authenticated requests when the request was received</p></li><li style="list-style-type: disc"><p><code class="literal">%v</code>: This is the name of the server (<code class="literal">ServerName</code>) handling the request</p></li></ul></div><p>The <code class="literal">LogFormat</code> option names a format string with an alias. For example, the <code class="literal">httpd.conf</code> file uses <code class="literal">LogFormat</code> to define strings named as <code class="literal">common</code> and <code class="literal">combined</code>, which can be used elsewhere. It's a good idea to define your own alias for your virtual host logging and use the alias in the individual configuration files rather than having cryptic format strings scattered about. In <code class="literal">httpd.conf</code>, simply add your custom <code class="literal">LogFormat</code> entry in the same area as the <code class="literal">common</code> and <code class="literal">combined</code> entries:</p><pre class="programlisting">
<span class="strong"><strong>LogFormat "%v %h %u %t "%r" %&gt;s %b" vhostcommon</strong></span>
</pre><p>Then, you can reference the alias in your sites' configuration files:</p><pre class="programlisting">
<span class="strong"><strong>CustomLog "/var/www/example.com/www/logs/access_log" vhostcommon</strong></span>
</pre><p>After making the changes, restart Apache for the configuration to take effect.</p><p>Whatever their destination, make sure the ownership/permissions your security context allow Apache runs to write to the log file. If the logs reside under <code class="literal">/var/log/httpd</code> then creating the necessary subdirectories should be sufficient. The server will create the log files itself when it starts:</p><pre class="programlisting">
<span class="strong"><strong>mkidr -p /var/log/httpd/example.com/www</strong></span>
</pre><p>However, if you wish to keep the logs in another directory, perhaps such as <code class="literal">/var/www/example.com/www/logs</code>, the server may be blocked from writing to them. SELinux is enabled regardless of the filesystem permissions appearing sane. To fix the situation, first verify the security context with <code class="literal">ls -Z</code>:</p><pre class="programlisting">
<span class="strong"><strong>ls -Z /var/www/example.com/www | grep logs</strong></span>
<span class="strong"><strong>drwxr-xr-x. apache apache unconfined_u:object_r:httpd_sys_content_
t:s0 logs</strong></span>
</pre><p>In this case, the <code class="literal">logs</code> directory is owned by the <code class="literal">apache</code> user, which Apache runs under, and the permissions on the directory should allow the server to create the log files. However, we can also see that the directory has inherited the label that identifies it as web content as indicated by <code class="literal">httpd_sys_content_t</code>. To fix the problem, we need to relabel the directory for logging purposes using <code class="literal">chcon</code>:</p><pre class="programlisting">
<span class="strong"><strong>chcon -Rv --type=httpd_log_t /var/www/example.com/www/logs</strong></span>
</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec268"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on working with virtual hosting:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Apache Virtual Host documentation (<a class="ulink" href="http://httpd.apache.org/docs/current/vhosts/" target="_blank">http://httpd.apache.org/docs/current/vhosts/</a>)</p></li><li style="list-style-type: disc"><p>Apache <code class="literal">mod_log_config</code>Â documentation (<a class="ulink" href="http://httpd.apache.org/docs/current/mod/mod_log_config.html" target="_blank">http://httpd.apache.org/docs/current/mod/mod_log_config.html</a>)</p></li><li style="list-style-type: disc"><p>VirtualHost examples (<a class="ulink" href="http://httpd.apache.org/docs/current/vhosts/examples.html" target="_blank">http://httpd.apache.org/docs/current/vhosts/examples.html</a>)</p></li><li style="list-style-type: disc"><p>CentOS Wiki: SELinux HowTo (<a class="ulink" href="https://wiki.centos.org/HowTos/SELinux" target="_blank">https://wiki.centos.org/HowTos/SELinux</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch10lvl1sec83"></a>Configuring Apache to serve pages over HTTPS</h2></div></div><hr /></div><p>HTTP traffic is sent in plain text across the network. In an untrusted environment, a malicious user can monitor and capture the traffic to spy on what sites you're visiting and what content you're reading. While such snooping isn't interesting if the victim is just reading the daily news or watching cat videos on YouTube, the user's credit card number, shipping address, and other details could be snagged if an e-commerce transaction were to take place unencrypted. To support encrypted traffic, Apache supports HTTPS. This recipe will teach you how to configure HTTPS support and protect your users' traffic from prying eyes no matter how benign the content is.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec269"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection. It assumes that the system is configured with the IP address <code class="literal">192.168.56.100</code> and is running Apache as described in the previous recipes. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec270"></a>How to do it...</h3></div></div></div><p>Follow these steps to serve pages over HTTPS:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Generate a new key file and security certificate using <code class="literal">openssl</code>:</p><pre class="programlisting">
<span class="strong"><strong>openssl req -newkey rsa:2048 -nodes \</strong></span>
<span class="strong"><strong>     -keyout /etc/pki/tls/private/www.example.key \</strong></span>
<span class="strong"><strong>     -x509 -days 730 -subj "/CN=www.example.com" -text \</strong></span>
<span class="strong"><strong>     -out /etc/pki/tls/certs/www.example.pem</strong></span>
</pre></li><li><p>Install the server's SSL module:</p><pre class="programlisting">
<span class="strong"><strong>yum install mod_ssl</strong></span>
</pre></li><li><p>Open the <code class="literal">/etc/httpd/conf.d/ssl.conf</code> file with your text editor:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/httpd/conf.d/ssl.conf</strong></span>
</pre></li><li><p>Locate the <code class="literal">SSLCertificateFile</code> option and update its value to point to the self-signed certificate file:</p><pre class="programlisting">
<span class="strong"><strong>SSLCertificateFile /etc/pki/tls/certs/www.example.pem</strong></span>
</pre></li><li><p>Locate the <code class="literal">SSLCertificateKeyFile</code> option and update it to point to the encryption key:</p><pre class="programlisting">
<span class="strong"><strong>SSLCertificateKeyFile /etc/pki/tls/private/www.example.key</strong></span>
</pre></li><li><p>Save your changes and close the file.</p></li><li><p>Restart the server for the updated configuration to take effect:</p><pre class="programlisting">
<span class="strong"><strong>systemctl restart httpd</strong></span>
</pre></li><li><p>Open port <code class="literal">443</code> in the firewall to allow HTTPS traffic:</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --add-service=https</strong></span>
<span class="strong"><strong>firewall-cmd --reload</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec271"></a>How it works...</h3></div></div></div><p>The Apache HTTP Server comes with a default SSL/TLS configuration contained within a catch-all virtual host definition in <code class="literal">/etc/httpd/conf.d/ssl.conf</code>. With most of the configuration already done for us, all that's left is to install the SSL module, generate a new key and certificate, and update the configuration to point to our files.</p><p>First, we generated a new encryption key and signing certificate. If you've already read the <span class="emphasis"><em>Configuring Postfix to use TLS</em></span> recipe in <a class="link" href="#" linkend="ch09">Chapter 9</a>, <span class="emphasis"><em>Managing E-mails</em></span>, then you already know that the key is needed for secured communication and the certificate confirms the ownership of the key:</p><pre class="programlisting">
<span class="strong"><strong>openssl req -newkey rsa:2048 -nodes \</strong></span>
<span class="strong"><strong>  -keyout /etc/pki/tls/private/www.example.key \</strong></span>
<span class="strong"><strong>  -x509 -days 730 -subj "/CN=www.example.com" -text \</strong></span>
<span class="strong"><strong>  -out /etc/pki/tls/certs/www.example.pem</strong></span>
</pre><p>The recipe generates a self-signed certificate which is sufficient for personal use and intranet sites. The <code class="literal">req</code> option creates a new certificate and <code class="literal">-newkey</code> generates a new private key. The key is a 2048-bit RSA key and itself is not encrypted (<code class="literal">-nodes</code>), so we don't need to provide a passphrase to decrypt the key every time we start the web server. The certificate is an X.509 certificate (<code class="literal">-x509</code>) and is valid for 3 years (<code class="literal">-days 730</code>). The certificate's <code class="literal">CN</code> field must match the domain name of the site it will be used for.</p><p>In the configuration file, the <code class="literal">SSLCertificateFile</code> option specifies the file that contains the certificate file and the key is identified using <code class="literal">SSLCertificateKeyFile</code>:</p><pre class="programlisting">
<span class="strong"><strong>SSLCertificateFile /etc/pki/tls/certs/www.example.pem</strong></span>
<span class="strong"><strong>SSLCertificateKeyFile /etc/pki/tls/private/www.example.key</strong></span>
</pre><p>The server determines which virtual host configuration to use to handle a request by looking at the site's name in the incoming request. However, the original HTTPS implementation encrypted the request in its entirety between the web client and server, including the site's hostname, which raised a chicken and egg problem. The server needed to know which certificate to serve and couldn't know it without reading the request, and the client wanted a certificate that matched the site's domain before it would even send the request. It was impossible to use TLS with name-based virtual hosting and any encrypted site required its own dedicated IP address.</p><p>RFC-3546 (Transport Layer Security Extensions) modified the protocol so that the hostname could be sent unencrypted. This allowed the server to select the correct certificate to satisfy the client and opened the door for using TLS with virtual hosting. It took approximately ten years for the major browsers to support the change but we're pretty much there now Internet Explorer as of version 7, Mozilla Firefox as of version 2, and Google Chrome as of version 6 support what is known as Server Name Indication (SNI).</p><p>To server your virtual hosts over HTTPS, each site will need its own certificate and key. Then, add the <code class="literal">SSLEngine</code>, <code class="literal">SSLCertificateFile</code>, and <code class="literal">SSLCertificateKeyFile</code> options to the host's configuration. The port number also needs to be changed in the configuration to <code class="literal">443</code>, the default port for HTTPS traffic:</p><pre class="programlisting">
<span class="strong"><strong>    &lt;VirtualHost *:443&gt;
      ServerName www.example.com
      DocumentRoot "/var/www/example.com/www/html"
      CustomLog "/var/log/httpd/example.com/www/access_log" common
      ErrorLog  "/var/log/httpd/example.com/www/error_log"
      SSLEngine on
      SSLCertificateFile /etc/pki/tls/certs/www.example.pem
      SSLCertificateKeyFile /etc/pki/tls/private/www.example.key
      &lt;IfModule proxy_fcgi_module&gt;
        ProxyPassMatch ^/(.*\.php)$ fcgi://127.0.0.1:9000/var/www/
        example.com/www/html/$1
      &lt;/IfModule&gt;
    &lt;/VirtualHost&gt;
</strong></span>
</pre><p>Although self-signed certificates are adequate for personal use and private network/intranet sites, most likely you'll want to use a trusted certificate for sites accessible on a larger scale. However, depending on the Certificate Authority and the specifics of your request, purchasing a trusted certificate can be expensive. If you need only a basic trusted certificate, then you might want to investigate whether Let's Encrypt will meet your needs. Let's Encrypt is a project offering an automated, self-service model for generating trusted certificates for free.</p><p>To use <span class="emphasis"><em>Let's Encrypt</em></span>, you'll need to install the <code class="literal">certbot</code> package available in the EPEL repository (refer to the <span class="emphasis"><em>Registering the EPEL and Remi repositories</em></span>Â recipe in Â  Â  Â  Â  Â 
<a class="link" href="#" linkend="ch04">Chapter 4</a>,<span class="emphasis"><em>Â Software InstallationÂ Management</em></span>Â if you haven't already enabled the repository). Then run the <code class="literal">certbot certonly</code> command and follow the prompts to request your certificate. Full instructions can be found online in the Let's Encrypt/Certbot User Guide at Â Â 
<a class="ulink" href="http://letsencrypt.readthedocs.io/en/latest/using.html" target="_blank">http://letsencrypt.readthedocs.io/en/latest/using.html</a>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note69"></a>Note</h3><p>There are a few caveats to Let's Encrypt. First, the certificates are only valid for three months; you'll need to request a new certificate every 90 days. It also won't generate certificates for IP addresses. Also, it rate limits requests which, although necessary to help prevent abuse, causes issues for those using a dynamic DNS service such asÂ DynDNS or NoIP to make their sites accessible. For Let's Encrypt to be a viable option for you, you'll need a proper domain and access to the web system to automate the renewal. If you're running a home server or using a shared hosting provider, then Let's Encrypt is probably not for you.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec272"></a>See also</h3></div></div></div><p>Refer to the following resources for working with HTTPS:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>SSL/TLS Strong Encryption: How-To (<a class="ulink" href="http://httpd.apache.org/docs/2.4/ssl/ssl_howto.html" target="_blank">http://httpd.apache.org/docs/2.4/ssl/ssl_howto.html</a>)</p></li><li style="list-style-type: disc"><p>How to create an SSL Certificate for Apache on CentOS 7 (<a class="ulink" href="http://www.digitalocean.com/community/tutorials/how-to-create-an-ssl-certificate-on-apache-for-centos-7" target="_blank">http://www.digitalocean.com/community/tutorials/how-to-create-an-ssl-certificate-on-apache-for-centos-7</a>)</p></li><li style="list-style-type: disc"><p>How to secure Apache with Let's Encrypt on CentOS 7 (<a class="ulink" href="https://www.digitalocean.com/community/tutorials/how-to-secure-apache-with-let-s-encrypt-on-centos-7" target="_blank">https://www.digitalocean.com/community/tutorials/how-to-secure-apache-with-let-s-encrypt-on-centos-7</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch10lvl1sec84"></a>Enabling overrides and performing URL rewriting</h2></div></div><hr /></div><p>This recipe teaches you how to use <code class="literal">mod_rewrite</code>. I mentioned <code class="literal">mod_rewrite</code> earlier; it is a module for Apache that allows us to modify the URL and resolve it to different resources. There are many reasons one would want to do this. For example, perhaps you moved some files and their URL changed, but you don't want any links that exist elsewhere still pointing to the old destinations to be broken. You can write a rewrite rule that matches the old locations and updates the URL on the fly to successfully satisfy the request. Another example is SEO; you may have long, unfriendly canonical URLs for a resource but want something shorter and more memorable. The friendly URLs can be mapped to the canonical URL behind the scenes.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec273"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection. It assumes that the system is configured with the IP address <code class="literal">192.168.56.100</code> and is running Apache as described in the previous recipes. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec274"></a>How to do it...</h3></div></div></div><p>Follow these steps to perform URL rewriting:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Open the <code class="literal">/etc/httpd/conf/httpd.conf</code> file with your text editor:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/httpd/conf/httpd.conf</strong></span>
</pre></li><li><p>Locate the <code class="literal">Directory</code> section that defines various options for your document root. Find its <code class="literal">AllowOverrides</code> option and update the value from <code class="literal">None</code> to <code class="literal">All</code>:</p><pre class="programlisting">
<span class="strong"><strong>       &lt;Directory "/var/www/html"&gt;
       ...
           AllowOverrides All
       ...
       &lt;/Directory&gt;
</strong></span>
</pre></li><li><p>Save your changes and close the file.</p></li><li><p>Restart Apache for the configuration update to take effect:</p><pre class="programlisting">
<span class="strong"><strong>systemctl restart httpd</strong></span>
</pre></li><li><p>Verify that the <code class="literal">mod_rewrite</code> module (identified as <code class="literal">rewrite_module</code>) is available:</p><pre class="programlisting">
<span class="strong"><strong>httpd -M | grep rewrite</strong></span>
</pre></li><li><p>Create a file named <code class="literal">.htaccess</code> in your document root:</p><pre class="programlisting">
<span class="strong"><strong>       vi /var/www/html/.htaccess
</strong></span>
</pre></li><li><p>In the <code class="literal">.htaccess</code> file, add <code class="literal">RewriteEngine</code> to turn on the URL rewriting engine:</p><pre class="programlisting">
<span class="strong"><strong>RewriteEngine on</strong></span>
</pre></li><li><p>Add <code class="literal">Rewrite</code> rules that describe the desired redirects. For example, the following rule redirects all requests without a file extension to a PHP file of the given name:</p><pre class="programlisting">
<span class="strong"><strong>RewriteRule ^/?([A-Z]+)$ $1.php [NC,L]</strong></span>
</pre></li><li><p>Save and close the file.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec275"></a>How it works...</h3></div></div></div><p>The <code class="literal">.htaccess</code> files are supplemental configuration files that reside in the sites' directory structure. When configured, Apache searches for an <code class="literal">.htaccess</code> file and applies the option settings in it while satisfying a request. Of course, searching and loading configuration values for each request does have a slight performance impact, but its trade-off increases flexibility. For example, the server doesn't need to be restarted for configuration changes in an <code class="literal">.htaccess</code> file to take effect. In a shared-hosting environment, savvy clients can tweak the server's behavior for their own sites without asking a server administrator or requiring access to the main configuration files in <code class="literal">/etc/httpd</code> (which may contain sensitive configuration values). Even web applications that rely on specific server features might include an <code class="literal">.htaccess</code> file with the necessary configuration to make its deployment easier.</p><p>Apache doesn't allow the use of the <code class="literal">.htaccess</code> files to override the server's configuration by default. To enable it, we need to update the <code class="literal">AllowOverrides</code> option in the appropriate context and then restart the server. This recipe made the change in the section that applies to the web root directory:</p><pre class="programlisting">
<span class="strong"><strong>    &lt;Directory "/var/www/html"&gt;
    ...
        AllowOverrides All
    ...
    &lt;/Directory&gt;
</strong></span>
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note70"></a>Note</h3><p>If you're using virtual hosting, be sure to put the <code class="literal">AllowOverrides</code> option in your site's configuration file.</p></div><p>A value of <code class="literal">None</code> causes the server to ignore any <code class="literal">.htaccess</code> files. Apart from that, not all options are allowed in an <code class="literal">.httaccess</code> file. The most common ones found in the files pertain to rewriting requests or directory-specific access. Those that can appear are grouped under different categories and we can specify the category of options that will be allowed to be overridden. The possible group names are as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">AuthConfig</code>: This allows overriding the authorization options (<code class="literal">AuthUserFile</code>, <code class="literal">AuthDBMUserFile</code>, and so on)</p></li><li style="list-style-type: disc"><p><code class="literal">FileInfo</code>: This allows overriding request-related options (<code class="literal">ErrorDocument</code>, <code class="literal">Redirect</code>, <code class="literal">RewriteRule</code>, and so on)</p></li><li style="list-style-type: disc"><p><code class="literal">Indexes</code>: These allow index-related options to be overridden (<code class="literal">DirectoryIndex</code>, <code class="literal">IndexOptions</code>, and so on)</p></li><li style="list-style-type: disc"><p><code class="literal">Limit</code>: This allows the access options to be overridden (<code class="literal">Allow</code>, <code class="literal">Deny</code>, and <code class="literal">Order</code>)</p></li><li style="list-style-type: disc"><p><code class="literal">All</code>: This allows overriding all of the option groups</p></li></ul></div><p>Since <code class="literal">AllowOverrides</code> applies to the directory level, it's possible to allow or deny different overrides in different directories. For example, overriding can be disabled across a site, but then the authorization options can be overridden for a <code class="literal">private</code> directory so that the specific authorization databases can be specified:</p><pre class="programlisting">
<span class="strong"><strong>    &lt;Directory "/var/www/html"&gt;
        AllowOverrides None
    &lt;/Directory&gt;
    &lt;Directory "/var/www/html/priv"&gt;
        AllowOverrides AuthConfig
    &lt;/Directory&gt;
</strong></span>
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note71"></a>Note</h3><p>Even if you have full control over Apache and you want to place everything in the main <code class="literal">httpd.conf</code> files for performance reasons, allowing rewrite options to be overridden with <code class="literal">FileInfo</code> lets you devise and troubleshoot your rules without restarting the server after each change. You can then migrate the rules to the main configuration file once you're certain they're correct, and turn off overrides.</p></div><p><code class="literal">rewrite_module</code> injects itself into the server's request handling workflow and can change what the requested URL looks like on the fly, given what we provide in our ruleset. Although the module is installed by default, we still need to explicitly enable URL rewriting with <code class="literal">RewriteEngine on</code>. Beyond that, the two most important rewrite options are <code class="literal">RewriteRule</code> and <code class="literal">RewriteCond</code>.</p><p>The <code class="literal">RewriteRule</code> option specifies a regular expression against which the URL is compared. If it matches, then the given substitution takes place. Positional variables such asÂ <code class="literal">$1</code> can be used in the substitution to reference captured pattern matches. In our recipe, the rule matches the path (such as <code class="literal">/about</code> or <code class="literal">/contactus</code>) and rewrites it to direct the user to a PHP script of the same name (<code class="literal">about.php</code> or <code class="literal">contact.php</code>), thus hiding the fact that we're using PHP from our users:</p><pre class="programlisting">
<span class="strong"><strong>    RewriteRule ^/?([A-Z]+)$ $1.php [NC,L]
</strong></span>
</pre><p>We also can provide flags that affect how the request is returned. The <code class="literal">NC</code> flag, for example, performs the pattern matching case insensitively. The <code class="literal">L</code> flag stops the engine and returns the URL without any further rule processing. Also common are <code class="literal">R</code>, which forces a redirect (an HTTP status code is usually given, for example <code class="literal">R=301</code>), and <code class="literal">QSA</code>, which appends the query string from the original URL to the new URL.</p><p>The <code class="literal">RewriteCond</code> option gives a condition that must pass before evaluating a <code class="literal">RewriteRule</code>. The condition is a mix of regular expression matching, variables, and test operators. Special variables are available which we can use to reference pieces of the URL, such as the hostname (<code class="literal">%{HTTP_HOST}</code>), the requested file (<code class="literal">%{REQUEST_FILENAME}</code>), and the query string (<code class="literal">%{QUERY_STRING}</code>), or details about the environment/request, such as cookies (<code class="literal">%{HTTP_COOKIE</code>}) and user agent strings (<code class="literal">%{HTTP_USER_AGENT}</code>). The <code class="literal">-d</code> operator tests whether the path is a directory, <code class="literal">-f</code> tests whether the path is a file, and <code class="literal">!</code> negates the match. <code class="literal">RewriteCond</code> can also accept a handful of flags, such asÂ <code class="literal">NC</code> flag to make comparison without regard to case sensitivity and the <code class="literal">OR</code> flag to join multiple options in an <span class="emphasis"><em>or</em></span> relationship (multiple options are implicitly treated as <span class="emphasis"><em>and</em></span>).</p><p>A very common rewrite that uses both <code class="literal">RewriteCond</code> and <code class="literal">RewriteRule</code> is one that directs the user to a main <code class="literal">index.php</code> file when the request doesn't match an existing file or directory. This is used a lot with web applications that route all requests through a central control point:</p><pre class="programlisting">
<span class="strong"><strong>    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.*) index.php [L,QSA]
</strong></span>
</pre><p>The first <code class="literal">RewriteCond</code> option checks whetherÂ the request is for an existing file and the second checks the same for an existing directory. If the request is neither for a file nor aÂ directory, then the <code class="literal">RewriteRule</code> option maps the request to <code class="literal">index.php</code>. Any query string that may be present is included and it's marked as the last action, so no further rewriting will be performed.</p><p>Many people jokingly refer to rewriting as black magic. Indeed, it's impressive how powerful <code class="literal">mod_rewrite</code> is and how it transforms requests, and it can be frustrating when you can't seem to figure out the proper incantation to make your rule work as desired. In this case, you may want to turn on logging to gain insight into how the engine views the request. To enable logging, use the <code class="literal">RewriteLog</code> option to specify a log file where messages can be written to, and use <code class="literal">RewriteLogLevel</code> to specify the verbosity. Typically, a value of <code class="literal">5</code> for <code class="literal">RewriteLogLevel</code> is sufficient. They can be added to your <code class="literal">.htaccess</code> file and removed later after you're confident that your rules are correct:</p><pre class="programlisting">
<span class="strong"><strong>    RewriteLog /var/log/httpd/rewrite_log
    RewriteLogLevel 5
</strong></span>
</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec276"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on rewriting URLs:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Apache <code class="literal">mod_rewrite</code> documentation (<a class="ulink" href="http://httpd.apache.org/docs/current/mod/mod_rewrite.html" target="_blank">http://httpd.apache.org/docs/current/mod/mod_rewrite.html</a>)</p></li><li style="list-style-type: disc"><p>URL rewriting guide (<a class="ulink" href="http://httpd.apache.org/docs/2.0/misc/rewriteguide.html" target="_blank">http://httpd.apache.org/docs/2.0/misc/rewriteguide.html</a>)</p></li><li style="list-style-type: disc"><p>URL rewriting for the fearful (<a class="ulink" href="https://24ways.org/2013/url-rewriting-for-the-fearful" target="_blank">https://24ways.org/2013/url-rewriting-for-the-fearful</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch10lvl1sec85"></a>Installing NGINX as a load balancer</h2></div></div><hr /></div><p>High traffic websites can be distributed to different servers, either to better spread out the workload or to achieve redundancy. Each server in the cluster of systems would have their own copy of the website or web application's files and be capable of satisfying the user's request. The trick then is to route the user's request to one of these servers in an orderly fashion. There are different approaches to this, but a common one is to set up a load balancer or reverse proxy server.</p><p>NGINX is somewhat newer to the scene than Apache; written a little over a decade ago specifically to handle high-load connections, it can function as a web server, proxy, cache, and load-balancer. In this recipe, we'll see how to set up NGINX as a load balancer to proxy requests between the client and a cluster of Apache servers.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec277"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection. It assumes that you have other systems configured with Apache to serve a website as described in the earlier recipes; we'll refer to these systems using the IP addresses <code class="literal">192.168.56.20</code> and <code class="literal">192.168.56.30</code>. The package for NGINX is hosted by the EPEL repository; if the repository is not already registered, refer to the <span class="emphasis"><em>Registering the EPEL and Remi repositories</em></span>Â recipe in <a class="link" href="#" linkend="ch04">Chapter 4</a>, <span class="emphasis"><em>Software InstallationÂ Management</em></span>. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec278"></a>How to do it...</h3></div></div></div><p>Follow these steps to set up reverse proxy using NGINX:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Install the <code class="literal">nginx</code> package from the EPEL repository:</p><pre class="programlisting">
<span class="strong"><strong>yum install nginx</strong></span>
</pre></li><li><p>Open the NGINX server's configuration file with your text editor:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/nginx/nginx.conf</strong></span>
</pre></li><li><p>Within the <code class="literal">http</code> block, add a new <code class="literal">upstream</code> block to identify the servers in your cluster:</p><pre class="programlisting">
<span class="strong"><strong>       upstream cluster {
         server 192.168.56.20;
         server 192.168.56.30;
       }
</strong></span>
</pre></li><li><p>Find the <code class="literal">location</code> block and add a <code class="literal">proxy_pass</code> option that references the <code class="literal">upstream</code> block:</p><pre class="programlisting">
<span class="strong"><strong>       location / {
           proxy_pass http://cluster;
       }
</strong></span>
</pre></li><li><p>Save your changes to the configuration and close the file.</p></li><li><p>Start the server and enable it to start automatically when your system reboots:</p><pre class="programlisting">
<span class="strong"><strong>systemctl start nginx.service</strong></span>
<span class="strong"><strong>systemctl enable nginx.service</strong></span>
</pre></li><li><p>Open port <code class="literal">80</code> in the system's firewall to allow HTTP requests through:</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --add-service=http</strong></span>
<span class="strong"><strong>firewall-cmd --reload</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec279"></a>How it works...</h3></div></div></div><p>AsÂ usual, we began by installing the program's package, this time <code class="literal">nginx</code>. The package is available in the EPEL repository. Once installed, we updated its configuration, identifying the servers in our cluster and then proxying requests. First, we added an <code class="literal">upstream</code> block:</p><pre class="programlisting">
<span class="strong"><strong>    upstream cluster {
      server 192.168.56.20;
      server 192.168.56.30;
    }
</strong></span>
</pre><p><code class="literal">cluster</code> is simply a name we assigned to this group of servers so that we can refer to the group by name. You can have multiple upstream blocks if you are balancing multiple clusters. Each <code class="literal">server</code> entry within it gives the IP address or hostname of one of the systems running the site.</p><p>Next, we found the main <code class="literal">location</code> block and added a <code class="literal">proxy_pass</code> parameter. <code class="literal">proxy_pass</code> will forward the incoming request to one of the systems in our cluster group and return the response to satisfy the request:</p><pre class="programlisting">
<span class="strong"><strong>    location / {
        proxy_pass http://cluster;
    }
</strong></span>
</pre><p>Communication between NGINX and the hosting web servers is done over <code class="literal">http</code> since that's the protocol specified in the value for <code class="literal">proxy_pass</code>. This is fine because the clustered systems would be running behind the load balancer on a trusted network. If your site is to be served over HTTPS, it's NGINX that will need to handle the TLS negotiation as it's the public server point seen by the client; the client is unaware of anything behind the balancer.</p><p>To configure NGINX to handle HTTPS requests, within the <code class="literal">server</code> block update the <code class="literal">listen</code> options to listen on port 443. Then add entries with the <code class="literal">ssl_certificate</code> and <code class="literal">ssl_certificate_key</code> options to identify the certificate and key, respectively:</p><pre class="programlisting">
<span class="strong"><strong>    server {
        # listen 80 default_server;
        # listen [::]:80 default_server;
        listen 443 ssl default_server;
        listen [::]:443 ssl default_server;

        ssl_certificate /etc/pki/tls/certs/www.example.pem;
        ssl_certificate_key /etc/pki/tls/private/www.example.key;
    ...
    }
</strong></span>
</pre><p>Once the changes are made and the configuration file is saved, open port <code class="literal">443</code> in your firewall and restart NGINX:</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --add-service=https</strong></span>
<span class="strong"><strong>firewall-cmd --reload</strong></span>
<span class="strong"><strong>systemctctl restart nginx.service</strong></span>
</pre><p>Round-robin is the default approach for load balancing. This means the first request is proxied to the first server in the cluster, then next to the second server, and so on. When NGINX reaches the end of the list, it starts again from the top of the list, proxying the next request to the first server. There are other strategies we can use, for example, weighted balancing.</p><p>To perform weighted balancing, we assign a weight to any of the servers and it will handle that number of requests per iteration. Here, the first server will handle five requestsÂ before NGINX proxies anything to the second server:</p><pre class="programlisting">
<span class="strong"><strong>    upstream cluster {
      server 192.168.56.20 weight=5;
      server 192.168.56.30;
    }
</strong></span>
</pre><p>When using load balancing, remember that any one web server isn't guaranteed to receive the next request sent by a user. If you're balancing access to a web application that uses sessions, this can be problematic. You may want to consider storing session data on a central system that each web server has access to, perhaps using a database such as Redis or Memcache.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note72"></a>Note</h3><p>I recommend that you avoid any balancing strategy that relies on session persistence. The post at <a class="ulink" href="http://www.chaosincomputing.com/2012/05/sticky-sessions-are-evil" target="_blank">http://www.chaosincomputing.com/2012/05/sticky-sessions-are-evil</a> offers a good overview of their problems.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl2sec280"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on working with NGINX and load balancing:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The NGINX website (<a class="ulink" href="https://www.nginx.com/" target="_blank">https://www.nginx.com/</a>)</p></li><li style="list-style-type: disc"><p>How to install NGINX on CentOS 7 (<a class="ulink" href="https://www.digitalocean.com/community/tutorials/how-to-install-nginx-on-centos-7" target="_blank">https://www.digitalocean.com/community/tutorials/how-to-install-nginx-on-centos-7</a>)</p></li><li style="list-style-type: disc"><p>Configuring HTTPS servers (<a class="ulink" href="http://nginx.org/en/docs/http/configuring_https_servers.html" target="_blank">http://nginx.org/en/docs/http/configuring_https_servers.html</a>)</p></li><li style="list-style-type: disc"><p>Using NGINX as a load balancer (<a class="ulink" href="http://nginx.org/en/docs/http/load_balancing.html" target="_blank">http://nginx.org/en/docs/http/load_balancing.html</a>)</p></li><li style="list-style-type: disc"><p>How to store PHP sessions in Memcache (<a class="ulink" href="http://www.scalescale.com/tips/nginx/store-php-sessions-memcached" target="_blank">http://www.scalescale.com/tips/nginx/store-php-sessions-memcached</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="chapter" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="ch11"></a>ChapterÂ 11.Â Safeguarding Against Threats</h2></div></div></div><p>This chapter contains the following recipes:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Sending messages to Syslog</p></li><li style="list-style-type: disc"><p>Rotating log files with logrotate</p></li><li style="list-style-type: disc"><p>Using Tripwire to detect modified files</p></li><li style="list-style-type: disc"><p>Using ClamAV to fight viruses</p></li><li style="list-style-type: disc"><p>Checking for rootkits with chkrootkit</p></li><li style="list-style-type: disc"><p>Using Bacula for network backups</p></li></ul></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch11lvl1sec86"></a>Introduction</h2></div></div><hr /></div><p>From logging your system's activities to sniffing out rootkits, this chapter presents recipes to help protect the investment you've made in your system and its data against various threats. First, you'll learn how to set up a central log server using Syslog, and then, how to rotate log files to make sure that they don't grow out of control. Then, we'll look at how Tripwire is used to detect system intrusion by checking if changes have been made to important system files. This chapter also contains recipes for setting up ClamAV and chkrootkit to keep your system free of viruses, Trojans, rootkits, and other malware. We'll finish with how to set up a centralized backup server using Bacula to safeguard your data from everyday threats such as accidental deletion and hardware failures.</p></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch11lvl1sec87"></a>Sending messages to Syslog</h2></div></div><hr /></div><p>Syslog is a process that listens for messages from other applications and writes them to its log files, providing a common service to handle all logging activity. Messages can also be sent to a running instance of Syslog on a remote system acting as a centralized log server for your entire network. Apart from convenience, centralized logging can be useful for security reasons and also becauseÂ it's harder for an attacker to cover their tracks when it's logged to a second system. In this recipe, you'll learn how to configure local and remote instances of Syslog to run your own log server.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec281"></a>Getting ready</h3></div></div></div><p>This recipe requires two CentOS systems with working network connections. The recipe will refer to the first system as the local system and assume that it is configured with the IP address <code class="literal">192.168.56.100</code> and the hostname <code class="literal">benito</code>. The second system, referred to as the remote system, is assumed to have the address <code class="literal">192.168.56.35</code> and the hostname <code class="literal">logs</code>. The systems should be able to access each other by the hostnames; so, you will need to add the appropriate DNS records or override entries in the systems' <code class="literal">/etc/hosts</code> files. Administrative privileges are also required either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec282"></a>How to do it...</h3></div></div></div><p>To forward log messages from the local system to the remote system, perform the following steps on the local system:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Open Syslog's configuration file using your text editor:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/rsyslog.conf</strong></span>
</pre></li><li><p>At the end of the file, add the following rule:</p><pre class="programlisting">
<span class="strong"><strong>*.*  @logs.example.com</strong></span>
</pre></li><li><p>Save the change and close the configuration file.</p></li><li><p>Restart Syslog for the updated configuration to take effect:</p><pre class="programlisting">
<span class="strong"><strong>systemctl restart rsyslog</strong></span>
</pre></li></ol></div><p>Then, to accept incoming log messages, perform the following steps on the remote system:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Open Syslog's configuration file using your text editor:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/rsyslog.conf</strong></span>
</pre></li><li><p>Locate the <code class="literal">$ModLoad</code> directive responsible for loading the <code class="literal">imudp</code> module and uncomment it by removing the leading <code class="literal">#</code> character. Uncomment the <code class="literal">$UDPServerRun</code> directive that immediately follows it as well:</p><pre class="programlisting">
<span class="strong"><strong>$ModLoad imudp</strong></span>
<span class="strong"><strong>$UDPServerRun 514</strong></span>
</pre></li><li><p>Save the changes and close the configuration file.</p></li><li><p>Restart Syslog for the updated configuration to take effect:</p><pre class="programlisting">
<span class="strong"><strong>systemctl restart rsyslog</strong></span>
</pre></li><li><p>Open the firewall to UDP traffic on port <code class="literal">514</code>:</p><pre class="programlisting">
<span class="strong"><strong>firewall-cmd --zone=public --permanent --add-port=514/udp</strong></span>
<span class="strong"><strong>firewall-cmd --reload</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec283"></a>How it works...</h3></div></div></div><p>Syslog receives messages through several logging facilities, and each message has an assigned priority/severity. Messages can be filtered based on their facility and priority so that the desired messages are relayed while the rest are discarded. A list of facilities and priorities are both outlined in RFC-5424 (the Syslog protocol), and Rsyslog (the version of Syslog available in CentOS) implements most of them.</p><p>Facilities offer a broad categorization designed to organize messages by the type of service that generates them. You can think of them as channels, where a message that logs a user's failed login attempt can be sent over the <code class="literal">auth</code> channel separate from messages logging the restart of a service sent over the <code class="literal">daemon</code> channel. Rsyslog's facilities are the following:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">auth</code>: Security and authorization-related messages</p></li><li style="list-style-type: disc"><p><code class="literal">cron</code>: Messages from cron</p></li><li style="list-style-type: disc"><p><code class="literal">daemon</code>: Messages from system daemons</p></li><li style="list-style-type: disc"><p><code class="literal">kern</code>: Messages from the Linux kernel</p></li><li style="list-style-type: disc"><p><code class="literal">lpr</code>: Messages from the system's printer services</p></li><li style="list-style-type: disc"><p><code class="literal">mail</code>: Messages from the system's mail services</p></li><li style="list-style-type: disc"><p><code class="literal">news</code>: Messages from NTTP services</p></li><li style="list-style-type: disc"><p><code class="literal">syslog</code>: Messages generated by Syslog itself</p></li><li style="list-style-type: disc"><p><code class="literal">user</code>: User-level messages</p></li><li style="list-style-type: disc"><p><code class="literal">uucp</code>: Messages from UUCP services</p></li><li style="list-style-type: disc"><p><code class="literal">local0</code>-<code class="literal">local7</code>: User-level facilities for messages that aren't handled by the other facilities</p></li></ul></div><p>Priorities indicate the severity of the message, for example, a situation that generates an error message is more severe than one generating an informational or debugging message. Rsyslog's priorities are as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">emerg</code>, <code class="literal">panic</code>: The system is unusable</p></li><li style="list-style-type: disc"><p><code class="literal">alert</code>: Immediate action is required</p></li><li style="list-style-type: disc"><p><code class="literal">crit</code>: A critical event happened</p></li><li style="list-style-type: disc"><p><code class="literal">err</code>, <code class="literal">error</code>: An error happened</p></li><li style="list-style-type: disc"><p><code class="literal">warn</code>, <code class="literal">warning</code>: A significant condition is encountered</p></li><li style="list-style-type: disc"><p><code class="literal">notice</code>: Notice messages</p></li><li style="list-style-type: disc"><p><code class="literal">info</code>: Informational messages</p></li><li style="list-style-type: disc"><p><code class="literal">debug</code>: Debugging messages</p></li></ul></div><p>The rules in Syslog's configuration file specify where a log is written to and they are made up of two partsâ€”the first part is a pattern that identifies a facility and priority. It consists of both the facility and priority names separated by a dot, for example, <code class="literal">auth.warn</code> or <code class="literal">local2.debug</code>. More than one facility can be separated by commas, as in <code class="literal">auth,daemon,cron.warn</code>. Additionally, <code class="literal">*</code> can be used as a wildcard to match all facilities or priorities. <code class="literal">auth.*</code> represents messages coming through the <code class="literal">auth</code> facility of any priority, <code class="literal">*.warn</code> represents messages with a priority of <code class="literal">warn</code> or above from any facility, and <code class="literal">*.*</code> represents all messages regardless of facility or priority.</p><p>Messages that match the pattern are processed by the rule's second part, the action. Usually, the action is the location of a file that the message is written to, but it can also discard the message (use <code class="literal">~</code> as the location), send the message to a named pipe to be handled by an external process (prefix the location with <code class="literal">|</code>), or forward the message to another system (give a hostname as the location prefixed with <code class="literal">@</code>).</p><p>Since Rsyslog is installed, the service's configuration file is <code class="literal">/etc/rsyslogd.conf</code>. On the local system we added the following rule:</p><pre class="programlisting">
<span class="strong"><strong>*.*  @logs.example.com</strong></span>
</pre><p>This rule matches all messages and sends them to the server <code class="literal">logs.example.com</code>. One <code class="literal">@</code> means messages will be sent using UDP while two means they will be sent using TCP:</p><pre class="programlisting">
<span class="strong"><strong>*.*  @@archive.example.com</strong></span>
</pre><p>Then, we uncommented the following configuration on the remote system:</p><pre class="programlisting">
<span class="strong"><strong>$ModLoad imudp</strong></span>
<span class="strong"><strong>$UDPServerRun 514</strong></span>
</pre><p><code class="literal">$ModLoad</code> loads a Syslog module, in this case <code class="literal">imudp</code>, which handles incoming messages over UDP. The <code class="literal">$UDPServerRun</code> directive specifies the port which the module listens to for the messages. Traditionally, Syslog messages are sent to port <code class="literal">514</code>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note73"></a>Note</h3><p>Syslog can be configured to transmit messages using TCP, but unless you have specific need to do so, I recommend that you use UDP. UDP is less reliable, but TCP entails more overhead and can result in more severe network congestion during heavy logging events.</p></div><div class="mediaobject"><img src="graphics/image_11_001.jpg" /><div class="caption"><p>The configuration file contains rules to direct messages to different files based on their facility and priorities</p></div></div><p>Many applications are capable of sending messages to Syslog, even if they write to their own log files by default. Some programs do so when given an appropriate argument on the command line, for example, MySQL accepts the <code class="literal">--syslog</code> argument. Others, such as BIND and Apache, require changes in their configuration files. Even the shell scripts you write can send messages to Syslog using the <code class="literal">logger</code> command as follows:</p><pre class="programlisting">
<span class="strong"><strong>logger -n logs.example.com -p user.notice "Test notice"</strong></span>
</pre><p><code class="literal">logger</code> accepts several arguments and then the log message. <code class="literal">-n</code> specifies the server where the message is sent (messages are sent to the local system's Syslog instance when not provided) and <code class="literal">-p</code> specifies the facility and priority for the message.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec284"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on working with Syslog:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The Rsyslog website (<a class="ulink" href="http://www.rsyslog.com/" target="_blank">http://www.rsyslog.com/</a>)</p></li><li style="list-style-type: disc"><p>Basic configuration of Rsyslog (<a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/s1-basic_configuration_of_rsyslog.html" target="_blank">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/s1-basic_configuration_of_rsyslog.html</a>)</p></li><li style="list-style-type: disc"><p>RFC5424: The Syslog protocol (<a class="ulink" href="http://www.rfc-base.org/txt/rfc-5424.tx" target="_blank">http://www.rfc-base.org/txt/rfc-5424.tx</a>t)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch11lvl1sec88"></a>Rotating log files with logrotate</h2></div></div><hr /></div><p>Log files are important because they provide better insight into what is happening on a system. The debugging and error messages in a log can be used to track down the source of a problem and resolve it quickly. Authentication messages maintain a record of who accessed the system and when, and repeated authentication failures can be a sign that an attacker is trying to gain unauthorized access. However, the usefulness of logs typically diminishes with age, and chatty applications that generate a lot of log entries could, if left unchecked, easily consume all of the system's storage resources. This recipe will show you how to rotate the log files to prevent the files from growing out of control and stale logs from wasting space.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec285"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection. Administrative privileges are also required either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec286"></a>How to do it...</h3></div></div></div><p>Follow these steps to configure log file rotation using <code class="literal">logrotate</code>:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Create the <code class="literal">/etc/logrotate.d/example</code> file:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/logrotate.d/example</strong></span>
</pre></li><li><p>Write the following contents to the file:</p><pre class="programlisting">
<span class="strong"><strong>/var/log/example.log {</strong></span>
<span class="strong"><strong>       monthly</strong></span>
<span class="strong"><strong>       rotate 4</strong></span>
<span class="strong"><strong>       missingok</strong></span>
<span class="strong"><strong>       notifempty</strong></span>
<span class="strong"><strong>       create 0600 root root</strong></span>
<span class="strong"><strong>       postrotate</strong></span>
<span class="strong"><strong>           kill -HUP $(cat /var/run/example.pid)</strong></span>
<span class="strong"><strong>       endscript</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></li><li><p>Save your update and close the file.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec287"></a>How it works...</h3></div></div></div><p><code class="literal">logrotate</code> rotates the log files by renaming them as sequential backups and creating a new file for the application to write to. While rotating <code class="literal">example.log</code>, it renames <code class="literal">example.log</code> to <code class="literal">example.log.1</code>. If <code class="literal">example.log.1</code> exists, it renames that file to <code class="literal">example.log.2</code> first (and so on for the other enumerated files).</p><p>For the sake of this example, this recipe created a new configuration to rotate the <code class="literal">/var/log/example.log</code> file. The main configuration file of <code class="literal">logrotate</code> is <code class="literal">/etc/logrotate.conf</code>, while additional files can be placed in the <code class="literal">/etc/logrotate.d</code> directory. You'll want to check <code class="literal">logrotate.d</code> to see if rotation for the application's logs you want to manage is already configured (many packages will drop a configuration file there as a courtesy). You can then update the configuration if the package maintainer's configuration doesn't suit your needs. Directives in the main file set the global behavior, which is overridden on a per-configuration basis by the additional files in <code class="literal">logrotate.d</code>.</p><p>The configuration supplies the name of the targeted log file followed by a braced set of directives that specifies how <code class="literal">logrotate</code> should manage the file. <code class="literal">*</code> can be used as a wildcard to match multiple files which is useful when an application writes to more than one log file. For example, the Apache HTTP server logs messages to <code class="literal">access_log</code> and <code class="literal">error_log</code> in /<code class="literal">var/log/http</code>. So it's configuration targets the log files as follows:</p><pre class="programlisting">
<span class="strong"><strong>/var/log/http/*log {</strong></span>
<span class="strong"><strong>...</strong></span>
<span class="strong"><strong>}</strong></span>
</pre><p>The <code class="literal">monthly</code> directive instructs <code class="literal">logrotate</code> to rotate the files on a monthly basis. Other options are <code class="literal">daily</code>, <code class="literal">weekly</code>, and <code class="literal">yearly</code>. Alternatively, you can instruct <code class="literal">logrotate</code> to manage files based on their sizeâ€”the <code class="literal">size</code> directive specifies a size and <code class="literal">logrotate</code> will rotate those files that are larger than that.</p><pre class="programlisting">
<span class="strong"><strong>size 30k</strong></span>
</pre><p>If a value is given without a unit, the given value is understood as bytes. <code class="literal">logrotate</code> also supports <code class="literal">k</code> for kilobytes, <code class="literal">M</code> for megabytes, and <code class="literal">G</code> for gigabytes.</p><p>The <code class="literal">rotate</code> directive specifies how many log files to keep in the rotation. In our scenario, four files are allowed; so, <code class="literal">example.log.3</code> overwrites <code class="literal">example.log.4</code> and there is no <code class="literal">example.log.5</code>. The <code class="literal">missingok</code> directive lets <code class="literal">logrotate</code> know that it's okay to go on if a log file doesn't exist (its default behavior is to raise an error). Also, the <code class="literal">notifempty</code> directive instructs <code class="literal">logrotate</code> to skip rotating if the file is empty. The <code class="literal">create</code> directive instructs <code class="literal">logrotate</code> to create a new log file after renaming the original and supplies the mode, user, and group for the new file:</p><pre class="programlisting">
<span class="strong"><strong>rotate 4</strong></span>
<span class="strong"><strong>missingok</strong></span>
<span class="strong"><strong>notifempty</strong></span>
<span class="strong"><strong>create 0600 root root</strong></span>
</pre><div class="mediaobject"><img src="graphics/image_11_002.jpg" /><div class="caption"><p>Rotated log files are numbered in sequence</p></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note74"></a>Note</h3><p>The content of the original <code class="literal">example.log.4</code> file doesn't have to be lost. One option is to use the <code class="literal">mail</code> directive to instruct <code class="literal">logrotate</code> to e-mail its contents to you before overwriting it.</p><p>
<span class="strong"><strong><code class="literal">mail tboronczyk@example.com</code></strong></span>
</p><p>Personally though, I recommend using <code class="literal">mail</code> only if the file is relatively small since sending a large file can cause undue strain on the mail server. Also, a log file that contains sensitive information shouldn't be transmitted by e-mail. For sensitive logs and larger files, I recommend using <code class="literal">prerotate</code> to invoke <code class="literal">scp</code> or another utility to copy the file elsewhere before the rotation.</p><pre class="programlisting"><span class="strong"><strong>prerotate</strong></span>
<span class="strong"><strong> scp /var/log/example.log.4Â  storage@archive.example.com:example.log-$ (date +%F)</strong></span>
<span class="strong"><strong>endscript</strong></span></pre></div><p>We can specify external actions to be performed before and after the log files are rotated. The <code class="literal">prerotate</code> directive supplies a set of shell commands that will be executed before the rotation process begins, and the <code class="literal">postrotate</code> directive supplies commands that will be run after rotation. Both directives use <code class="literal">endscript</code> to mark the end of the command set as shown in the preceding tip and in the recipe's configuration. The configuration invokes <code class="literal">kill</code> to send the hang-up signal (<code class="literal">HUP</code>) to the example process which would reload that daemon. Some programs might be confused if the log file they're writing to is moved and recreated, and reloading it causes the program to reopen its connection to the log file so that it can continue logging:</p><pre class="programlisting"><span class="strong"><strong>postrotate</strong></span>
<span class="strong"><strong>    kill -HUP $(cat /var/run/example.pid)</strong></span>
<span class="strong"><strong>endscript</strong></span>
</pre><p><code class="literal">logrotate</code> is run daily via <code class="literal">cron</code>, so once you've created/adjusted your rotation's configuration you should be finished. The next time <code class="literal">logrotate</code> runs, it will pick up the update as it re-reads all of the configuration files.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec288"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on working with <code class="literal">logrotate</code>:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">logrotate</code> manual page (<code class="literal">man 8 logrotate</code>)</p></li><li style="list-style-type: disc"><p>Manage Linux log files with Logrotate (<a class="ulink" href="http://www.techrepublic.com/article/manage-linux-log-files-with-logrotate" target="_blank">http://www.techrepublic.com/article/manage-linux-log-files-with-logrotate</a>)</p></li><li style="list-style-type: disc"><p>How to manage system logs (<a class="ulink" href="http://www.tecmint.com/manage-linux-system-logs-using-rsyslogd-and-logrotate/" target="_blank">http://www.tecmint.com/manage-linux-system-logs-using-rsyslogd-and-logrotate/</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch11lvl1sec89"></a>Using Tripwire to detect modified files</h2></div></div><hr /></div><p>This recipe shows you how to set up Tripwire, an auditing tool for detecting changes made to files on your system. Most often, Tripwire is positioned as an intrusion detection system because the unexpected modification of important configuration files is usually a sign of intrusion or malicious activity. Being able to monitor for such changes gives you the ability to detect and put a stop to malicious activity in a timely manner should it occur.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec289"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection. The <code class="literal">tripwire</code> package is found in the EPEL repository, so the repository must be registered as discussed in <a class="link" href="#" linkend="ch04">Chapter 4</a>, <span class="emphasis"><em>Software Installation Management</em></span>. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec290"></a>How to do it...</h3></div></div></div><p>Follow these steps to monitor for system intrusions using Tripwire:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Install the <code class="literal">tripwire</code> package from the EPEL repository:</p><pre class="programlisting">
<span class="strong"><strong>yum install tripwire</strong></span>
</pre></li><li><p>Run <code class="literal">tripwire-setup-keyfiles</code> to generate Tripwire's keyfiles and configuration and policy files:</p><pre class="programlisting">
<span class="strong"><strong>tripwire-setup-keyfiles</strong></span>
</pre><p>You will be prompted to provide a passphrase for the site keyfile and local keyfiles and then to give the site passphrase again to sign the configuration and policy files that are generated.</p></li><li><p>Initialize Tripwire's database. You will be prompted to provide your local passphrase:</p><pre class="programlisting">
<span class="strong"><strong>tripwire --init 2&gt;output.txt</strong></span>
</pre></li><li><p>Review warnings in the output to identify files that are defined in the policy but do not exist on your system:</p><pre class="programlisting">
<span class="strong"><strong>cat output.txt</strong></span>
</pre></li><li><p>Comment out the entries in <code class="literal">/etc/tripwire/twpol.txt</code> that reference the nonexisting files in <code class="literal">output.txt</code>. If all of the warnings in <code class="literal">output.txt</code> were caused by nonexisting files, then you can automate this step as follows:</p><pre class="programlisting">
<span class="strong"><strong>for f in $(grep "Filename:" output.txt | cut -f2 -d:); do</strong></span>
<span class="strong"><strong>       sed -i "s|\($f\) |#\\1|g" /etc/tripwire/twpol.txt</strong></span>
<span class="strong"><strong>done</strong></span>
</pre></li><li><p>Regenerate the signed policy file. Provide the password for the site keyfile when prompted:</p><pre class="programlisting">
<span class="strong"><strong>twadmin --create-polfile -S /etc/tripwire/site.key
       /etc/tripwire/twpol.txt</strong></span>
</pre></li><li><p>Delete the original database and initialize a new one. This time, the process should finish without generating any warnings:</p><pre class="programlisting">
<span class="strong"><strong>rm /var/lib/tripwire/benito.twd</strong></span>
<span class="strong"><strong>tripwire --init</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec291"></a>How it works...</h3></div></div></div><p>Tripwire audits your system to detect which files have changed. The idea behind this is, if an attacker gains access to your system, they'll inevitably create or modify keyfiles to secure their presence. However, it would be trivial for an attacker to modify Tripwire's policy files to create the illusion that nothing has changed; so, the configuration and policy files are signed with a keyfile. The configuration file, policy file, and the keyfile are all generated when we run:</p><pre class="programlisting">
<span class="strong"><strong>tripwire-setup-keyfiles
</strong></span>
</pre><p>Because the default policy tries to be as comprehensive as possible for most users, there will be entries that aren't applicable to our CentOS system. If we were to run with the unmodified defaults then Tripwire would report the missing files, and sifting through the list of false positives would make it more difficult to identify if someone deleted a file of legitimate concern. Rather than reviewing the policy file manually, especially if you're not an expert and familiar with some of the files, the best approach is to run an initial scan on a system that is known to be clean and then let Tripwire report the nonexistent files. This will help save time as we try to tailor the policy to our system.</p><p>Initializing Tripwire's database is done using <code class="literal">tripwire --init</code>. The program will scan the system, comparing the filesystem with what it knows about in the policy file and collect statistics on the files that do exist. These statistics are stored in the database as a baseline metric for comparison the next time Tripwire runs to see if there have been changes. The recipe redirected the error output containing the list of missing files to a separate text file for two reasons: the list will be lengthy and it's sometimes easier to page through a file than scroll the terminal session, and we can script the process of customizing the policy based on that output:</p><pre class="programlisting">
<span class="strong"><strong>tripwire --init 2&gt;output.txt</strong></span>
</pre><p><code class="literal">sed</code> is the traditional search-and-replace workhorse and <code class="literal">grep</code> is great for finding and extracting lines of interest, so we can use these two tools to update the policy <code class="literal">/etc/tripwire/twpol.txt</code>. First, we need to know what the messages in <code class="literal">output.txt</code> look like:</p><pre class="programlisting">
<span class="strong"><strong>cat output.txt</strong></span>
</pre><div class="mediaobject"><img src="graphics/image_11_003.jpg" /><div class="caption"><p>Nonexistent files generate a warning when initializing the Tripwire database</p></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note75"></a>Note</h3><p>If all of the warnings in the output file are related to nonexistent files then it's safe to automate updating the policy. This is why we then carefully reviewed the contents before continuing.</p></div><p>We use <code class="literal">grep</code> to target the lines containing <code class="literal">Filename:</code> and then use <code class="literal">cut</code> to split the line on the colon and capture the second partâ€”the name of the nonexistent file. The <code class="literal">for</code> loop captures each filename and assigns it to the variable <code class="literal">f</code>, which we can then reference in our pattern to <code class="literal">sed</code>. The pattern performs a global search and replace, using capturing parentheses and numeric back references to overwrite the filename with a leading <code class="literal">#</code>:</p><pre class="programlisting">
<span class="strong"><strong>for f in $(grep "Filename:" output.txt | cut -f2 -d:); do</strong></span>
<span class="strong"><strong>    sed -i "s|\($f\) |#\\1|g" /etc/tripwire/twpol.txt;</strong></span>
<span class="strong"><strong>done</strong></span>
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note76"></a>Note</h3><p>It's important there is a space in the search space after the filename to make sure we only match the entire file. For example, we want to avoid a scenario where <code class="literal">/etc/rc.d</code> will also match <code class="literal">/etc/rc.d/init</code> because of the common prefix.</p></div><p>An unsigned, plain-text copy of the policy is stored at <code class="literal">/etc/tripwire/twpol.txt</code>. After we make our changes, we want to create a signed policy file which is used by Tripwire for the security reasons mentioned earlier. This is done with <code class="literal">twadmin</code> and the <code class="literal">--create-policy</code> argument. The <code class="literal">-S</code> argument provides the command with the path to our signing key and then we supply the plain-texted copy of the policy as the input:</p><pre class="programlisting">
<span class="strong"><strong>twadmin --create-polfile -S /etc/tripwire/site.key
/etc/tripwire/twpol.txt</strong></span>
</pre><p><code class="literal">twadmin</code> will sign the policy and write the result to <code class="literal">/etc/tripwire/tw.pol</code>. After the policy file has been modified we can then reinitialize the database. In fact, any time the policy file is updated you should regenerate the database, which is stored in <code class="literal">/var/lib/tripwire</code> and is named using the system's hostname:</p><pre class="programlisting">
<span class="strong"><strong>rm /var/lib/tripwire/benito.twd</strong></span>
<span class="strong"><strong>tripwire --init</strong></span>
</pre><p>To scan the system for violations, run Tripwire with the <code class="literal">--check</code> option:</p><pre class="programlisting">
<span class="strong"><strong>tripwire --check</strong></span>
</pre><div class="mediaobject"><img src="graphics/image_11_004.jpg" /><div class="caption"><p>Tripwire reports its findings after a scan is performed</p></div></div><p>Of course, to be effective, a scan must be performed at least once a day. For this reason, a cron job is installed in <code class="literal">/etc/cron.daily</code> by the <code class="literal">tripwire</code> package which runs a Tripwire scan. Depending on how cron is configured, the output of the scan will probably be e-mailed by cron to the system's <code class="literal">root</code> user (and will most likely end up in <code class="literal">/var/spool/mail/root</code>). You can edit <code class="literal">/etc/cron.daily/tripwire-check</code> so that the output is e-mailed to you instead:</p><pre class="programlisting">
<span class="strong"><strong>test -f /etc/tripwire/tw.cfg &amp;&amp; /usr/sbin/tripwire --check |
/bin/mailx -s "Tripwire Report" tboronczyk@example.com 2&gt;&amp;1</strong></span>
</pre><p>You can also configure Tripwire to send e-mails itself if you prefer. First, you'll want to ensure that Tripwire can send mail to your address. Issue the following to send a test message and then check to make sure it arrives in your inbox:</p><pre class="programlisting">
<span class="strong"><strong>tripwire --test --email tboronczyk@example.com</strong></span>
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note77"></a>Note</h3><p>You can use supply the <code class="literal">--email-report</code> option when running a manual scan to have Tripwire send its results to your e-mail.</p><p>
<span class="strong"><strong><code class="literal">tripwire --check --email-report</code></strong></span>
</p><p>By default, Tripwire will attempt to send the e-mail via sendmail (or Postfix's sendmail interface). If you need to send the mail through an SMTP server instead, review the <span class="emphasis"><em>Email Notification Variables</em></span> section in <code class="literal">man 4 twconfig</code>.</p></div><p>Specifying the destination e-mail address is a bit more involved in Tripwire's configuration. The tests defined in the Tripwire policy file are grouped into rulesets, which allows files to be grouped together in a logical fashion. For example, there is a ruleset that tests the integrity of the Tripwire binaries themselves, which is separate from the ruleset that tests system administration programs. Each ruleset can have a defined e-mail address to send notifications to, which is great for flexibility where one administrator should be notified of modifications to one set of files and another admin should be notified about others:</p><pre class="programlisting">
<span class="strong"><strong>(</strong></span>
<span class="strong"><strong>  rulename = "Tripwire Binaries",</strong></span>
<span class="strong"><strong>  emailto = tboronczyk@example.com,</strong></span>
<span class="strong"><strong>  severity = $(SIG_HI)</strong></span>
<span class="strong"><strong>)</strong></span>
</pre><p>If you're the only administrator, repeatedly specifying the same address can be tedious. A better approach would define the e-mail address as a global variable and then let the creative use of <code class="literal">sed</code> come to the rescue.</p><p>First, edit <code class="literal">twpol.txt</code> to include the variable assignment for your e-mail address in the global variable definitions section:</p><pre class="programlisting">
<span class="strong"><strong>@@section GLOBAL</strong></span>
<span class="strong"><strong>TWROOT=/usr/sbin;</strong></span>
<span class="strong"><strong>TWBIN=/usr/sbin;</strong></span>
<span class="strong"><strong>TWPOL=/"/etc/tripwire";</strong></span>
<span class="strong"><strong>TWD="/var/lib/tripwire";</strong></span>
<span class="strong"><strong>TWSKEY="/etc/tripwire";</strong></span>
<span class="strong"><strong>TWLKEY="/etc/tripwire";</strong></span>
<span class="strong"><strong>TWREPORT="/var/lib/tripwire/report";</strong></span>
<span class="strong"><strong>HOSTNAME=benito;</strong></span>
<span class="strong"><strong>EMAILADDR="tboronczyk@example.com";</strong></span>
</pre><p>Save the change and close the file. Then, knowing each ruleset contains a <code class="literal">severity</code> directive, we can use a replacement pattern to insert the <code class="literal">mailto</code> directive:</p><pre class="programlisting">
<span class="strong"><strong>sed -i "s|\( \+\)\(severity = \)|\\1mailto =  \$(EMAILADDR),\n\\1\\2|g"
    /etc/tripwire/twpol.txt</strong></span>
</pre><p>The end result should include the <code class="literal">emailto</code> directive in each ruleset's definition:</p><pre class="programlisting">
<span class="strong"><strong>(</strong></span>
<span class="strong"><strong>  rulename = "Tripwire Binaries",</strong></span>
<span class="strong"><strong>  emailto = $(EMAILADDR),</strong></span>
<span class="strong"><strong>  severity = $(SIG_HI)</strong></span>
<span class="strong"><strong>)</strong></span>
</pre><p>After you inspect the results, resign the policy file and reinitialize the database.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec292"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on working with Tripwire:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Introduction to Tripwire (<code class="literal">man 8 twintro</code>)</p></li><li style="list-style-type: disc"><p>Tripwire configuration manual page (<code class="literal">man 4 twconfig</code>)</p></li><li style="list-style-type: disc"><p>Tripwire policy manual page (<code class="literal">man 4 twpolicy</code>)</p></li><li style="list-style-type: disc"><p>Intrusion detection with Tripwire (<a class="ulink" href="http://www.akadia.com/services/tripwire.html" target="_blank">http://www.akadia.com/services/tripwire.html</a>)</p></li><li style="list-style-type: disc"><p>How to set up and use Tripwire (<a class="ulink" href="http://www.linuxjournal.com/article/8758" target="_blank">http://www.linuxjournal.com/article/8758</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch11lvl1sec90"></a>Using ClamAV to fight viruses</h2></div></div><hr /></div><p>The threat from viruses, Trojans, and other forms of malware is real. They have grown exponentially in both quantity and in sophistication, and antivirus software have had to adopt sophisticated detection methods. While there's no guarantee that your system will not fall victim to these unwanted bits of code, remaining mindful when using the Internet and sharing files, implementing common-sense security policies, and using an up-to-date antivirus program can go a long way in protecting you. This recipe will show you how to install ClamAV, the professional-grade open-source antivirus program, keep its threat database up to date, and scan your system.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec293"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection. The ClamAV packages can be found in the EPEL repository, so the repository must be registered as discussed in <a class="link" href="#" linkend="ch04">Chapter 4</a>, <span class="emphasis"><em>Software Installation Management</em></span>. Administrative privileges are also required either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec294"></a>How to do it...</h3></div></div></div><p>Follow these steps to install ClamAV and scan for viruses and Trojans:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Install the <code class="literal">clamav</code> and <code class="literal">clamav-update</code> packages from the EPEL repository:</p><pre class="programlisting">
<span class="strong"><strong>yum install clamav clamav-update</strong></span>
</pre></li><li><p>Open the <code class="literal">freshclam</code> configuration file with your text editor:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/freshclam.conf</strong></span>
</pre></li><li><p>Locate the <code class="literal">Example</code> line and add an <code class="literal">#</code> to the start of its line to comment it out:</p><pre class="programlisting">
<span class="strong"><strong># Comment or remove the line below</strong></span>
<span class="strong"><strong>#Example</strong></span>
</pre></li><li><p>Save the update and close the file.</p></li><li><p>Run <code class="literal">freshclam</code> to update the scanner's threat database:</p><pre class="programlisting">
<span class="strong"><strong>freshclam</strong></span>
</pre></li><li><p>Create a <code class="literal">systemd</code> service file to manage the <code class="literal">freshclam</code> daemon for automate updates:</p><pre class="programlisting">
<span class="strong"><strong>vi /lib/systemd/system/freshclam.service</strong></span>
</pre></li><li><p>Use the following for the file's content:</p><pre class="programlisting">
<span class="strong"><strong>[Unit]</strong></span>
<span class="strong"><strong>Description = freshclam daemon to update clamav</strong></span>
<span class="strong"><strong>After = network.target</strong></span>
<span class="strong"><strong>[Service]</strong></span>
<span class="strong"><strong>Type = forking</strong></span>
<span class="strong"><strong>ExecStart = /usr/bin/freshclam -d</strong></span>
<span class="strong"><strong>Restart = on-failure</strong></span>
<span class="strong"><strong>[Install]</strong></span>
<span class="strong"><strong>WantedBy=multi-user.target</strong></span>
</pre></li><li><p>Force <code class="literal">systemd</code> to reload its services:</p><pre class="programlisting">
<span class="strong"><strong>systemctl daemon-reload</strong></span>
</pre></li><li><p>Start the new <code class="literal">freshclam</code> service and enable it to start when the system reboots:</p><pre class="programlisting">
<span class="strong"><strong>systemctl start freshclam.service</strong></span>
<span class="strong"><strong>systemctl enable freshclam.service</strong></span>
</pre></li><li><p>Scan the files in your <code class="literal">home</code> directory for threats using <code class="literal">clamscan</code>:</p><pre class="programlisting">
<span class="strong"><strong>clamscan -ir /home/tboronczyk</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec295"></a>How it works...</h3></div></div></div><p>First, we installed the <code class="literal">clamav</code> and <code class="literal">clamav-update</code> packages. The <code class="literal">clamav</code> package contains the virus scanner while <code class="literal">clamav-update</code> contains the <code class="literal">freshclam</code> program, which updates ClamAV's virus definitions to keep it up to date:</p><pre class="programlisting">
<span class="strong"><strong>yum install clamav clamav-update</strong></span>
</pre><p><code class="literal">freshclam</code> reads its configuration from <code class="literal">/etc/freshclam.conf</code>. The file contains a line with the word <code class="literal">Example</code> to prevent users from using the defaults blindly and we must remove it or comment it out before we can use <code class="literal">freshclam</code>. The defaults settings are fine for our purposes and this is more of an annoyance than anything else, but it does force us to look at the file and see what behavior can be tweaked. Each directive is commented with an explanation and what the default behavior is.</p><p>Then, we ran <code class="literal">freshclam</code> to update the scanner's databases:</p><pre class="programlisting">
<span class="strong"><strong>freshclam</strong></span>
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note78"></a>Note</h3><p>The process outputs its progress to the terminal and you may see several error messages. For example, it may report that it was unable to download a daily file. Don't panic; <code class="literal">freshclam</code> will try several mirrors. As long as it reports that <code class="literal">main.cvd</code>, <code class="literal">daily.cvd</code>, and <code class="literal">bytecode.cvd</code> are up to date when it's finished you know you have the latest definitions.</p></div><p>We can run <code class="literal">freshclam</code> any time we want to make sure the definition databases are up to date, but it would be inconvenient to have to always run it manually. When launched with the <code class="literal">-d</code> argument, <code class="literal">freshclam</code> will run in the daemon mode and periodically check for updates throughout the day (every two hours by default). To keep things clean, we created a service file to run <code class="literal">freshclam</code> and registered it with <code class="literal">systemd</code>:</p><pre class="programlisting">
<span class="strong"><strong>[Unit]</strong></span>
<span class="strong"><strong>Description = freshclam clamav update daemon</strong></span>
<span class="strong"><strong>After = network.target</strong></span>
<span class="strong"><strong>[Service]</strong></span>
<span class="strong"><strong>Type = forking</strong></span>
<span class="strong"><strong>ExecStart = /usr/bin/freshclam -d</strong></span>
<span class="strong"><strong>Restart = on-failure</strong></span>
<span class="strong"><strong>[Install]</strong></span>
<span class="strong"><strong>WantedBy=multi-user.target</strong></span>
</pre><p>The <code class="literal">[Unit]</code> section defines the basic attributes of the service, such as its description and that it relies on a network connection. The <code class="literal">[Service]</code> section defines the service itself,Â <code class="literal">ExecStart</code> will run <code class="literal">freshclam</code> with the <code class="literal">-d</code> argument, <code class="literal">Type</code> lets systemd know that the process will fork and run in the background as a daemon, and <code class="literal">Restart</code> will have systemd monitor the service and restart it automatically if it crashes. The <code class="literal">[Install]</code> section defines how it will be linked when we run <code class="literal">systemctl enable</code>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note79"></a>Note</h3><p>The system file's content is pretty basic and can be used as a starting point for other custom services you write.</p></div><p>Scanning files for threats is done with <code class="literal">clamscan</code>:</p><pre class="programlisting">
<span class="strong"><strong>clamscan -ir /home/tboronczyk</strong></span>
</pre><p>The <code class="literal">-i</code> argument instructs the scanner to only output infected files as opposed to the name of every file it scans. <code class="literal">-r </code>triggers a recursive scan, descending into subdirectories. The path given can be an individual file to scan or a directory, in this case, our <code class="literal">home</code> directory:</p><div class="mediaobject"><img src="graphics/image_11_005.jpg" /><div class="caption"><p>ClamAV provides a summary of its scan results</p></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note80"></a>Note</h3><p>You can use EICAR's test files from <a class="ulink" href="http://www.eicar.org/85-0-Download.html" target="_blank">http://www.eicar.org/85-0-Download.html</a> to verify if ClamAV is working. Read their intended use page for more information at <a class="ulink" href="http://www.eicar.org/86-0-Intended-use.html" target="_blank">http://www.eicar.org/86-0-Intended-use.html</a>.</p></div><p>ClamAV is generally used in two waysâ€”as a scanner to examine existing files to detect threats or as a filter to detect threats in a stream of data in real time. The easiest way to schedule a reoccurring scan is by setting up a cron job.</p><p>To create a personal cron job that runs <code class="literal">clamav</code> to scan your <code class="literal">home</code> directory, use <code class="literal">crontab</code>:</p><pre class="programlisting">
<span class="strong"><strong>crontab -e</strong></span>
</pre><p><code class="literal">crontab</code> will launch your default editor for you to enter the job schedule. Then <code class="literal">crontab</code> will automatically activate the job after you save the schedule and close the file.</p><p>An example schedule that runs <code class="literal">clamscan</code> every day at 3:00 a.m. might look as follows:</p><pre class="programlisting">
<span class="strong"><strong>0 3 * * * clamscan &gt;&gt; $HOME/clamscan.log</strong></span>
</pre><p>The first five columns specify the time when the job should run. The first column is the time's minutes, the second is hours, the third is the day of the month, the fourth is the month, and last is the day of the week when the job will run. <code class="literal">*</code> is used as a shorthand to indicate the entire range, thus the example will run every day of every month. More information can be found in the man page outlining the format of the <code class="literal">crontab</code> file (<code class="literal">man 5 crontab</code>).</p><p>On a server system, ClamAV is often run as a real-time scanner as a mail filter. Messages are received by the mail server, for example Postfix, and passed off to ClamAV for scanning. Assuming that you're running Postfix, as discussed in <a class="link" href="#" linkend="ch09">Chapter 9</a>, <span class="emphasis"><em>Managing E-mails</em></span>, here's what you'll need to do to set up ClamAV and Postfix to work together.</p><p>First, we need to install some additional packages. The <code class="literal">clamav-scanner-systemd</code> package will install the functionality we need to run <code class="literal">clamscan</code> as a daemon so that it's always available and the <code class="literal">clamav-milter-systemd</code> package installs a mail filter that acts as a proxy between Postfix and the scanner:</p><pre class="programlisting">
<span class="strong"><strong>yum install clamav-scanner-systemd clamav-milter-systemd</strong></span>
</pre><p>Then, edit the configuration file <code class="literal">/etc/clamd.d/scan.conf</code>. Comment out the <code class="literal">Example</code> line and uncomment the <code class="literal">LocalSocket</code> option:</p><pre class="programlisting">
<span class="strong"><strong>LocalSocket /var/run/clamd.scan/clamd.sock</strong></span>
</pre><p>The value given with <code class="literal">LocalSocket</code> is the socket file used by the scanner daemon for communicating with outside processes.</p><p>Next, edit the <code class="literal">/etc/mail/clamav-milter.conf</code> file, which is the configuration file for the <code class="literal">clamav-milter</code> mail filter. Comment out the <code class="literal">Example</code> line, uncomment the first <code class="literal">MilterSocket</code> directive, and add the <code class="literal">ClamdSocket</code> directive. The value for <code class="literal">ClamdSocket</code> should be the same as the <code class="literal">LocalSocket</code> in <code class="literal">scan.conf</code> but prefixed with <code class="literal">unix:</code> to denote that it's a Unix socket:</p><pre class="programlisting">
<span class="strong"><strong>MilterSocket /var/run/clamav-milter/clamav.socket</strong></span>
<span class="strong"><strong>ClamdSocket unix:/var/run/clamd.scan/clamd.sock</strong></span>
</pre><p>Start and enable the scanner daemon and the filter services:</p><pre class="programlisting">
<span class="strong"><strong>system start clamd@scan.service clamav-milter.service</strong></span>
<span class="strong"><strong>system enable clamd@scan.service clamav-milter.service</strong></span>
</pre><p>Finally, open <code class="literal">/etc/postfix/main.cnf</code> and add an <code class="literal">smtpd_milters</code> entry which lets Postfix know about the filter:</p><pre class="programlisting">
<span class="strong"><strong>smtpd_milters=unix:/var/run/clamav-milter/clamav.socket</strong></span>
</pre><p>Don't forget to restart Postfix after updating its configuration:</p><pre class="programlisting">
<span class="strong"><strong>systemctl restart postfix.service</strong></span>
</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec296"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on working with ClamAV:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>ClamAV documentation (<a class="ulink" href="http://www.clamav.net/documents/installing-clamav" target="_blank">http://www.clamav.net/documents/installing-clamav</a>)</p></li><li style="list-style-type: disc"><p>European Institute for Computer Anti-Virus Research (<a class="ulink" href="http://www.eicar.org/" target="_blank">http://www.eicar.org/</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch11lvl1sec91"></a>Checking for rootkits with chkrootkit</h2></div></div><hr /></div><p>In the unfortunate event that an attacker gains access to your system, one of the first things they'll do is try to hide their intrusion while preserving access for as long as possible, perhaps by installing a rootkit. A rootkit is a program that runs stealthily and gives the attacker administrator access. They embed themselves in the Linux kernel to prevent detection, and there are even rootkits that can hide in a system firmware's dedicated memory allowing an attacker to control the system even when it's powered down. This recipe shows you how to check your system for rootkits using chkrootkit.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec297"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection. Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec298"></a>How to do it...</h3></div></div></div><p>Follow these steps to use chkrootkit to check for rootkits:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Install the <code class="literal">gcc</code> and <code class="literal">glibc-static</code> packages that are needed to compile <code class="literal">chkrootkit</code> binaries:</p><pre class="programlisting">
<span class="strong"><strong>yum install gcc glibc-static</strong></span>
</pre></li><li><p>Download <code class="literal">chkrootkit</code> source code:</p><pre class="programlisting">
<span class="strong"><strong>       curl -O ftp://ftp.pangeia.com.br/pub/seg/pac/chkrootkit.tar.gz</strong></span>
</pre></li><li><p>Extract the downloaded source code archive and enter into the code's directory:</p><pre class="programlisting">
<span class="strong"><strong>tar xzvf chkrootkit.tar.gz</strong></span>
<span class="strong"><strong>cd chkrootkit-0.50</strong></span>
</pre></li><li><p>Run make to compile chkrootkit's binary components:</p><pre class="programlisting">
<span class="strong"><strong>make</strong></span>
</pre></li><li><p>chkrootkit requires <code class="literal">netstat</code> to conduct its network tests which is available in the <code class="literal">net-tools</code> package:</p><pre class="programlisting">
<span class="strong"><strong>yum install net-tools</strong></span>
</pre></li><li><p>Run chkrootkit to scan for rootkits:</p><pre class="programlisting">
<span class="strong"><strong>./chkrootkit</strong></span>
</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec299"></a>How it works...</h3></div></div></div><p>chkrootkit consists of a shell script and a small collection of compiled utilities distributed as source code so we need to compile it. This means you'll need a compiler installed on your system. Minimally, <code class="literal">gcc</code> will suffice. Also, we need to install the <code class="literal">glibc-static</code> package because the project's <code class="literal">Makefile</code> builds a statically compiled binaryâ€”all of the binaries' dependencies are compiled in; it doesn't dynamically reference the copy of the system's shared libraries:</p><pre class="programlisting">
<span class="strong"><strong>yum install gcc glibc-static</strong></span>
</pre><p>The source code for chkrootkit is available on the project's website. The link used in the recipe is a direct link to the latest source archive and is downloaded using <code class="literal">curl</code>:</p><pre class="programlisting">
<span class="strong"><strong>curl -O ftp://ftp.pangeia.com.br/pub/seg/pac/chkrootkit.tar.gz</strong></span>
</pre><p>Once the download is complete, building chkrootkit's is a matter of extracting the archive, entering into the newly created directory, and running <code class="literal">make</code>:</p><pre class="programlisting">
<span class="strong"><strong>make</strong></span>
</pre><p>When you learned how to compile a program from source code in the <span class="emphasis"><em>Compiling a program from source</em></span> recipe of <a class="link" href="#" linkend="ch04">Chapter 4</a>, <span class="emphasis"><em>Software Installation Management</em></span>, you used the common <code class="literal">configure</code>, <code class="literal">make</code>, and <code class="literal">make install</code> approach. However, chkrootkit doesn't ship with a configure script and its <code class="literal">Makefile</code> doesn't contain an <code class="literal">install</code> target. All we need to do here to kick off the compilation process is invoke <code class="literal">make</code> itself.</p><p>chkrootkit runs a series of tests to check for known rootkit signatures. Some of these tests use its compiled utilities while others use common system utilities. One of its network tests checks which ports are open using <code class="literal">netstat</code>, which is not installed by default on CentOS but is available in the <code class="literal">net-tools</code> package. So, before we can use chkrootkit, we need to install this dependency:</p><pre class="programlisting">
<span class="strong"><strong>   yum install net-tools</strong></span>
</pre><p>Once everything is installed, we can execute the chkrootkit script. When run without any arguments, chkrootkit executes all of its tests. Otherwise, we can specify one or more tests and only those will run. The <code class="literal">-l</code> (lowercase L) argument will display a list of possible tests:</p><pre class="programlisting">
<span class="strong"><strong>   ./chkrootkit -l</strong></span>
</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec300"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on working with chkrootkit:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The chkrootkit website (<a class="ulink" href="http://www.chkrootkit.org" target="_blank">http://www.chkrootkit.org</a>)</p></li><li style="list-style-type: disc"><p>Chkrootkit: check your system for hidden rootkits (<a class="ulink" href="https://www.youtube.com/watch?v=IdvdUv0Nsq4" target="_blank">https://www.youtube.com/watch?v=IdvdUv0Nsq4</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch11lvl1sec92"></a>Using Bacula for network backups</h2></div></div><hr /></div><p>The fact of the matter is that we are living in a world that is becoming increasingly dependent on data. Also, from accidental deletion to a catastrophic hard drive failure, there are many threats to the safety of your data. The more important your data is and the more difficult it is to recreate if it were lost, the more important it is to have backups. So, this recipe shows you how you can set up a backup server using Bacula and how to configure other systems on your network to backup their data to it.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec301"></a>Getting ready</h3></div></div></div><p>This recipe requires at least two CentOS systems with working network connections. The first system is the local system which we'll assume has the hostname <code class="literal">benito</code> and the IP address <code class="literal">192.168.56.41</code>. The second system is the backup server. You'll need administrative access on both systems, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec302"></a>How to do it...</h3></div></div></div><p>Perform the following steps on your local system to install and configure the Bacula file daemon:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Install the <code class="literal">bacula-client</code> package:</p><pre class="programlisting">
<span class="strong"><strong>       yum install bacula-client</strong></span>
</pre></li><li><p>Open the file daemon's configuration file with your text editor:</p><pre class="programlisting">
<span class="strong"><strong>       vi /etc/bacula/bacula-fd.conf</strong></span>
</pre></li><li><p>In the <code class="literal">FileDaemon</code> resource, update the value of the <code class="literal">Name</code> directive to reflect the system's hostname with the suffix <code class="literal">-fd</code>:</p><pre class="programlisting">
<span class="strong"><strong>       FileDaemon {
         Name = benito-fd
       ...
       }</strong></span>
</pre></li><li><p>Save the changes and close the file.</p></li><li><p>Start the file daemon and enable it to start when the system reboots:</p><pre class="programlisting">
<span class="strong"><strong>       systemctl start bacula-fd.service
       systemctl enable bacula-fd.service
</strong></span>
</pre></li><li><p>Open the firewall to allow TCP traffic through to port <code class="literal">9102</code>:</p><pre class="programlisting">
<span class="strong"><strong>       firewall-cmd --zone=public --permanent --add-port=9102/tcp
       firewall-cmd --reload</strong></span>
</pre></li><li><p>Repeat steps 1-6 on each system that will be backed up.</p></li></ol></div><p>Perform the following steps on the system designated as the backup server to install and configure the Bacula director, storage, and file daemons.</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Install the <code class="literal">bacula-console</code>, <code class="literal">bacula-director</code>, <code class="literal">bacula-storage</code>, and <code class="literal">bacula-client</code> packages:</p><pre class="programlisting">
<span class="strong"><strong>yum install bacula-console bacula-director bacula-storage
       bacula-client</strong></span>
</pre></li><li><p>Re-link the catalog library to use SQLite database storage:</p><pre class="programlisting">
<span class="strong"><strong>alternatives --config libbaccats.so</strong></span>
</pre></li><li><p>Type 2 when asked to provide the selection number.</p></li><li><p>Create the SQLite database file and import the table schema:</p><pre class="programlisting">
<span class="strong"><strong>       /usr/libexec/bacula/create_sqlite3_database
       /usr/libexec/bacula/make_sqlite3_tables
</strong></span>
</pre></li><li><p>Open the director's configuration file with your text editor:</p><pre class="programlisting">
<span class="strong"><strong>vi /etc/bacula/bacula-dir.conf</strong></span>
</pre></li><li><p>In the <code class="literal">Job</code> resource where <code class="literal">Name</code> has the value <code class="literal">BackupClient1</code>, change the value of the <code class="literal">Name</code> directive to reflect one of the local systems. Then add a <code class="literal">Client</code> directive with a value that matches that system's <code class="literal">FileDaemon</code><code class="literal">Name</code>:</p><pre class="programlisting">
<span class="strong"><strong>       Job {
         Name = "BackupBenito"
         Client = benito-fd
         JobDefs = "DefaultJob"
       }</strong></span>
</pre></li><li><p>Duplicate the <code class="literal">Job</code> resource and update its directive values as necessary so that there is a <code class="literal">Job</code> resource defined for each system to be backed up.</p></li><li><p>For each system that will be backed up, duplicate the <code class="literal">Client</code> resource where the <code class="literal">Name</code> directive is set to <code class="literal">bacula-fd</code>. In the copied resource, update the <code class="literal">Name</code> and <code class="literal">Address</code> directives to identify that system:</p><pre class="programlisting">
<span class="strong"><strong>       Client {
         Name = bacula-fd
         Address = localhost
         ...
       }
 Â Â Â Â Â  Client {
   Â Â Â Â Â  Name = benito-fd
   Â Â Â Â Â  Address = 192.168.56.41
   Â Â Â Â Â  ...
 Â Â Â Â Â  }
 Â Â Â Â Â  Client {
   Â Â Â Â Â  Name = javier-fd
   Â Â Â Â Â  Address = 192.168.56.42
   Â Â Â Â Â  ...
 Â Â Â Â Â  }</strong></span>
</pre></li><li><p>Save your changes and close the file.</p></li><li><p>Open the storage daemon's configuration file:</p><pre class="programlisting">Â Â Â Â Â Â  <span class="strong"><strong>vi /etc/bacula/bacula-sd.conf
</strong></span>
</pre></li><li><p>In the <code class="literal">Device</code> resource where <code class="literal">Name</code> has the value <code class="literal">FileStorage</code>, change the value of the <code class="literal">Archive Device</code> directive to <code class="literal">/bacula</code>:</p><pre class="programlisting">Â Â Â Â Â Â  <span class="strong"><strong>Device {
   Â Â Â Â Â  Name = FileStorage
   Â Â Â Â Â  Media Type = File
   Â Â Â Â Â  Archive Device = /bacula
 Â Â Â Â Â  ...</strong></span>
</pre></li><li><p>Save the update and close the file.</p></li><li><p>Create the <code class="literal">/bacula</code> directory and assign it the proper ownership:</p><pre class="programlisting">Â Â Â Â Â Â <span class="strong"><strong> mkdir /bacula
 Â Â Â Â Â  chown bacula:bacula /bacula</strong></span>
</pre></li><li><p>If you have SELinux enabled, reset the security context on the new directory:</p><pre class="programlisting">
<span class="strong"><strong>Â Â Â Â Â Â  restorecon -Rv /bacula</strong></span>
</pre></li><li><p>Start the director and storage daemons and enable them to start when the system reboots:</p><pre class="programlisting">Â Â Â Â Â Â <span class="strong"><strong> systemctl start bacula-dir.service bacula-sd.service
       bacula-fd.service
 Â Â Â Â Â  systemctl enable bacula-dir.service bacula-sd.service
       bacula-fd.service</strong></span>
</pre></li><li><p>Open the firewall to allow TCP traffic through to ports <code class="literal">9101-9103</code>:</p><pre class="programlisting">Â Â Â Â Â Â  <span class="strong"><strong>firewall-cmd --zone=public --permanent --add-port=9101-9103/tcp
 Â Â Â Â Â  firewall-cmd -reload</strong></span>
</pre></li><li><p>Launch Bacula's console interface:</p><pre class="programlisting">Â Â Â Â Â Â <span class="strong"><strong> bconsole
</strong></span>
</pre></li><li><p>Enter <code class="literal">label</code> to create a destination for the backup. When prompted for the volume name, use <code class="literal">Volume0001</code> or a similar value. When prompted for the pool, select the <code class="literal">File</code> pool:</p><pre class="programlisting">Â Â Â Â Â Â <span class="strong"><strong> label
</strong></span>
</pre></li><li><p>Enter <code class="literal">quit</code> to leave the console interface.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec303"></a>How it works</h3></div></div></div><p>Configuring Bacula can be a daunting task for the most part because of the suite's distributed architecture and the level of flexibility it offers in organizing and scheduling backup and restore jobs. However, once everything is up and running, I'm sure you'll have peace of mind knowing that your data is safe from accidents and disasters.</p><p>Bacula is made up of several components. In this recipe, our efforts were centered on three daemonsâ€”the director, the file daemon, and the storage daemon. The file daemon is installed on each of the client systems to be backed up and listens for connections from the director. The director connects to each file daemon as scheduled and tells it which files to backup and where to copy them to (the storage daemon). The storage daemon receives the backed up data and writes it to the backup medium, for example, the disk or tape drive.</p><p>First, we installed the file daemon with the <code class="literal">bacula-client</code> package on our client systems. Then we edited the file daemon's configuration file found at <code class="literal">/etc/bacula/bacula-fd.conf</code> to specify the name of the process. The convention is to add the suffix <code class="literal">-fd</code> to the system's hostname:</p><pre class="programlisting">
<span class="strong"><strong>    FileDaemon {
      Name = benito-fd
      FDPort = 9102
      WorkingDirectory = /var/spool/bacula
      Pid Directory = /var/run
      Maximum Concurrent Jobs = 20
    }</strong></span>
</pre><p>After the update is made to the configuration, we started the service and opened the appropriate port in the system firewall. The file daemon is now listening, waiting for the director to connect and tell it what it needs to do.</p><p>On the backup server, we installed the <code class="literal">bacula-director</code>, <code class="literal">bacula-storage</code>, and <code class="literal">bacula-client</code> packages. This gives us the director and storage daemon, and another file daemon. The file daemon's purpose here on the backup server is to backup Bacula's catalog:</p><div class="mediaobject"><img src="graphics/image_11_006.jpg" /><div class="caption"><p>This image reproduced from Bacula's documentation shows how the different applications relate to one another</p></div></div><p>Bacula maintains a database of metadata about previous backup jobs called the catalog, which can be managed by MySQL, PostgreSQL, or SQLite. SQLite is an embedded database library, meaning the program using it links against the SQLite library and manages its own database files. To support multiple databases, Bacula's code is written so that all the database access routines are contained in separate shared libraries with a different library for each database. Then, when Bacula wants to interact with a database, it does so through <code class="literal">libbaccats.so</code>, a <span class="emphasis"><em>fake</em></span> library that is nothing more than a symbolic link pointing to one of the specific database libraries. This let's Bacula support different databases without requiring us to recompile its source code.</p><p>To create the symbolic link, we usedÂ <code class="literal">alternatives</code> and select the real library that we want to use:</p><pre class="programlisting">
<span class="strong"><strong>    alternatives --config libbaccats.so</strong></span>
</pre><p>Then, we initialized the database's schema using the scripts that come with Bacula:</p><pre class="programlisting">
<span class="strong"><strong>    /usr/libexec/bacula/create_sqlite3_database
    /usr/libexec/bacula/make_sqlite3_tables</strong></span>
</pre><div class="mediaobject"><img src="graphics/image_11_007.jpg" /><div class="caption"><p>Bacula supports multiple databases without recompiling</p></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note81"></a>Note</h3><p>This recipe took advantage of Bacula's SQLite support because it's convenient and doesn't require additional effort to set up. If you want to use MySQL, install MySQL as discussed in <a class="link" href="#" linkend="ch07">Chapter 7</a>, <span class="emphasis"><em>Working with Databases</em></span>, create a dedicated MySQL user for Bacula to use, and then initialize the schema with the following scripts:</p><pre class="programlisting"><span class="strong"><strong>/usr/libexec/bacula/grant_mysql_privileges</strong></span>
<span class="strong"><strong> /usr/libexec/bacula/create_mysql_database</strong></span>
<span class="strong"><strong> /usr/libexec/bacula/make_mysql_tables</strong></span></pre><p>You'll also need to review Bacula's configuration files to provide Bacula with the required MySQL credentials.</p></div><p>Different resources are defined in the director's configuration file at <code class="literal">/etc/bacula/bacula-dir.conf</code>, many of which consist not only of their own values but also reference to other resources. For example, the <code class="literal">FileSet</code> resource specifies which files are included or excluded in backups and restores, while a <code class="literal">Schedule</code> resource specifies when backups should be made. A <code class="literal">JobDef</code> resource can contain various configuration directives that are common to multiple backup jobs and also reference particular <code class="literal">FileSet</code> and <code class="literal">Schedule</code> resources. <code class="literal">Client</code> resources identify the names and addresses of systems running file daemons, and a <code class="literal">Job</code> resource will pull together a <code class="literal">JobDef</code> and <code class="literal">Client</code> resource to define the backup or restore task for a particular system. Some resources define things at a more granular level and are used as building blocks to define other resources, creating complex definitions in a flexible manner.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip82"></a>Note</h3><p>The default resource definitions define basic backup and restore jobs sufficient for this recipe. You'll want to study the configuration and see how the different resources fit together so you can tweak them to better suit your backup needs.</p></div><div class="mediaobject"><img src="graphics/image_11_008.jpg" /><div class="caption"><p>This image, reproduced from Bacula's documentation shows, how the different resources relate to one another</p></div></div><p>To get started, we customized the existing backup <code class="literal">Job</code> by changing its name and client. Then we customized the existing <code class="literal">Client</code> resource by changing its name and address to point to a specific system running a file daemon. The pair of <code class="literal">Job</code> and <code class="literal">Client</code> resources were duplicated, a pair for each system we're backing up. Notice that we also left a default <code class="literal">Client</code> resource that defines <code class="literal">bacula-fd</code> for the localhost. This is the file daemon that's local to the backup server and will be the target for things such as restore jobs and catalog backups:</p><pre class="programlisting">Â Â Â  <span class="strong"><strong>Job {
   Â Â  Name = "BackupBenito"
   Â Â  Client = benito-fd
   Â Â  JobDefs = "DefaultJob"
 Â Â  }

 Â Â  Job {
   Â Â  Name = "BackupJavier"
   Â Â  Client = javier-fd
   Â Â  JobDefs = "DefaultJob"
 Â Â  }

 Â Â  Client {
   Â Â  Name = bacula-fd
   Â Â  Address = localhost
   Â Â  ...
 Â Â  }

 Â Â  Client {
   Â Â  Name = benito-fd</strong></span>
<span class="strong"><strong> Â Â  Address = 192.168.56.100
   Â Â  ...
 Â Â  }

 Â Â  Client {
   Â Â  Name = javier-fd
   Â Â  Address = 192.168.56.100
   Â Â  ...
 Â Â  }</strong></span>
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="tip83"></a>Note</h3><p>If you have a lot of client systems or a lot of job definitions, you can stay better organized by defining these resources in their own files and read them into <code class="literal">bacula-dir.conf</code>. Create the directory <code class="literal">/etc/bacula/config.d</code>, and place the individual configuration files there. Then add the following line to <code class="literal">bacula-dir.conf</code> to read them:</p><p><span class="strong"><strong><code class="literal">@|"find /etc/bacula/config.d -name '*.conf' f -exec echo @{} \;" </code></strong></span></p></div><p>To complete the setup, we need to label a backup volume. This task, as with most others, is performed through <code class="literal">bconsole</code>, a console interface to the Bacula director.</p><p>We used the <code class="literal">label</code> command to define a label for the backup volume, and when prompted for the pool, we assigned the labeled volume to the <code class="literal">File</code> pool. In a way very similar to how logical volumes work (refer to <a class="link" href="#" linkend="ch05">Chapter 5</a>, <span class="emphasis"><em>Managing Filesystems and Storage</em></span>), an individual device or storage unit is allocated as a volume and the volumes are grouped into storage pools. If a pool contains two volumes backed by tape drives for example, and one of the drives is full, the storage daemon will write the backup data to the tape that has space available. Even though in our configuration we're storing the backup to disk, we still need to create a volume as the destination for data to be written to.</p><p>At this point, you should consider which backup strategy works best for you. A full backup is a complete copy of your data, a differential backup captures only the files that have changed since the last full backup, and an incremental backup copies the files that have changed since the last backup (regardless of the type of backup). Commonly, administrators employ a combination of these, perhaps making a full backup at the start of the week and then differential or incremental backups each day thereafter. This saves storage space because the differential and incremental backups are smaller and also convenient when the need to restore a file arises, because a limited number of backups need to be searched for the file.</p><p>Another consideration is the expected size of each backup and how long it will take for the backup to run to completion. Full backups obviously take longer to run, and in an office with 9-5 working hours, Monday through Friday, it may not be possible to run a full backup during the evenings. Performing a full backup on Fridays gives the backup time over the weekend to run. Smaller, incremental backups can be performed on the other days when time is lesser.</p><p>Still another point that is important in your backup strategy is how long the backups will be kept and where they will be kept. This touches on a larger issue, disaster recovery. If your office burns down, a year's worth of backups will be of no use if they were sitting in the office's IT closet. At one employer, we kept the last full backup and last day's incremental on a disk on site. These were then duplicated to tape and shipped off site.</p><p>Regardless of the strategy you choose to implement, your backups are only as good as your ability to restore data from them. You should periodically test your backups to make sure you can restore your files.</p><p>To run a backup job on demand, enter <code class="literal">run</code> in <code class="literal">bconsole</code>. You'll be prompted with a menu to select one of the current configured jobs. You'll then be presented with the job's options, such as what level of backup will be performed (full, incremental, or differential), it's priority, and when it will run. You can type <code class="literal">yes</code> or <code class="literal">no</code> to accept or cancel it or <code class="literal">mod</code> to modify a parameter. Once accepted, the job will be queued and assigned a job ID.</p><p>To restore files from a backup, use the <code class="literal">restore</code> command. You'll be presented with a list of options allowing you to specify which backup the desired files will be retrieved from. Depending on your selection, the prompts will be different. Bacula's prompts are rather clear, so read them carefully and it will guide you through the process.</p><p>Apart from the <code class="literal">run</code> and <code class="literal">restore</code> commands, another useful command is <code class="literal">status</code>. It will allow you to see the current status of the Bacula components, if there are any jobs currently running, and which jobs have completed. A full list of commands can be retrieved by typing <code class="literal">help</code> in <code class="literal">bconsole</code>.</p><div class="mediaobject"><img src="graphics/image_11_009.jpg" /><div class="caption"><p>bconsole is a console interface to the Bacula director</p></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch11lvl2sec304"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on working with Bacula:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Bacula documentation (<a class="ulink" href="http://blog.bacula.org/documentation/" target="_blank">http://blog.bacula.org/documentation/</a>)</p></li><li style="list-style-type: disc"><p>How to use Bacula on CentOS 7 (<a class="ulink" href="https://www.digitalocean.com/community/tutorial_series/how-to-use-bacula-on-centos-7" target="_blank">https://www.digitalocean.com/community/tutorial_series/how-to-use-bacula-on-centos-7</a>)</p></li><li style="list-style-type: disc"><p>Bacula-Web (a web-based reporting and monitoring tool for Bacula) (<a class="ulink" href="http://www.bacula-web.org/" target="_blank">http://www.bacula-web.org/</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="chapter" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="ch12"></a>ChapterÂ 12.Â Virtualization</h2></div></div></div><p>This chapter contains the following recipes:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>Creating a new virtual machine</p></li><li style="list-style-type: disc"><p>Cloning a virtual machine</p></li><li style="list-style-type: disc"><p>Adding storage to a virtual machine</p></li><li style="list-style-type: disc"><p>Connecting USB peripherals to a guest system</p></li><li style="list-style-type: disc"><p>Configuring a guest's network interface</p></li></ul></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch12lvl1sec93"></a>Introduction</h2></div></div><hr /></div><p>The recipes in this chapter focus on running a second operating system as a guest using virtualization on your CentOS system. You'll learn how to setup the virtual machine to install a guest operating system, properly create a copy of the machine through cloning, and add additional storage resources. You'll also learn how to share access to USB peripherals attached to the host system and configure the guest's virtual network interface to access the network.</p></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch12lvl1sec94"></a>Creating a new virtual machine</h2></div></div><hr /></div><p>This recipe teaches you how to install the KVM virtualization software and create a new virtual machine. Virtualization allows us to take advantage of the hardware resources available to us by running multiple operating systems on the same physical system. The primary operating system is installed "bare-metal" and is known as the host OS. Then, special software is installed that allows the host to provide emulation or direct access to hardware resources. The resources are partitioned as virtual machines and several guest operating systems can then be installed and run on top of the host, each in their own virtual machine.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec305"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection and a graphical user interface installed (refer to the <span class="emphasis"><em>Installing the GNOME desktop</em></span> and <span class="emphasis"><em>Installing the KDE Plasma desktop</em></span> recipes in <a class="link" href="#" linkend="ch01">Chapter 1</a>, <span class="emphasis"><em>Getting Started with CentOS</em></span>). Administrative privileges are also required, either by logging in with the <code class="literal">root</code> account or through the use of <code class="literal">sudo</code>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec306"></a>How to do it...</h3></div></div></div><p>Follow these steps to install a guest operating system:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Install the necessary virtualization packages using package groups:</p><pre class="programlisting">
<span class="strong"><strong>yum groupinstall "Virtualization Platform"
       "Virtualization Client" "Virtualization Tools"</strong></span>
</pre></li><li><p>Launch the Virtual Machine Manager application:</p><pre class="programlisting">
<span class="strong"><strong>       virt-manager</strong></span>
</pre></li><li><p>Create a new virtual machine by selecting <span class="strong"><strong>New Virtual Machine</strong></span> from the <span class="strong"><strong>File</strong></span> menu. This opens the <span class="strong"><strong>New VM</strong></span> wizard.</p></li><li><p>Select the desired installation method and click on <span class="strong"><strong>Forward</strong></span>. For this recipe, we'll choose the <span class="strong"><strong>Local install media</strong></span> option:</p><div class="mediaobject"><img src="graphics/image_12_001.jpg" /><div class="caption"><p>The New VM wizard collects the necessary details to create a new machine</p></div></div></li><li><p>Select the media source. If the media is a CD or DVD, select the <span class="strong"><strong>Use CDROM or DVD</strong></span> option. If the media is an ISO file, select the <span class="strong"><strong>Use ISO image</strong></span> option and specify the path to the image file. Then, click on <span class="strong"><strong>Forward</strong></span>:</p><div class="mediaobject"><img src="graphics/image_12_002.jpg" /><div class="caption"><p>The new machine will use an ISO file as its installation media</p></div></div></li><li><p>Set the amount of RAM and the number of CPUs that you want to allocate to the virtual machine and then click on <span class="strong"><strong>Forward</strong></span>:</p><div class="mediaobject"><img src="graphics/image_12_003.jpg" /><div class="caption"><p>1 GB of RAM and 1 CPU areÂ allocated to the virtual machine</p></div></div></li><li><p>Specify the storage capacity that will be allocated to the machine and then click on <span class="strong"><strong>Forward</strong></span>:</p><div class="mediaobject"><img src="graphics/image_12_004.jpg" /><div class="caption"><p>The machine is set up with 8 GB of storage</p></div></div></li><li><p>Provide a name to identify the virtual machine and click on <span class="strong"><strong>Finish</strong></span>:</p><div class="mediaobject"><img src="graphics/image_12_005.jpg" /><div class="caption"><p>The wizard is ready to create the virtual machine and boot the installation media</p></div></div></li><li><p>The virtual machine will automatically start and boot from the specified installation media. You can now proceed with installing your guest operating system in the machine as if it were a physical system:</p><div class="mediaobject"><img src="graphics/image_12_006.jpg" /><div class="caption"><p>An operating system can be installed on the virtual machine the same way as a physical system</p></div></div></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec307"></a>How it works...</h3></div></div></div><p>The necessary software is installed by installing three package groups; the <code class="literal">Virtualization Platform</code> group installs the base virtualization libraries, the <code class="literal">Virtualization Client</code> package installs client programs for creating and managing virtual machines, and the <code class="literal">Virtualization Tools</code> package installs utilities for maintaining the machines:</p><pre class="programlisting">
<span class="strong"><strong>yum groupinstall "Virtualization Platform"
"Virtualization Client"  "Virtualization Tools"</strong></span>
</pre><p>After installing the software, we used the Virtual Machine Manager to create a machine. The machine defines a virtual system, specifying what resources are available to the guest and how the guest may access them. Under the GNOME desktop environment, the manager is launched from the <span class="strong"><strong>System Tools</strong></span> category of the <span class="strong"><strong>Applications</strong></span> menu. In KDE, it's found via the Kickoff Application Launcher under <span class="strong"><strong>Applications</strong></span> | <span class="strong"><strong>System Tools</strong></span>. The manager can also be launched from the command line with <code class="literal">virt-manager</code>:</p><pre class="programlisting">
<span class="strong"><strong>virt-manager</strong></span>
</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note84"></a>Note</h3><p>A new virtual machine can be created on the command line as well, using <code class="literal">virt-install</code> and specifying the resource allocations as arguments. This is especially useful if you want to script the process of spinning up new guests.</p></div><p>The manager's new VM makes it easy to create a new virtual machine definition by prompting us for the necessary resource allocations. For instance, we're asked to provide the amount of RAM, the number of CPUs, and the amount of storage space to make available to the guest. After we provide the values, it creates the machine and starts it, booting from the specified installation media to install the guest operating system. From there, installing the operating system is the same as if you were installing it on a physical system.</p><p>To boot a virtual machine, select the desired machine from the available list so that it's highlighted and then click on the play arrow icon in the manager's tool bar. Alternatively, right-click on the list entry and select <span class="strong"><strong>Run</strong></span> from the context menu. This powers on the machine and its status changes to <span class="emphasis"><em>Running</em></span>. When you're finished, you can power the machine off by clicking on the power switch icon in the tool bar or on one of the <span class="strong"><strong>Shut Down</strong></span> options from the context menu. The machine's status changes to <span class="emphasis"><em>Shut off</em></span>. To interact with the guest while it's running, double-click on the entry or highlight it and then click on the Open icon in the manager's tool bar.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note85"></a>Note</h3><p>Scrollbars will appear on the side and bottom of the window if the guest's display is too large to show in its entirety. Scaling it to fit within the window can improve your experience. To adjust the display's presentation, select <span class="strong"><strong>Display</strong></span> from <span class="strong"><strong>View</strong></span>.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec308"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on working with virtual machines:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">virt-install</code>Â manual page (<code class="literal">man 1 virt-install</code>)</p></li><li style="list-style-type: disc"><p>The KVM website (<a class="ulink" href="http://www.linux-kvm.org/page/Main_Page" target="_blank">http://www.linux-kvm.org/page/Main_Page</a>)</p></li><li style="list-style-type: disc"><p>RHEL 7 Virtualization Deployment and Administration Guide (<a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Virtualization_Deployment_and_Administration_Guide/" target="_blank">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Virtualization_Deployment_and_Administration_Guide/</a>)</p></li><li style="list-style-type: disc"><p>Best practices for KVM (<a class="ulink" href="http://www.ibm.com/support/knowledgecenter/linuxonibm/liaat/liaatbpkickoff.htm" target="_blank">http://www.ibm.com/support/knowledgecenter/linuxonibm/liaat/liaatbpkickoff.htm</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch12lvl1sec95"></a>Cloning a virtual machine</h2></div></div><hr /></div><p>Since a virtual machine is ultimately nothing more than data files, these can easily be copied and shared. This is useful because you can set up a gold server exactly how you want it and then make copies that are used for different purposes. However, using the <code class="literal">cp</code> command isn't the way to go about it. This recipe shows you the correct way to duplicate a machine with a process called cloning.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec309"></a>Getting ready</h3></div></div></div><p>This recipe requires a virtual machine set up as described in the previous recipe. While the cloning process doesn't require administrative privileges per se, privileges may be needed to access the machine's files depending on where they are located. By default, the files are stored at <code class="literal">/var/lib/libvirt/images</code>, which requires administrative access.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec310"></a>How to do it...</h3></div></div></div><p>Follow these steps to clone a virtual machine:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Make sure the machine you want to clone is not running.</p></li><li><p>In Virtual Machine Manager, right-click on the desired machine in the list of available machines and select <span class="strong"><strong>Clone</strong></span> from the context menu. This opens the <span class="strong"><strong>Clone Virtual Machine</strong></span> dialog:</p><div class="mediaobject"><img src="graphics/image_12_007.jpg" /><div class="caption"><p>The Clone Virtual Machine dialog makes it easy to clone a machine image</p></div></div></li><li><p>Specify a unique name for the new image and click on the <span class="strong"><strong>Clone</strong></span> button. This will create a standalone copy of the virtual machine and selected storage.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec311"></a>How it works...</h3></div></div></div><p>This recipe used Virtual Machine Manager to create a copy of a machine known as a clone. The machine should be cloned in this manner instead of simply copying the underlying files, because the cloning process also updates various identifiers that should be unique between machines, such as the MAC address of the network interface.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note86"></a>Note</h3><p>The <code class="literal">virt-clone</code> command can be used to clone a guest on the command-line. For more information, refer to the program's man page using <code class="literal">man 1 virt-clone</code>.</p></div><p>If you want to update various aspects of the cloned machine before booting it, you can use tools such as <code class="literal">virt-sysprep</code> and <code class="literal">virt-configure</code>. These programs mount the machine's disk image in a chrooted environment, perform the requested modifications, and then unmount the image. <code class="literal">virt-sysprep</code> is installed via <code class="literal">libguestfs-tools-c</code>:</p><pre class="programlisting">
<span class="strong"><strong>    yum install libguestfs-tools-c
</strong></span>
</pre><p>To view a list of the available maintenance actions <code class="literal">virt-sysprep</code> can perform, invoke the program using <code class="literal">--list-operations</code>. Each option will be displayed along with a brief description of what it does. To perform an operation, use the <code class="literal">--operation</code> argument followed by one or more of the operation labels, separated by commas. For example, the following command clears the bash history for any accounts on the system and deletes any files that may be in <code class="literal">/tmp</code>. The <code class="literal">-a</code> argument provides the path to the machine's disk image:</p><pre class="programlisting">
<span class="strong"><strong>virt-sysprep -a /var/lib/virt/images/Ubuntu-clone.qcow2
--operations bash-history,tmp-files</strong></span>
</pre><p>Depending on what the original machine image was used for, you may find the following cleanup operations useful as well:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">ca-certificates</code>: This deletes any CA certificates</p></li><li style="list-style-type: disc"><p><code class="literal">logfiles</code>: This deletes log files</p></li><li style="list-style-type: disc"><p><code class="literal">ssh-hostkeys</code>: This deletes the SSH host keys</p></li><li style="list-style-type: disc"><p><code class="literal">ssh-userdir</code>: This deletes the users' <code class="literal">.ssh</code> directories</p></li><li style="list-style-type: disc"><p><code class="literal">user-account</code>: This deletes all user accounts except for root</p></li></ul></div><p>There is some overlap in the functionality of <code class="literal">virt-sysprep</code> and <code class="literal">virt-customize</code>; however, <code class="literal">virt-customize</code> performs more general customization operations, while virt-sysprep's actions focus more on cleaning up an image. <code class="literal">virt-customize</code> can do things like move and set the system's hostname, reset passwords, and install and uninstall packages.</p><p>To reset the system's hostname, use the <code class="literal">--hostname</code> argument and provide the desired name:</p><pre class="programlisting">
<span class="strong"><strong>virt-customize -a /var/lib/virt/images/Ubuntu-clone.qcow2
--hostname ubuntu2</strong></span>
</pre><p>The <code class="literal">--install</code> and <code class="literal">--uninstall</code> arguments add and remove packages and specify one or more package names separated by commas:</p><pre class="programlisting">
<span class="strong"><strong>virt-customize -a /var/lib/virt/images/Ubuntu-clone.qcow2
--install build-essential</strong></span>
</pre><p>Some arguments you may find useful for <code class="literal">virt-customize</code> are as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="literal">--chmod</code>: This changes file permissions</p></li><li style="list-style-type: disc"><p><code class="literal">--copy</code>: This creates a copy of a file or directory</p></li><li style="list-style-type: disc"><p><code class="literal">--delete</code>: This removes a file or directory</p></li><li style="list-style-type: disc"><p><code class="literal">--mkdir</code>: This creates a new directory</p></li><li style="list-style-type: disc"><p><code class="literal">--move</code>: This moves a file or directory to a new destination</p></li><li style="list-style-type: disc"><p><code class="literal">--password</code>: This updates a user's password</p></li><li style="list-style-type: disc"><p><code class="literal">--run-command</code>: This runs a command on the image</p></li></ul></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec312"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on cloning and customizing virtual machines:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>The <code class="literal">virt-clone</code>Â manual page (<code class="literal">man 1 virt-clone</code>)</p></li><li style="list-style-type: disc"><p>The <code class="literal">virt-configure</code>Â manual page (<code class="literal">man 1 virt-configure</code>)</p></li><li style="list-style-type: disc"><p>The <code class="literal">virt-sysprep</code>Â manual page (<code class="literal">man 1 virt-sysprep</code>)</p></li><li style="list-style-type: disc"><p>How to clone a KVM virtual machine and reset the VM (<a class="ulink" href="http://www.unixarena.com/2015/12/how-to-clone-a-kvm-virtual-machines-and-reset-the-vm.html" target="_blank">http://www.unixarena.com/2015/12/how-to-clone-a-kvm-virtual-machines-and-reset-the-vm.html</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch12lvl1sec96"></a>Adding storage to a virtual machine</h2></div></div><hr /></div><p>Even if you're not a data hoarder, the time will probably come when you need to add additional storage to a guest system. No worries! This is easy to do! This recipe teaches you how to add and modify the virtual hardware attached to a machine.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec313"></a>Getting ready</h3></div></div></div><p>This recipe requires a virtual machine set up as described in the previous recipes.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec314"></a>How to do it...</h3></div></div></div><p>Follow these steps to add storage to a virtual machine:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Make sure the virtual machine you want to modify is not running.</p></li><li><p>Open the virtual machine by double-clicking on the desired entry in the list of available machines.</p></li><li><p>Either click on the lightbulb icon in the menu bar or select <span class="strong"><strong>Details</strong></span> from <span class="strong"><strong>View</strong></span> to show the virtual machine's hardware details:</p><div class="mediaobject"><img src="graphics/image_12_008.jpg" /><div class="caption"><p>The machine's virtual hardware is displayed and resources can be added, modified, and removed</p></div></div></li><li><p>Click on the <span class="strong"><strong>Add Hardware</strong></span> button in the bottom-left corner of the window to open the <span class="strong"><strong>Add New Virtual Hardware</strong></span> window.</p></li><li><p>Select <span class="strong"><strong>Storage</strong></span> from the list of possible resources. Specify the desired storage space to allocate for the new disk and click on <span class="strong"><strong>Finish</strong></span>:</p><div class="mediaobject"><img src="graphics/image_12_009.jpg" /><div class="caption"><p>A virtual 8 GB storage drive is added to the machine</p></div></div></li><li><p>Leave the hardware view by either clicking on the computer icon in the menu bar or selecting <span class="strong"><strong>Console</strong></span> from <span class="strong"><strong>View</strong></span>.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec315"></a>How it works...</h3></div></div></div><p>This recipe showed you where to configure the virtual hardware definitions associated with a machine. To increase the storage available to a guest operating system, we navigated to this view and added a new virtual drive. The storage device can be created through the interface, as shown in the recipe, or an existing drive file can be selected and attached to the system.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note87"></a>Note</h3><p>If you are creating a new disk, you will want to partition, format, and mount the storage so it can be used. You may find the recipes discussed in <a class="link" href="#" linkend="ch05">Chapter 5</a>, <span class="emphasis"><em>Managing FilesystemsÂ and StorageÂ </em></span>helpful.</p></div><p>Other hardware can be managed via the hardware view as well. Most notably, you can add and configure new network interfaces and allocate additional RAM and CPU resources. Increasing the RAM/CPU might be done to run resource-intensive processes on the systemâ€”it's better to allocate a smaller amount first and then increase the resources when the need arises.</p><p>Another useful configuration is to change the display server. By default, the display is configured to use SPICE, a more robust protocol than VNC. A SPICE server is built into the virtualization platform so that you can connect to the virtual machine using a SPICE client to access its display, even if the guest is only running a console display (refer to <a class="ulink" href="https://www.spice-space.org/" target="_blank">https://www.spice-space.org/</a> to find a SPICE client). If you want to connect using VNC instead, select the <span class="strong"><strong>Display Spice</strong></span> entry in the hardware list and set its <span class="strong"><strong>Type</strong></span> to <span class="strong"><strong>VNC server</strong></span>. Change the <span class="strong"><strong>Address</strong></span> value to <span class="strong"><strong>All interfaces</strong></span> to accept connections from outside the localhost, specify a connection password, and then click on the <span class="strong"><strong>Apply</strong></span> button.</p><p>The display's label in the hardware list will change to <span class="strong"><strong>Display VNC</strong></span>:</p><div class="mediaobject"><img src="graphics/image_12_010.jpg" /><div class="caption"><p>Users can connect to a virtual system's display using a SPICE or VNC client</p></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec316"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on working with virtual hardware:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>RHEL 7 Virtualization Deployment and Administration Guide: Storage Pools Â 
(<a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Virtualization_Deployment_and_Administration_Guide/chap-Storage_pools.html" target="_blank">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Virtualization_Deployment_and_Administration_Guide/chap-Storage_pools.html</a>)</p></li><li style="list-style-type: disc"><p>Storage management (<a class="ulink" href="http://libvirt.org/storage.html" target="_blank">http://libvirt.org/storage.html</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch12lvl1sec97"></a>Connecting USB peripherals to a guest system</h2></div></div><hr /></div><p>This recipe teaches you how to share the USB devices that are connected to the host system with a virtual machine. This means you can use your USB printers, webcams, and storage devices from your guest operating system.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec317"></a>Getting ready</h3></div></div></div><p>This recipe requires a virtual machine set up as described in the previous recipes.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec318"></a>How to do it...</h3></div></div></div><p>Follow these steps to connect USB peripherals to a guest system:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Make sure the virtual machine you want to modify is not running.</p></li><li><p>Attach the USB device to the physical system.</p></li><li><p>Open the virtual machine by double-clicking on the desired entry in the list of available machines.</p></li><li><p>Show the virtual machine's hardware details by clicking on the lightbulb icon in the menu bar or selecting <span class="strong"><strong>Details</strong></span> from <span class="strong"><strong>View</strong></span>.</p></li><li><p>Click on the <span class="strong"><strong>Add Hardware</strong></span> button to open the <span class="strong"><strong>Add New Virtual Hardware</strong></span> window.</p></li><li><p>Select <span class="strong"><strong>USB HOST Device</strong></span> from the list of resources.</p></li><li><p>Select the desired USB device and then click on the <span class="strong"><strong>Finish</strong></span> button:</p><div class="mediaobject"><img src="graphics/image_12_011.jpg" /><div class="caption"><p>USB devices attached to the host system can be assigned to the virtual machines</p></div></div></li><li><p>Leave the hardware view by either clicking on the computer icon in the menu bar or selecting <span class="strong"><strong>Console</strong></span> from <span class="strong"><strong>View</strong></span>.</p></li><li><p>Start the virtual machine and verify that the USB device is available.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec319"></a>How it works...</h3></div></div></div><p>USB devices attached to the host system can be allocated to a virtual machine through the hardware details. We selected the <span class="strong"><strong>USB Host Device</strong></span> category, which displayed all of the devices currently registered with the host from which we can make our selection. There are a couple of items to be aware of when using USB devices in your guest system. First, only the USB 1.1 protocol is supported. This isn't an issue for most peripherals, such asÂ webcams, printers, and USB microphones, where transfer speed isn't much of a concern. It may be a concern if you intend to attach a USB storage device and transfer large amounts of data. Second, the device must be plugged in and accessible by the host before starting the virtual machine. This is because the virtualization platform running on the host is responsible for provisioning access to the guest.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note88"></a>Note</h3><p>This recipe showed you how to assign a USB device connected to the host system to a guest. If you're accessing your virtual machine remotely with a SPICE client, you can plug in USB devices to your local machine and redirect them to the remote guest using USB redirection. More information can be found in the RHEL 7 Virtualization Deployment and Administration Guide.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec320"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on sharing USB devices:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>RHEL 7 Virtualization Deployment and Administration Guide: USB Devices Â  Â 
(<a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Virtualization_Deployment_and_Administration_Guide/sect-Guest_virtual_machine_device_configuration-USB_devices.html" target="_blank">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Virtualization_Deployment_and_Administration_Guide/sect-Guest_virtual_machine_device_configuration-USB_devices.html</a>)</p></li><li style="list-style-type: disc"><p>USB pass-through with libvirt and KVM (<a class="ulink" href="https://david.wragg.org/blog/2009/03/usb-pass-through-with-libvirt-and-kvm.html" target="_blank">https://david.wragg.org/blog/2009/03/usb-pass-through-with-libvirt-and-kvm.html</a>)</p></li></ul></div></div></div></div></div></div>
ï»¿<div class="reader-container col-sm-12 col-lg-offset-1 col-lg-10 col-xl-offset-2 col-xl-8"><div class="row"><div style="position:relative;" class="book-content">
<div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ch12lvl1sec98"></a>Configuring a guest's network interface</h2></div></div><hr /></div><p>This recipe teaches you how to configure the virtual network interface's behavior. By changing the interface's behavior, you can provide the guest direct access or filtered access to the network, and even set up a local network visible only to the host system and other guests.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec321"></a>Getting ready</h3></div></div></div><p>This recipe requires a CentOS system with a working network connection. It also requires a virtual machine set up as described in the previous recipes.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec322"></a>How to do it...</h3></div></div></div><p>Follow these steps to configure a guest's network interface:</p><div class="orderedlist"><ol class="orderedlist arabic" type="1"><li><p>Make sure that the virtual machine you want to modify is not running.</p></li><li><p>Open the virtual machine by double-clicking on the desired entry in the list of available machines.</p></li><li><p>View the virtual machine's hardware details by clicking on the lightbulb icon in the menu bar or selecting <span class="strong"><strong>Details</strong></span> from <span class="strong"><strong>View</strong></span>.</p></li><li><p>Specify the desired <span class="strong"><strong>Network source</strong></span> (NAT or Host device).</p></li><li><p>If selecting a host device, specify the desired mode (Bridged, VEPA, Private, or Passthrough):</p><div class="mediaobject"><img src="graphics/image_12_012.jpg" /><div class="caption"><p>The virtual network interface can be configured to handle the guest's traffic in different ways</p></div></div></li><li><p>Click on the <span class="strong"><strong>Apply</strong></span> button to save your configuration.</p></li><li><p>Leave the hardware view by either clicking on the computer icon in the menu bar or selecting <span class="strong"><strong>Console</strong></span> from <span class="strong"><strong>View</strong></span>.</p></li><li><p>Start the virtual machine and proceed to configuring the guest's networking as necessary.</p></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec323"></a>How it works...</h3></div></div></div><p>Managing a guest's network connectivity is a matter of specifying the behavior of the virtual machine's network adaptor. To do this correctly, we need to first understand what the behaviors are from the options that are available to us.</p><p>The first option is <span class="strong"><strong>Network Address Translation</strong></span> (<span class="strong"><strong>NAT</strong></span>) and that isÂ the default for new virtual machines. The virtualization platform provides a virtual network interface to the guest and handles all of its traffic. The platform marshals the traffic through the host's physical interface, acting very much like a router between the guest and host.</p><p>The second option is to tie the virtual interface directly to the host's physical interface. There are four sharing modes, which are as follows:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="strong"><strong>Bridged</strong></span>: The virtualization platform connects the guest and host interfaces, giving the guest direct access to the Internet. The guest needs to obtain its own IP address and has full access to the network.</p></li><li style="list-style-type: disc"><p><span class="strong"><strong>VEPA</strong></span>: This is for use with VEPA-capable network devices (special hardware requirements must be met).</p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Private</strong></span>: The platform creates private network, routing packets so that virtual machines on the same host can communicate with one another and the external network, but connections coming in from the network can't reach the virtual machines.</p></li><li style="list-style-type: disc"><p><span class="strong"><strong>Passthrough</strong></span>: The host's interface is shared directly (additional technical requirements must be met).</p></li></ul></div><p>The documentation and terminology areÂ quite technical, given the nature of the subject. Moreover, many people who are not networking experts often have trouble deciding the correct configuration. In my experience, there're two common scenarios in which non-networkers use virtualization-local virtualization to provide an alternate environment and virtualization to provision multiple server systems. If you're using your virtual machine as a typical desktop system where users need Internet access to read e-mail and surf the Web, use NAT networking and configure the guest to use DHCP. If you're running the machines as servers, share the host's adaptor in the Bridged mode and configure the guest with a static IP address.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="ch12lvl2sec324"></a>See also</h3></div></div></div><p>Refer to the following resources for more information on configuring the virtual network interface:</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>libvirt Virtualization API: Networking (<a class="ulink" href="http://wiki.libvirt.org/page/Networking" target="_blank">http://wiki.libvirt.org/page/Networking</a>)</p></li><li style="list-style-type: disc"><p>RHEL 7 Virtualization Deployment and Administration Guide: Network Configuration (<a class="ulink" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Virtualization_Deployment_and_Administration_Guide/chap-Network_configuration.html" target="_blank">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Virtualization_Deployment_and_Administration_Guide/chap-Network_configuration.html</a>)</p></li></ul></div></div></div></div></div></div>
</div></div></div></body></html>
